<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roundwood Route Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2d5016; --primary-light: #5a8a3a; --primary-dark: #1a3009;
            --accent: #8fbc5a; --danger: #dc2626; --warning: #f59e0b; --success: #10b981;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-300: #d1d5db;
            --gray-500: #6b7280; --gray-600: #4b5563; --gray-700: #374151; --gray-900: #111827;
        }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--gray-50); color: var(--gray-900); line-height: 1.5; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(45, 80, 22, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; }
        .loading-spinner { font-size: 3rem; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .header { background: var(--primary); color: white; padding: 1rem 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; }
        .header h1 { font-size: 1.5rem; font-weight: 700; }
        .header-subtitle { font-size: 0.875rem; opacity: 0.9; }
        .nav-tabs { background: white; border-bottom: 1px solid var(--gray-200); position: sticky; top: 73px; z-index: 90; }
        .nav-tabs-inner { display: flex; max-width: 1200px; margin: 0 auto; overflow-x: auto; }
        .nav-tab { padding: 1rem 1.5rem; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); font-weight: 500; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .nav-tab:hover { color: var(--primary); background: var(--gray-50); }
        .nav-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .main-content { padding: 1.5rem; max-width: 1200px; margin: 0 auto; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--gray-200); }
        .card-title { font-size: 1.25rem; font-weight: 600; }
        .btn { padding: 0.625rem 1.25rem; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
        .btn-secondary:hover { background: var(--gray-300); }
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-700); font-size: 0.875rem; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.625rem; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 0.875rem; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1); }
        .form-textarea { resize: vertical; min-height: 80px; }
        .checkbox-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; }
        .checkbox-item { display: flex; align-items: center; gap: 0.5rem; }
        .checkbox-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .checkbox-item label { cursor: pointer; font-size: 0.875rem; }
        .visit-card { background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 1.25rem; margin-bottom: 1rem; transition: all 0.2s; }
        .visit-card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .visit-header { margin-bottom: 0.75rem; }
        .visit-site-name { font-weight: 600; font-size: 1.125rem; }
        .visit-date { color: var(--gray-600); font-size: 0.875rem; margin-top: 0.25rem; }
        .visit-type { display: inline-block; padding: 0.25rem 0.75rem; background: var(--primary-light); color: white; border-radius: 4px; font-size: 0.75rem; font-weight: 500; margin-top: 0.5rem; }
        .visit-details { margin: 0.75rem 0; color: var(--gray-600); font-size: 0.875rem; }
        .visit-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; }
        .badge { display: inline-block; padding: 0.25rem 0.625rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
        .badge-pending { background: var(--warning); color: white; }
        .badge-invoiced { background: var(--success); color: white; }
        .badge-overdue { background: var(--danger); color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; padding: 2rem 1rem; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 8px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.25rem; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 1.5rem; color: var(--gray-500); cursor: pointer; padding: 0; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { color: var(--gray-700); }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 0.75rem; }
        .signature-pad { border: 2px dashed var(--gray-300); border-radius: 8px; background: var(--gray-50); cursor: crosshair; }
        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--gray-500); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
        .empty-state-title { font-size: 1.25rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .stat-label { color: var(--gray-600); font-size: 0.875rem; margin-top: 0.25rem; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--gray-200); }
        .list-item:last-child { border-bottom: none; }
        .list-item-info { flex: 1; }
        .list-item-title { font-weight: 500; margin-bottom: 0.25rem; }
        .list-item-meta { font-size: 0.875rem; color: var(--gray-600); }
        .photo-preview { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; margin-top: 0.5rem; }
        .photo-preview img { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; border: 1px solid var(--gray-300); }
        .worksheet { border: 2px solid var(--gray-300); border-radius: 8px; padding: 1rem; margin: 1rem 0; background: white; }
        .worksheet-row { display: grid; grid-template-columns: 1fr 100px; gap: 1rem; margin-bottom: 0.5rem; padding: 0.5rem; border-bottom: 1px solid var(--gray-200); }
        .worksheet-row:last-child { border-bottom: none; }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.25rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .visit-actions { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">🌿</div>
        <div style="margin-top: 1rem; font-size: 1.25rem;">Loading Roundwood Manager...</div>
    </div>
    <div id="appContent" style="display: none;">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>🌿 Roundwood Route Manager</h1>
                    <div class="header-subtitle">Grounds Maintenance Scheduling</div>
                </div>
                <div id="userInfo" style="text-align: right; display: none;">
                    <div style="font-size: 0.875rem; opacity: 0.9;" id="currentUser"></div>
                    <button class="btn btn-secondary" style="margin-top: 0.25rem; padding: 0.375rem 0.75rem; font-size: 0.75rem;" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
        <div class="nav-tabs">
            <div class="nav-tabs-inner">
                <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
                <button class="nav-tab" data-tab="upcoming">Upcoming Visits</button>
                <button class="nav-tab admin-only" data-tab="sites">Sites</button>
                <button class="nav-tab admin-only" data-tab="invoices">Invoice Tracking</button>
                <button class="nav-tab" data-tab="completed">Completed</button>
            </div>
        </div>
        <div class="main-content">
            <div id="dashboard" class="tab-pane active">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="stat-total-sites">0</div><div class="stat-label">Total Sites</div></div>
                    <div class="stat-card"><div class="stat-value" id="stat-upcoming">0</div><div class="stat-label">Upcoming Visits</div></div>
                    <div class="stat-card"><div class="stat-value" id="stat-pending-invoice">0</div><div class="stat-label">Pending Invoices</div></div>
                    <div class="stat-card"><div class="stat-value" id="stat-this-week">0</div><div class="stat-label">This Week</div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h2 class="card-title">Quick Actions</h2></div>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-primary admin-only" onclick="showAddSiteModal()">➕ Add New Site</button>
                        <button class="btn btn-secondary" onclick="switchTab('upcoming')">📅 View Upcoming Visits</button>
                        <button class="btn btn-secondary admin-only" onclick="switchTab('invoices')">💰 Track Invoices</button>
                        <button class="btn btn-secondary admin-only" onclick="switchTab('sites')">🏢 Manage Sites</button>
                    </div>
                </div>
            </div>
            <div id="upcoming" class="tab-pane">
                <div class="card"><div class="card-header"><h2 class="card-title">Next Visit</h2></div><div id="upcoming-visits-list"></div></div>
                <div class="card"><div class="card-header"><h2 class="card-title">Future Visits</h2></div><div id="future-visits-list"></div></div>
            </div>
            <div id="sites" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Your Sites</h2>
                        <button class="btn btn-primary admin-only" onclick="showAddSiteModal()">➕ Add Site</button>
                    </div>
                    <div id="sites-list"></div>
                </div>
            </div>
            <div id="invoices" class="tab-pane">
                <div class="card"><div class="card-header"><h2 class="card-title">Invoice Tracking</h2></div><div id="invoices-list"></div></div>
            </div>
            <div id="completed" class="tab-pane">
                <div class="card"><div class="card-header"><h2 class="card-title">Completed Visits</h2></div><div id="completed-list"></div></div>
            </div>
        </div>
<div id="loginModal" class="modal active">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header"><h3 class="modal-title">🌿 Roundwood Route Manager</h3></div>
                <div class="modal-body">
                    <div id="loginFormContainer">
                        <div class="form-group"><label class="form-label">Email Address</label><input type="email" class="form-input" id="loginEmail" autocomplete="email"></div>
                        <div class="form-group"><label class="form-label">Password</label><input type="password" class="form-input" id="loginPassword" autocomplete="current-password"></div>
                        <div style="margin-top: 1.5rem;"><button type="button" class="btn btn-primary" onclick="handleLogin()" style="width: 100%;">Login</button></div>
                        <div style="text-align: center; margin-top: 1rem;"><button type="button" class="btn btn-secondary" onclick="showRegisterForm()" style="width: 100%;">Create New Account</button></div>
                    </div>
                    <div id="registerFormContainer" style="display: none;">
                        <div class="form-group"><label class="form-label">Full Name</label><input type="text" class="form-input" id="registerName"></div>
                        <div class="form-group"><label class="form-label">Email Address</label><input type="email" class="form-input" id="registerEmail" autocomplete="email"></div>
                        <div class="form-group"><label class="form-label">Password</label><input type="password" class="form-input" id="registerPassword" autocomplete="new-password"><small style="color: var(--gray-600); font-size: 0.75rem; margin-top: 0.25rem; display: block;">Must be at least 6 characters</small></div>
                        <div class="form-group"><label class="form-label">Confirm Password</label><input type="password" class="form-input" id="registerPasswordConfirm" autocomplete="new-password"></div>
                        <div style="margin-top: 1.5rem;"><button type="button" class="btn btn-success" onclick="handleRegister()" style="width: 100%;">Create Account</button></div>
                        <div style="text-align: center; margin-top: 1rem;"><button type="button" class="btn btn-secondary" onclick="showLoginForm()" style="width: 100%;">Back to Login</button></div>
                    </div>
                    <div id="firstUserNotice" style="margin-top: 1.5rem; padding: 1rem; background: var(--accent); color: white; border-radius: 6px; font-size: 0.875rem; display: none;"><strong>👑 First User Setup</strong><br>The first account created will automatically become the administrator with full access.</div>
                </div>
            </div>
        </div>
        <div id="addSiteModal" class="modal">
            <div class="modal-content">
                <div class="modal-header"><h3 class="modal-title">Add New Site</h3><button class="modal-close" onclick="closeModal('addSiteModal')">×</button></div>
                <div class="modal-body">
                    <div class="form-group"><label class="form-label">Site Name *</label><input type="text" class="form-input" id="siteName"></div>
                    <div class="form-group"><label class="form-label">Address *</label><textarea class="form-textarea" id="siteAddress"></textarea></div>
                    <div class="form-group"><label class="form-label">Services</label><div class="checkbox-group" id="servicesCheckboxes"></div></div>
                    <div class="form-group">
                        <label class="form-label">Visit Frequency *</label>
                        <select class="form-select" id="visitFrequency">
                            <option value="">Select frequency...</option>
                            <option value="one-off">One-off</option>
                            <option value="weekly">Weekly</option>
                            <option value="fortnightly">Fortnightly</option>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="tri-annually">Tri-annually</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">First Visit Date *</label><input type="date" class="form-input" id="firstVisit"></div>
                    <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="siteNotes"></textarea></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('addSiteModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveSite()">Add Site</button>
                </div>
            </div>
        </div>
        <div id="startVisitModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header"><h3 class="modal-title">📸 Start Visit - Before Photos</h3><button class="modal-close" onclick="closeModal('startVisitModal')">×</button></div>
                <div class="modal-body">
                    <p style="margin-bottom: 1rem; color: var(--gray-700);">Please take before photos of the site before starting work.</p>
                    <div class="form-group">
                        <label class="form-label">Before Photos *</label>
                        <input type="file" class="form-input" id="beforePhotosInput" accept="image/*" multiple capture="environment">
                    </div>
                    <div id="beforePhotosPreview" class="photo-preview"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('startVisitModal')">Cancel</button>
                    <button class="btn btn-success" onclick="confirmStartVisit()">Start Work</button>
                </div>
            </div>
        </div>
        <div id="completeVisitModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header"><h3 class="modal-title">Complete Visit</h3><button class="modal-close" onclick="closeModal('completeVisitModal')">×</button></div>
                <div class="modal-body">
                    <input type="hidden" id="visitId">
                    <div class="form-group"><label class="form-label">Staff Member *</label><input type="text" class="form-input" id="staffMember"></div>
                    <div class="form-group"><label class="form-label">Time Spent (hours)</label><input type="number" step="0.1" class="form-input" id="timeSpent" min="0"></div>
                    <div class="form-group"><label class="form-label">Services Completed</label><div class="checkbox-group" id="completedServicesCheckboxes"></div></div>
                    <div class="form-group"><label class="form-label">Work Completed</label><textarea class="form-textarea" id="workNotes" placeholder="Describe the work completed..."></textarea></div>
                    <div class="form-group">
                        <label class="form-label">After Photos *</label>
                        <input type="file" class="form-input" id="afterPhotosInput" accept="image/*" multiple capture="environment">
                        <div id="afterPhotosPreview" class="photo-preview" style="margin-top: 0.5rem;"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Work Completion Worksheet</label>
                        <div class="worksheet">
                            <div style="margin-bottom: 1rem; font-weight: 600; color: var(--primary);">Mark tasks as completed:</div>
                            <div class="worksheet-row">
                                <label>Grass cutting completed</label>
                                <input type="checkbox" id="ws-grass" style="width: 20px; height: 20px;">
                            </div>
                            <div class="worksheet-row">
                                <label>Hedges trimmed</label>
                                <input type="checkbox" id="ws-hedges" style="width: 20px; height: 20px;">
                            </div>
                            <div class="worksheet-row">
                                <label>Weeds removed</label>
                                <input type="checkbox" id="ws-weeds" style="width: 20px; height: 20px;">
                            </div>
                            <div class="worksheet-row">
                                <label>Borders maintained</label>
                                <input type="checkbox" id="ws-borders" style="width: 20px; height: 20px;">
                            </div>
                            <div class="worksheet-row">
                                <label>Litter removed</label>
                                <input type="checkbox" id="ws-litter" style="width: 20px; height: 20px;">
                            </div>
                            <div class="worksheet-row">
                                <label>Site left tidy</label>
                                <input type="checkbox" id="ws-tidy" style="width: 20px; height: 20px;">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Customer Signature *</label>
                        <canvas id="signaturePad" class="signature-pad" width="600" height="200"></canvas>
                        <div style="margin-top: 0.5rem;"><button type="button" class="btn btn-secondary" onclick="clearSignature()">Clear Signature</button></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('completeVisitModal')">Cancel</button>
                    <button class="btn btn-success" onclick="completeVisit()">Complete & Send Invoice Request</button>
                </div>
            </div>
        </div>
    </div>
<script>
        const firebaseConfig = {apiKey: "AIzaSyDiARsn-HBhwuHuWjmeAB9ntRxyd4FSR-E",authDomain: "roundwood-manager.firebaseapp.com",databaseURL: "https://roundwood-manager-default-rtdb.europe-west1.firebasedatabase.app",projectId: "roundwood-manager",storageBucket: "roundwood-manager.firebasestorage.app",messagingSenderId: "1064499324684",appId: "1:1064499324684:web:c974e276f5b86092bbcb29"};
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const SERVICES = ['Regular Grass Cutting', 'Hedge Trimming', 'Weed Control', 'Border Maintenance', 'Leaf Clearing', 'Seasonal Planting', 'Litter Picking', 'Car Park Maintenance', 'Sports Pitch Line Marking', 'Forest School Maintenance', 'Tree Surveys'];
        const FREQUENCY_DAYS = {'one-off': 0, 'weekly': 7, 'fortnightly': 14, 'monthly': 30, 'quarterly': 91, 'tri-annually': 122};
        let currentUser = null, sites = [], visits = [], completedVisits = [], signaturePad = null, isDrawing = false, beforePhotosData = [], currentVisitId = null;
        document.addEventListener('DOMContentLoaded', function() {
            initializeServiceCheckboxes();
            initializeTabs();
            initializeSignaturePad();
            document.getElementById('beforePhotosInput').addEventListener('change', handleBeforePhotosSelect);
            document.getElementById('afterPhotosInput').addEventListener('change', handleAfterPhotosSelect);
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const userRef = database.ref('users/' + user.uid);
                    const snapshot = await userRef.once('value');
                    const userData = snapshot.val();
                    currentUser = {uid: user.uid, email: user.email, name: userData?.name || user.email, role: userData?.role || 'staff'};
                    await loadDataFromFirebase();
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    document.getElementById('loginModal').classList.remove('active');
                    updateUIForRole();
                    renderAll();
                } else {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    document.getElementById('loginModal').classList.add('active');
                }
            });
        });
        async function loadDataFromFirebase() {
            try {
                const sitesRef = database.ref('sites');
                const sitesSnapshot = await sitesRef.once('value');
                sites = [];
                sitesSnapshot.forEach((child) => {sites.push({ id: child.key, ...child.val() });});
                const visitsRef = database.ref('visits');
                const visitsSnapshot = await visitsRef.once('value');
                visits = [];
                visitsSnapshot.forEach((child) => {visits.push({ id: child.key, ...child.val() });});
                const completedRef = database.ref('completedVisits');
                const completedSnapshot = await completedRef.once('value');
                completedVisits = [];
                completedSnapshot.forEach((child) => {completedVisits.push({ id: child.key, ...child.val() });});
                sitesRef.on('value', (snapshot) => {sites = [];snapshot.forEach((child) => {sites.push({ id: child.key, ...child.val() });});renderAll();});
                visitsRef.on('value', (snapshot) => {visits = [];snapshot.forEach((child) => {visits.push({ id: child.key, ...child.val() });});renderAll();});
                completedRef.on('value', (snapshot) => {completedVisits = [];snapshot.forEach((child) => {completedVisits.push({ id: child.key, ...child.val() });});renderAll();});
            } catch (error) {console.error('Error loading data:', error);alert('Error loading data from server.');}
        }
        function initializeServiceCheckboxes() {
            const container = document.getElementById('servicesCheckboxes');
            SERVICES.forEach(service => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `<input type="checkbox" id="service-${service.replace(/\s+/g, '-')}" value="${service}"><label for="service-${service.replace(/\s+/g, '-')}">${service}</label>`;
                container.appendChild(div);
            });
        }
        function initializeTabs() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {switchTab(tab.dataset.tab);});
            });
        }
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
            renderAll();
        }
        function initializeSignaturePad() {
            const canvas = document.getElementById('signaturePad');
            const ctx = canvas.getContext('2d');
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            signaturePad = { canvas, ctx };
        }
        function startDrawing(e) {isDrawing = true;const rect = signaturePad.canvas.getBoundingClientRect();signaturePad.ctx.beginPath();signaturePad.ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);}
        function draw(e) {if (!isDrawing) return;const rect = signaturePad.canvas.getBoundingClientRect();signaturePad.ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);signaturePad.ctx.stroke();}
        function stopDrawing() {isDrawing = false;}
        function handleTouch(e) {e.preventDefault();const touch = e.touches[0];const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {clientX: touch.clientX, clientY: touch.clientY});signaturePad.canvas.dispatchEvent(mouseEvent);}
        function clearSignature() {signaturePad.ctx.clearRect(0, 0, signaturePad.canvas.width, signaturePad.canvas.height);}
        function handleBeforePhotosSelect(e) {
            const files = Array.from(e.target.files);
            const preview = document.getElementById('beforePhotosPreview');
            preview.innerHTML = '';
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }
        function handleAfterPhotosSelect(e) {
            const files = Array.from(e.target.files);
            const preview = document.getElementById('afterPhotosPreview');
            preview.innerHTML = '';
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }
        function showLoginForm() {document.getElementById('loginFormContainer').style.display = 'block';document.getElementById('registerFormContainer').style.display = 'none';}
        async function showRegisterForm() {document.getElementById('loginFormContainer').style.display = 'none';document.getElementById('registerFormContainer').style.display = 'block';const usersRef = database.ref('users');const snapshot = await usersRef.once('value');const userCount = snapshot.numChildren();document.getElementById('firstUserNotice').style.display = userCount === 0 ? 'block' : 'none';}
        async function handleRegister() {const name = document.getElementById('registerName').value.trim();const email = document.getElementById('registerEmail').value.trim().toLowerCase();const password = document.getElementById('registerPassword').value;const passwordConfirm = document.getElementById('registerPasswordConfirm').value;if (!name || !email || !password) {alert('Please fill in all fields!');return;}if (password !== passwordConfirm) {alert('Passwords do not match!');return;}if (password.length < 6) {alert('Password must be at least 6 characters long!');return;}try {const usersRef = database.ref('users');const snapshot = await usersRef.once('value');const userCount = snapshot.numChildren();const role = userCount === 0 ? 'admin' : 'staff';const userCredential = await auth.createUserWithEmailAndPassword(email, password);const user = userCredential.user;await database.ref('users/' + user.uid).set({name: name, email: email, role: role, createdAt: new Date().toISOString()});alert(`✅ Account created successfully!${role === 'admin' ? '\n\n👑 You are the first user and have been granted administrator access.' : ''}\n\nYou're now logged in!`);} catch (error) {console.error('Registration error:', error);if (error.code === 'auth/email-already-in-use') {alert('An account with this email already exists!');} else {alert('Error creating account: ' + error.message);}}}
        async function handleLogin() {const email = document.getElementById('loginEmail').value.trim().toLowerCase();const password = document.getElementById('loginPassword').value;if (!email || !password) {alert('Please enter your email and password!');return;}try {await auth.signInWithEmailAndPassword(email, password);} catch (error) {console.error('Login error:', error);alert('Invalid email or password. Please try again.');}}
        async function logout() {if (confirm('Are you sure you want to logout?')) {try {await auth.signOut();currentUser = null;sites = [];visits = [];completedVisits = [];document.getElementById('loginModal').classList.add('active');} catch (error) {console.error('Logout error:', error);}}}
        function updateUIForRole() {const isAdmin = currentUser.role === 'admin';document.getElementById('userInfo').style.display = 'block';document.getElementById('currentUser').innerHTML = `<strong>${currentUser.name}</strong><br><span style="font-size: 0.75rem;">${currentUser.email}</span><br><span style="font-size: 0.75rem;">${isAdmin ? '👑 Administrator' : '👤 Staff Member'}</span>`;document.querySelectorAll('.admin-only').forEach(el => {el.style.display = isAdmin ? '' : 'none';});if (!isAdmin) {switchTab('upcoming');}}
        function showAddSiteModal() {if (currentUser.role !== 'admin') {alert('Only administrators can add sites.');return;}document.getElementById('addSiteModal').classList.add('active');}
        function closeModal(modalId) {document.getElementById(modalId).classList.remove('active');if (modalId === 'startVisitModal') {beforePhotosData = [];currentVisitId = null;document.getElementById('beforePhotosInput').value = '';document.getElementById('beforePhotosPreview').innerHTML = '';}}
        async function saveSite() {const name = document.getElementById('siteName').value;const address = document.getElementById('siteAddress').value;const frequency = document.getElementById('visitFrequency').value;const firstVisit = document.getElementById('firstVisit').value;const notes = document.getElementById('siteNotes').value;if (!name || !address || !frequency || !firstVisit) {alert('Please fill in all required fields!');return;}const selectedServices = [];document.querySelectorAll('#servicesCheckboxes input[type="checkbox"]:checked').forEach(cb => {selectedServices.push(cb.value);});try {const siteRef = database.ref('sites').push();const siteId = siteRef.key;await siteRef.set({name, address, services: selectedServices, frequency, notes, createdAt: new Date().toISOString(), createdBy: currentUser.email});await generateVisitsForSite(siteId, name, address, frequency, selectedServices, new Date(firstVisit));closeModal('addSiteModal');alert('Site added successfully!');} catch (error) {console.error('Error saving site:', error);alert('Error saving site: ' + error.message);}}
        async function generateVisitsForSite(siteId, siteName, address, frequency, services, startDate) {
            const daysBetween = FREQUENCY_DAYS[frequency];
            if (frequency === 'one-off') {
                await database.ref('visits').push({siteId, siteName, address, frequency, services, date: startDate.toISOString().split('T')[0], status: 'scheduled'});
            } else {
                let visitDate = new Date(startDate);
                for (let i = 0; i < 12; i++) {
                    await database.ref('visits').push({siteId, siteName, address, frequency, services, date: visitDate.toISOString().split('T')[0], status: 'scheduled'});
                    visitDate.setDate(visitDate.getDate() + daysBetween);
                }
            }
        }
        function startVisit(visitId) {
            currentVisitId = visitId;
            document.getElementById('startVisitModal').classList.add('active');
        }
        async function confirmStartVisit() {
            const files = document.getElementById('beforePhotosInput').files;
            if (files.length === 0) {
                if (!confirm('No before photos selected. Continue anyway?')) return;
            }
            beforePhotosData = [];
            for (const file of files) {
                const base64 = await fileToBase64(file);
                beforePhotosData.push(base64);
            }
            closeModal('startVisitModal');
            showCompleteVisitModal(currentVisitId);
        }
        function fileToBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        }
        function showCompleteVisitModal(visitId) {
            document.getElementById('visitId').value = visitId;
            if (currentUser.role === 'staff') {
                document.getElementById('staffMember').value = currentUser.name;
            }
            const visit = visits.find(v => v.id === visitId);
            if (visit && visit.services) {
                const container = document.getElementById('completedServicesCheckboxes');
                container.innerHTML = '';
                visit.services.forEach(service => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    div.innerHTML = `<input type="checkbox" id="completed-${service.replace(/\s+/g, '-')}" value="${service}"><label for="completed-${service.replace(/\s+/g, '-')}">${service}</label>`;
                    container.appendChild(div);
                });
            }
            document.getElementById('completeVisitModal').classList.add('active');
        }
        async function completeVisit() {
            const visitId = document.getElementById('visitId').value;
            const staffMember = document.getElementById('staffMember').value;
            const timeSpent = document.getElementById('timeSpent').value;
            const workNotes = document.getElementById('workNotes').value;
            if (!staffMember) {alert('Please enter staff member name');return;}
            const afterPhotosFiles = document.getElementById('afterPhotosInput').files;
            if (afterPhotosFiles.length === 0) {
                if (!confirm('No after photos selected. Continue anyway?')) return;
            }
            const visit = visits.find(v => v.id === visitId);
            if (!visit) return;
            const signatureData = signaturePad.canvas.toDataURL();
            const completedServices = [];
            document.querySelectorAll('#completedServicesCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                completedServices.push(cb.value);
            });
            const worksheet = {
                grass: document.getElementById('ws-grass').checked,
                hedges: document.getElementById('ws-hedges').checked,
                weeds: document.getElementById('ws-weeds').checked,
                borders: document.getElementById('ws-borders').checked,
                litter: document.getElementById('ws-litter').checked,
                tidy: document.getElementById('ws-tidy').checked
            };
            try {
                const afterPhotosData = [];
                for (const file of afterPhotosFiles) {
                    const base64 = await fileToBase64(file);
                    afterPhotosData.push(base64);
                }
                const completedVisit = {...visit, completedAt: new Date().toISOString(), staffMember, timeSpent, workNotes, completedServices, worksheet, signature: signatureData, beforePhotos: beforePhotosData, afterPhotos: afterPhotosData, invoiceStatus: 'awaiting_invoice', completedBy: currentUser.email};
                await database.ref('completedVisits').push(completedVisit);
                await database.ref('visits/' + visitId).remove();
                const site = sites.find(s => s.id === visit.siteId);
                if (site && site.frequency !== 'one-off') {
                    const nextDate = new Date(visit.date);
                    const daysBetween = FREQUENCY_DAYS[site.frequency];
                    nextDate.setDate(nextDate.getDate() + daysBetween);
                    await database.ref('visits').push({siteId: site.id, siteName: site.name, address: site.address, frequency: site.frequency, services: site.services, date: nextDate.toISOString().split('T')[0], status: 'scheduled'});
                }
                sendCompletionEmail(completedVisit);
                alert('✅ Visit completed!\n\n📧 Email sent to Office@roundwoodsolutions.co.uk');
                beforePhotosData = [];
                currentVisitId = null;
                closeModal('completeVisitModal');
            } catch (error) {console.error('Error:', error);alert('Error completing visit: ' + error.message);}
        }
        function sendCompletionEmail(visit) {const emailSubject = `Invoice Required: ${visit.siteName} - ${visit.frequency} Visit Completed`;const emailBody = `Visit Completion Details\n========================\n\nSite: ${visit.siteName}\nAddress: ${visit.address}\nFrequency: ${visit.frequency}\n\nCompleted By: ${visit.staffMember}\nCompleted On: ${new Date(visit.completedAt).toLocaleString('en-GB')}\nTime Spent: ${visit.timeSpent || 'Not recorded'} hours\n\nServices Completed:\n${visit.completedServices?.join(', ') || 'None specified'}\n\nWork Notes:\n${visit.workNotes || 'No notes provided'}\n\nWorksheet:\n- Grass cutting: ${visit.worksheet?.grass ? 'Yes' : 'No'}\n- Hedges trimmed: ${visit.worksheet?.hedges ? 'Yes' : 'No'}\n- Weeds removed: ${visit.worksheet?.weeds ? 'Yes' : 'No'}\n- Borders maintained: ${visit.worksheet?.borders ? 'Yes' : 'No'}\n- Litter removed: ${visit.worksheet?.litter ? 'Yes' : 'No'}\n- Site left tidy: ${visit.worksheet?.tidy ? 'Yes' : 'No'}\n\nPhotos:\n- Before: ${visit.beforePhotos?.length || 0}\n- After: ${visit.afterPhotos?.length || 0}\n\nCustomer Signature: Received\n\nPlease prepare and send invoice to the customer.`.trim();window.location.href = `mailto:Office@roundwoodsolutions.co.uk?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;}
        async function markInvoiceSent(visitId) {if (currentUser.role !== 'admin') {alert('Only administrators can manage invoices.');return;}try {await database.ref('completedVisits/' + visitId).update({invoiceStatus: 'invoiced', invoicedAt: new Date().toISOString(), invoicedBy: currentUser.email});alert('Invoice marked as sent!');} catch (error) {console.error('Error:', error);}}
        async function deleteSite(siteId) {if (currentUser.role !== 'admin') {alert('Only administrators can delete sites.');return;}if (confirm('Delete this site and all associated visits?')) {try {await database.ref('sites/' + siteId).remove();const visitsToDelete = visits.filter(v => v.siteId === siteId);for (const visit of visitsToDelete) {await database.ref('visits/' + visit.id).remove();}alert('Site deleted!');} catch (error) {console.error('Error:', error);}}}
        function renderAll() {renderStats();renderUpcomingVisits();renderSites();renderInvoices();renderCompleted();}
        function renderStats() {const today = new Date().toISOString().split('T')[0];const weekFromNow = new Date();weekFromNow.setDate(weekFromNow.getDate() + 7);const weekEnd = weekFromNow.toISOString().split('T')[0];document.getElementById('stat-total-sites').textContent = sites.length;document.getElementById('stat-upcoming').textContent = visits.length;document.getElementById('stat-pending-invoice').textContent = completedVisits.filter(v => v.invoiceStatus === 'awaiting_invoice').length;document.getElementById('stat-this-week').textContent = visits.filter(v => v.date >= today && v.date <= weekEnd).length;}
        function renderUpcomingVisits() {const container = document.getElementById('upcoming-visits-list');const futureContainer = document.getElementById('future-visits-list');const upcomingVisits = visits.sort((a, b) => new Date(a.date) - new Date(b.date));if (upcomingVisits.length === 0) {container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📅</div><div class="empty-state-title">No upcoming visits</div><p>Add a site to schedule visits</p></div>';futureContainer.innerHTML = '';return;}const nextVisit = upcomingVisits[0];const isOverdue = new Date(nextVisit.date) < new Date();container.innerHTML = `<div class="visit-card"><div class="visit-header"><div class="visit-site-name">${nextVisit.siteName}</div><div class="visit-date">📅 ${formatDate(nextVisit.date)}</div><span class="visit-type">${nextVisit.frequency || 'Scheduled'}</span>${isOverdue ? '<span class="badge badge-overdue" style="margin-left: 0.5rem;">Overdue</span>' : ''}</div><div class="visit-details">📍 ${nextVisit.address}</div><div class="visit-actions"><button class="btn btn-success" onclick="startVisit('${nextVisit.id}')">▶️ Start Visit</button></div></div>`;if (upcomingVisits.length > 1) {futureContainer.innerHTML = upcomingVisits.slice(1).map(visit => {const isOverdue = new Date(visit.date) < new Date();return `<div class="list-item"><div class="list-item-info"><div class="list-item-title">${visit.siteName} - ${visit.frequency || 'Scheduled'}</div><div class="list-item-meta">📅 ${formatDate(visit.date)} | 📍 ${visit.address}${isOverdue ? '<span class="badge badge-overdue">Overdue</span>' : ''}</div></div></div>`;}).join('');} else {futureContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">✅</div><div class="empty-state-title">All caught up!</div></div>';}}
        function renderSites() {const container = document.getElementById('sites-list');if (sites.length === 0) {container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🏢</div><div class="empty-state-title">No sites yet</div><p>Click "Add Site" to get started</p></div>';return;}container.innerHTML = sites.map(site => `<div class="list-item"><div class="list-item-info"><div class="list-item-title">${site.name}</div><div class="list-item-meta">📍 ${site.address}<br>📅 ${site.frequency || 'Not set'} visits</div></div><button class="btn btn-danger admin-only" onclick="deleteSite('${site.id}')">Delete</button></div>`).join('');}
        function renderInvoices() {const container = document.getElementById('invoices-list');const pendingInvoices = completedVisits.filter(v => v.invoiceStatus === 'awaiting_invoice');if (pendingInvoices.length === 0) {container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">💰</div><div class="empty-state-title">All caught up!</div><p>No pending invoices</p></div>';return;}container.innerHTML = pendingInvoices.map(visit => `<div class="list-item"><div class="list-item-info"><div class="list-item-title">${visit.siteName} - ${visit.frequency}</div><div class="list-item-meta">✅ Completed: ${formatDate(visit.completedAt.split('T')[0])}<br>👤 Staff: ${visit.staffMember}</div></div><button class="btn btn-success" onclick="markInvoiceSent('${visit.id}')">✓ Invoice Sent</button></div>`).join('');}
        function renderCompleted() {const container = document.getElementById('completed-list');const recentCompleted = completedVisits.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt)).slice(0, 20);if (recentCompleted.length === 0) {container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">✅</div><div class="empty-state-title">No completed visits yet</div></div>';return;}container.innerHTML = recentCompleted.map(visit => `<div class="list-item"><div class="list-item-info"><div class="list-item-title">${visit.siteName} - ${visit.frequency}</div><div class="list-item-meta">✅ ${formatDate(visit.completedAt.split('T')[0])} by ${visit.staffMember}<br>${visit.timeSpent ? `⏱️ ${visit.timeSpent} hours<br>` : ''}<span class="badge ${visit.invoiceStatus === 'invoiced' ? 'badge-invoiced' : 'badge-pending'}">${visit.invoiceStatus === 'invoiced' ? 'Invoiced' : 'Awaiting Invoice'}</span></div></div></div>`).join('');}
        function formatDate(dateString) {const date = new Date(dateString);return date.toLocaleDateString('en-GB', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });}
    </script>
</body>
</html>