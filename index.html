<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roundwood Route Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Google Drive API -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2d5016;
            --primary-light: #5a8a3a;
            --primary-dark: #1a3009;
            --accent: #8fbc5a;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --danger-dark: #991b1b;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --warning-dark: #92400e;
            --success: #10b981;
            --success-light: #d1fae5;
            --success-dark: #065f46;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.5;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            inset: 0;
            background: var(--primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Login Screen */
        #loginScreen {
            display: none;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 2rem;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: white;
            border-radius: 16px;
            padding: 3rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .login-card h1 {
            color: var(--primary);
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .login-card p {
            color: var(--gray-600);
            text-align: center;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: var(--gray-700);
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }

        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 80, 22, 0.3);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .alert {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        /* Main App */
        #mainApp {
            display: none;
            min-height: 100vh;
            flex-direction: column;
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-email {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-export {
            background: rgba(255,255,255,0.25);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.3);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            margin-right: 0.5rem;
        }

        .btn-export:hover {
            background: rgba(255,255,255,0.35);
            border-color: rgba(255,255,255,0.5);
        }

        .nav-tabs {
            background: white;
            border-bottom: 2px solid var(--gray-200);
            padding: 0 1.5rem;
            overflow-x: auto;
            overflow-y: visible;
            white-space: nowrap;
        }

        .nav-tabs button {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .nav-tabs button:hover {
            color: var(--primary);
            background: var(--gray-50);
        }

        .nav-tabs button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .nav-tabs button .badge {
            background: var(--danger);
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            margin-left: 0.5rem;
            font-weight: 600;
        }

        /* Dropdown Menu */
        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dropdown-toggle:hover {
            color: var(--primary);
            background: var(--gray-50);
        }

        .dropdown-toggle.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .dropdown-arrow {
            font-size: 0.7rem;
            transition: transform 0.2s;
        }

        .nav-dropdown.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            display: none;
            position: fixed;
            background: white;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 0.5rem 0;
            z-index: 10000;
            margin-top: 0.5rem;
        }

        .nav-dropdown.open .dropdown-menu {
            display: block;
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 0.75rem 1.5rem;
            text-align: left;
            background: none;
            border: none;
            color: var(--gray-700);
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .dropdown-item:hover {
            background: var(--gray-50);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .tab-content {
            flex: 1;
            padding: 2rem 1.5rem;
        }

        .tab-pane {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tab-pane.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-100);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .site-card {
            border: 2px solid var(--gray-200);
            padding: 1.25rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .site-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(45, 80, 22, 0.1);
        }

        .site-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .site-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .site-address {
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .site-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .meta-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .meta-value {
            font-size: 0.95rem;
            color: var(--gray-900);
            font-weight: 500;
        }

        .badge-frequency {
            display: inline-block;
            background: var(--primary-light);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .visit-card {
            border-left: 4px solid var(--warning);
            background: white;
            padding: 1.25rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .visit-card.completed {
            border-left-color: var(--success);
            opacity: 0.7;
        }

        .visit-card.overdue {
            border-left-color: var(--danger);
            background: #fef2f2;
        }

        .visit-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .visit-site {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--gray-900);
        }

        .visit-date {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
        }

        .visit-status {
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-overdue {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-paused {
            background: #e0e7ff;
            color: #3730a3;
        }

        .visit-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(2px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-400);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .btn-close:hover {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 100px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--gray-500);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        .empty-state-text {
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .header-content h1 {
                font-size: 1.125rem;
            }

            .user-email {
                display: none;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .site-meta {
                grid-template-columns: 1fr;
            }

            .visit-actions {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Calculator Specific Styles */
        .calc-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--gray-50);
            border-radius: 8px;
        }

        .calc-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-light);
        }

        .calc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .calc-grid {
                grid-template-columns: 1fr;
            }
        }

        .calc-input {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 2px solid var(--gray-300);
        }

        .calc-input.preset {
            background: #fff3e0;
            border-color: #ff9800;
        }

        .calc-result {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 6px;
            border: 2px solid #2196f3;
        }

        .calc-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .calc-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .calc-unit {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-left: 0.5rem;
        }

        .saved-calc-item {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid var(--gray-200);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .saved-calc-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .saved-calc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .saved-calc-title {
            font-weight: 600;
            color: var(--gray-900);
        }

        .saved-calc-date {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .saved-calc-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        /* Collapsible Sections */
        .collapsible-section {
            margin-bottom: 1rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
            font-weight: 600;
        }

        .collapsible-header:hover {
            opacity: 0.9;
        }

        .collapsible-header:active {
            transform: scale(0.99);
        }

        .collapsible-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.125rem;
        }

        .collapsible-badge {
            background: rgba(255, 255, 255, 0.3);
            color: inherit;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .collapsible-arrow {
            font-size: 1.25rem;
            transition: transform 0.3s ease;
        }

        .collapsible-section.open .collapsible-arrow {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: white;
        }

        .collapsible-section.open .collapsible-content {
            max-height: 2000px;
            overflow: visible;
        }

        /* Mobile: Allow scrolling within collapsible sections */
        @media (max-width: 768px) {
            .collapsible-section.open .collapsible-content {
                max-height: calc(100vh - 200px);
                overflow-y: auto;
                overflow-x: hidden;
            }
            
            .collapsible-inner {
                padding: 1rem;
            }
        }

        .collapsible-inner {
            padding: 1rem 1.25rem;
        }

        .section-description {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 1rem;
        }

        /* Pipeline-specific styles */
        .pipeline-card {
            background: white;
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border-left: 4px solid;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .pipeline-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .pipeline-card-ref {
            font-size: 0.85rem;
            color: var(--gray-500);
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .pipeline-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .pipeline-card-subtitle {
            font-size: 0.9rem;
            color: var(--gray-500);
        }

        .pipeline-card-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            text-align: right;
        }

        .pipeline-card-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .meta-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            font-weight: 600;
        }

        .meta-value {
            font-size: 0.95rem;
            color: var(--gray-700);
            font-weight: 500;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-badge.sent {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.not-sent {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-badge.approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-badge.invoiced {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.paid {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.unpaid {
            background: #fef3c7;
            color: #92400e;
        }

        .date-prefill {
            display: inline-block;
            background: #d1fae5;
            color: #065f46;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
            font-weight: 600;
        }

        .info-box {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--info);
        }

        .info-box strong {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--gray-800);
        }

        /* Calendar Styles */
        .calendar-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 2rem;
            overflow: visible;
        }

        .calendar-header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .calendar-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .calendar-nav button {
            background: white;
            border: 1px solid var(--gray-300);
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .calendar-nav button:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }

        .calendar-grid-wrapper {
            overflow-x: auto;
            overflow-y: visible;
            padding: 0 1px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--gray-200);
            border: 1px solid var(--gray-200);
            min-width: 700px;
            width: 100%;
        }

        .calendar-day-header {
            background: var(--gray-100);
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 0.5rem;
            position: relative;
        }

        .calendar-day.other-month {
            background: var(--gray-50);
            opacity: 0.5;
        }

        .calendar-day.today {
            background: #fef3c7;
        }

        .calendar-day-number {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .calendar-day.other-month .calendar-day-number {
            color: var(--gray-400);
        }

        .shift-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .shift-badge.night {
            background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%);
        }

        .calendar-event {
            background: #d1fae5;
            border-left: 3px solid #10b981;
            padding: 0.2rem 0.4rem;
            margin-bottom: 0.2rem;
            border-radius: 3px;
            font-size: 0.7rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .calendar-event:hover {
            transform: translateX(2px);
        }

        .calendar-event.project {
            background: #e0e7ff;
            border-left-color: #6366f1;
        }

        .calendar-event.holiday {
            background: #fce7f3;
            border-left-color: #ec4899;
        }

        .calendar-event.overdue {
            background: #fee2e2;
            border-left-color: #ef4444;
        }

        .calendar-legend {
            display: flex;
            gap: 1.5rem;
            padding: 1rem 1.5rem;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
            flex-wrap: wrap;
            font-size: 0.85rem;
        }

        .calendar-legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .calendar-legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <p style="margin-top: 1rem;">Loading Roundwood Manager...</p>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-card">
            <h1>üå≥ Roundwood</h1>
            <p>Route Manager</p>
            
            <div id="loginError" style="display: none;" class="alert alert-error"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="btn btn-primary">Sign In</button>
            </form>
            
            <div style="text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
                <p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">
                    Don't have an account?
                </p>
                <button id="showRegisterBtn" class="btn btn-secondary" style="width: 100%;">
                    Create Account
                </button>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create Account</h2>
                <button class="btn-close" onclick="closeRegisterModal()">√ó</button>
            </div>
            
            <div id="registerError" style="display: none;" class="alert alert-error"></div>
            
            <form id="registerForm">
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
                    <small style="color: var(--gray-500); font-size: 0.8rem;">Minimum 6 characters</small>
                </div>
                <div class="form-group">
                    <label for="registerConfirm">Confirm Password</label>
                    <input type="password" id="registerConfirm" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="btn btn-primary">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp">
        <header class="header">
            <div class="header-content">
                <h1>üå≥ Roundwood Route Manager</h1>
                <div class="user-info">
                    <span class="user-email" id="userEmail"></span>
                    <button class="btn-logout" onclick="logout()">Sign Out</button>
                </div>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button onclick="showTab('pipeline')">üéØ Pipeline <span class="badge" id="pipelineCount">0</span></button>
            <button onclick="showTab('visits')">üìÖ Upcoming Visits <span class="badge" id="upcomingCount">0</span></button>
            <button onclick="showTab('invoices')">üí∞ Invoice Tracking <span class="badge" id="uninvoicedCount">0</span></button>
            <button onclick="showTab('reviews')">‚≠ê Reviews</button>
            
            <!-- Tools Dropdown -->
            <div class="nav-dropdown" id="toolsDropdown">
                <button class="dropdown-toggle" onclick="toggleDropdown(event)">
                    üîß Tools
                    <span class="dropdown-arrow">‚ñº</span>
                </button>
                <div class="dropdown-menu">
                    <button class="dropdown-item" onclick="exportAllDataToExcel(); closeDropdown();">üì§ Export All Data</button>
                    <button class="dropdown-item" onclick="toggleAutoBackup(); closeDropdown();">
                        <span id="autoBackupMenuItem">‚úÖ Auto-Backup: ON</span>
                    </button>
                    <button class="dropdown-item" onclick="authenticateGoogleDrive(); closeDropdown();">
                        <span id="googleDriveMenuItem">üîó Connect Google Drive</span>
                    </button>
                    <button class="dropdown-item" onclick="showTab('sites'); closeDropdown();">üìç Sites</button>
                    <button class="dropdown-item" onclick="showTab('history'); closeDropdown();">üìú History</button>
                    <button class="dropdown-item" onclick="showTab('calculator'); closeDropdown();">üß™ Calibration</button>
                </div>
            </div>
        </nav>

        <script>
        // Dropdown Menu Functions - Available immediately
        (function() {
            console.log('üîß Dropdown script loaded');
            
            window.toggleDropdown = function(event) {
                console.log('üîß toggleDropdown called');
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                const dropdown = document.getElementById('toolsDropdown');
                if (dropdown) {
                    const isOpen = dropdown.classList.contains('open');
                    console.log('üîß Dropdown current state:', isOpen ? 'open' : 'closed');
                    
                    if (!isOpen) {
                        // Calculate position before opening
                        const button = dropdown.querySelector('.dropdown-toggle');
                        const menu = dropdown.querySelector('.dropdown-menu');
                        if (button && menu) {
                            const rect = button.getBoundingClientRect();
                            menu.style.top = (rect.bottom + 5) + 'px';
                            menu.style.left = rect.left + 'px';
                            console.log('üîß Positioned dropdown at:', rect.left, rect.bottom + 5);
                        }
                    }
                    
                    dropdown.classList.toggle('open');
                    console.log('üîß Dropdown new state:', dropdown.classList.contains('open') ? 'open' : 'closed');
                } else {
                    console.error('üîß toolsDropdown element not found!');
                }
            };

            window.closeDropdown = function() {
                console.log('üîß closeDropdown called');
                const dropdown = document.getElementById('toolsDropdown');
                if (dropdown) {
                    dropdown.classList.remove('open');
                }
            };

            // Close dropdown when clicking outside - set up immediately
            setTimeout(function() {
                document.addEventListener('click', function(event) {
                    const dropdown = document.getElementById('toolsDropdown');
                    if (dropdown && !dropdown.contains(event.target)) {
                        dropdown.classList.remove('open');
                    }
                });
                console.log('üîß Click-outside listener added');
            }, 100);
        })();
        </script>

        <div class="tab-content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-pane active">
                <!-- Due Today (Collapsible) -->
                <div id="dueTodayCard" style="display: none;">
                    <div class="collapsible-section open">
                        <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e;">
                            <div class="collapsible-title">
                                <span>üìÖ Due Today</span>
                                <span class="collapsible-badge" id="dueTodayBadge">0</span>
                            </div>
                            <span class="collapsible-arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="collapsible-inner">
                                <p class="section-description" style="color: #78350f;">Visits and projects scheduled for today:</p>
                                <div id="dueTodayContent"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Visit Reminders (Collapsible) -->
                <div id="visitRemindersCard" style="display: none;">
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e;">
                            <div class="collapsible-title">
                                <span>‚è∞ Upcoming Reminders</span>
                                <span class="collapsible-badge" id="remindersBadge">0</span>
                            </div>
                            <span class="collapsible-arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="collapsible-inner">
                                <p class="section-description" style="color: #78350f;">Sites with visits in 1-3 days - consider sending courtesy reminders:</p>
                                <div id="visitRemindersContent"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Projects (Collapsible) -->
                <div id="activeProjectsCard" style="display: none;">
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); color: #5b21b6;">
                            <div class="collapsible-title">
                                <span>üöß Active Projects</span>
                                <span class="collapsible-badge" id="activeProjectsBadge">0</span>
                            </div>
                            <span class="collapsible-arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="collapsible-inner">
                                <p class="section-description" style="color: #6b21a8;">Projects in progress or starting soon:</p>
                                <div id="activeProjectsContent"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendar View (Collapsible) -->
                <div class="collapsible-section open">
                    <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); color: #0c4a6e;">
                        <div class="collapsible-title">
                            <span>üìÖ Calendar View</span>
                        </div>
                        <span class="collapsible-arrow">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-inner" style="padding: 0;">
                            <div class="calendar-section" style="margin: 0;">
                                <div class="calendar-header-bar">
                                    <div class="calendar-title" id="calendarMonthTitle">January 2026</div>
                                    <div style="display: flex; gap: 0.75rem; align-items: center;">
                                        <button onclick="openAddEventModal()" style="background: var(--primary); color: white; border: none; padding: 0.4rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">+ Add Event</button>
                                        <div class="calendar-nav">
                                            <button onclick="navigateCalendar('prev')">‚Üê Prev</button>
                                            <button onclick="navigateCalendar('today')">Today</button>
                                            <button onclick="navigateCalendar('next')">Next ‚Üí</button>
                                        </div>
                                    </div>
                                </div>
                                <div id="calendarContainer"></div>
                                <div class="calendar-legend">
                                    <div class="calendar-legend-item">
                                        <div class="calendar-legend-color" style="background: #d1fae5; border-left: 3px solid #10b981;"></div>
                                        <span>üîß Maintenance</span>
                                    </div>
                                    <div class="calendar-legend-item">
                                        <div class="calendar-legend-color" style="background: #e0e7ff; border-left: 3px solid #6366f1;"></div>
                                        <span>üéØ Project</span>
                                    </div>
                                    <div class="calendar-legend-item">
                                        <div class="calendar-legend-color" style="background: #fce7f3; border-left: 3px solid #ec4899;"></div>
                                        <span>üèñÔ∏è Holiday</span>
                                    </div>
                                    <div class="calendar-legend-item">
                                        <div class="calendar-legend-color" style="background: #fee2e2; border-left: 3px solid #ef4444;"></div>
                                        <span>‚ö†Ô∏è Overdue</span>
                                    </div>
                                    <div class="calendar-legend-item">
                                        <div class="calendar-legend-color" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.65rem;">D</div>
                                        <span>Day Shift</span>
                                    </div>
                                    <div class="calendar-legend-item">
                                        <div class="calendar-legend-color" style="background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.65rem;">N</div>
                                        <span>Night Shift</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seasonal Tips (Collapsible) -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46;">
                        <div class="collapsible-title">
                            <span>üå± This Month's Focus</span>
                        </div>
                        <span class="collapsible-arrow">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-inner">
                            <div id="seasonalTips" style="color: #064e3b;"></div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Upsells (Collapsible) -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af;">
                        <div class="collapsible-title">
                            <span>üíº Upsell Opportunities</span>
                        </div>
                        <span class="collapsible-arrow">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-inner">
                            <div id="monthlyUpsells" style="color: #1e3a8a;"></div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Sites Tab -->
            <!-- Sites Tab -->
            <div id="sites" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">All Sites</h2>
                        <button class="btn btn-primary" onclick="openAddSiteModal()">+ Add New Site</button>
                    </div>
                    <div id="sitesContainer"></div>
                </div>
            </div>

            <!-- Projects Tab -->
            <div id="projects" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">All Projects</h2>
                        <button class="btn btn-primary" onclick="openAddProjectModal()">+ Add New Project</button>
                    </div>
                    <div id="projectsContainer"></div>
                </div>
            </div>

            <!-- Visits Tab -->
            <div id="visits" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Upcoming Visits</h2>
                    </div>
                    <div id="visitsContainer"></div>
                </div>
            </div>

            <!-- Invoices Tab -->
            <div id="invoices" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Invoice Tracking</h2>
                    </div>
                    <div id="invoicesContainer"></div>
                </div>
            </div>

            <!-- Pipeline Tab -->
            <div id="pipeline" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üéØ Project Pipeline</h2>
                        <button class="btn btn-primary" onclick="openAddPipelineJobModal()">+ Add New Lead</button>
                    </div>

                    <div style="padding: 1.5rem;">
                        <!-- New Leads Section -->
                        <div class="collapsible-section open">
                            <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-weight: 600; font-size: 1.1rem;">üÜï New Leads</span>
                                    <span style="background: rgba(0,0,0,0.15); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem;" id="newLeadsCount">0</span>
                                </div>
                                <span class="collapsible-arrow" style="transition: transform 0.2s; font-size: 0.8rem;">‚ñº</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-inner" id="newLeadsContainer">
                                    <div class="empty-state">
                                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìã</div>
                                        <div class="empty-state-text">No new leads</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quotes Sent Section -->
                        <div class="collapsible-section open">
                            <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-weight: 600; font-size: 1.1rem;">üí∑ Quotes Sent</span>
                                    <span style="background: rgba(0,0,0,0.15); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem;" id="quotesSentCount">0</span>
                                </div>
                                <span class="collapsible-arrow" style="transition: transform 0.2s; font-size: 0.8rem;">‚ñº</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-inner" id="quotesSentContainer">
                                    <div class="empty-state">
                                        <div style="font-size: 2rem; margin-bottom: 1rem;">üí∑</div>
                                        <div class="empty-state-text">No quotes sent</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Approved - Ready to Schedule Section -->
                        <div class="collapsible-section">
                            <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-weight: 600; font-size: 1.1rem;">‚úÖ Approved - Ready to Schedule</span>
                                    <span style="background: rgba(0,0,0,0.15); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem;" id="approvedCount">0</span>
                                </div>
                                <span class="collapsible-arrow" style="transition: transform 0.2s; font-size: 0.8rem;">‚ñº</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-inner" id="approvedContainer">
                                    <div class="empty-state">
                                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚úÖ</div>
                                        <div class="empty-state-text">No approved quotes</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Work in Progress Section -->
                        <div class="collapsible-section">
                            <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); color: #3730a3;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-weight: 600; font-size: 1.1rem;">üî® Work in Progress</span>
                                    <span style="background: rgba(0,0,0,0.15); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem;" id="inProgressCount">0</span>
                                </div>
                                <span class="collapsible-arrow" style="transition: transform 0.2s; font-size: 0.8rem;">‚ñº</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-inner" id="inProgressContainer">
                                    <div class="empty-state">
                                        <div style="font-size: 2rem; margin-bottom: 1rem;">üî®</div>
                                        <div class="empty-state-text">No work in progress</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Complete - Awaiting Invoice Section -->
                        <div class="collapsible-section">
                            <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-weight: 600; font-size: 1.1rem;">‚úÖ Complete - Awaiting Invoice</span>
                                    <span style="background: rgba(0,0,0,0.15); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem;" id="completeCount">0</span>
                                </div>
                                <span class="collapsible-arrow" style="transition: transform 0.2s; font-size: 0.8rem;">‚ñº</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-inner" id="completeContainer">
                                    <div class="empty-state">
                                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚úÖ</div>
                                        <div class="empty-state-text">No completed work awaiting invoice</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Invoiced - Awaiting Payment Section -->
                        <div class="collapsible-section">
                            <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-weight: 600; font-size: 1.1rem;">üí∞ Invoiced - Awaiting Payment</span>
                                    <span style="background: rgba(0,0,0,0.15); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem;" id="invoicedCount">0</span>
                                </div>
                                <span class="collapsible-arrow" style="transition: transform 0.2s; font-size: 0.8rem;">‚ñº</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-inner" id="invoicedContainer">
                                    <div class="empty-state">
                                        <div style="font-size: 2rem; margin-bottom: 1rem;">üí∞</div>
                                        <div class="empty-state-text">No invoices awaiting payment</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Completed & Paid Section -->
                        <div class="collapsible-section">
                            <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-weight: 600; font-size: 1.1rem;">üéâ Completed & Paid</span>
                                    <span style="background: rgba(0,0,0,0.15); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem;" id="paidCount">0</span>
                                </div>
                                <span class="collapsible-arrow" style="transition: transform 0.2s; font-size: 0.8rem;">‚ñº</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-inner" id="paidContainer">
                                    <div class="empty-state">
                                        <div style="font-size: 2rem; margin-bottom: 1rem;">üéâ</div>
                                        <div class="empty-state-text">No completed & paid jobs yet</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Completed Visits History</h2>
                    </div>
                    <div id="historyContainer"></div>
                </div>
            </div>

            <!-- Reviews Tab -->
            <div id="reviews" class="tab-pane">
                <div class="card">
                    <h2 class="card-title">‚≠ê Request Google Reviews</h2>
                    <p style="color: var(--gray-600); margin-bottom: 1.5rem;">
                        Send review requests to your customers. They'll get an email with a direct link to leave a Google review.
                    </p>

                    <form id="sendReviewForm" style="max-width: 600px;">
                        <div class="form-group">
                            <label for="reviewBusiness">Business *</label>
                            <select id="reviewBusiness" required style="font-size: 1rem; padding: 0.75rem;">
                                <option value="roundwood">üå≥ Roundwood Solutions - Grounds Maintenance</option>
                                <option value="weedcontrol">üåø Weed Control Kent - Weed Control</option>
                            </select>
                            <small style="color: var(--gray-500); font-size: 0.85rem;">Choose which business this review is for</small>
                        </div>

                        <div class="form-group">
                            <label for="reviewCustomerName">Customer Name *</label>
                            <input type="text" id="reviewCustomerName" required placeholder="e.g. John Smith">
                        </div>

                        <div class="form-group">
                            <label for="reviewCustomerEmail">Customer Email *</label>
                            <input type="email" id="reviewCustomerEmail" required placeholder="customer@example.com">
                        </div>

                        <div class="form-group">
                            <label for="reviewSiteName">Site/Property Name *</label>
                            <input type="text" id="reviewSiteName" required placeholder="e.g. Maidstone Office Park or 123 High Street">
                            <small style="color: var(--gray-500); font-size: 0.85rem;">This will appear in the email</small>
                        </div>

                        <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                            <strong>üìß Email Preview:</strong><br>
                            <span id="emailPreviewText">The customer will receive a professional email thanking them for choosing Roundwood Solutions and asking them to leave a Google review.</span>
                        </div>

                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            üìß Send Review Request
                        </button>
                    </form>
                </div>

                <div class="card" style="margin-top: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">üìä Recent Review Requests</h3>
                    <div id="reviewHistoryContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">‚≠ê</div>
                            <div class="empty-state-text">No review requests sent yet</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calculator Tab -->
            <div id="calculator" class="tab-pane">
                <div class="card">
                    <h2 class="card-title">Sprayer Calibration Calculator</h2>
                    
                    <div id="calcAlert" style="display: none;"></div>

                    <!-- Save Calculation Name -->
                    <div class="form-group">
                        <label for="calcName">Calculation Name (optional)</label>
                        <input type="text" id="calcName" placeholder="e.g. Front Car Park - School Site">
                    </div>

                    <!-- Calibration Setup -->
                    <div class="calc-section">
                        <div class="calc-section-title">Calibration Setup</div>
                        <div class="calc-grid">
                            <div class="calc-input preset">
                                <div class="calc-label">Seconds to spray 100m (preset)</div>
                                <input type="number" id="seconds" value="90" step="1" style="width: 100%; padding: 0.5rem; border: 1px solid #ff9800; border-radius: 4px;">
                                <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">seconds</div>
                            </div>
                            <div class="calc-input">
                                <div class="calc-label">Nozzle output</div>
                                <input type="number" id="nozzleOutput" step="0.1" placeholder="0.0" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">LPM</div>
                            </div>
                            <div class="calc-input preset">
                                <div class="calc-label">Strip width (preset)</div>
                                <input type="number" id="stripWidth" value="1" step="0.1" style="width: 100%; padding: 0.5rem; border: 1px solid #ff9800; border-radius: 4px;">
                                <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">meters</div>
                            </div>
                            <div class="calc-input preset">
                                <div class="calc-label">Sprayer capacity (preset)</div>
                                <input type="number" id="sprayerCapacity" value="15" step="1" style="width: 100%; padding: 0.5rem; border: 1px solid #ff9800; border-radius: 4px;">
                                <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">litres</div>
                            </div>
                        </div>
                    </div>

                    <!-- Results Section 1 & 2 -->
                    <div class="calc-section">
                        <div class="calc-section-title">Walking Speed & Sprayer Output</div>
                        <div class="calc-grid">
                            <div class="calc-result">
                                <div class="calc-label">1. Walking Speed</div>
                                <div class="calc-value" id="walkingSpeed">0.00<span class="calc-unit">KPH</span></div>
                            </div>
                            <div class="calc-result">
                                <div class="calc-label">2. Sprayer Output per Hectare</div>
                                <div class="calc-value" id="sprayerOutput">0.00<span class="calc-unit">L/ha</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Result 3 -->
                    <div class="calc-section">
                        <div class="calc-section-title">Spray Tanks per Hectare</div>
                        <div class="calc-result">
                            <div class="calc-label">3. Number of Spray Tanks per Hectare</div>
                            <div class="calc-value" id="tanksPerHa">0.00<span class="calc-unit">tanks</span></div>
                        </div>
                    </div>

                    <!-- Chemical Application -->
                    <div class="calc-section">
                        <div class="calc-section-title">Chemical Application</div>
                        <div class="calc-grid">
                            <div class="calc-input">
                                <div class="calc-label">Chemical rate</div>
                                <input type="number" id="chemicalRate" step="0.1" placeholder="0.0" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">L/ha</div>
                            </div>
                            <div class="calc-result">
                                <div class="calc-label">4. Chemical per Spray Tank</div>
                                <div class="calc-value" id="chemicalPerTank">0.00<span class="calc-unit">mls</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Area Calculations -->
                    <div class="calc-section">
                        <div class="calc-section-title">Area to be Sprayed</div>
                        <div class="calc-grid">
                            <div class="calc-input">
                                <div class="calc-label">Area to be sprayed</div>
                                <input type="number" id="area" step="1" placeholder="0" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">m¬≤</div>
                            </div>
                            <div></div>
                        </div>
                    </div>

                    <!-- Total Chemical & Water -->
                    <div class="calc-section">
                        <div class="calc-section-title">Total Requirements</div>
                        <div class="calc-grid">
                            <div class="calc-result">
                                <div class="calc-label">5. Total Chemical Required</div>
                                <div class="calc-value" id="totalChemical">0.000<span class="calc-unit">litres</span></div>
                            </div>
                            <div class="calc-result">
                                <div class="calc-label">6. Total Water Required</div>
                                <div class="calc-value" id="totalWater">0.00<span class="calc-unit">litres</span></div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="saveCalculation()">üíæ Save Calculation</button>
                        <button class="btn btn-secondary" onclick="resetCalculator()">üîÑ Reset</button>
                    </div>
                </div>

                <div class="card" style="margin-top: 1.5rem;">
                    <h2 class="card-title">Saved Calculations</h2>
                    <div id="savedCalcsList" class="loading">Loading saved calculations...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- PIPELINE MODALS -->
    
    <!-- Add Pipeline Job Modal -->
    <div id="addPipelineJobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">+ Add New Lead</h2>
                <button class="btn-close" onclick="closeAddPipelineJobModal()">√ó</button>
            </div>
            <form id="addPipelineJobForm">
                <div class="modal-body">
                    <div class="info-box">
                        <strong>üí° Auto-Generated</strong>
                        Job Reference will be automatically assigned
                    </div>

                    <div class="form-group">
                        <label for="pipelineResponsiblePerson">Responsible Person *</label>
                        <select id="pipelineResponsiblePerson" required>
                            <option value="">-- Select --</option>
                            <option value="Ben">Ben</option>
                            <option value="Ricky">Ricky</option>
                        </select>
                        <small>Who is handling this lead?</small>
                    </div>

                    <div class="form-group">
                        <label for="pipelineCustomerName">Customer Name *</label>
                        <input type="text" id="pipelineCustomerName" required placeholder="e.g., Tunbury Primary School">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pipelineCustomerPhone">Phone</label>
                            <input type="tel" id="pipelineCustomerPhone" placeholder="01234 567890">
                        </div>
                        <div class="form-group">
                            <label for="pipelineCustomerEmail">Email</label>
                            <input type="email" id="pipelineCustomerEmail" placeholder="contact@customer.com">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="pipelineJobDescription">Job Description *</label>
                        <textarea id="pipelineJobDescription" required placeholder="e.g., Install new fencing around playground"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pipelineProjectType">Project Type *</label>
                            <select id="pipelineProjectType" required>
                                <option value="">-- Select --</option>
                                <option>Landscaping</option>
                                <option>Paving</option>
                                <option>Fencing</option>
                                <option>Weed Control</option>
                                <option>Tree Work</option>
                                <option>Maintenance Contract</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pipelineEstimatedValue">Estimated Value (¬£)</label>
                            <input type="number" id="pipelineEstimatedValue" placeholder="0.00" step="0.01">
                            <small>Optional - helps prioritize</small>
                        </div>
                        <div class="form-group">
                            <label for="pipelineEstimatedEndDate">Estimated End Date</label>
                            <input type="date" id="pipelineEstimatedEndDate">
                            <small>Optional - shows project duration on calendar</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="pipelineNotes">Notes (Optional)</label>
                        <textarea id="pipelineNotes" placeholder="Any additional notes..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="pipelineDeadlineType">Quote Deadline *</label>
                        <select id="pipelineDeadlineType" required onchange="toggleCustomDeadlineDate()">
                            <option value="1week" selected>1 Week</option>
                            <option value="2weeks">2 Weeks</option>
                            <option value="custom">Custom Date</option>
                        </select>
                        <small>Required - keeps you accountable for timely quotes</small>
                    </div>

                    <div class="form-group" id="customDeadlineContainer" style="display: none;">
                        <label for="pipelineCustomDeadline">Custom Deadline Date *</label>
                        <input type="date" id="pipelineCustomDeadline">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddPipelineJobModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Lead</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Send Quote Modal -->
    <div id="sendQuoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí∑ Send Quote</h2>
                <button class="btn-close" onclick="closeSendQuoteModal()">√ó</button>
            </div>
            <form id="sendQuoteForm">
                <div class="modal-body">
                    <div class="info-box">
                        <strong id="quoteJobInfo">Job details</strong>
                    </div>

                    <div class="form-group">
                        <label for="quoteAmount">Quote Amount (Ex VAT) *</label>
                        <input type="number" id="quoteAmount" required placeholder="0.00" step="0.01">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="quoteDate">Date <span class="date-prefill">‚ú® Today</span></label>
                            <input type="date" id="quoteDate" required>
                        </div>
                        <div class="form-group">
                            <label for="quoteValidUntil">Valid Until <span class="date-prefill">‚ú® +30 days</span></label>
                            <input type="date" id="quoteValidUntil" required>
                        </div>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="quoteSent" checked>
                        <label for="quoteSent">Mark as sent immediately</label>
                    </div>

                    <div class="form-group">
                        <label for="requiresApproval">Requires Approval?</label>
                        <select id="requiresApproval" onchange="toggleApprovalFields()">
                            <option value="no">No - Direct to customer</option>
                            <option value="yes">Yes - Needs approval</option>
                            <option value="na">N/A</option>
                        </select>
                    </div>

                    <div id="approvalFields" style="display: none;">
                        <div class="form-group">
                            <label for="poNumber">PO Number</label>
                            <input type="text" id="poNumber" placeholder="e.g., TPS002498">
                            <small>Purchase Order number (if applicable)</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeSendQuoteModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Quote</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mark Approved Modal -->
    <div id="markApprovedModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úÖ Mark Quote Approved</h2>
                <button class="btn-close" onclick="closeMarkApprovedModal()">√ó</button>
            </div>
            <form id="markApprovedForm">
                <div class="modal-body">
                    <div class="info-box">
                        <strong id="approvedJobInfo">Job details</strong>
                    </div>

                    <div class="form-group">
                        <label for="approvalStatus">Approval Status *</label>
                        <select id="approvalStatus" required>
                            <option value="">-- Select --</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected/Not Approved</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="approvedPoNumber">PO Number</label>
                        <input type="text" id="approvedPoNumber" placeholder="e.g., TPS002498">
                        <small>Purchase Order number (if provided)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeMarkApprovedModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Complete Work Modal -->
    <div id="completeWorkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úÖ Mark Work Complete</h2>
                <button class="btn-close" onclick="closeCompleteWorkModal()">√ó</button>
            </div>
            <form id="completeWorkForm">
                <div class="modal-body">
                    <div class="info-box">
                        <strong id="completeJobInfo">Job details</strong>
                    </div>

                    <div class="form-group">
                        <label for="completionDate">Completion Date <span class="date-prefill">‚ú® Today</span></label>
                        <input type="date" id="completionDate" required>
                        <small>Pre-filled with today - change if needed</small>
                    </div>

                    <div class="form-group">
                        <label for="jobStatus">Job Status *</label>
                        <select id="jobStatus" required>
                            <option value="complete">Complete</option>
                            <option value="complete-snagging">Complete (minor snagging)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="snaggingItems">Any Snagging Items?</label>
                        <textarea id="snaggingItems" placeholder="List any minor items to fix (optional)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCompleteWorkModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">‚úÖ Mark Complete</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Send Invoice Modal -->
    <div id="sendInvoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìÑ Send Invoice</h2>
                <button class="btn-close" onclick="closeSendInvoiceModal()">√ó</button>
            </div>
            <form id="sendInvoiceForm">
                <div class="modal-body">
                    <div class="info-box">
                        <strong id="invoiceJobInfo">Job details</strong>
                    </div>

                    <div class="form-group">
                        <label for="invoiceNumber">Invoice Number <span class="date-prefill">‚ú® Auto-generated</span></label>
                        <input type="text" id="invoiceNumber" required placeholder="26-XXX">
                        <small>Next available invoice number</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoiceDate">Invoice Date <span class="date-prefill">‚ú® Today</span></label>
                            <input type="date" id="invoiceDate" required>
                        </div>
                        <div class="form-group">
                            <label for="paymentDue">Payment Due <span class="date-prefill">‚ú® +14 days</span></label>
                            <input type="date" id="paymentDue" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="finalAmount">Final Amount (Ex VAT)</label>
                        <input type="number" id="finalAmount" step="0.01" required>
                        <small>Change if different from quote</small>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="invoiceSent" checked>
                        <label for="invoiceSent">Mark as sent immediately</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeSendInvoiceModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Invoice</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mark Paid Modal -->
    <div id="markPaidModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úÖ Mark as Paid</h2>
                <button class="btn-close" onclick="closeMarkPaidModal()">√ó</button>
            </div>
            <form id="markPaidForm">
                <div class="modal-body">
                    <div class="info-box">
                        <strong id="paidJobInfo">Job details</strong>
                    </div>

                    <div class="form-group">
                        <label for="paymentDate">Payment Received Date <span class="date-prefill">‚ú® Today</span></label>
                        <input type="date" id="paymentDate" required>
                    </div>

                    <div class="form-group">
                        <label for="paymentMethod">Payment Method</label>
                        <select id="paymentMethod">
                            <option>Bank Transfer</option>
                            <option>Cash</option>
                            <option>Card</option>
                            <option>Cheque</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeMarkPaidModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">‚úÖ Mark Paid</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Site Modal -->
    <div id="addSiteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Site</h2>
                <button class="btn-close" onclick="closeAddSiteModal()">√ó</button>
            </div>
            
            <form id="addSiteForm">
                <div class="form-group">
                    <label for="siteName">Site Name *</label>
                    <input type="text" id="siteName" required placeholder="e.g., Maidstone Primary School">
                </div>
                
                <div class="form-group">
                    <label for="siteAddress">Address *</label>
                    <input type="text" id="siteAddress" required placeholder="Full address">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="siteContact">Contact Name</label>
                        <input type="text" id="siteContact" placeholder="Site manager">
                    </div>
                    
                    <div class="form-group">
                        <label for="sitePhone">Phone</label>
                        <input type="tel" id="sitePhone" placeholder="01234 567890">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="siteFrequency">Visit Frequency *</label>
                        <select id="siteFrequency" required class="form-group input" style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px;">
                            <option value="7">Weekly (7 days)</option>
                            <option value="14">Fortnightly (14 days)</option>
                            <option value="28">4-Weekly (28 days)</option>
                            <option value="30">Monthly (30 days)</option>
                            <option value="0">Custom Schedule (set dates manually)</option>
                        </select>
                        <small>For Custom: You'll set the next visit date each time you complete a visit</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="sitePrice">Price per Visit *</label>
                        <input type="number" id="sitePrice" required placeholder="0.00" step="0.01" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="siteFirstVisit">First Visit Date *</label>
                    <input type="date" id="siteFirstVisit" required>
                </div>
                
                <div class="form-group">
                    <label for="siteNotes">Notes</label>
                    <textarea id="siteNotes" placeholder="Access codes, special instructions, etc."></textarea>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddSiteModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Add Site</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Complete Visit Modal -->
    <div id="completeVisitModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Complete Visit Worksheet</h2>
                <button class="btn-close" onclick="closeCompleteVisitModal()">√ó</button>
            </div>
            
            <form id="completeVisitForm">
                <input type="hidden" id="completeVisitId">
                
                <div class="alert alert-warning" style="margin-bottom: 1.5rem;">
                    <strong>üì∏ Remember:</strong> Take before/after photos with your phone camera before completing
                </div>
                
                <div class="form-group">
                    <label for="completedBy">Roundwood Operative *</label>
                    <input type="text" id="completedBy" required placeholder="Staff member name">
                </div>

                <div style="background: var(--primary); color: white; padding: 1rem; border-radius: 8px; margin: 1.5rem 0;">
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.125rem;">Work Completed - Tick what applies</h3>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; padding: 1rem; background: white; border: 2px solid var(--gray-300); border-radius: 8px; cursor: pointer; margin-bottom: 0.75rem;">
                        <input type="checkbox" id="weedRemoval" style="width: 20px; height: 20px; margin-right: 1rem;">
                        <div>
                            <strong>Weed removal</strong> to appropriate areas - entrance/exits etc
                        </div>
                    </label>
                    
                    <label style="display: flex; align-items: center; padding: 1rem; background: white; border: 2px solid var(--gray-300); border-radius: 8px; cursor: pointer; margin-bottom: 0.75rem;">
                        <input type="checkbox" id="strimming" style="width: 20px; height: 20px; margin-right: 1rem;">
                        <div>
                            <strong>Strimming</strong> as required to whole site
                        </div>
                    </label>
                    
                    <label style="display: flex; align-items: center; padding: 1rem; background: white; border: 2px solid var(--gray-300); border-radius: 8px; cursor: pointer; margin-bottom: 0.75rem;">
                        <input type="checkbox" id="weedSuppressant" style="width: 20px; height: 20px; margin-right: 1rem;">
                        <div>
                            <strong>Weed suppressant</strong> applied as per map provided (Glyphosate based)
                        </div>
                    </label>
                    
                    <label style="display: flex; align-items: center; padding: 1rem; background: white; border: 2px solid var(--gray-300); border-radius: 8px; cursor: pointer; margin-bottom: 0.75rem;">
                        <input type="checkbox" id="generalTidy" style="width: 20px; height: 20px; margin-right: 1rem;">
                        <div>
                            <strong>General tidy</strong> and rubbish removal
                        </div>
                    </label>

                    <small style="color: var(--gray-500); display: block; margin-top: 0.5rem;">
                        Tick only the tasks that were completed for this visit
                    </small>
                </div>

                <div class="form-group">
                    <label for="siteNotes">Site Notes / Additional Work</label>
                    <textarea id="siteNotes" placeholder="Any additional notes about this visit..." rows="3"></textarea>
                    <small style="color: var(--gray-500); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                        Note: Weed suppressant can take around 4-6 weeks to take effect
                    </small>
                </div>

                <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
                    <h3 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.125rem;">Customer Sign-Off *</h3>
                    
                    <div class="form-group">
                        <label for="customerName">Customer Name *</label>
                        <input type="text" id="customerName" required placeholder="e.g. John Smith">
                    </div>

                    <div class="form-group">
                        <label>Customer Signature *</label>
                        <canvas id="signaturePad" class="signature-pad" width="540" height="200" style="touch-action: none;"></canvas>
                        <div class="signature-controls">
                            <button type="button" class="btn btn-secondary" onclick="clearSignature()">Clear Signature</button>
                        </div>
                        <small style="color: var(--gray-500); font-size: 0.85rem;">Customer must sign above to confirm work completed</small>
                    </div>
                </div>

                <div class="alert alert-info">
                    Completing this visit will:
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li>Save worksheet with customer signature</li>
                        <li>Automatically schedule the next visit</li>
                        <li>Send email notification to finance team</li>
                    </ul>
                    <p style="margin-top: 0.75rem; margin-bottom: 0;">
                        üí° <strong>Tip:</strong> Use the ‚≠ê <strong>Reviews</strong> tab to send review requests later
                    </p>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeCompleteVisitModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-success" style="flex: 1;">‚úì Complete & Generate Worksheet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Visit Modal -->
    <div id="editVisitModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è Edit Visit</h2>
                <button class="btn-close" onclick="closeEditVisitModal()">√ó</button>
            </div>
            
            <form id="editVisitForm">
                <input type="hidden" id="editVisitId">
                
                <div class="form-group">
                    <label for="editScheduledDate">Scheduled Date *</label>
                    <input type="date" id="editScheduledDate" required>
                </div>
                
                <div class="form-group">
                    <label for="editPrice">Price (¬£) *</label>
                    <input type="number" id="editPrice" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="editNotes">Notes</label>
                    <textarea id="editNotes" rows="3" placeholder="Any special notes for this visit..."></textarea>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditVisitModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div id="addProjectModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Add New Project</h2>
                <button class="btn-close" onclick="closeAddProjectModal()">√ó</button>
            </div>
            
            <form id="addProjectForm">
                <div class="form-group">
                    <label for="projectName">Project Name *</label>
                    <input type="text" id="projectName" required placeholder="e.g. Car Park Resurfacing">
                </div>

                <div class="form-group">
                    <label for="projectType">Project Type *</label>
                    <select id="projectType" required>
                        <option value="">-- Select Type --</option>
                        <option value="Landscaping">Landscaping</option>
                        <option value="Paving">Paving</option>
                        <option value="Fencing">Fencing</option>
                        <option value="Tree Work">Tree Work</option>
                        <option value="Groundworks">Groundworks</option>
                        <option value="Artificial Grass">Artificial Grass</option>
                        <option value="Decking">Decking</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="projectClientName">Client Name *</label>
                    <input type="text" id="projectClientName" required placeholder="e.g. John Smith or Station Road Site">
                </div>
                
                <div class="form-group">
                    <label for="projectAddress">Site Address *</label>
                    <input type="text" id="projectAddress" required placeholder="Full address">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="projectContact">Contact Name</label>
                        <input type="text" id="projectContact" placeholder="Site contact">
                    </div>
                    
                    <div class="form-group">
                        <label for="projectPhone">Phone</label>
                        <input type="tel" id="projectPhone" placeholder="01234 567890">
                    </div>
                </div>

                <div class="form-group">
                    <label for="projectEmail">Email</label>
                    <input type="email" id="projectEmail" placeholder="client@example.com">
                </div>

                <div class="form-group">
                    <label for="projectPrice">Project Price *</label>
                    <input type="number" id="projectPrice" required placeholder="0.00" step="0.01" min="0">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="projectStartDate">Start Date *</label>
                        <input type="date" id="projectStartDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="projectExpectedEnd">Expected Completion *</label>
                        <input type="date" id="projectExpectedEnd" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="projectDescription">Project Description / Scope *</label>
                    <textarea id="projectDescription" required placeholder="Describe the work to be completed..." rows="4"></textarea>
                </div>

                <div class="form-group">
                    <label for="projectNotes">Additional Notes</label>
                    <textarea id="projectNotes" placeholder="Any special requirements, access notes, etc..." rows="2"></textarea>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddProjectModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Add Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Complete Project Modal -->
    <div id="completeProjectModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Complete Project</h2>
                <button class="btn-close" onclick="closeCompleteProjectModal()">√ó</button>
            </div>
            
            <form id="completeProjectForm">
                <input type="hidden" id="completeProjectId">
                
                <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                    <strong>üì∏ Remember:</strong> Take before/after photos with your phone before completing
                </div>

                <div class="form-group">
                    <label for="projectCompletedBy">Completed By *</label>
                    <input type="text" id="projectCompletedBy" required placeholder="Staff member name">
                </div>

                <div class="form-group">
                    <label for="projectActualEndDate">Actual Completion Date *</label>
                    <input type="date" id="projectActualEndDate" required>
                </div>
                
                <div class="form-group">
                    <label for="projectCompletionNotes">Completion Notes</label>
                    <textarea id="projectCompletionNotes" placeholder="Any notes about the completed project..." rows="3"></textarea>
                </div>

                <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.125rem;">Customer Sign-Off *</h3>
                    
                    <div class="form-group">
                        <label for="projectCustomerName">Customer Name *</label>
                        <input type="text" id="projectCustomerName" required placeholder="e.g. John Smith">
                    </div>

                    <div class="form-group">
                        <label>Customer Signature *</label>
                        <canvas id="projectSignaturePad" class="signature-pad" width="540" height="200" style="touch-action: none;"></canvas>
                        <div class="signature-controls">
                            <button type="button" class="btn btn-secondary" onclick="clearProjectSignature()">Clear Signature</button>
                        </div>
                        <small style="color: var(--gray-500); font-size: 0.85rem;">Customer must sign above to confirm work completed</small>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    Completing this project will:
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li>Save completion details with customer signature</li>
                        <li>Add to invoice tracking for billing</li>
                        <li>Send email notification to finance team</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeCompleteProjectModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-success" style="flex: 1;">‚úì Complete Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Project Update Modal -->
    <div id="addUpdateModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Add Project Update</h2>
                <button class="btn-close" onclick="closeAddUpdateModal()">√ó</button>
            </div>
            
            <form id="addUpdateForm">
                <input type="hidden" id="updateProjectId">
                
                <div class="form-group">
                    <label for="updateText">Update / Note *</label>
                    <textarea id="updateText" required placeholder="e.g. Awaiting materials - ETA 2 weeks&#10;Revisit in 6 weeks for painting&#10;Client requested color change" rows="4" style="resize: vertical;"></textarea>
                    <small style="color: var(--gray-500); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                        Track progress, delays, client requests, or any important notes
                    </small>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddUpdateModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Add Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Event/Holiday Modal -->
    <div id="addEventModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">üìÖ Add Event / Holiday</h2>
                <button class="btn-close" onclick="closeAddEventModal()">√ó</button>
            </div>
            
            <form id="addEventForm">
                <div class="form-group">
                    <label for="eventTitle">Event Title *</label>
                    <input type="text" id="eventTitle" required placeholder="e.g. Ben's Holiday, Christmas Day, Training">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="eventStartDate">Start Date *</label>
                        <input type="date" id="eventStartDate" required>
                    </div>
                    <div class="form-group">
                        <label for="eventEndDate">End Date *</label>
                        <input type="date" id="eventEndDate" required>
                        <small>Same as start for single day</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="eventType">Event Type *</label>
                    <select id="eventType" required>
                        <option value="holiday">üèñÔ∏è Holiday / Time Off</option>
                        <option value="bankholiday">üéÑ Bank Holiday</option>
                        <option value="office">üè¢ Office Event</option>
                        <option value="reminder">‚ÑπÔ∏è Reminder</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="eventNotes">Notes (Optional)</label>
                    <textarea id="eventNotes" rows="2" placeholder="Additional details..."></textarea>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddEventModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Add Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Event Modal -->
    <div id="editEventModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è Edit Event</h2>
                <button class="btn-close" onclick="closeEditEventModal()">√ó</button>
            </div>
            
            <form id="editEventForm">
                <input type="hidden" id="editEventId">
                
                <div class="form-group">
                    <label for="editEventTitle">Event Title *</label>
                    <input type="text" id="editEventTitle" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="editEventStartDate">Start Date *</label>
                        <input type="date" id="editEventStartDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editEventEndDate">End Date *</label>
                        <input type="date" id="editEventEndDate" required>
                        <small>Same as start for single day</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editEventType">Event Type *</label>
                    <select id="editEventType" required>
                        <option value="holiday">üèñÔ∏è Holiday / Time Off</option>
                        <option value="bankholiday">üéÑ Bank Holiday</option>
                        <option value="office">üè¢ Office Event</option>
                        <option value="reminder">‚ÑπÔ∏è Reminder</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editEventNotes">Notes</label>
                    <textarea id="editEventNotes" rows="2"></textarea>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-danger" onclick="deleteEvent()" style="flex: 0.5;">üóëÔ∏è Delete</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditEventModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Pipeline Job Modal -->
    <div id="editPipelineJobModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è Edit Pipeline Job</h2>
                <button class="btn-close" onclick="closeEditPipelineJobModal()">√ó</button>
            </div>
            
            <form id="editPipelineJobForm">
                <input type="hidden" id="editPipelineJobId">
                <input type="hidden" id="editPipelineJobStage">
                
                <div class="form-group">
                    <label for="editPipelineCustomerName">Customer Name *</label>
                    <input type="text" id="editPipelineCustomerName" required>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="editPipelineCustomerPhone">Customer Phone</label>
                        <input type="tel" id="editPipelineCustomerPhone" placeholder="e.g., 01234 567890">
                    </div>
                    <div class="form-group">
                        <label for="editPipelineCustomerEmail">Customer Email</label>
                        <input type="email" id="editPipelineCustomerEmail" placeholder="e.g., customer@email.com">
                    </div>
                </div>

                <div class="form-group">
                    <label for="editPipelineResponsiblePerson">Responsible Person</label>
                    <select id="editPipelineResponsiblePerson">
                        <option value="">Not assigned</option>
                        <option value="Ben">Ben</option>
                        <option value="Ricky">Ricky</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editPipelineJobDescription">Job Description *</label>
                    <textarea id="editPipelineJobDescription" required placeholder="e.g., Install new fencing around playground"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="editPipelineProjectType">Project Type *</label>
                        <select id="editPipelineProjectType" required>
                            <option value="">Select type...</option>
                            <option>Landscaping</option>
                            <option>Fencing</option>
                            <option>Decking</option>
                            <option>Paving</option>
                            <option>Weed Control</option>
                            <option>Tree Work</option>
                            <option>Maintenance Contract</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editPipelineEstimatedValue">Estimated Value (¬£)</label>
                        <input type="number" id="editPipelineEstimatedValue" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <!-- Quote Deadline - shown for New Lead & Quote Sent stages -->
                    <div class="form-group" id="editQuoteDeadlineField">
                        <label for="editPipelineQuoteDeadline">Quote Deadline</label>
                        <input type="date" id="editPipelineQuoteDeadline">
                        <small>When you need to send quote by</small>
                    </div>
                    <!-- Start Date - shown for Approved onwards -->
                    <div class="form-group" id="editStartDateField" style="display: none;">
                        <label for="editPipelineStartDate">Start Date</label>
                        <input type="date" id="editPipelineStartDate">
                        <small>When work started/will start</small>
                    </div>
                    <div class="form-group">
                        <label for="editPipelineEstimatedEndDate">Estimated End Date</label>
                        <input type="date" id="editPipelineEstimatedEndDate">
                        <small>For multi-day projects</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editPipelineNotes">Notes</label>
                    <textarea id="editPipelineNotes" placeholder="Any additional notes..."></textarea>
                </div>

                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditPipelineJobModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getDatabase, 
            ref, 
            set, 
            get, 
            update, 
            remove, 
            onValue,
            push,
            query,
            orderByChild,
            equalTo
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDiARsn-HBhwuHuWjmeAB9ntRxyd4FSR-E",
            authDomain: "roundwood-manager.firebaseapp.com",
            databaseURL: "https://roundwood-manager-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "roundwood-manager",
            storageBucket: "roundwood-manager.firebasestorage.app",
            messagingSenderId: "1064499324684",
            appId: "1:1064499324684:web:c974e276f5b86092bbcb29"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Make functions globally available
        window.auth = auth;
        window.database = database;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.dbUpdate = update;
        window.dbRemove = remove;
        window.dbOnValue = onValue;
        window.dbPush = push;
        window.dbQuery = query;
        window.dbOrderByChild = orderByChild;
        window.dbEqualTo = equalTo;

        // Google Drive API Configuration
        const GOOGLE_API_KEY = 'YOUR_GOOGLE_API_KEY_HERE'; // SECURITY: Add your key locally only - DO NOT commit to GitHub!
        const GOOGLE_CLIENT_ID = '1064499324684-uhn2u0okn82psh87j7v0jvf5mjvbhq5s.apps.googleusercontent.com';
        const GOOGLE_DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        let gapiLoaded = false;
        let googleAuth = null;

        // Initialize Google API
        function initGoogleAPI() {
            // Check if gapi is loaded
            if (typeof gapi === 'undefined') {
                console.warn('Google API not loaded yet. Retrying in 1 second...');
                setTimeout(initGoogleAPI, 1000);
                return;
            }

            gapi.load('client:auth2', async () => {
                try {
                    await gapi.client.init({
                        apiKey: GOOGLE_API_KEY,
                        clientId: GOOGLE_CLIENT_ID,
                        discoveryDocs: GOOGLE_DISCOVERY_DOCS,
                        scope: GOOGLE_SCOPES
                    });
                    googleAuth = gapi.auth2.getAuthInstance();
                    gapiLoaded = true;
                    console.log('‚úÖ Google Drive API initialized successfully');
                } catch (error) {
                    console.error('‚ùå Error initializing Google API:', error);
                    console.log('Note: This is normal if you haven\'t configured OAuth consent screen yet');
                }
            });
        }

        // Export data to Google Drive
        async function exportToGoogleDrive() {
            if (!gapiLoaded) {
                alert('‚ö†Ô∏è Google Drive Export Not Configured\n\nThis feature requires OAuth setup:\n1. Complete OAuth consent screen in Google Cloud Console\n2. Verify redirect URIs are set\n3. Uncomment initGoogleAPI() in the code\n\nFor now, your data is safely stored in Firebase.');
                console.log('üí° To enable Google Drive export, complete OAuth setup and uncomment initGoogleAPI()');
                return;
            }

            try {
                // Sign in if not already signed in
                if (!googleAuth.isSignedIn.get()) {
                    await googleAuth.signIn();
                }

                // Get all data
                const userId = window.auth.currentUser.uid;
                const snapshot = await window.dbGet(window.dbRef(window.database, `users/${userId}`));
                const allData = snapshot.val();

                // Create formatted export data
                const exportData = {
                    exportDate: new Date().toISOString(),
                    pipeline: allData.pipelineJobs || {},
                    sites: allData.sites || {},
                    projects: allData.projects || {},
                    visits: allData.visits || {},
                    reviews: allData.reviews || {}
                };

                // Convert to JSON
                const jsonContent = JSON.stringify(exportData, null, 2);
                const fileName = `Roundwood-Backup-${new Date().toISOString().split('T')[0]}.json`;

                // Create file metadata
                const fileMetadata = {
                    name: fileName,
                    mimeType: 'application/json'
                };

                // Create file content
                const fileContent = new Blob([jsonContent], { type: 'application/json' });

                // Upload to Google Drive
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
                form.append('file', fileContent);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + gapi.auth.getToken().access_token
                    },
                    body: form
                });

                if (response.ok) {
                    alert(`‚úÖ Data exported successfully to Google Drive!\nFile: ${fileName}`);
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå Failed to export to Google Drive. Please try again.');
            }
        }

        // Make Google Drive functions available globally
        window.initGoogleAPI = initGoogleAPI;
        window.exportToGoogleDrive = exportToGoogleDrive;

        // Define essential UI functions immediately (before auth listener)
        window.toggleSection = function(header) {
            const section = header.closest('.collapsible-section');
            const arrow = header.querySelector('.collapsible-arrow');
            
            section.classList.toggle('open');
            
            if (section.classList.contains('open')) {
                if (arrow) arrow.textContent = '‚ñ≤';
            } else {
                if (arrow) arrow.textContent = '‚ñº';
            }
        };

        window.showTab = (tabName) => {
            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-tabs > button').forEach(item => {
                item.classList.remove('active');
            });
            
            // Remove active class from dropdown toggle
            document.querySelectorAll('.dropdown-toggle').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Check if this tab is in the Tools dropdown
            const toolsTabs = ['sites', 'history', 'calculator'];
            if (toolsTabs.includes(tabName)) {
                // Make Tools dropdown active
                const dropdownToggle = document.querySelector('.dropdown-toggle');
                if (dropdownToggle) {
                    dropdownToggle.classList.add('active');
                }
            } else {
                // Add active class to clicked nav item
                const selectedNav = document.querySelector(`.nav-tabs > button[onclick="showTab('${tabName}')"]`);
                if (selectedNav) {
                    selectedNav.classList.add('active');
                }
            }
            
            // Load tab-specific data
            if (tabName === 'sites') {
                if (typeof renderSites === 'function') renderSites();
            } else if (tabName === 'dashboard') {
                if (typeof renderUpcomingVisits === 'function') renderUpcomingVisits();
                if (typeof renderInvoiceTracking === 'function') renderInvoiceTracking();
            } else if (tabName === 'projects') {
                if (typeof renderProjects === 'function') renderProjects();
            } else if (tabName === 'upcomingVisits') {
                if (typeof renderAllUpcomingVisits === 'function') renderAllUpcomingVisits();
            } else if (tabName === 'invoiceTracking') {
                if (typeof renderFullInvoiceTracking === 'function') renderFullInvoiceTracking();
            } else if (tabName === 'pipeline') {
                if (typeof renderPipeline === 'function') renderPipeline();
            }
        };

        window.loadAppData = async function() {
            if (!window.currentUser) return;
            
            console.log('Loading ALL data (shared across all users)');
            // Everyone sees all data - simple team sharing
            loadAllUsersData();
        };
        
        // Load data from ALL users (everyone sees everything)
        function loadAllUsersData() {
            // Load ALL users' sites
            const allUsersRef = window.dbRef(window.database, 'users');
            window.dbOnValue(allUsersRef, (snapshot) => {
                window.sites = [];
                window.visits = [];
                window.projects = [];
                window.pipelineJobs = [];
                window.calendarEvents = [];
                
                snapshot.forEach((userSnapshot) => {
                    const userId = userSnapshot.key;
                    
                    // Sites
                    const sitesData = userSnapshot.child('sites').val();
                    if (sitesData) {
                        Object.keys(sitesData).forEach(siteId => {
                            window.sites.push({
                                id: siteId,
                                userId: userId,
                                ...sitesData[siteId]
                            });
                        });
                    }
                    
                    // Visits
                    const visitsData = userSnapshot.child('visits').val();
                    if (visitsData) {
                        Object.keys(visitsData).forEach(visitId => {
                            window.visits.push({
                                id: visitId,
                                userId: userId,
                                ...visitsData[visitId]
                            });
                        });
                    }
                    
                    // Projects
                    const projectsData = userSnapshot.child('projects').val();
                    if (projectsData) {
                        Object.keys(projectsData).forEach(projectId => {
                            window.projects.push({
                                id: projectId,
                                userId: userId,
                                ...projectsData[projectId]
                            });
                        });
                    }
                    
                    // Pipeline Jobs
                    const pipelineData = userSnapshot.child('pipelineJobs').val();
                    if (pipelineData) {
                        Object.keys(pipelineData).forEach(jobId => {
                            window.pipelineJobs.push({
                                id: jobId,
                                userId: userId,
                                ...pipelineData[jobId]
                            });
                        });
                    }
                    
                    // Calendar Events
                    const eventsData = userSnapshot.child('calendarEvents').val();
                    if (eventsData) {
                        Object.keys(eventsData).forEach(eventId => {
                            window.calendarEvents.push({
                                id: eventId,
                                userId: userId,
                                ...eventsData[eventId]
                            });
                        });
                    }
                });
                
                console.log('Loaded ALL data (admin):', {
                    sites: window.sites.length,
                    visits: window.visits.length,
                    projects: window.projects.length,
                    pipelineJobs: window.pipelineJobs.length,
                    calendarEvents: window.calendarEvents.length
                });
                
                // Render everything
                if (typeof renderSites === 'function') renderSites();
                if (typeof renderVisits === 'function') renderVisits();
                if (typeof renderProjects === 'function') renderProjects();
                if (typeof renderPipeline === 'function') renderPipeline();
                if (typeof renderInvoices === 'function') renderInvoices();
                if (typeof renderHistory === 'function') renderHistory();
                if (typeof updateStats === 'function') updateStats();
                if (typeof renderCalendar === 'function') renderCalendar();
            });
        }
            
            // Load review history and saved calculations
            if (typeof loadReviewHistory === 'function') loadReviewHistory();
            if (typeof loadSavedCalculations === 'function') loadSavedCalculations();
        };

        // Auth State Listener
        onAuthStateChanged(auth, (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');

            if (user) {
                // User is logged in
                document.getElementById('userEmail').textContent = user.email;
                loadingScreen.style.display = 'none';
                loginScreen.style.display = 'none';
                mainApp.style.display = 'flex';
                
                // Initialize app data
                window.currentUser = user;
                
                // Initialize Google Drive API (disabled until OAuth fully configured)
                // Uncomment this line after completing OAuth consent screen setup
                // initGoogleAPI();
                
                // Load data immediately (functions are now defined)
                loadAppData();
                
                // Wait briefly for render functions to be defined
                setTimeout(() => {
                    if (typeof renderSeasonalTips === 'function') renderSeasonalTips();
                    if (typeof renderMonthlyUpsells === 'function') renderMonthlyUpsells();
                    // Update Tools dropdown menu items
                    if (typeof updateAutoBackupButton === 'function') updateAutoBackupButton();
                    if (typeof updateGoogleDriveStatus === 'function') updateGoogleDriveStatus();
                }, 50);
            } else {
                // User is logged out
                loadingScreen.style.display = 'none';
                loginScreen.style.display = 'flex';
                mainApp.style.display = 'none';
            }
        });

        // Login Handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        });

        // Register Handlers
        document.getElementById('showRegisterBtn').addEventListener('click', () => {
            document.getElementById('registerModal').classList.add('active');
        });

        window.closeRegisterModal = () => {
            document.getElementById('registerModal').classList.remove('active');
            document.getElementById('registerForm').reset();
            document.getElementById('registerError').style.display = 'none';
        };

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerConfirm').value;
            const errorDiv = document.getElementById('registerError');

            if (password !== confirm) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                closeRegisterModal();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        });

        // Logout
        window.logout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        console.log('Firebase initialized successfully');
    </script>

    <script>
        // Send Invoice Request Email using mailto
        function sendInvoiceEmail(visit) {
            const emailSubject = `Invoice Required: ${visit.siteName} - Completed ${visit.completedDate}`;
            
            // Format work completed checklist
            const workList = [];
            if (visit.workCompleted) {
                if (visit.workCompleted.weedRemoval) workList.push('‚úì Weed removal to appropriate areas');
                if (visit.workCompleted.strimming) workList.push('‚úì Strimming as required to whole site');
                if (visit.workCompleted.weedSuppressant) workList.push('‚úì Weed suppressant applied (Glyphosate based)');
                if (visit.workCompleted.generalTidy) workList.push('‚úì General tidy and rubbish removal');
            }
            
            const emailBody = `
Visit Completion Worksheet
====================================

Site Information:
- Site Name: ${visit.siteName}
- Address: ${visit.siteAddress}

Work Details:
- Completed By: ${visit.completedBy}
- Completed On: ${new Date(visit.completedDate).toLocaleDateString('en-GB')}
- Invoice Amount: ¬£${visit.price.toFixed(2)}

Work Completed:
${workList.length > 0 ? workList.join('\n') : 'No tasks recorded'}

${visit.siteNotes ? `Site Notes / Additional Work:\n${visit.siteNotes}\n` : ''}
Customer Sign-Off:
- Customer Name: ${visit.customerName}
- Signature: Captured digitally (view in app History tab)

REMINDER: 
- Field staff should have before/after photos on their phone
- Customer signature captured digitally
- Work completion confirmed

Please prepare and send invoice to the customer.

---
This notification was generated automatically by Roundwood Route Manager.
            `.trim();

            // Create mailto link
            const mailto = `mailto:office@roundwoodsolutions.co.uk?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
            
            // Open email client
            window.location.href = mailto;
        }

        // Toggle Collapsible Sections
        // App State (initialize on window for global access)
        window.sites = [];
        window.visits = [];
        window.projects = [];
        window.pipelineJobs = [];
        let sites = window.sites;
        let visits = window.visits;
        let projects = window.projects;
        let pipelineJobs = window.pipelineJobs;
        let projectSignaturePad = null;

        // Seasonal Tips and Upsells Data
        const monthlyContent = {
            1: { // January
                tips: [
                    "üå≥ <strong>Prune fruit trees</strong> - Perfect time while trees are dormant. Remove dead, diseased, or crossing branches.",
                    "‚ùÑÔ∏è <strong>Winter damage checks</strong> - Inspect sites for frost damage, broken branches, and waterlogging issues.",
                    "üçÇ <strong>Clear debris</strong> - Remove remaining autumn leaves and debris to prevent disease and drainage problems."
                ],
                upsells: [
                    "üå≤ <strong>Tree pruning service</strong> - Offer winter pruning for fruit trees and ornamentals while dormant.",
                    "üíß <strong>Drainage solutions</strong> - Identify waterlogged areas and offer drainage improvement services."
                ]
            },
            2: { // February
                tips: [
                    "üå± <strong>Early weed control</strong> - Start treating perennial weeds before they establish. More effective now.",
                    "üå≥ <strong>Complete winter pruning</strong> - Last chance for major pruning before sap rises in March.",
                    "üîç <strong>Site audits</strong> - Perfect time to walk sites and plan spring work programmes with clients."
                ],
                upsells: [
                    "‚ùÑÔ∏è <strong>Winter tree pruning</strong> - February is the last month for dormant season pruning. Quote for fruit trees, roses, and deciduous shrubs before sap rises.",
                    "üåø <strong>Early weed treatment</strong> - Treat perennial weeds NOW while they're small and weak. February treatments are more effective than waiting until spring."
                ]
            },
            3: { // March
                tips: [
                    "üå± <strong>Spring growth begins</strong> - Increase visit frequency as grass starts growing actively.",
                    "‚úÇÔ∏è <strong>First cuts of season</strong> - Set mowers high for first cuts, don't scalp the grass.",
                    "üåø <strong>Feed applications</strong> - Apply spring fertilizer to boost growth and green-up lawns."
                ],
                upsells: [
                    "üíö <strong>Spring fertilizer treatments</strong> - Offer professional feed applications for healthier lawns.",
                    "üå∑ <strong>Summer bedding installation</strong> - Quote for installing colorful summer displays - book now for May planting."
                ]
            },
            4: { // April
                tips: [
                    "üå± <strong>Weekly cuts resume</strong> - Grass growing strongly now, ensure teams are keeping to schedules.",
                    "üå∏ <strong>Weed control peak time</strong> - Most effective month for treating broad-leaved weeds in grass.",
                    "üí¶ <strong>Check irrigation</strong> - Test and commission irrigation systems before hot weather arrives."
                ],
                upsells: [
                    "üåø <strong>Selective weed treatments</strong> - Offer targeted weed control programs for lawns and beds.",
                    "üíß <strong>Irrigation maintenance</strong> - Propose irrigation system checks and repairs before summer."
                ]
            },
            5: { // May
                tips: [
                    "‚úÇÔ∏è <strong>Peak cutting season</strong> - Busiest time of year, ensure equipment is maintained and teams are productive.",
                    "üå∫ <strong>Bedding plants</strong> - Install summer displays and hanging baskets for commercial sites.",
                    "üêõ <strong>Pest monitoring</strong> - Watch for aphids, caterpillars, and other spring pests."
                ],
                upsells: [
                    "üåª <strong>Summer displays</strong> - Offer vibrant bedding plant installations and maintenance packages.",
                    "ü¶ü <strong>Pest control services</strong> - Propose integrated pest management programs."
                ]
            },
            6: { // June
                tips: [
                    "‚òÄÔ∏è <strong>Drought watch</strong> - Monitor grass and plants closely, advise clients on irrigation needs.",
                    "üåø <strong>Hedge cutting begins</strong> - Start formal hedge trimming after bird nesting season (check first!).",
                    "üíê <strong>Deadheading</strong> - Regular deadheading keeps displays looking fresh all summer."
                ],
                upsells: [
                    "‚úÇÔ∏è <strong>Hedge trimming services</strong> - Offer professional hedge cutting and shaping packages.",
                    "üí¶ <strong>Drought management</strong> - Propose temporary irrigation or drought-tolerant planting solutions."
                ]
            },
            7: { // July
                tips: [
                    "üåû <strong>Heat stress management</strong> - Raise cutting heights, mow early morning or evening to reduce stress.",
                    "üíß <strong>Irrigation critical</strong> - Ensure irrigation systems are working efficiently during peak demand.",
                    "üåæ <strong>Holiday cover</strong> - Plan staff rotas carefully to maintain service during holiday season."
                ],
                upsells: [
                    "üåø <strong>Book autumn renovation now</strong> - Pre-sell scarifying, aerating, and overseeding packages for September. Early booking discounts available.",
                    "üí¶ <strong>Water management services</strong> - Offer irrigation monitoring and water-saving solutions."
                ]
            },
            8: { // August
                tips: [
                    "üçÇ <strong>Plan autumn work</strong> - Start discussing and quoting autumn renovation projects with clients.",
                    "üå± <strong>Overseed preparation</strong> - Identify thin or damaged turf that will need autumn overseeding.",
                    "‚òÄÔ∏è <strong>Continue heat precautions</strong> - Keep cutting heights up, don't stress grass in dry spells."
                ],
                upsells: [
                    "üåæ <strong>Autumn renovation bookings</strong> - Scarifying removes thatch, aeration relieves compaction, overseeding thickens turf. Package all three for September.",
                    "üå≥ <strong>Tree health surveys</strong> - Professional tree inspections identify disease, decay, and hazards before winter storms."
                ]
            },
            9: { // September
                tips: [
                    "üçÇ <strong>Autumn renovation peak</strong> - Perfect conditions for scarifying, aerating, and overseeding.",
                    "üå± <strong>Autumn feeding</strong> - Apply autumn fertilizer with slow-release nitrogen for winter hardiness.",
                    "üíß <strong>Reduce irrigation</strong> - Scale back watering as temperatures drop and rain increases."
                ],
                upsells: [
                    "üçÇ <strong>Gutter clearing contracts</strong> - Prevent blockages and water damage. Quote for October/November monthly gutter clears.",
                    "üåø <strong>Lawn renovation final push</strong> - Last chance this year! Scarify dead thatch, aerate compacted soil, overseed thin patches."
                ]
            },
            10: { // October
                tips: [
                    "üçÇ <strong>Leaf clearance begins</strong> - Start regular leaf blowing and removal programs.",
                    "‚úÇÔ∏è <strong>Final cuts</strong> - Reduce cutting frequency as growth slows, set mowers higher.",
                    "üå≥ <strong>Tree inspection</strong> - Check trees for damage or disease before winter storms."
                ],
                upsells: [
                    "üçÅ <strong>Leaf clearance contracts</strong> - Offer weekly leaf clearing services for remainder of autumn.",
                    "üå≤ <strong>Winter plant protection</strong> - Propose wrapping and protection services for tender plants."
                ]
            },
            11: { // November
                tips: [
                    "üçÇ <strong>Leaf clearance priority</strong> - Peak leaf fall month, stay on top of clearing schedules.",
                    "‚ùÑÔ∏è <strong>Winter prep</strong> - Clear gutters, check drains, prepare sites for winter weather.",
                    "üå≥ <strong>Tree works</strong> - Begin tree surgery and major pruning work in earnest."
                ],
                upsells: [
                    "üéÑ <strong>Christmas displays</strong> - Offer festive planting and decoration services for commercial sites.",
                    "‚ùÑÔ∏è <strong>Winter gritting</strong> - Propose path and car park gritting contracts."
                ]
            },
            12: { // December
                tips: [
                    "üéÑ <strong>Festive displays</strong> - Install and maintain Christmas planters and decorations.",
                    "‚ùÑÔ∏è <strong>Weather watch</strong> - Monitor forecasts, be ready for snow/ice response if contracted.",
                    "üìã <strong>Year planning</strong> - Review year with clients, plan contracts and pricing for next season."
                ],
                upsells: [
                    "üìÖ <strong>Renew 2026 contracts now</strong> - Secure next year's business. Offer multi-year discounts or frequency increases for contract renewals.",
                    "üå≤ <strong>Bare-root tree planting</strong> - Winter is ideal for planting dormant bare-root trees. Quote for January/February planting projects."
                ]
            }
        };

        // Render Seasonal Tips
        function renderSeasonalTips() {
            const month = new Date().getMonth() + 1; // 1-12
            const content = monthlyContent[month];
            const container = document.getElementById('seasonalTips');
            
            if (!container) {
                console.error('seasonalTips container not found');
                return;
            }
            
            if (!content) {
                console.error('No content for month:', month);
                return;
            }
            
            console.log('Rendering tips for month:', month, content.tips);
            
            container.innerHTML = content.tips.map(tip => 
                `<div style="padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.75rem; border-left: 3px solid var(--success);">
                    ${tip}
                </div>`
            ).join('');
        }

        // Render Monthly Upsells
        function renderMonthlyUpsells() {
            const currentMonth = new Date().getMonth() + 1; // 1-12
            const nextMonth = currentMonth === 12 ? 1 : currentMonth + 1;
            const content = monthlyContent[nextMonth];
            const container = document.getElementById('monthlyUpsells');
            
            if (!container) {
                console.error('monthlyUpsells container not found');
                return;
            }
            
            if (!content) {
                console.error('No content for next month:', nextMonth);
                return;
            }
            
            console.log('Rendering upsells for next month:', nextMonth, content.upsells);
            
            const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            container.innerHTML = `
                <p style="margin-bottom: 1rem; font-weight: 500;">For ${monthNames[nextMonth]}:</p>
                ${content.upsells.map(upsell => 
                    `<div style="padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.75rem; border-left: 3px solid #3b82f6;">
                        ${upsell}
                    </div>`
                ).join('')}
            `;
        }

        // Load App Data
        async function loadAppData() {
            const userId = window.currentUser.uid;
            console.log('Loading data for user:', userId);
            
            // Listen to sites
            const sitesRef = window.dbRef(window.database, `users/${userId}/sites`);
            window.dbOnValue(sitesRef, (snapshot) => {
                sites = [];
                snapshot.forEach((childSnapshot) => {
                    sites.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                console.log('Loaded sites:', window.sites.length);
                renderSites();
                updateStats();
                if (typeof renderCalendar === 'function') renderCalendar();
            });

            // Listen to visits
            const visitsRef = window.dbRef(window.database, `users/${userId}/visits`);
            window.dbOnValue(visitsRef, (snapshot) => {
                visits = [];
                snapshot.forEach((childSnapshot) => {
                    visits.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                console.log('Loaded visits:', window.visits.length);
                renderVisits();
                renderInvoices();
                renderHistory();
                updateStats();
                if (typeof renderCalendar === 'function') renderCalendar();
            });

            // Listen to projects
            const projectsRef = window.dbRef(window.database, `users/${userId}/projects`);
            window.dbOnValue(projectsRef, (snapshot) => {
                projects = [];
                snapshot.forEach((childSnapshot) => {
                    projects.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                console.log('Loaded projects:', window.projects.length);
                renderProjects();
                updateStats();
            });
            
            // Load review history and saved calculations
            loadReviewHistory();
            loadSavedCalculations();
        }

        // Add Site Modal
        window.openAddSiteModal = () => {
            document.getElementById('addSiteModal').classList.add('active');
            // Set default first visit to today
            document.getElementById('siteFirstVisit').valueAsDate = new Date();
        };

        // Track if we're editing a site
        let editingSiteId = null;

        window.closeAddSiteModal = () => {
            document.getElementById('addSiteModal').classList.remove('active');
            document.getElementById('addSiteForm').reset();
            editingSiteId = null; // Clear edit mode
            
            // Reset button text
            const submitBtn = document.querySelector('#addSiteForm button[type="submit"]');
            if (submitBtn) submitBtn.textContent = 'Add Site';
            
            // Reset title
            const titleElement = document.querySelector('#addSiteModal .modal-title');
            if (titleElement) titleElement.textContent = '+ Add New Site';
        };

        // Add/Update Site Handler
        document.getElementById('addSiteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const siteData = {
                name: document.getElementById('siteName').value,
                address: document.getElementById('siteAddress').value,
                contact: document.getElementById('siteContact').value,
                phone: document.getElementById('sitePhone').value,
                frequency: parseInt(document.getElementById('siteFrequency').value),
                price: parseFloat(document.getElementById('sitePrice').value),
                notes: document.getElementById('siteNotes').value
            };

            try {
                const userId = window.currentUser.uid;
                
                if (editingSiteId) {
                    // UPDATE existing site
                    await window.dbUpdate(window.dbRef(window.database, `users/${userId}/sites/${editingSiteId}`), siteData);

                    // Update all pending visits for this site
                    const siteVisits = window.visits.filter(v => v.siteId === editingSiteId && v.status === 'pending');
                    for (const visit of siteVisits) {
                        await window.dbUpdate(window.dbRef(window.database, `users/${userId}/visits/${visit.id}`), {
                            siteName: siteData.name,
                            siteAddress: siteData.address,
                            price: siteData.price,
                            frequency: siteData.frequency
                        });
                    }

                    alert('‚úÖ Site updated successfully!');
                    closeAddSiteModal();
                } else {
                    // ADD new site
                    siteData.firstVisit = document.getElementById('siteFirstVisit').value;
                    siteData.createdAt = new Date().toISOString();
                    
                    const siteRef = window.dbPush(window.dbRef(window.database, `users/${userId}/sites`));
                    await window.dbSet(siteRef, siteData);

                    // Create first visit
                    const visitData = {
                        siteId: siteRef.key,
                        siteName: siteData.name,
                        siteAddress: siteData.address,
                        scheduledDate: siteData.firstVisit,
                        price: siteData.price,
                        frequency: siteData.frequency,
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    };

                    const visitRef = window.dbPush(window.dbRef(window.database, `users/${userId}/visits`));
                    await window.dbSet(visitRef, visitData);

                    alert('‚úÖ Site added successfully!');
                    closeAddSiteModal();
                }
            } catch (error) {
                console.error('Error saving site:', error);
                alert('Error saving site. Please try again.');
            }
        });

        // ========================================
        // PIPELINE RENDERING
        // ========================================

        // Render Pipeline Jobs
        function renderPipeline() {
            if (!window.pipelineJobs) {
                console.error('pipelineJobs not initialized');
                return;
            }

            console.log('Rendering pipeline with', window.pipelineJobs.length, 'jobs');

            // Stage mapping
            const stages = {
                newLead: { container: 'newLeadsContainer', count: 'newLeadsCount', empty: 'No new leads' },
                quoteSent: { container: 'quotesSentContainer', count: 'quotesSentCount', empty: 'No quotes sent' },
                approved: { container: 'approvedContainer', count: 'approvedCount', empty: 'No approved quotes' },
                inProgress: { container: 'inProgressContainer', count: 'inProgressCount', empty: 'No work in progress' },
                complete: { container: 'completeContainer', count: 'completeCount', empty: 'No completed work awaiting invoice' },
                invoiced: { container: 'invoicedContainer', count: 'invoicedCount', empty: 'No invoices awaiting payment' },
                paid: { container: 'paidContainer', count: 'paidCount', empty: 'No completed & paid jobs yet' }
            };

            // Group jobs by stage
            const jobsByStage = {};
            Object.keys(stages).forEach(stage => {
                jobsByStage[stage] = window.pipelineJobs.filter(job => job.stage === stage);
            });

            // Render each stage
            Object.entries(stages).forEach(([stage, config]) => {
                const container = document.getElementById(config.container);
                const countBadge = document.getElementById(config.count);
                
                if (!container) return;

                const jobs = jobsByStage[stage];
                
                // Update count
                if (countBadge) {
                    countBadge.textContent = jobs.length;
                }

                // Render jobs or empty state
                if (jobs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">üìã</div>
                            <div class="empty-state-text">${config.empty}</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = jobs.map(job => createPipelineJobCard(job, stage)).join('');
                }
            });

            // Update pipeline badge in nav
            const pipelineBadge = document.getElementById('pipelineCount');
            if (pipelineBadge) {
                pipelineBadge.textContent = window.pipelineJobs.length;
            }
        }

        // Create pipeline job card HTML
        function createPipelineJobCard(job, stage) {
            // Show quoted price if available (from quote sent onwards), otherwise estimated value
            let value = 'No value set';
            let priceLabel = '';
            
            if (job.quotedPrice) {
                value = `¬£${job.quotedPrice.toLocaleString()}`;
                priceLabel = '<span style="font-size: 0.75rem; color: var(--gray-500); display: block;">Quoted</span>';
            } else if (job.estimatedValue) {
                value = `¬£${job.estimatedValue.toLocaleString()}`;
                priceLabel = '<span style="font-size: 0.75rem; color: var(--gray-500); display: block;">Estimated</span>';
            }
            
            // Stage-specific actions
            let actions = '';
            let reviewSection = '';
            
            if (stage === 'newLead') {
                actions = `
                    <button class="btn btn-small btn-primary" onclick="markAsQuoteSent('${job.id}')">Mark as Quote Sent</button>
                    <button class="btn btn-small" onclick="editPipelineJob('${job.id}')" style="background: #f3f4f6; color: #374151;">‚úèÔ∏è Edit</button>
                    <button class="btn btn-small btn-danger" onclick="deletePipelineJob('${job.id}')">üóëÔ∏è Delete</button>
                `;
            } else if (stage === 'quoteSent') {
                actions = `
                    <button class="btn btn-small btn-success" onclick="markAsApproved('${job.id}')">Mark as Approved</button>
                    <button class="btn btn-small" onclick="editPipelineJob('${job.id}')" style="background: #f3f4f6; color: #374151;">‚úèÔ∏è Edit</button>
                    <button class="btn btn-small btn-secondary" onclick="moveBackToNewLead('${job.id}')">‚Üê Move Back to New Leads</button>
                `;
            } else if (stage === 'approved') {
                actions = `
                    <button class="btn btn-small btn-primary" onclick="scheduleWork('${job.id}')">Schedule Work</button>
                    <button class="btn btn-small" onclick="editPipelineJob('${job.id}')" style="background: #f3f4f6; color: #374151;">‚úèÔ∏è Edit</button>
                    <button class="btn btn-small btn-secondary" onclick="moveBackToQuoteSent('${job.id}')">‚Üê Move Back to Quote Sent</button>
                `;
            } else if (stage === 'inProgress') {
                actions = `
                    <button class="btn btn-small btn-success" onclick="markAsComplete('${job.id}')">Mark Complete</button>
                    <button class="btn btn-small" onclick="editPipelineJob('${job.id}')" style="background: #f3f4f6; color: #374151;">‚úèÔ∏è Edit</button>
                    <button class="btn btn-small btn-secondary" onclick="moveBackToApproved('${job.id}')">‚Üê Move Back to Approved</button>
                `;
            } else if (stage === 'complete') {
                actions = `
                    <button class="btn btn-small btn-primary" onclick="sendInvoice('${job.id}')">Send Invoice</button>
                    <button class="btn btn-small" onclick="editPipelineJob('${job.id}')" style="background: #f3f4f6; color: #374151;">‚úèÔ∏è Edit</button>
                    <button class="btn btn-small btn-secondary" onclick="moveBackToInProgress('${job.id}')">‚Üê Move Back to In Progress</button>
                `;
            } else if (stage === 'invoiced') {
                actions = `
                    <button class="btn btn-small btn-success" onclick="markAsPaid('${job.id}')">Mark as Paid</button>
                    <button class="btn btn-small" onclick="editPipelineJob('${job.id}')" style="background: #f3f4f6; color: #374151;">‚úèÔ∏è Edit</button>
                    <button class="btn btn-small btn-secondary" onclick="moveBackToComplete('${job.id}')">‚Üê Move Back to Complete</button>
                `;
            } else if (stage === 'paid') {
                actions = `
                    <button class="btn btn-small" onclick="editPipelineJob('${job.id}')" style="background: #f3f4f6; color: #374151;">‚úèÔ∏è Edit</button>
                    <button class="btn btn-small btn-secondary" onclick="moveBackToInvoiced('${job.id}')">‚Üê Move Back to Invoiced</button>
                `;
                // For paid jobs, show review request status
                if (job.reviewRequested) {
                    reviewSection = `
                        <div style="background: var(--success-light); border: 1px solid var(--success); border-radius: 6px; padding: 0.75rem; margin-top: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--success-dark);">
                                <span>‚úÖ</span>
                                <span style="font-weight: 500;">Review requested on ${new Date(job.reviewRequestedDate).toLocaleDateString('en-GB')}</span>
                            </div>
                        </div>
                    `;
                } else {
                    reviewSection = `
                        <div style="background: var(--warning-light); border: 1px solid var(--warning); border-radius: 6px; padding: 0.75rem; margin-top: 0.75rem;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--warning-dark);">
                                    <span>‚≠ê</span>
                                    <span style="font-weight: 500;">Review not requested yet</span>
                                </div>
                                <button class="btn btn-small btn-primary" onclick="requestReviewForJob('${job.id}')">Request Review</button>
                            </div>
                        </div>
                    `;
                }
            }

            return `
                <div class="pipeline-job-card" style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                        <div>
                            <div style="font-weight: 600; font-size: 1rem; color: var(--gray-900);">${job.customerName}</div>
                            <div style="color: var(--gray-500); font-size: 0.85rem;">
                                Job #${job.jobReference}
                                ${job.responsiblePerson ? `<span style="display: inline-block; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">üë§ ${job.responsiblePerson}</span>` : ''}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: var(--primary);">${value}</div>
                            ${priceLabel}
                        </div>
                    </div>
                    <div style="color: var(--gray-600); font-size: 0.9rem; margin-bottom: 0.5rem;">${job.projectType}</div>
                    <div style="color: var(--gray-600); font-size: 0.9rem; margin-bottom: 1rem;">${job.jobDescription}</div>
                    ${job.customerPhone ? `<div style="color: var(--gray-500); font-size: 0.85rem; margin-bottom: 0.25rem;">üìû ${job.customerPhone}</div>` : ''}
                    ${job.customerEmail ? `<div style="color: var(--gray-500); font-size: 0.85rem; margin-bottom: 0.75rem;">üìß ${job.customerEmail}</div>` : ''}
                    ${(stage === 'newLead' || stage === 'quoteSent') && job.quoteDeadline ? `
                        <div style="background: ${new Date(job.quoteDeadline) < new Date() ? '#fef3c7' : '#dbeafe'}; border: 1px solid ${new Date(job.quoteDeadline) < new Date() ? '#f59e0b' : '#3b82f6'}; border-radius: 6px; padding: 0.5rem; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; color: ${new Date(job.quoteDeadline) < new Date() ? '#92400e' : '#1e40af'};">
                                <span>‚è∞</span>
                                <span style="font-size: 0.85rem; font-weight: 500;">Quote deadline: ${new Date(job.quoteDeadline).toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })}</span>
                            </div>
                        </div>
                    ` : ''}
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        ${actions}
                    </div>
                    ${reviewSection}
                </div>
            `;
        }

        // Make renderPipeline available globally
        window.renderPipeline = renderPipeline;

        // ========================================
        // VISITS RENDERING
        // ========================================

        // Render Upcoming Visits Tab
        function renderVisits() {
            const container = document.getElementById('visitsContainer');
            if (!container) {
                console.error('visitsContainer not found');
                return;
            }

            if (!window.visits || window.visits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìÖ</div>
                        <div class="empty-state-text">No upcoming visits</div>
                        <p style="color: var(--gray-500); margin-top: 0.5rem;">All visits are completed or there are no sites yet</p>
                    </div>
                `;
                return;
            }

            // Get today's date at midnight for comparison
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            console.log('=== VISITS DEBUG INFO ===');
            console.log('Total visits in database:', window.visits.length);

            // Filter for pending visits (not completed and not paused)
            const pendingVisits = window.visits.filter(visit => {
                // Exclude completed visits
                if (visit.status === 'completed') return false;
                
                // Exclude if visit itself is paused
                if (visit.paused === true) return false;
                
                // Exclude if parent site is paused
                if (window.sites && visit.siteId) {
                    const parentSite = window.sites.find(s => s.id === visit.siteId);
                    if (parentSite && parentSite.paused === true) {
                        return false;
                    }
                }
                
                return true;
            });

            console.log('Pending visits (not completed, not paused):', pendingVisits.length);

            // Separate into projects and maintenance visits
            const projectVisits = [];
            const maintenanceVisits = [];
            
            pendingVisits.forEach(visit => {
                if (visit.pipelineJobId) {
                    // This is a project visit - include all of them
                    projectVisits.push(visit);
                } else {
                    // This is a maintenance visit - we'll filter these
                    maintenanceVisits.push(visit);
                }
            });

            console.log('Project visits (all shown):', projectVisits.length);
            console.log('Maintenance visits (before filtering):', maintenanceVisits.length);

            // For maintenance: only keep the NEXT visit for each site
            const nextMaintenanceVisits = [];
            const siteVisitMap = {};
            const visitsWithoutSiteId = [];
            
            // Group by siteId and find earliest visit for each site
            maintenanceVisits.forEach(visit => {
                if (!visit.siteId) {
                    // No siteId, include it anyway
                    visitsWithoutSiteId.push(visit);
                    nextMaintenanceVisits.push(visit);
                    return;
                }
                
                if (!siteVisitMap[visit.siteId]) {
                    // First visit for this site
                    siteVisitMap[visit.siteId] = visit;
                } else {
                    // Compare dates and keep earliest
                    const existing = siteVisitMap[visit.siteId];
                    if (new Date(visit.scheduledDate) < new Date(existing.scheduledDate)) {
                        siteVisitMap[visit.siteId] = visit;
                    }
                }
            });
            
            console.log('Unique sites with visits:', Object.keys(siteVisitMap).length);
            console.log('Visits without siteId:', visitsWithoutSiteId.length);
            
            // Convert map to array
            Object.values(siteVisitMap).forEach(visit => {
                nextMaintenanceVisits.push(visit);
            });

            console.log('Next maintenance visits (after filtering):', nextMaintenanceVisits.length);

            // Combine projects (all) and maintenance (next only)
            const upcomingVisits = [...projectVisits, ...nextMaintenanceVisits];

            console.log('TOTAL VISITS TO DISPLAY:', upcomingVisits.length);
            console.log('=== END DEBUG INFO ===');

            if (upcomingVisits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                        <div class="empty-state-text">All visits completed!</div>
                        <p style="color: var(--gray-500); margin-top: 0.5rem;">No upcoming visits scheduled</p>
                    </div>
                `;
                return;
            }

            // Sort by date (earliest first)
            upcomingVisits.sort((a, b) => new Date(a.scheduledDate) - new Date(b.scheduledDate));

            // Create debug info panel
            const debugInfo = `
                <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 1rem; margin: 1rem 1.5rem;">
                    <div style="font-weight: 600; color: #0369a1; margin-bottom: 0.5rem;">üìä Visit Statistics:</div>
                    <div style="font-size: 0.875rem; color: #075985; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div>Total in database: <strong>${window.visits.length}</strong></div>
                        <div>Pending (not done): <strong>${pendingVisits.length}</strong></div>
                        <div>Projects: <strong>${projectVisits.length}</strong></div>
                        <div>Maintenance: <strong>${maintenanceVisits.length}</strong></div>
                        <div>Unique sites: <strong>${Object.keys(siteVisitMap).length}</strong></div>
                        <div>Showing now: <strong>${upcomingVisits.length}</strong></div>
                    </div>
                </div>
            `;

            // Render visits
            container.innerHTML = `
                ${debugInfo}
                <div style="padding: 1.5rem;">
                    ${upcomingVisits.map(visit => createVisitCard(visit)).join('')}
                </div>
            `;
        }

        // Create visit card HTML
        function createVisitCard(visit) {
            const visitDate = new Date(visit.scheduledDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            visitDate.setHours(0, 0, 0, 0);
            const daysUntil = Math.floor((visitDate - today) / (1000 * 60 * 60 * 24));

            let urgencyClass = '';
            let urgencyText = '';
            
            if (visit.paused) {
                urgencyClass = 'info';
                urgencyText = 'PAUSED';
            } else if (daysUntil < 0) {
                urgencyClass = 'danger';
                urgencyText = 'OVERDUE';
            } else if (daysUntil === 0) {
                urgencyClass = 'danger';
                urgencyText = 'TODAY';
            } else if (daysUntil <= 3) {
                urgencyClass = 'warning';
                urgencyText = `${daysUntil} DAYS`;
            } else if (daysUntil <= 7) {
                urgencyClass = 'success';
                urgencyText = `${daysUntil} DAYS`;
            } else {
                urgencyClass = 'secondary';
                urgencyText = `${daysUntil} DAYS`;
            }

            // Determine border color based on urgency
            let borderColor = '#e5e7eb'; // default gray
            if (visit.paused) {
                borderColor = '#3b82f6'; // blue
            } else if (daysUntil < 0) {
                borderColor = '#ef4444'; // red for overdue
            } else if (daysUntil === 0) {
                borderColor = '#ef4444'; // red for today
            } else if (daysUntil <= 3) {
                borderColor = '#f59e0b'; // orange
            } else if (daysUntil <= 7) {
                borderColor = '#10b981'; // green
            }

            const price = visit.price ? `¬£${parseFloat(visit.price).toFixed(2)}` : '¬£0.00';
            
            // Determine visit type
            const isProject = visit.pipelineJobId ? true : false;
            const visitTypeBadge = isProject 
                ? '<span style="display: inline-block; background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">üéØ PROJECT</span>'
                : '<span style="display: inline-block; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">üîß MAINTENANCE</span>';

            return `
                <div class="visit-card" style="
                    background: white; 
                    border: 1px solid var(--gray-200); 
                    border-left: 4px solid ${borderColor};
                    border-radius: 8px; 
                    padding: 1.5rem; 
                    margin-bottom: 1rem;
                    position: relative;
                ">
                    <!-- Badge at top right -->
                    <div style="position: absolute; top: 1.5rem; right: 1.5rem;">
                        <span class="badge badge-${urgencyClass}" style="font-size: 0.75rem; font-weight: 600;">${urgencyText}</span>
                    </div>
                    
                    <!-- Site name -->
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 600; color: var(--gray-900); padding-right: 6rem;">
                        ${visit.siteName}
                        ${visitTypeBadge}
                    </h3>
                    
                    <!-- Date -->
                    <div style="color: var(--gray-600); font-size: 0.95rem; margin-bottom: 0.75rem;">
                        ${visitDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })}
                    </div>
                    
                    <!-- Address -->
                    <div style="color: var(--gray-600); font-size: 0.95rem; margin-bottom: 1.25rem;">
                        ${visit.siteAddress}
                    </div>
                    
                    <!-- Visit Price -->
                    <div style="margin-bottom: 1.25rem;">
                        <div style="font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; font-weight: 600;">
                            VISIT PRICE
                        </div>
                        <div style="font-size: 1rem; font-weight: 500; color: var(--gray-900);">
                            ${price}
                        </div>
                    </div>
                    
                    ${visit.notes ? `
                    <div style="margin-bottom: 1.25rem; padding: 0.75rem; background: var(--gray-50); border-radius: 6px;">
                        <div style="font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; font-weight: 600;">
                            NOTES
                        </div>
                        <div style="color: var(--gray-700); font-size: 0.9rem;">
                            ${visit.notes}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Buttons -->
                    ${!visit.paused ? `
                        <button class="btn btn-success" onclick="openCompleteVisitModal('${visit.id}')" style="width: 100%; padding: 0.875rem; font-size: 1rem; font-weight: 500; margin-bottom: 0.5rem;">
                            ‚úì Complete Visit
                        </button>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="openEditVisitModal('${visit.id}')" style="flex: 1; padding: 0.75rem; font-size: 0.9rem;">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="btn btn-danger" onclick="deleteVisit('${visit.id}')" style="flex: 1; padding: 0.75rem; font-size: 0.9rem;">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    ` : `
                        <button class="btn btn-primary" onclick="resumeVisit('${visit.id}')" style="width: 100%; padding: 0.875rem; font-size: 1rem; font-weight: 500;">
                            ‚ñ∂ Resume Visit
                        </button>
                    `}
                </div>
            `;
        }

        // Make renderVisits available globally
        window.renderVisits = renderVisits;

        // ========================================
        // INVOICES RENDERING
        // ========================================

        // Render Invoice Tracking Tab
        function renderInvoices() {
            const container = document.getElementById('invoicesContainer');
            if (!container) {
                console.error('invoicesContainer not found');
                return;
            }

            // Collect items needing invoicing from both pipeline and visits
            let needsInvoice = [];
            let awaitingPayment = [];

            // Check pipeline jobs
            if (window.pipelineJobs) {
                window.pipelineJobs.forEach(job => {
                    if (job.stage === 'complete') {
                        needsInvoice.push({
                            type: 'pipeline',
                            id: job.id,
                            customerName: job.customerName,
                            jobReference: job.jobReference,
                            projectType: job.projectType || job.jobDescription,
                            amount: job.quotedPrice || job.estimatedValue,  // Use quoted price, fallback to estimate
                            completedDate: job.completedDate,
                            ...job
                        });
                    } else if (job.stage === 'invoiced') {
                        awaitingPayment.push({
                            type: 'pipeline',
                            id: job.id,
                            customerName: job.customerName,
                            jobReference: job.jobReference,
                            projectType: job.projectType || job.jobDescription,
                            amount: job.quotedPrice || job.estimatedValue,  // Use quoted price, fallback to estimate
                            invoicedDate: job.invoicedDate,
                            ...job
                        });
                    }
                });
            }

            // Check completed visits
            if (window.visits) {
                window.visits.forEach(visit => {
                    if (visit.status === 'completed' && !visit.invoiced) {
                        needsInvoice.push({
                            type: 'visit',
                            id: visit.id,
                            siteName: visit.siteName,
                            siteAddress: visit.siteAddress,
                            amount: visit.price,
                            completedDate: visit.completedDate,
                            ...visit
                        });
                    }
                });
            }

            // Show empty state if nothing to display
            if (needsInvoice.length === 0 && awaitingPayment.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                        <div class="empty-state-text">All caught up!</div>
                        <p style="color: var(--gray-500); margin-top: 0.5rem;">No invoices awaiting to be sent</p>
                    </div>
                `;
                return;
            }

            // Sort by date
            needsInvoice.sort((a, b) => new Date(b.completedDate || 0) - new Date(a.completedDate || 0));
            awaitingPayment.sort((a, b) => new Date(b.invoicedDate || 0) - new Date(a.invoicedDate || 0));

            // Render sections
            let html = '<div style="padding: 1.5rem;">';

            // Section 1: Needs Invoice
            if (needsInvoice.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--gray-900);">
                            üìÑ Awaiting Invoice (${needsInvoice.length})
                        </h2>
                        <div class="alert alert-warning" style="margin-bottom: 1rem;">
                            <strong>üí° Tip:</strong> Send invoices promptly to maintain healthy cash flow!
                        </div>
                        ${needsInvoice.map(item => createInvoiceCard(item)).join('')}
                    </div>
                `;
            }

            // Section 2: Awaiting Payment
            if (awaitingPayment.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--gray-900);">
                            üí∞ Awaiting Payment (${awaitingPayment.length})
                        </h2>
                        ${awaitingPayment.map(item => createPaymentCard(item)).join('')}
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // Create invoice card HTML (for items needing invoice)
        function createInvoiceCard(item) {
            const completedDate = new Date(item.completedDate || item.scheduledDate);
            const daysSince = Math.floor((new Date() - completedDate) / (1000 * 60 * 60 * 24));
            
            let urgencyClass = daysSince > 7 ? 'danger' : daysSince > 3 ? 'warning' : 'success';
            let borderColor = daysSince > 7 ? '#ef4444' : daysSince > 3 ? '#f59e0b' : '#10b981';

            const amount = item.amount ? `¬£${parseFloat(item.amount).toFixed(2)}` : '¬£0.00';

            if (item.type === 'pipeline') {
                // Pipeline job card
                return `
                    <div class="invoice-card" style="
                        background: white; 
                        border: 1px solid var(--gray-200); 
                        border-left: 4px solid ${borderColor};
                        border-radius: 8px; 
                        padding: 1.5rem; 
                        margin-bottom: 1rem;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">
                                    PROJECT ‚Ä¢ JOB #${item.jobReference}
                                </div>
                                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 600; color: var(--gray-900);">
                                    ${item.customerName}
                                </h3>
                                <div style="color: var(--gray-600); font-size: 0.95rem;">
                                    ${item.projectType}
                                </div>
                            </div>
                            <span class="badge badge-${urgencyClass}" style="font-size: 0.75rem; font-weight: 600;">
                                ${daysSince} days ago
                            </span>
                        </div>
                        
                        <div style="margin-bottom: 1.25rem;">
                            <div style="font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; font-weight: 600;">
                                INVOICE AMOUNT
                            </div>
                            <div style="font-size: 1.25rem; font-weight: 600; color: var(--success);">
                                ${amount}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-success" onclick="sendInvoice('${item.id}')" style="flex: 1;">
                                üìß Send Invoice
                            </button>
                            <button class="btn btn-secondary" onclick="markAsPaid('${item.id}')" style="flex: 1;">
                                ‚úì Mark as Paid
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Visit card
                return `
                    <div class="invoice-card" style="
                        background: white; 
                        border: 1px solid var(--gray-200); 
                        border-left: 4px solid ${borderColor};
                        border-radius: 8px; 
                        padding: 1.5rem; 
                        margin-bottom: 1rem;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">
                                    VISIT
                                </div>
                                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 600; color: var(--gray-900);">
                                    ${item.siteName}
                                </h3>
                                <div style="color: var(--gray-600); font-size: 0.95rem;">
                                    ${item.siteAddress}
                                </div>
                            </div>
                            <span class="badge badge-${urgencyClass}" style="font-size: 0.75rem; font-weight: 600;">
                                ${daysSince} days ago
                            </span>
                        </div>
                        
                        <div style="margin-bottom: 1.25rem;">
                            <div style="font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; font-weight: 600;">
                                INVOICE AMOUNT
                            </div>
                            <div style="font-size: 1.25rem; font-weight: 600; color: var(--success);">
                                ${amount}
                            </div>
                        </div>
                        
                        <button class="btn btn-success" onclick="markVisitAsInvoiced('${item.id}')" style="width: 100%;">
                            ‚úì Mark as Invoiced
                        </button>
                    </div>
                `;
            }
        }

        // Create payment card HTML (for items awaiting payment)
        function createPaymentCard(item) {
            const invoicedDate = new Date(item.invoicedDate);
            const daysSince = Math.floor((new Date() - invoicedDate) / (1000 * 60 * 60 * 24));
            
            let urgencyClass = daysSince > 30 ? 'danger' : daysSince > 14 ? 'warning' : 'info';
            let borderColor = daysSince > 30 ? '#ef4444' : daysSince > 14 ? '#f59e0b' : '#3b82f6';

            const amount = item.amount ? `¬£${parseFloat(item.amount).toFixed(2)}` : '¬£0.00';

            return `
                <div class="payment-card" style="
                    background: white; 
                    border: 1px solid var(--gray-200); 
                    border-left: 4px solid ${borderColor};
                    border-radius: 8px; 
                    padding: 1.5rem; 
                    margin-bottom: 1rem;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">
                                PROJECT ‚Ä¢ JOB #${item.jobReference}
                            </div>
                            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 600; color: var(--gray-900);">
                                ${item.customerName}
                            </h3>
                            <div style="color: var(--gray-600); font-size: 0.95rem;">
                                ${item.projectType}
                            </div>
                        </div>
                        <span class="badge badge-${urgencyClass}" style="font-size: 0.75rem; font-weight: 600;">
                            ${daysSince} days
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 1.25rem;">
                        <div style="font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; font-weight: 600;">
                            AMOUNT DUE
                        </div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--warning);">
                            ${amount}
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="markAsPaid('${item.id}')" style="width: 100%;">
                        üí∞ Mark as Paid
                    </button>
                </div>
            `;
        }

        // Make renderInvoices available globally
        window.renderInvoices = renderInvoices;

        // Render Sites
        function renderSites() {
            const container = document.getElementById('sitesContainer');
            
            if (!container) {
                console.error('sitesContainer element not found');
                return;
            }
            
            console.log('renderSites called with', window.sites.length, 'sites');
            
            if (window.sites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìç</div>
                        <div class="empty-state-title">No sites yet</div>
                        <div class="empty-state-text">Add your first site to get started with route management</div>
                        <button class="btn btn-primary" onclick="openAddSiteModal()">+ Add Your First Site</button>
                    </div>
                `;
                return;
            }

            try {
                const html = window.sites.map(site => {
                    const frequencyText = {
                    7: 'Weekly',
                    14: 'Fortnightly',
                    28: '4-Weekly',
                    30: 'Monthly',
                    91: 'Quarterly'
                }[site.frequency] || `Every ${site.frequency} days`;

                return `
                    <div class="site-card">
                        <div class="site-header">
                            <div>
                                <div class="site-name">${site.name}</div>
                                <div class="site-address">${site.address}</div>
                                ${site.paused ? `
                                    <div style="display: inline-block; background: #fee2e2; color: #991b1b; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; margin-top: 0.25rem;">
                                        ‚è∏Ô∏è Paused${site.pausedUntil ? ` until ${new Date(site.pausedUntil).toLocaleDateString('en-GB')}` : ' indefinitely'}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="badge-frequency">${frequencyText}</span>
                                ${site.paused ? `
                                    <button class="btn btn-success" onclick="resumeContract('${site.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                                        ‚ñ∂Ô∏è Resume
                                    </button>
                                ` : `
                                    <button class="btn btn-warning" onclick="pauseContract('${site.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.85rem; background: #f59e0b; color: white;">
                                        ‚è∏Ô∏è Pause
                                    </button>
                                `}
                                <button class="btn btn-primary" onclick="scheduleManualVisit('${site.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                                    üìÖ Schedule Visit
                                </button>
                                <button class="btn btn-secondary" onclick="editSite('${site.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                                    ‚úèÔ∏è Edit Site
                                </button>
                                <button class="btn btn-danger" onclick="deleteSite('${site.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                        <div class="site-meta">
                            ${site.contractNotes ? `
                                <div class="meta-item" style="grid-column: 1 / -1; background: #fef3c7; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #f59e0b;">
                                    <div class="meta-label" style="color: #92400e; font-weight: 600;">üìã Contract Notes</div>
                                    <div class="meta-value" style="color: #78350f; white-space: pre-wrap;">${site.contractNotes}</div>
                                </div>
                            ` : ''}
                            ${site.contact ? `
                                <div class="meta-item">
                                    <div class="meta-label">Contact</div>
                                    <div class="meta-value">${site.contact}</div>
                                </div>
                            ` : ''}
                            ${site.phone ? `
                                <div class="meta-item">
                                    <div class="meta-label">Phone</div>
                                    <div class="meta-value">${site.phone}</div>
                                </div>
                            ` : ''}
                            <div class="meta-item">
                                <div class="meta-label">Price</div>
                                <div class="meta-value">¬£${site.price.toFixed(2)}</div>
                            </div>
                            ${site.notes ? `
                                <div class="meta-item" style="grid-column: 1 / -1;">
                                    <div class="meta-label">Access Notes</div>
                                    <div class="meta-value">${site.notes}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('Generated HTML length:', html.length);
            container.innerHTML = html;
            console.log('Container innerHTML set successfully');
            
            } catch (error) {
                console.error('Error rendering sites:', error);                container.innerHTML = `
                    <div class="alert alert-danger">
                        Error displaying sites. Please refresh the page. Error: ${error.message}
                    </div>
                `;
            }
        }

        // ============================================
        // SITE MANAGEMENT FUNCTIONS
        // ============================================

        // Pause Contract
        window.pauseContract = async (siteId) => {
            const site = window.sites.find(s => s.id === siteId);
            if (!site) return;

            const pauseIndefinitely = confirm(`Pause "${site.name}"?\n\nClick OK to pause indefinitely, or Cancel to choose an end date.`);
            
            let pausedUntil = null;
            if (!pauseIndefinitely) {
                const dateStr = prompt('Pause until (YYYY-MM-DD):');
                if (!dateStr) return;
                pausedUntil = dateStr;
            }

            try {
                const userId = window.currentUser.uid;
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/sites/${siteId}`), {
                    paused: true,
                    pausedUntil: pausedUntil,
                    pausedDate: new Date().toISOString().split('T')[0]
                });

                // Hide all pending visits for this site
                const siteVisits = window.visits.filter(v => v.siteId === siteId && v.status === 'pending');
                for (const visit of siteVisits) {
                    await window.dbUpdate(window.dbRef(window.database, `users/${userId}/visits/${visit.id}`), {
                        hidden: true
                    });
                }

                alert(`‚úÖ Contract paused${pausedUntil ? ` until ${new Date(pausedUntil).toLocaleDateString('en-GB')}` : ' indefinitely'}`);
            } catch (error) {
                console.error('Error pausing contract:', error);
                alert('Error pausing contract. Please try again.');
            }
        };

        // Resume Contract
        window.resumeContract = async (siteId) => {
            const site = window.sites.find(s => s.id === siteId);
            if (!site) return;

            if (!confirm(`Resume "${site.name}"?\n\nThis will create a new visit starting from today.`)) {
                return;
            }

            try {
                const userId = window.currentUser.uid;
                
                // Resume the site
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/sites/${siteId}`), {
                    paused: false,
                    pausedUntil: null,
                    resumedDate: new Date().toISOString().split('T')[0]
                });

                // Unhide visits and create new visit from today
                const siteVisits = window.visits.filter(v => v.siteId === siteId && v.hidden);
                for (const visit of siteVisits) {
                    await window.dbRemove(window.dbRef(window.database, `users/${userId}/visits/${visit.id}`));
                }

                // Create new visit starting today
                const nextVisitData = {
                    siteId: site.id,
                    siteName: site.name,
                    siteAddress: site.address,
                    scheduledDate: new Date().toISOString().split('T')[0],
                    price: site.price,
                    frequency: site.frequency,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };

                const nextVisitRef = window.dbPush(window.dbRef(window.database, `users/${userId}/visits`));
                await window.dbSet(nextVisitRef, nextVisitData);

                alert('‚úÖ Contract resumed! New visit scheduled for today.');
            } catch (error) {
                console.error('Error resuming contract:', error);
                alert('Error resuming contract. Please try again.');
            }
        };

        // Edit Site
        window.editSite = async (siteId) => {
            console.log('editSite called with siteId:', siteId);
            const site = window.sites.find(s => s.id === siteId);
            console.log('Found site:', site);
            if (!site) {
                console.error('Site not found');
                return;
            }

            // Set edit mode
            editingSiteId = siteId;

            // Open modal first
            const modal = document.getElementById('addSiteModal');
            if (!modal) {
                console.error('Modal not found');
                return;
            }
            modal.classList.add('active');

            // Wait for modal to be visible before populating
            setTimeout(() => {
                // Populate form with existing data
                const fields = {
                    siteName: site.name,
                    siteAddress: site.address,
                    siteContact: site.contact || '',
                    sitePhone: site.phone || '',
                    sitePrice: site.price,
                    siteFrequency: site.frequency,
                    siteNotes: site.notes || ''
                };

                for (const [fieldId, value] of Object.entries(fields)) {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.value = value;
                    } else {
                        console.warn(`Field ${fieldId} not found`);
                    }
                }

                // Change form title and button text
                const titleElement = document.querySelector('#addSiteModal .modal-title');
                if (titleElement) titleElement.textContent = 'Edit Site';
                
                const submitBtn = document.querySelector('#addSiteForm button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Update Site';
                }

                console.log('Edit modal populated and opened');
            }, 100); // Wait 100ms for modal to render
        };

        // Schedule Manual Visit for a Site
        window.scheduleManualVisit = async (siteId) => {
            const site = window.sites.find(s => s.id === siteId);
            if (!site) {
                alert('Site not found');
                return;
            }

            // Prompt for scheduled date
            const today = new Date().toISOString().split('T')[0];
            const scheduledDate = prompt(`Schedule visit for ${site.name}\n\nEnter date (YYYY-MM-DD):`, today);
            
            if (!scheduledDate) return; // User cancelled
            
            // Validate date format
            if (!/^\d{4}-\d{2}-\d{2}$/.test(scheduledDate)) {
                alert('Invalid date format. Please use YYYY-MM-DD');
                return;
            }

            try {
                const userId = window.currentUser.uid;
                
                // Create visit
                const visitData = {
                    siteId: siteId,
                    siteName: site.name,
                    siteAddress: site.address,
                    scheduledDate: scheduledDate,
                    price: site.price,
                    frequency: site.frequency,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };

                const visitRef = window.dbPush(window.dbRef(window.database, `users/${userId}/visits`));
                await window.dbSet(visitRef, visitData);

                alert(`‚úÖ Visit scheduled for ${new Date(scheduledDate).toLocaleDateString('en-GB')}!`);

                // Refresh views
                if (typeof renderVisits === 'function') renderVisits();
                if (typeof updateStats === 'function') updateStats();

            } catch (error) {
                console.error('Error scheduling visit:', error);
                alert('Error scheduling visit. Please try again.');
            }
        };

        // Delete Site
        window.deleteSite = async (siteId) => {
            const site = window.sites.find(s => s.id === siteId);
            if (!site) return;

            if (!confirm(`Are you sure you want to delete "${site.name}"?\n\nThis will also delete all associated visits.\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const userId = window.currentUser.uid;
                
                // Delete all visits for this site
                const siteVisits = window.visits.filter(v => v.siteId === siteId);
                for (const visit of siteVisits) {
                    await window.dbRemove(window.dbRef(window.database, `users/${userId}/visits/${visit.id}`));
                }

                // Delete the site
                await window.dbRemove(window.dbRef(window.database, `users/${userId}/sites/${siteId}`));

                alert(`‚úÖ Site "${site.name}" and all associated visits deleted successfully.`);
            } catch (error) {
                console.error('Error deleting site:', error);
                alert('Error deleting site: ' + error.message);
            }
        };

        // ============================================
        // PROJECT FUNCTIONS
        // ============================================

        // Render Projects
        function renderProjects() {
            const container = document.getElementById('projectsContainer');
            
            if (window.projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìê</div>
                        <div class="empty-state-title">No projects yet</div>
                        <div class="empty-state-text">Add your first landscaping project or one-off job</div>
                        <button class="btn btn-primary" onclick="openAddProjectModal()">+ Add Your First Project</button>
                    </div>
                `;
                return;
            }

            // Separate by status
            const notStarted = window.projects.filter(p => p.status === 'not-started');
            const inProgress = window.projects.filter(p => p.status === 'in-progress');
            const completed = window.projects.filter(p => p.status === 'completed');

            let html = '';

            // In Progress Section
            if (inProgress.length > 0) {
                html += `
                    <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 1.5rem;">
                        <h3 style="color: #1e40af; margin-bottom: 0.5rem; font-size: 1.125rem;">üöß In Progress (${inProgress.length})</h3>
                    </div>
                `;
                html += inProgress.map(renderProjectCard).join('');
            }

            // Not Started Section
            if (notStarted.length > 0) {
                html += `
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 1.5rem; margin-top: 1.5rem;">
                        <h3 style="color: #92400e; margin-bottom: 0.5rem; font-size: 1.125rem;">üìã Not Started (${notStarted.length})</h3>
                    </div>
                `;
                html += notStarted.map(renderProjectCard).join('');
            }

            // Completed Section (show last 5)
            if (completed.length > 0) {
                html += `
                    <div style="background: #d1fae5; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--success); margin-bottom: 1.5rem; margin-top: 1.5rem;">
                        <h3 style="color: #065f46; margin-bottom: 0.5rem; font-size: 1.125rem;">‚úÖ Recently Completed</h3>
                    </div>
                `;
                html += completed.slice(-5).reverse().map(renderProjectCard).join('');
            }

            container.innerHTML = html;
        }

        function renderProjectCard(project) {
            const statusColors = {
                'not-started': { bg: '#fef3c7', text: '#92400e', label: 'Not Started' },
                'in-progress': { bg: '#dbeafe', text: '#1e40af', label: 'In Progress' },
                'completed': { bg: '#d1fae5', text: '#065f46', label: 'Completed' }
            };

            const status = statusColors[project.status];
            const startDate = new Date(project.startDate).toLocaleDateString('en-GB');
            const endDate = new Date(project.expectedEnd).toLocaleDateString('en-GB');

            return `
                <div class="site-card" style="border-left: 4px solid ${status.bg};">
                    <div class="site-header">
                        <div>
                            <div class="site-name">üìê ${project.projectName}</div>
                            <div class="site-address">${project.projectType} ‚Ä¢ ${project.clientName}</div>
                            <div class="site-address" style="margin-top: 0.25rem;">${project.address}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span class="visit-status" style="background: ${status.bg}; color: ${status.text}; padding: 0.375rem 0.875rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                ${status.label}
                            </span>
                            ${project.status !== 'completed' ? `
                                <button class="btn btn-secondary" onclick="editProject('${project.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button class="btn btn-danger" onclick="deleteProject('${project.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                                    üóëÔ∏è Delete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="site-meta">
                        <div class="meta-item">
                            <div class="meta-label">Price</div>
                            <div class="meta-value">¬£${project.price.toFixed(2)}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Start Date</div>
                            <div class="meta-value">${startDate}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">${project.status === 'completed' ? 'Completed' : 'Expected End'}</div>
                            <div class="meta-value">${project.actualCompletionDate ? new Date(project.actualCompletionDate).toLocaleDateString('en-GB') : endDate}</div>
                        </div>
                        ${project.contact ? `
                            <div class="meta-item">
                                <div class="meta-label">Contact</div>
                                <div class="meta-value">${project.contact}</div>
                            </div>
                        ` : ''}
                        ${project.phone ? `
                            <div class="meta-item">
                                <div class="meta-label">Phone</div>
                                <div class="meta-value">${project.phone}</div>
                            </div>
                        ` : ''}
                        ${project.description ? `
                            <div class="meta-item" style="grid-column: 1 / -1; background: var(--gray-50); padding: 0.75rem; border-radius: 6px;">
                                <div class="meta-label">Project Description</div>
                                <div class="meta-value" style="white-space: pre-wrap;">${project.description}</div>
                            </div>
                        ` : ''}
                        ${project.notes ? `
                            <div class="meta-item" style="grid-column: 1 / -1;">
                                <div class="meta-label">Notes</div>
                                <div class="meta-value">${project.notes}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${project.status !== 'completed' ? `
                        <!-- Project Updates Section -->
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <h4 style="margin: 0; font-size: 0.95rem; color: var(--gray-700);">üìù Project Updates</h4>
                                <button class="btn btn-secondary" onclick="openAddUpdateModal('${project.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                                    + Add Update
                                </button>
                            </div>
                            <div id="projectUpdates-${project.id}">
                                ${project.updates && project.updates.length > 0 ? `
                                    <div style="max-height: 200px; overflow-y: auto;">
                                        ${project.updates.map(update => `
                                            <div style="background: var(--gray-50); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid var(--primary);">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.25rem;">
                                                    <div style="font-size: 0.8rem; color: var(--gray-500);">
                                                        ${new Date(update.timestamp).toLocaleDateString('en-GB', { 
                                                            day: 'numeric', 
                                                            month: 'short', 
                                                            year: 'numeric',
                                                            hour: '2-digit',
                                                            minute: '2-digit'
                                                        })}
                                                    </div>
                                                    <button onclick="deleteProjectUpdate('${project.id}', '${update.id}')" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 0; font-size: 0.85rem;" title="Delete update">üóëÔ∏è</button>
                                                </div>
                                                <div style="color: var(--gray-700); font-size: 0.9rem; white-space: pre-wrap;">${update.text}</div>
                                            </div>
                                        `).reverse().join('')}
                                    </div>
                                ` : `
                                    <div style="text-align: center; padding: 1rem; color: var(--gray-400); font-size: 0.9rem;">
                                        No updates yet - click "Add Update" to track progress
                                    </div>
                                `}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${project.status !== 'completed' ? `
                        <div style="display: flex; gap: 0.75rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                            ${project.status === 'not-started' ? `
                                <button class="btn btn-primary" onclick="startProject('${project.id}')" style="flex: 1;">
                                    ‚ñ∂Ô∏è Start Project
                                </button>
                            ` : `
                                <button class="btn btn-success" onclick="openCompleteProjectModal('${project.id}')" style="flex: 1;">
                                    ‚úì Complete Project
                                </button>
                            `}
                        </div>
                    ` : `
                        ${project.invoiceStatus === 'pending' ? `
                            <div style="display: flex; gap: 0.75rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                                <button class="btn btn-success" onclick="markProjectInvoiced('${project.id}')" style="flex: 1;">
                                    ‚úì Mark Invoiced
                                </button>
                            </div>
                        ` : ''}
                    `}
                </div>
            `;
        }

        // Open Add Project Modal
        window.openAddProjectModal = () => {
            document.getElementById('addProjectModal').classList.add('active');
            document.getElementById('projectStartDate').valueAsDate = new Date();
        };

        window.closeAddProjectModal = () => {
            document.getElementById('addProjectModal').classList.remove('active');
            document.getElementById('addProjectForm').reset();
        };

        // Add Project Handler
        document.getElementById('addProjectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const projectData = {
                projectName: document.getElementById('projectName').value,
                projectType: document.getElementById('projectType').value,
                clientName: document.getElementById('projectClientName').value,
                address: document.getElementById('projectAddress').value,
                contact: document.getElementById('projectContact').value,
                phone: document.getElementById('projectPhone').value,
                email: document.getElementById('projectEmail').value,
                price: parseFloat(document.getElementById('projectPrice').value),
                startDate: document.getElementById('projectStartDate').value,
                expectedEnd: document.getElementById('projectExpectedEnd').value,
                description: document.getElementById('projectDescription').value,
                notes: document.getElementById('projectNotes').value,
                status: 'not-started',
                invoiceStatus: 'pending',
                createdAt: new Date().toISOString()
            };

            try {
                const userId = window.currentUser.uid;
                const projectRef = window.dbPush(window.dbRef(window.database, `users/${userId}/projects`));
                await window.dbSet(projectRef, projectData);

                closeAddProjectModal();
                alert('‚úÖ Project added successfully!');
            } catch (error) {
                console.error('Error adding project:', error);
                alert('Error adding project. Please try again.');
            }
        });

        // Start Project
        window.startProject = async (projectId) => {
            if (!confirm('Mark this project as started?')) return;
            
            try {
                const userId = window.currentUser.uid;
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/projects/${projectId}`), {
                    status: 'in-progress',
                    actualStartDate: new Date().toISOString().split('T')[0]
                });
                alert('‚úÖ Project started!');
            } catch (error) {
                console.error('Error starting project:', error);
                alert('Error starting project. Please try again.');
            }
        };

        // Initialize project signature pad
        function initProjectSignaturePad() {
            const canvas = document.getElementById('projectSignaturePad');
            if (!canvas) return;
            
            projectSignaturePad = canvas.getContext('2d');
            projectSignaturePad.strokeStyle = '#000';
            projectSignaturePad.lineWidth = 2;
            projectSignaturePad.lineCap = 'round';
            
            let lastX = 0;
            let lastY = 0;
            let isDrawing = false;
            
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                lastX = touch.clientX - rect.left;
                lastY = touch.clientY - rect.top;
                isDrawing = true;
            });
            
            canvas.addEventListener('touchmove', (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                projectSignaturePad.beginPath();
                projectSignaturePad.moveTo(lastX, lastY);
                projectSignaturePad.lineTo(x, y);
                projectSignaturePad.stroke();
                
                lastX = x;
                lastY = y;
            });
            
            canvas.addEventListener('touchend', () => {
                isDrawing = false;
            });
            
            canvas.addEventListener('mousedown', (e) => {
                const rect = canvas.getBoundingClientRect();
                lastX = e.clientX - rect.left;
                lastY = e.clientY - rect.top;
                isDrawing = true;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                projectSignaturePad.beginPath();
                projectSignaturePad.moveTo(lastX, lastY);
                projectSignaturePad.lineTo(x, y);
                projectSignaturePad.stroke();
                
                lastX = x;
                lastY = y;
            });
            
            canvas.addEventListener('mouseup', () => {
                isDrawing = false;
            });
            
            canvas.addEventListener('mouseleave', () => {
                isDrawing = false;
            });
        }

        window.clearProjectSignature = function() {
            const canvas = document.getElementById('projectSignaturePad');
            if (projectSignaturePad) {
                projectSignaturePad.clearRect(0, 0, canvas.width, canvas.height);
            }
        };

        // Open Complete Project Modal
        window.openCompleteProjectModal = (projectId) => {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            document.getElementById('completeProjectId').value = projectId;
            document.getElementById('projectCompletedBy').value = window.currentUser.email;
            document.getElementById('projectActualEndDate').valueAsDate = new Date();
            
            if (!projectSignaturePad) {
                initProjectSignaturePad();
            }
            
            setTimeout(() => {
                const canvas = document.getElementById('projectSignaturePad');
                if (canvas && projectSignaturePad) {
                    projectSignaturePad.clearRect(0, 0, canvas.width, canvas.height);
                }
            }, 100);
            
            document.getElementById('completeProjectModal').classList.add('active');
        };

        window.closeCompleteProjectModal = () => {
            document.getElementById('completeProjectModal').classList.remove('active');
            document.getElementById('completeProjectForm').reset();
            
            const canvas = document.getElementById('projectSignaturePad');
            if (canvas && projectSignaturePad) {
                projectSignaturePad.clearRect(0, 0, canvas.width, canvas.height);
            }
        };

        // Complete Project Handler
        document.getElementById('completeProjectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const projectId = document.getElementById('completeProjectId').value;
            const completedBy = document.getElementById('projectCompletedBy').value;
            const actualEndDate = document.getElementById('projectActualEndDate').value;
            const completionNotes = document.getElementById('projectCompletionNotes').value;
            const customerName = document.getElementById('projectCustomerName').value;

            // Validate signature
            const canvas = document.getElementById('projectSignaturePad');
            const signatureData = canvas.toDataURL();
            const blankCanvas = document.createElement('canvas');
            blankCanvas.width = canvas.width;
            blankCanvas.height = canvas.height;
            if (signatureData === blankCanvas.toDataURL()) {
                alert('Please get customer signature before completing.');
                return;
            }

            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            try {
                const userId = window.currentUser.uid;
                
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/projects/${projectId}`), {
                    status: 'completed',
                    completedBy: completedBy,
                    actualCompletionDate: actualEndDate,
                    completionNotes: completionNotes,
                    customerName: customerName,
                    customerSignature: signatureData,
                    completedAt: new Date().toISOString()
                });

                closeCompleteProjectModal();
                
                // Send email notification
                sendProjectInvoiceEmail(project, completedBy, actualEndDate, completionNotes, customerName);
                
                alert('‚úÖ Project completed!\nüìß Email notification sent\n\nProject moved to invoice tracking');
            } catch (error) {
                console.error('Error completing project:', error);
                alert('Error completing project. Please try again.');
            }
        });

        // Send Project Invoice Email
        function sendProjectInvoiceEmail(project, completedBy, completedDate, notes, customerName) {
            const emailSubject = `Invoice Required: ${project.projectName} - Completed ${completedDate}`;
            
            const emailBody = `
Project Completion Details
====================================

Project Information:
- Project Name: ${project.projectName}
- Project Type: ${project.projectType}
- Client: ${project.clientName}
- Address: ${project.address}

Work Details:
- Completed By: ${completedBy}
- Completed On: ${new Date(completedDate).toLocaleDateString('en-GB')}
- Invoice Amount: ¬£${project.price.toFixed(2)}

Project Description:
${project.description}

${notes ? `Completion Notes:\n${notes}\n` : ''}
Customer Sign-Off:
- Customer Name: ${customerName}
- Signature: Captured digitally (view in app Projects tab)

REMINDER: 
- Field staff should have before/after photos on their phone
- Customer signature captured digitally
- Project completion confirmed

Please prepare and send invoice to the customer.

---
This notification was generated automatically by Roundwood Route Manager.
            `.trim();

            const mailto = `mailto:office@roundwoodsolutions.co.uk?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
            window.location.href = mailto;
        }

        // Delete Project
        window.deleteProject = async (projectId) => {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            if (!confirm(`Are you sure you want to delete "${project.projectName}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const userId = window.currentUser.uid;
                await window.dbRemove(window.dbRef(window.database, `users/${userId}/projects/${projectId}`));
                alert(`‚úÖ Project "${project.projectName}" deleted successfully.`);
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Error deleting project: ' + error.message);
            }
        };

        // Edit Project
        window.editProject = async (projectId) => {
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                console.error('Project not found');
                return;
            }

            // Open modal first
            const modal = document.getElementById('addProjectModal');
            if (!modal) {
                console.error('Project modal not found');
                return;
            }
            modal.classList.add('active');

            // Wait for modal to render then populate
            setTimeout(() => {
                const fields = {
                    projectName: project.projectName,
                    projectType: project.projectType,
                    clientName: project.clientName,
                    projectAddress: project.address,
                    projectContact: project.contact || '',
                    projectPhone: project.phone || '',
                    projectPrice: project.price,
                    projectStartDate: project.startDate,
                    projectExpectedEnd: project.expectedEnd,
                    projectDescription: project.description || '',
                    projectNotes: project.notes || ''
                };

                for (const [fieldId, value] of Object.entries(fields)) {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.value = value;
                    } else {
                        console.warn(`Field ${fieldId} not found`);
                    }
                }

                // Change form title and button
                const titleElement = document.querySelector('#addProjectModal .modal-title');
                if (titleElement) titleElement.textContent = 'Edit Project';
                
                const submitBtn = document.querySelector('#addProjectForm button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Update Project';
                    submitBtn.onclick = async (e) => {
                        e.preventDefault();
                        
                        const updatedData = {
                            projectName: document.getElementById('projectName').value,
                            projectType: document.getElementById('projectType').value,
                            clientName: document.getElementById('clientName').value,
                            address: document.getElementById('projectAddress').value,
                            contact: document.getElementById('projectContact').value,
                            phone: document.getElementById('projectPhone').value,
                            price: parseFloat(document.getElementById('projectPrice').value),
                            startDate: document.getElementById('projectStartDate').value,
                            expectedEnd: document.getElementById('projectExpectedEnd').value,
                            description: document.getElementById('projectDescription').value,
                            notes: document.getElementById('projectNotes').value
                        };

                        try {
                            const userId = window.currentUser.uid;
                            await window.dbUpdate(window.dbRef(window.database, `users/${userId}/projects/${projectId}`), updatedData);
                            closeAddProjectModal();
                            alert('‚úÖ Project updated successfully!');
                        } catch (error) {
                            console.error('Error updating project:', error);
                            alert('Error updating project. Please try again.');
                        }
                    };
                }
            }, 100);
        };

        // Mark Project Invoiced
        window.markProjectInvoiced = async (projectId) => {
            if (!confirm('Mark this project as invoiced?')) return;
            
            try {
                const userId = window.currentUser.uid;
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/projects/${projectId}`), {
                    invoiceStatus: 'sent',
                    invoiceSentDate: new Date().toISOString().split('T')[0]
                });
            } catch (error) {
                console.error('Error updating invoice status:', error);
                alert('Error updating invoice status. Please try again.');
            }
        };

        // ============================================
        // PROJECT UPDATE FUNCTIONS
        // ============================================

        // Open Add Update Modal
        window.openAddUpdateModal = (projectId) => {
            document.getElementById('updateProjectId').value = projectId;
            document.getElementById('addUpdateModal').classList.add('active');
        };

        // Close Add Update Modal
        window.closeAddUpdateModal = () => {
            document.getElementById('addUpdateModal').classList.remove('active');
            document.getElementById('addUpdateForm').reset();
        };

        // Add Project Update
        document.getElementById('addUpdateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const projectId = document.getElementById('updateProjectId').value;
            const updateText = document.getElementById('updateText').value;
            
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            try {
                const userId = window.currentUser.uid;
                
                // Get existing updates or create new array
                const existingUpdates = project.updates || [];
                
                // Create new update
                const newUpdate = {
                    id: Date.now().toString(),
                    text: updateText,
                    timestamp: new Date().toISOString()
                };
                
                // Add to beginning of array (newest first)
                const updatedUpdates = [...existingUpdates, newUpdate];
                
                // Save to Firebase
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/projects/${projectId}`), {
                    updates: updatedUpdates
                });

                closeAddUpdateModal();
                alert('‚úÖ Update added successfully!');
            } catch (error) {
                console.error('Error adding update:', error);
                alert('Error adding update. Please try again.');
            }
        });

        // Delete Project Update
        window.deleteProjectUpdate = async (projectId, updateId) => {
            if (!confirm('Delete this update?')) return;
            
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            try {
                const userId = window.currentUser.uid;
                
                // Remove the update from the array
                const updatedUpdates = (project.updates || []).filter(u => u.id !== updateId);
                
                // Save to Firebase
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/projects/${projectId}`), {
                    updates: updatedUpdates
                });

                alert('‚úÖ Update deleted successfully!');
            } catch (error) {
                console.error('Error deleting update:', error);
                alert('Error deleting update. Please try again.');
            }
        };

        // Complete Visit Modal
        window.openCompleteVisitModal = (visitId) => {
            document.getElementById('completeVisitId').value = visitId;
            document.getElementById('completeVisitModal').classList.add('active');
            
            // Initialize signature pad after modal is visible
            setTimeout(() => {
                initSignaturePad();
            }, 100);
        };

        window.closeCompleteVisitModal = () => {
            document.getElementById('completeVisitModal').classList.remove('active');
            document.getElementById('completeVisitForm').reset();
            clearSignature();
        };

        // Initialize signature pad
        let signaturePad = null;
        
        function initSignaturePad() {
            const canvas = document.getElementById('signaturePad');
            if (!canvas) return;
            
            signaturePad = canvas.getContext('2d');
            signaturePad.strokeStyle = '#000';
            signaturePad.lineWidth = 2;
            signaturePad.lineCap = 'round';
            
            let lastX = 0;
            let lastY = 0;
            let isDrawing = false;
            
            // Remove old event listeners by cloning the canvas
            const newCanvas = canvas.cloneNode(true);
            canvas.parentNode.replaceChild(newCanvas, canvas);
            const ctx = newCanvas.getContext('2d');
            signaturePad = ctx;
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            // Touch events
            newCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = newCanvas.getBoundingClientRect();
                lastX = touch.clientX - rect.left;
                lastY = touch.clientY - rect.top;
                isDrawing = true;
            });
            
            newCanvas.addEventListener('touchmove', (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const touch = e.touches[0];
                const rect = newCanvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                lastX = x;
                lastY = y;
            });
            
            newCanvas.addEventListener('touchend', () => {
                isDrawing = false;
            });
            
            // Mouse events
            newCanvas.addEventListener('mousedown', (e) => {
                const rect = newCanvas.getBoundingClientRect();
                lastX = e.clientX - rect.left;
                lastY = e.clientY - rect.top;
                isDrawing = true;
            });
            
            newCanvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const rect = newCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                lastX = x;
                lastY = y;
            });
            
            newCanvas.addEventListener('mouseup', () => {
                isDrawing = false;
            });
            
            newCanvas.addEventListener('mouseleave', () => {
                isDrawing = false;
            });
        }

        window.clearSignature = function() {
            const canvas = document.getElementById('signaturePad');
            if (canvas && signaturePad) {
                signaturePad.clearRect(0, 0, canvas.width, canvas.height);
            }
        };

        // Complete Visit Handler
        document.getElementById('completeVisitForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const visitId = document.getElementById('completeVisitId').value;
            const completedBy = document.getElementById('completedBy').value;
            const customerName = document.getElementById('customerName').value;
            
            // Get checklist values
            const workCompleted = {
                weedRemoval: document.getElementById('weedRemoval').checked,
                strimming: document.getElementById('strimming').checked,
                weedSuppressant: document.getElementById('weedSuppressant').checked,
                generalTidy: document.getElementById('generalTidy').checked
            };
            
            const siteNotes = document.getElementById('siteNotes').value;

            // Validate signature
            const canvas = document.getElementById('signaturePad');
            const signatureData = canvas.toDataURL();
            const blankCanvas = document.createElement('canvas');
            blankCanvas.width = canvas.width;
            blankCanvas.height = canvas.height;
            if (signatureData === blankCanvas.toDataURL()) {
                alert('Please get customer signature before completing.');
                return;
            }

            const visit = window.visits.find(v => v.id === visitId);
            if (!visit) return;

            try {
                const userId = window.currentUser.uid;
                
                // Update current visit
                const completedDate = new Date().toISOString().split('T')[0];
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/visits/${visitId}`), {
                    status: 'completed',
                    completedDate: completedDate,
                    completedBy: completedBy,
                    customerName: customerName,
                    customerSignature: signatureData,
                    workCompleted: workCompleted,
                    siteNotes: siteNotes,
                    invoiceStatus: 'pending'
                });

                // Create next visit (unless site is paused)
                const site = window.sites.find(s => s.id === visit.siteId);
                let nextVisitCreated = false;
                
                if (!site || !site.paused) {
                    // Check if custom schedule (frequency = 0)
                    if (visit.frequency === 0) {
                        // Custom schedule - prompt for next visit date
                        const nextDateStr = prompt('This site has a custom schedule.\n\nEnter the date for the NEXT visit (YYYY-MM-DD):\n\nExample: 2026-06-15');
                        
                        if (nextDateStr) {
                            // Validate date format
                            if (!/^\d{4}-\d{2}-\d{2}$/.test(nextDateStr)) {
                                alert('Invalid date format. Next visit not created.\n\nYou can add it manually later.');
                            } else {
                                const nextVisitData = {
                                    siteId: visit.siteId,
                                    siteName: visit.siteName,
                                    siteAddress: visit.siteAddress,
                                    scheduledDate: nextDateStr,
                                    price: visit.price,
                                    frequency: visit.frequency,
                                    status: 'pending',
                                    createdAt: new Date().toISOString()
                                };

                                const nextVisitRef = window.dbPush(window.dbRef(window.database, `users/${userId}/visits`));
                                await window.dbSet(nextVisitRef, nextVisitData);
                                nextVisitCreated = true;
                            }
                        }
                    } else {
                        // Standard frequency - auto-calculate next visit
                        const nextVisitDate = new Date(visit.scheduledDate);
                        nextVisitDate.setDate(nextVisitDate.getDate() + visit.frequency);

                        const nextVisitData = {
                            siteId: visit.siteId,
                            siteName: visit.siteName,
                            siteAddress: visit.siteAddress,
                            scheduledDate: nextVisitDate.toISOString().split('T')[0],
                            price: visit.price,
                            frequency: visit.frequency,
                            status: 'pending',
                            createdAt: new Date().toISOString()
                        };

                        const nextVisitRef = window.dbPush(window.dbRef(window.database, `users/${userId}/visits`));
                        await window.dbSet(nextVisitRef, nextVisitData);
                        nextVisitCreated = true;
                    }
                }

                closeCompleteVisitModal();

                // Prepare email data and open email client
                const visitForEmail = {
                    ...visit,
                    completedDate: completedDate,
                    completedBy: completedBy,
                    customerName: customerName,
                    workCompleted: workCompleted,
                    siteNotes: siteNotes
                };
                
                // Open email client with pre-filled details
                sendInvoiceEmail(visitForEmail);
                
                // Refresh all views
                if (typeof renderVisits === 'function') renderVisits();
                if (typeof renderInvoices === 'function') renderInvoices();
                if (typeof updateStats === 'function') updateStats();
                
                const nextVisitMsg = nextVisitCreated ? '\nüìÖ Next visit scheduled' : '';
                alert(`‚úÖ Visit completed!\nüìß Email opening to office@roundwoodsolutions.co.uk${nextVisitMsg}`);
            } catch (error) {
                console.error('Error completing visit:', error);
                alert('Error completing visit. Please try again.');
            }
        });

        // Mark Invoice Sent
        window.markInvoiceSent = async (visitId) => {
            if (!confirm('Mark this invoice as sent? This will clear it from the tracking list.')) {
                return;
            }

            try {
                const userId = window.currentUser.uid;
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/visits/${visitId}`), {
                    invoiceStatus: 'sent',
                    invoiceSentDate: new Date().toISOString().split('T')[0]
                });
            } catch (error) {
                console.error('Error updating invoice status:', error);
                alert('Error updating invoice status. Please try again.');
            }
        };

        // Render History
        function renderHistory() {
            const container = document.getElementById('historyContainer');
            
            const completedVisits = visits
                .filter(v => v.status === 'completed')
                .sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate))
                .slice(0, 20);

            if (completedVisits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìú</div>
                        <div class="empty-state-title">No history yet</div>
                        <div class="empty-state-text">Completed visits will appear here</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = completedVisits.map(visit => {
                const completedDate = new Date(visit.completedDate);
                const formattedDate = completedDate.toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                });

                const invoiceStatus = visit.invoiceStatus === 'sent' ? 'Invoiced' : 'Awaiting Invoice';
                const invoiceClass = visit.invoiceStatus === 'sent' ? 'status-completed' : 'status-pending';

                return `
                    <div class="visit-card completed">
                        <div class="visit-header">
                            <div>
                                <div class="visit-site">${visit.siteName}</div>
                                <div class="visit-date">${formattedDate}</div>
                            </div>
                            <span class="visit-status ${invoiceClass}">${invoiceStatus}</span>
                        </div>
                        <div class="site-meta" style="margin-top: 1rem;">
                            ${visit.completedBy ? `
                                <div class="meta-item">
                                    <div class="meta-label">Completed By</div>
                                    <div class="meta-value">${visit.completedBy}</div>
                                </div>
                            ` : ''}
                            <div class="meta-item">
                                <div class="meta-label">Amount</div>
                                <div class="meta-value">¬£${visit.price.toFixed(2)}</div>
                            </div>
                            ${visit.completionNotes ? `
                                <div class="meta-item" style="grid-column: 1 / -1;">
                                    <div class="meta-label">Notes</div>
                                    <div class="meta-value">${visit.completionNotes}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }


        // Render Visit Reminders (3 days ahead)
        // Render Due Today on Dashboard
        function renderDueToday() {
            const todayStr = new Date().toISOString().split('T')[0];
            
            // Get today's visits
            const todayVisits = visits
                .filter(v => v.status === 'pending' && !v.hidden && v.scheduledDate === todayStr)
                .map(v => ({ ...v, type: 'visit' }));
            
            // Get today's projects
            const todayProjects = projects
                .filter(p => p.status !== 'completed' && p.startDate === todayStr)
                .map(p => ({ ...p, type: 'project' }));
            
            const todayItems = [...todayVisits, ...todayProjects];
            
            const card = document.getElementById('dueTodayCard');
            const container = document.getElementById('dueTodayContent');
            const badge = document.getElementById('dueTodayBadge');
            
            if (!card || !container) return;
            
            if (todayItems.length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            if (badge) badge.textContent = todayItems.length;
            container.innerHTML = todayItems.map(item => {
                if (item.type === 'project') {
                    return `
                        <div style="padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.75rem; border-left: 3px solid #8b5cf6;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #1f2937;">üìê ${item.projectName}</div>
                                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                        ${item.projectType} ‚Ä¢ ${item.clientName}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #8b5cf6; margin-top: 0.375rem; font-weight: 500;">
                                        ${item.status === 'not-started' ? 'Starting today' : 'In Progress'}
                                    </div>
                                </div>
                                <div>
                                    ${item.status === 'not-started' ? 
                                        `<button class="btn btn-primary" onclick="startProject('${item.id}')" style="font-size: 0.85rem; padding: 0.375rem 0.75rem;">‚ñ∂Ô∏è Start</button>` :
                                        `<button class="btn btn-success" onclick="openCompleteProjectModal('${item.id}')" style="font-size: 0.85rem; padding: 0.375rem 0.75rem;">‚úì Complete</button>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div style="padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.75rem; border-left: 3px solid var(--success);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #1f2937;">${item.siteName}</div>
                                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                        ${item.siteAddress}
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--success); margin-top: 0.375rem; font-weight: 500;">
                                        ¬£${item.price.toFixed(2)}
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-success" onclick="openCompleteVisitModal('${item.id}')" style="font-size: 0.85rem; padding: 0.375rem 0.75rem;">
                                        ‚úì Complete Visit
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Render Active Projects on Dashboard (includes both old Projects AND Pipeline jobs in progress)
        function renderActiveProjects() {
            const card = document.getElementById('activeProjectsCard');
            const container = document.getElementById('activeProjectsContent');
            const badge = document.getElementById('activeProjectsBadge');
            
            if (!card || !container) return;
            
            let allActiveItems = [];
            
            // Add old-style projects
            if (window.projects) {
                const activeProjects = window.projects.filter(p => p.status !== 'completed');
                allActiveItems = allActiveItems.concat(activeProjects.map(p => ({ ...p, source: 'project' })));
            }
            
            // Add pipeline jobs in progress
            if (window.pipelineJobs) {
                const inProgressJobs = window.pipelineJobs.filter(j => j.stage === 'inProgress');
                allActiveItems = allActiveItems.concat(inProgressJobs.map(j => ({ ...j, source: 'pipeline' })));
            }
            
            if (allActiveItems.length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            if (badge) badge.textContent = allActiveItems.length;
            
            container.innerHTML = allActiveItems.map(item => {
                if (item.source === 'project') {
                    // Old-style project display
                    const startDate = new Date(item.startDate);
                    const endDate = new Date(item.expectedEnd);
                    const today = new Date();
                    const daysUntilStart = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
                    const daysUntilEnd = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                    
                    const statusInfo = {
                        'not-started': {
                            bg: '#fef3c7',
                            text: '#92400e',
                            label: daysUntilStart > 0 ? `Starts in ${daysUntilStart} day${daysUntilStart > 1 ? 's' : ''}` : 'Starts today',
                            action: daysUntilStart <= 0 ? `<button class="btn btn-primary" onclick="startProject('${item.id}')" style="font-size: 0.85rem; padding: 0.375rem 0.75rem;">‚ñ∂Ô∏è Start Project</button>` : ''
                        },
                        'in-progress': {
                            bg: '#dbeafe',
                            text: '#1e40af',
                            label: daysUntilEnd > 0 ? `Due in ${daysUntilEnd} day${daysUntilEnd > 1 ? 's' : ''}` : 'Due today',
                            action: `<button class="btn btn-success" onclick="openCompleteProjectModal('${item.id}')" style="font-size: 0.85rem; padding: 0.375rem 0.75rem;">‚úì Complete</button>`
                        }
                    };
                    
                    const status = statusInfo[item.status];
                    
                    return `
                        <div style="padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.75rem; border-left: 3px solid ${status.bg};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #1f2937;">üìê ${item.projectName}</div>
                                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                        ${item.projectType} ‚Ä¢ ${item.clientName}
                                    </div>
                                    <div style="font-size: 0.85rem; color: ${status.text}; margin-top: 0.375rem; font-weight: 500;">
                                        ${status.label}
                                    </div>
                                </div>
                                <div>
                                    ${status.action}
                                </div>
                            </div>
                            <div style="font-size: 0.85rem; color: #9ca3af; margin-top: 0.5rem;">
                                ${startDate.toLocaleDateString('en-GB')} ‚Üí ${endDate.toLocaleDateString('en-GB')} ‚Ä¢ ¬£${item.price.toFixed(2)}
                            </div>
                        </div>
                    `;
                } else {
                    // Pipeline job display
                    return `
                        <div style="padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.75rem; border-left: 3px solid #8b5cf6;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #1f2937;">
                                        üéØ ${item.customerName}
                                        ${item.responsiblePerson ? `<span style="display: inline-block; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">üë§ ${item.responsiblePerson}</span>` : ''}
                                    </div>
                                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                        ${item.projectType} ‚Ä¢ ${item.jobDescription}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #7c3aed; margin-top: 0.375rem; font-weight: 500;">
                                        Work in Progress (Job #${item.jobReference})
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-success" onclick="switchToPipeline('${item.id}')" style="font-size: 0.85rem; padding: 0.375rem 0.75rem;">View in Pipeline</button>
                                </div>
                            </div>
                            ${item.estimatedValue ? `<div style="font-size: 0.85rem; color: #9ca3af; margin-top: 0.5rem;">Est. Value: ¬£${item.estimatedValue.toFixed(2)}</div>` : ''}
                        </div>
                    `;
                }
            }).join('');
        }

        // Switch to pipeline tab and highlight specific job
        window.switchToPipeline = function(jobId) {
            // Switch to pipeline tab
            document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            
            const pipelineLink = document.querySelector('[onclick="switchTab(\'pipeline\')"]');
            const pipelinePane = document.getElementById('pipeline');
            
            if (pipelineLink) pipelineLink.classList.add('active');
            if (pipelinePane) pipelinePane.classList.add('active');
            
            // Scroll to top
            window.scrollTo(0, 0);
        };

        // Render Visit Reminders
        function renderVisitReminders() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            const threeDaysFromNow = new Date(today);
            threeDaysFromNow.setDate(today.getDate() + 3);
            const threeDaysStr = threeDaysFromNow.toISOString().split('T')[0];
            
            // Get visits between tomorrow and 3 days from now
            const upcomingVisits = visits
                .filter(v => {
                    if (v.status !== 'pending' || v.hidden) return false;
                    return v.scheduledDate > todayStr && v.scheduledDate <= threeDaysStr;
                })
                .sort((a, b) => a.siteName.localeCompare(b.siteName));
            
            const card = document.getElementById('visitRemindersCard');
            const container = document.getElementById('visitRemindersContent');
            const badge = document.getElementById('remindersBadge');
            
            if (upcomingVisits.length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            if (badge) badge.textContent = upcomingVisits.length;
            container.innerHTML = upcomingVisits.map(visit => {
                const daysUntil = Math.ceil((new Date(visit.scheduledDate) - today) / (1000 * 60 * 60 * 24));
                return `
                <div style="padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #f59e0b;">
                    <div>
                        <div style="font-weight: 600; color: #92400e;">${visit.siteName}</div>
                        <div style="font-size: 0.875rem; color: #78350f; margin-top: 0.25rem;">
                            ${visit.siteAddress}
                        </div>
                        <div style="font-size: 0.85rem; color: #a16207; margin-top: 0.25rem;">
                            üìÖ ${new Date(visit.scheduledDate).toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' })} (in ${daysUntil} day${daysUntil > 1 ? 's' : ''})
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="sendCourtesyReminder('${visit.siteName}', '${visit.siteAddress}', '${visit.scheduledDate}')" style="font-size: 0.875rem; white-space: nowrap;">
                        üìß Send Reminder
                    </button>
                </div>
            `;
            }).join('');
        }

        // Send Courtesy Reminder Email
        window.sendCourtesyReminder = function(siteName, siteAddress, visitDate) {
            const formattedDate = new Date(visitDate).toLocaleDateString('en-GB', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long',
                year: 'numeric'
            });
            
            const emailSubject = `Roundwood Solutions - Upcoming Visit on ${formattedDate}`;
            
            const emailBody = `
Good morning,

This is a courtesy reminder that we have a scheduled grounds maintenance visit to ${siteName} on:

üìÖ ${formattedDate}

Our team will be on-site to complete the scheduled maintenance work as per our agreement.

If you have any specific requirements or concerns for this visit, please let us know.

Many thanks,

Ben Brice
Director
Roundwood Solutions Limited

üìû 07545 642021
üìß office@roundwoodsolutions.co.uk
üåê www.roundwoodsolutions.co.uk
            `.trim();

            const mailto = `mailto:?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
            window.location.href = mailto;
            
            alert('‚úÖ Courtesy reminder email opened!\n\nAdd the client contact email and send.');
        };

        // Render Next Due Visits (Next 7 days + Overdue)
        // Update Stats
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            
            // Count invoices from both pipeline and visits
            let totalNeedsInvoice = 0;
            
            if (window.pipelineJobs) {
                const pipelineInvoices = window.pipelineJobs.filter(j => j.stage === 'complete' || j.stage === 'invoiced').length;
                totalNeedsInvoice += pipelineInvoices;
                
                // Update pipeline count
                const pipelineCount = window.pipelineJobs.length;
                const pipelineBadge = document.getElementById('pipelineCount');
                if (pipelineBadge) {
                    pipelineBadge.textContent = pipelineCount;
                }
            }
            
            if (window.visits) {
                // Count upcoming visits with smart filtering
                // Projects: ALL scheduled projects
                // Maintenance: Only NEXT visit for each site
                
                const pendingVisits = window.visits.filter(v => {
                    if (v.status === 'completed') return false;
                    if (v.paused === true) return false;
                    
                    // Check if parent site is paused
                    if (window.sites && v.siteId) {
                        const parentSite = window.sites.find(s => s.id === v.siteId);
                        if (parentSite && parentSite.paused === true) return false;
                    }
                    
                    return true;
                });
                
                // Separate into projects and maintenance
                const projectVisits = pendingVisits.filter(v => v.pipelineJobId);
                const maintenanceVisits = pendingVisits.filter(v => !v.pipelineJobId);
                
                // For maintenance: only count NEXT visit per site
                const siteVisitMap = {};
                maintenanceVisits.forEach(visit => {
                    if (!visit.siteId) return;
                    
                    if (!siteVisitMap[visit.siteId]) {
                        siteVisitMap[visit.siteId] = visit;
                    } else {
                        const existing = siteVisitMap[visit.siteId];
                        if (new Date(visit.scheduledDate) < new Date(existing.scheduledDate)) {
                            siteVisitMap[visit.siteId] = visit;
                        }
                    }
                });
                
                const nextMaintenanceCount = Object.keys(siteVisitMap).length;
                const totalUpcoming = projectVisits.length + nextMaintenanceCount;
                
                const upcomingBadge = document.getElementById('upcomingCount');
                if (upcomingBadge) {
                    upcomingBadge.textContent = totalUpcoming;
                }
                
                // Count completed visits not yet invoiced
                const visitInvoices = window.visits.filter(v => v.status === 'completed' && !v.invoiced).length;
                totalNeedsInvoice += visitInvoices;
            }
            
            // Update invoice badge
            const uninvoicedBadge = document.getElementById('uninvoicedCount');
            if (uninvoicedBadge) {
                uninvoicedBadge.textContent = totalNeedsInvoice;
            }
            
            // Update legacy project count if element exists
            if (window.projects) {
                const activeProjects = window.projects.filter(p => p.status !== 'completed').length;
                const projectBadge = document.getElementById('projectsCount');
                if (projectBadge) {
                    projectBadge.textContent = activeProjects;
                }
            }
            
            // Update dashboard content - only if functions exist
            if (typeof renderSeasonalTips === 'function') renderSeasonalTips();
            if (typeof renderMonthlyUpsells === 'function') renderMonthlyUpsells();
            if (typeof renderActiveProjects === 'function') renderActiveProjects();
            if (typeof renderDueToday === 'function') renderDueToday();
            if (typeof renderVisitReminders === 'function') renderVisitReminders();
            if (typeof renderCalendar === 'function') renderCalendar();
        }

        // ============================================
        // CALENDAR FUNCTIONS
        // ============================================

        let currentCalendarDate = new Date();

        // Calculate shift pattern (2 days, 2 nights, 4 off starting Jan 21, 2026)
        function getShiftForDate(date) {
            const startDate = new Date(2026, 0, 21); // Jan 21, 2026
            const daysSinceStart = Math.floor((date - startDate) / (1000 * 60 * 60 * 24));
            
            if (daysSinceStart < 0) return null; // Before shift pattern starts
            
            const cycleDay = daysSinceStart % 8; // 8-day cycle: 2D, 2N, 4Off
            
            if (cycleDay === 0 || cycleDay === 1) return 'D'; // Days 0-1: Day shift
            if (cycleDay === 2 || cycleDay === 3) return 'N'; // Days 2-3: Night shift
            return null; // Days 4-7: Off
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update title
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonthTitle').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // Get first day of week (0 = Sunday, adjust to Monday = 0)
            let startingDayOfWeek = firstDay.getDay();
            startingDayOfWeek = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1; // Convert to Monday = 0
            
            // Get days from previous month
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            const prevMonthDays = [];
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                prevMonthDays.push(prevMonthLastDay - i);
            }
            
            // Build calendar grid
            let html = '<div class="calendar-grid-wrapper"><div class="calendar-grid">';
            
            // Day headers
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Previous month days
            prevMonthDays.forEach(day => {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            });
            
            // Current month days
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                currentDate.setHours(0, 0, 0, 0);
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const isToday = currentDate.getTime() === today.getTime();
                const shift = getShiftForDate(currentDate);
                
                // Get events for this day
                const events = getEventsForDate(dateStr, currentDate);
                
                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' today';
                
                html += `<div class="${dayClass}">`;
                
                // Shift badge
                if (shift) {
                    const shiftClass = shift === 'N' ? 'night' : '';
                    html += `<div class="shift-badge ${shiftClass}">${shift}</div>`;
                }
                
                html += `<div class="calendar-day-number">${day}</div>`;
                
                // Events
                events.forEach(event => {
                    const clickHandler = event.isCalendarEvent ? `onclick="editCalendarEvent('${event.id}')" style="cursor: pointer;"` : '';
                    html += `<div class="calendar-event ${event.type}" ${clickHandler}>${event.icon} ${event.title}</div>`;
                });
                
                html += '</div>';
            }
            
            // Next month days to fill the grid
            const totalCells = prevMonthDays.length + daysInMonth;
            const remainingCells = 7 - (totalCells % 7);
            if (remainingCells < 7) {
                for (let day = 1; day <= remainingCells; day++) {
                    html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
                }
            }
            
            html += '</div></div>';
            
            document.getElementById('calendarContainer').innerHTML = html;
        }

        function getEventsForDate(dateStr, date) {
            const events = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Get maintenance visits
            if (window.visits) {
                window.visits.forEach(visit => {
                    if (visit.scheduledDate === dateStr && visit.status !== 'completed') {
                        // Skip if visit itself is paused
                        if (visit.paused === true) return;
                        
                        // Skip if parent site is paused
                        if (window.sites && visit.siteId) {
                            const parentSite = window.sites.find(s => s.id === visit.siteId);
                            if (parentSite && parentSite.paused === true) return;
                        }
                        
                        const isOverdue = date < today;
                        events.push({
                            type: visit.pipelineJobId ? 'project' : (isOverdue ? 'overdue' : 'maintenance'),
                            icon: visit.pipelineJobId ? 'üéØ' : (isOverdue ? '‚ö†Ô∏è' : 'üîß'),
                            title: visit.siteName || visit.customerName || 'Visit'
                        });
                    }
                });
            }
            
            // Get calendar events/holidays
            if (window.calendarEvents) {
                window.calendarEvents.forEach(event => {
                    // Handle both old single-date events and new date-range events
                    const eventStartDate = event.startDate || event.date;
                    const eventEndDate = event.endDate || event.date;
                    
                    // Check if current date is within event range
                    if (eventStartDate && eventEndDate && dateStr >= eventStartDate && dateStr <= eventEndDate) {
                        let icon = 'üèñÔ∏è';
                        let type = 'holiday';
                        
                        if (event.type === 'bankholiday') {
                            icon = 'üéÑ';
                            type = 'holiday';
                        } else if (event.type === 'office') {
                            icon = 'üè¢';
                            type = 'holiday';
                        } else if (event.type === 'reminder') {
                            icon = '‚ÑπÔ∏è';
                            type = 'holiday';
                        }
                        
                        events.push({
                            type: type,
                            icon: icon,
                            title: event.title,
                            id: event.id,
                            isCalendarEvent: true
                        });
                    }
                });
            }
            
            // Get project durations from pipeline jobs with scheduled work
            if (window.pipelineJobs && window.visits) {
                window.pipelineJobs.forEach(job => {
                    // Find if this job has a scheduled visit
                    const jobVisit = window.visits.find(v => v.pipelineJobId === job.id && v.status !== 'completed');
                    
                    if (jobVisit && job.estimatedEndDate) {
                        const startDate = jobVisit.scheduledDate;
                        const endDate = job.estimatedEndDate;
                        
                        // Check if current date is within project duration
                        if (dateStr >= startDate && dateStr <= endDate) {
                            // Don't duplicate if already added as a visit
                            const alreadyAdded = events.some(e => e.title === (job.customerName || 'Project'));
                            if (!alreadyAdded) {
                                events.push({
                                    type: 'project',
                                    icon: 'üéØ',
                                    title: job.customerName || 'Project'
                                });
                            }
                        }
                    }
                });
            }
            
            return events;
        }

        window.navigateCalendar = function(direction) {
            if (direction === 'prev') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            } else if (direction === 'next') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            } else if (direction === 'today') {
                currentCalendarDate = new Date();
            }
            renderCalendar();
        };

        // ============================================
        // EVENT/HOLIDAY MANAGEMENT FUNCTIONS
        // ============================================

        window.calendarEvents = [];

        // Open/Close Event Modal
        window.openAddEventModal = function() {
            document.getElementById('addEventModal').classList.add('active');
            // Set default dates to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('eventStartDate').value = today;
            document.getElementById('eventEndDate').value = today;
        };

        window.closeAddEventModal = function() {
            document.getElementById('addEventModal').classList.remove('active');
            document.getElementById('addEventForm').reset();
        };

        // Add Event Form Handler
        document.getElementById('addEventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('eventTitle').value;
            const startDate = document.getElementById('eventStartDate').value;
            const endDate = document.getElementById('eventEndDate').value;
            const type = document.getElementById('eventType').value;
            const notes = document.getElementById('eventNotes').value;
            
            // Validate dates
            if (new Date(endDate) < new Date(startDate)) {
                alert('End date cannot be before start date!');
                return;
            }
            
            try {
                const userId = window.currentUser.uid;
                const eventsRef = window.dbRef(window.database, `users/${userId}/calendarEvents`);
                
                // Create a single event with start and end dates
                const newEventRef = window.dbPush(eventsRef);
                
                await window.dbSet(newEventRef, {
                    title: title,
                    startDate: startDate,
                    endDate: endDate,
                    type: type,
                    notes: notes,
                    createdAt: new Date().toISOString()
                });
                
                const dayCount = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
                alert(`‚úÖ Event "${title}" added to calendar!\n${dayCount} day${dayCount > 1 ? 's' : ''}: ${new Date(startDate).toLocaleDateString('en-GB')} - ${new Date(endDate).toLocaleDateString('en-GB')}`);
                closeAddEventModal();
                
            } catch (error) {
                console.error('Error adding event:', error);
                alert('Error adding event');
            }
        });

        // Edit Event Functions
        window.editCalendarEvent = function(eventId) {
            const event = window.calendarEvents.find(e => e.id === eventId);
            if (!event) {
                alert('Event not found');
                return;
            }
            
            // Populate edit form
            document.getElementById('editEventId').value = eventId;
            document.getElementById('editEventTitle').value = event.title || '';
            document.getElementById('editEventStartDate').value = event.startDate || event.date || '';
            document.getElementById('editEventEndDate').value = event.endDate || event.date || '';
            document.getElementById('editEventType').value = event.type || 'holiday';
            document.getElementById('editEventNotes').value = event.notes || '';
            
            // Open edit modal
            document.getElementById('editEventModal').classList.add('active');
        };
        
        window.closeEditEventModal = function() {
            document.getElementById('editEventModal').classList.remove('active');
            document.getElementById('editEventForm').reset();
        };
        
        // Handle Edit Event Form
        document.getElementById('editEventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const eventId = document.getElementById('editEventId').value;
            const title = document.getElementById('editEventTitle').value;
            const startDate = document.getElementById('editEventStartDate').value;
            const endDate = document.getElementById('editEventEndDate').value;
            const type = document.getElementById('editEventType').value;
            const notes = document.getElementById('editEventNotes').value;
            
            // Validate dates
            if (new Date(endDate) < new Date(startDate)) {
                alert('End date cannot be before start date!');
                return;
            }
            
            try {
                const userId = window.currentUser.uid;
                const eventRef = window.dbRef(window.database, `users/${userId}/calendarEvents/${eventId}`);
                
                await window.dbUpdate(eventRef, {
                    title: title,
                    startDate: startDate,
                    endDate: endDate,
                    type: type,
                    notes: notes
                });
                
                alert('‚úÖ Event updated successfully!');
                closeEditEventModal();
                
            } catch (error) {
                console.error('Error updating event:', error);
                alert('Error updating event');
            }
        });
        
        // Delete Event
        window.deleteEvent = async function() {
            const eventId = document.getElementById('editEventId').value;
            
            if (!confirm('Delete this event?')) return;
            
            try {
                const userId = window.currentUser.uid;
                const eventRef = window.dbRef(window.database, `users/${userId}/calendarEvents/${eventId}`);
                await window.dbRemove(eventRef);
                alert('‚úÖ Event deleted');
                closeEditEventModal();
            } catch (error) {
                console.error('Error deleting event:', error);
                alert('Error deleting event');
            }
        };

        // ============================================
        // REVIEW REQUEST FUNCTIONS
        // ============================================
        
        function sendReviewRequest(customerEmail, customerName, siteName, business) {
            let emailSubject, emailBody;
            
            if (business === 'weedcontrol') {
                // Weed Control Kent template
                emailSubject = 'How was our weed control service at ' + siteName + '?';
                
                emailBody = `
Hi ${customerName},

Thank you for choosing Weed Control Kent for your professional weed control at ${siteName}.

We'd really appreciate it if you could take 2 minutes to leave us a review on Google. Your feedback helps us improve and helps other property managers find reliable weed control services.

Leave a review here:
https://g.page/r/CUIoA0XVVFhTEAI/review

Thank you for your time and trust in our services.

Best regards,

Ben Brice
Director
Weed Control Kent

üìû 07545 642021
üìß office@roundwoodsolutions.co.uk
üåê www.weedcontrolkent.co.uk

üåø Professional Weed Control Services Across Kent
                `.trim();
            } else {
                // Roundwood Solutions template
                emailSubject = 'How was our service at ' + siteName + '?';
                
                emailBody = `
Hi ${customerName},

Thank you for choosing Roundwood Solutions for your grounds maintenance at ${siteName}.

We'd really appreciate it if you could take 2 minutes to leave us a review on Google. Your feedback helps us improve and helps other businesses find quality grounds maintenance services.

Leave a review here:
https://g.page/r/CW43cOg5aYctEBE/review

Thank you for your time and trust in our services.

Best regards,

Ben Brice
Director
Roundwood Solutions Limited

üìû 07545 642021
üìß office@roundwoodsolutions.co.uk
üåê www.roundwoodsolutions.co.uk

üå≥ Commercial Landscaping and Grounds Maintenance
                `.trim();
            }

            const mailto = `mailto:${customerEmail}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
            
            return mailto;
        }

        // Update email preview when business changes
        document.getElementById('reviewBusiness').addEventListener('change', (e) => {
            const previewText = document.getElementById('emailPreviewText');
            if (e.target.value === 'weedcontrol') {
                previewText.textContent = 'The customer will receive a professional email thanking them for choosing Weed Control Kent and asking them to leave a Google review.';
            } else {
                previewText.textContent = 'The customer will receive a professional email thanking them for choosing Roundwood Solutions and asking them to leave a Google review.';
            }
        });

        // Send Review Request Form
        document.getElementById('sendReviewForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const customerName = document.getElementById('reviewCustomerName').value;
            const customerEmail = document.getElementById('reviewCustomerEmail').value;
            const siteName = document.getElementById('reviewSiteName').value;
            const business = document.getElementById('reviewBusiness').value;
            
            const reviewLink = sendReviewRequest(customerEmail, customerName, siteName, business);
            window.location.href = reviewLink;
            
            const userId = window.currentUser.uid;
            const reviewData = {
                customerName: customerName,
                customerEmail: customerEmail,
                siteName: siteName,
                business: business,
                sentDate: new Date().toISOString(),
                sentBy: window.currentUser.email
            };
            
            try {
                // Save review request
                const reviewRef = window.dbPush(window.dbRef(window.database, `users/${userId}/reviewRequests`));
                await window.dbSet(reviewRef, reviewData);
                
                // Find and update matching pipeline job (paid jobs with same customer email)
                if (customerEmail && window.pipelineJobs) {
                    const matchingJob = window.pipelineJobs.find(job => 
                        job.stage === 'paid' && 
                        job.customerEmail && 
                        job.customerEmail.toLowerCase() === customerEmail.toLowerCase()
                    );
                    
                    if (matchingJob) {
                        const jobRef = window.dbRef(window.database, `users/${userId}/pipelineJobs/${matchingJob.id}`);
                        await window.dbUpdate(jobRef, {
                            reviewRequested: true,
                            reviewRequestedDate: new Date().toISOString()
                        });
                        console.log('Updated pipeline job with review request flag');
                    }
                }
                
                document.getElementById('sendReviewForm').reset();
                alert('‚úÖ Review request email opened!\n\nSend the email from your email client to complete.');
                loadReviewHistory();
            } catch (error) {
                console.error('Error saving review request:', error);
                alert('Error saving review request. Please try again.');
            }
        });

        // Load Review History
        function loadReviewHistory() {
            if (!window.currentUser) return;
            
            const userId = window.currentUser.uid;
            const reviewsRef = window.dbRef(window.database, `users/${userId}/reviewRequests`);
            
            window.dbOnValue(reviewsRef, (snapshot) => {
                const container = document.getElementById('reviewHistoryContainer');
                const reviews = [];
                
                snapshot.forEach((childSnapshot) => {
                    reviews.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                if (reviews.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚≠ê</div>
                            <div class="empty-state-text">No review requests sent yet</div>
                        </div>
                    `;
                    return;
                }
                
                reviews.sort((a, b) => new Date(b.sentDate) - new Date(a.sentDate));
                const recentReviews = reviews.slice(0, 10);
                
                container.innerHTML = recentReviews.map(review => {
                    const businessIcon = review.business === 'weedcontrol' ? 'üåø' : 'üå≥';
                    const businessName = review.business === 'weedcontrol' ? 'Weed Control Kent' : 'Roundwood Solutions';
                    
                    return `
                    <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 600;">${review.customerName}</div>
                                <div style="font-size: 0.9rem; color: var(--gray-600);">${review.customerEmail}</div>
                                <div style="font-size: 0.85rem; color: var(--gray-500); margin-top: 0.25rem;">
                                    Site: ${review.siteName}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--primary); margin-top: 0.25rem; font-weight: 500;">
                                    ${businessIcon} ${businessName}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.85rem; color: var(--gray-500);">
                                    ${new Date(review.sentDate).toLocaleDateString('en-GB')}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--gray-400);">
                                    by ${review.sentBy}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
            });
        }

        // ============================================
        // CALCULATOR FUNCTIONS
        // ============================================
        
        function calculate() {
            const seconds = parseFloat(document.getElementById('seconds').value) || 90;
            const nozzleOutput = parseFloat(document.getElementById('nozzleOutput').value) || 0;
            const stripWidth = parseFloat(document.getElementById('stripWidth').value) || 1;
            const sprayerCapacity = parseFloat(document.getElementById('sprayerCapacity').value) || 15;
            const chemicalRate = parseFloat(document.getElementById('chemicalRate').value) || 0;
            const area = parseFloat(document.getElementById('area').value) || 0;

            const walkingSpeed = 360 / seconds;
            document.getElementById('walkingSpeed').innerHTML = walkingSpeed.toFixed(2) + '<span class="calc-unit">KPH</span>';

            const sprayerOutput = (600 * nozzleOutput) / stripWidth / walkingSpeed;
            document.getElementById('sprayerOutput').innerHTML = sprayerOutput.toFixed(2) + '<span class="calc-unit">L/ha</span>';

            const tanksPerHa = sprayerOutput / sprayerCapacity;
            document.getElementById('tanksPerHa').innerHTML = tanksPerHa.toFixed(2) + '<span class="calc-unit">tanks</span>';

            const chemicalPerTank = tanksPerHa > 0 ? (chemicalRate * 1000) / tanksPerHa : 0;
            document.getElementById('chemicalPerTank').innerHTML = chemicalPerTank.toFixed(2) + '<span class="calc-unit">mls</span>';

            const totalChemical = (chemicalRate / 10000) * area;
            document.getElementById('totalChemical').innerHTML = totalChemical.toFixed(3) + '<span class="calc-unit">litres</span>';

            const totalWater = (sprayerOutput / 10000) * area - totalChemical;
            document.getElementById('totalWater').innerHTML = totalWater.toFixed(2) + '<span class="calc-unit">litres</span>';
        }

        setTimeout(() => {
            const inputs = ['seconds', 'nozzleOutput', 'stripWidth', 'sprayerCapacity', 'chemicalRate', 'area'];
            inputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', calculate);
                }
            });
        }, 1000);

        window.saveCalculation = async function() {
            if (!window.currentUser) {
                alert('Please sign in to save calculations');
                return;
            }

            const calcName = document.getElementById('calcName').value || 'Unnamed Calculation';
            const nozzleOutput = parseFloat(document.getElementById('nozzleOutput').value) || 0;

            if (nozzleOutput === 0) {
                alert('Please enter nozzle output');
                return;
            }

            const calculation = {
                name: calcName,
                timestamp: Date.now(),
                date: new Date().toLocaleDateString(),
                inputs: {
                    seconds: parseFloat(document.getElementById('seconds').value),
                    nozzleOutput: nozzleOutput,
                    stripWidth: parseFloat(document.getElementById('stripWidth').value),
                    sprayerCapacity: parseFloat(document.getElementById('sprayerCapacity').value),
                    chemicalRate: parseFloat(document.getElementById('chemicalRate').value),
                    area: parseFloat(document.getElementById('area').value)
                },
                results: {
                    walkingSpeed: parseFloat(document.getElementById('walkingSpeed').textContent),
                    sprayerOutput: parseFloat(document.getElementById('sprayerOutput').textContent),
                    tanksPerHa: parseFloat(document.getElementById('tanksPerHa').textContent),
                    chemicalPerTank: parseFloat(document.getElementById('chemicalPerTank').textContent),
                    totalChemical: parseFloat(document.getElementById('totalChemical').textContent),
                    totalWater: parseFloat(document.getElementById('totalWater').textContent)
                }
            };

            try {
                await window.dbSet(window.dbPush(window.dbRef(window.database, `users/${window.currentUser.uid}/calibrations`)), calculation);
                alert('Calculation saved successfully!');
                document.getElementById('calcName').value = '';
                loadSavedCalculations();
            } catch (error) {
                alert('Error saving calculation: ' + error.message);
            }
        };

        function loadSavedCalculations() {
            if (!window.currentUser) return;

            const listDiv = document.getElementById('savedCalcsList');
            listDiv.innerHTML = '<div class="loading">Loading...</div>';

            window.dbOnValue(window.dbRef(window.database, `users/${window.currentUser.uid}/calibrations`), (snapshot) => {
                const calcs = [];
                snapshot.forEach((child) => {
                    calcs.push({ id: child.key, ...child.val() });
                });

                calcs.reverse();

                if (calcs.length === 0) {
                    listDiv.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">No saved calculations yet</p>';
                    return;
                }

                listDiv.innerHTML = calcs.map(calc => `
                    <div class="saved-calc-item" onclick="loadCalculation('\${calc.id}')">
                        <div class="saved-calc-header">
                            <div class="saved-calc-title">\${calc.name}</div>
                            <div class="saved-calc-date">\${calc.date}</div>
                        </div>
                        <div class="saved-calc-details">
                            <div>Nozzle: \${calc.inputs.nozzleOutput} LPM</div>
                            <div>Chemical: \${calc.inputs.chemicalRate} L/ha</div>
                            <div>Area: \${calc.inputs.area} m¬≤</div>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--primary); font-weight: 600;">
                            Total Chemical: \${calc.results.totalChemical.toFixed(3)}L | Water: \${calc.results.totalWater.toFixed(2)}L
                        </div>
                        <button class="btn btn-danger" style="margin-top: 0.5rem; padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="event.stopPropagation(); deleteCalculation('\${calc.id}')">Delete</button>
                    </div>
                `).join('');
            });
        }

        window.loadCalculation = function(calcId) {
            window.dbGet(window.dbRef(window.database, `users/${window.currentUser.uid}/calibrations/${calcId}`)).then((snapshot) => {
                const calc = snapshot.val();
                if (!calc) return;

                document.getElementById('calcName').value = calc.name;
                document.getElementById('seconds').value = calc.inputs.seconds;
                document.getElementById('nozzleOutput').value = calc.inputs.nozzleOutput;
                document.getElementById('stripWidth').value = calc.inputs.stripWidth;
                document.getElementById('sprayerCapacity').value = calc.inputs.sprayerCapacity;
                document.getElementById('chemicalRate').value = calc.inputs.chemicalRate;
                document.getElementById('area').value = calc.inputs.area;

                calculate();
                window.scrollTo(0, 0);
                alert('Calculation loaded successfully!');
            });
        };

        window.deleteCalculation = async function(calcId) {
            if (!confirm('Are you sure you want to delete this calculation?')) return;

            try {
                await window.dbRemove(window.dbRef(window.database, `users/${window.currentUser.uid}/calibrations/${calcId}`));
                alert('Calculation deleted');
                loadSavedCalculations();
            } catch (error) {
                alert('Error deleting calculation: ' + error.message);
            }
        };

        window.resetCalculator = function() {
            document.getElementById('calcName').value = '';
            document.getElementById('seconds').value = 90;
            document.getElementById('nozzleOutput').value = '';
            document.getElementById('stripWidth').value = 1;
            document.getElementById('sprayerCapacity').value = 15;
            document.getElementById('chemicalRate').value = '';
            document.getElementById('area').value = '';
            calculate();
        };

        // ========================================
        // PIPELINE MODAL FUNCTIONS
        // ========================================

        window.openAddPipelineJobModal = function() {
            document.getElementById('addPipelineJobModal')?.classList.add('active');
        };

        window.closeAddPipelineJobModal = function() {
            document.getElementById('addPipelineJobModal')?.classList.remove('active');
            document.getElementById('addPipelineJobForm')?.reset();
            // Hide custom deadline field when modal closes
            document.getElementById('customDeadlineContainer').style.display = 'none';
            // Reset to default 1 week option
            document.getElementById('pipelineDeadlineType').value = '1week';
        };

        // Toggle custom deadline date field
        window.toggleCustomDeadlineDate = function() {
            const deadlineType = document.getElementById('pipelineDeadlineType').value;
            const customContainer = document.getElementById('customDeadlineContainer');
            const customDateInput = document.getElementById('pipelineCustomDeadline');
            
            if (deadlineType === 'custom') {
                customContainer.style.display = 'block';
                customDateInput.required = true;  // Make required when custom selected
            } else {
                customContainer.style.display = 'none';
                customDateInput.required = false; // Not required for other options
                customDateInput.value = ''; // Clear value
            }
        };

        // Request review for a paid job
        window.requestReviewForJob = async function(jobId) {
            const job = window.pipelineJobs.find(j => j.id === jobId);
            if (!job) {
                alert('Job not found');
                return;
            }

            // Navigate to Reviews tab
            showTab('reviews');

            // Pre-fill the review request form
            setTimeout(() => {
                // Determine which business
                const businessSelect = document.getElementById('reviewBusiness');
                if (businessSelect) {
                    // Default to roundwood, could be made smarter based on project type
                    businessSelect.value = 'roundwood';
                }

                // Fill customer details
                if (job.customerName) {
                    document.getElementById('reviewCustomerName').value = job.customerName;
                }
                if (job.customerEmail) {
                    document.getElementById('reviewCustomerEmail').value = job.customerEmail;
                }
                
                // Use job description as site name if available
                const siteName = job.jobDescription || `Job #${job.jobReference}`;
                document.getElementById('reviewSiteName').value = siteName;

                // Scroll to form
                document.getElementById('reviewCustomerName')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        };

        window.openSendQuoteModal = function(jobId) {
            currentPipelineJobId = jobId;
            const job = window.pipelineJobs.find(j => j.id === jobId);
            
            if (job) {
                document.getElementById('quoteJobInfo').textContent = `Job Ref: ${job.jobReference} - ${job.customerName} - ${job.jobDescription}`;
                document.getElementById('quoteDate').value = getTodayDate();
                document.getElementById('quoteValidUntil').value = getDatePlusDays(30);
                
                if (job.quoteAmount) {
                    document.getElementById('quoteAmount').value = job.quoteAmount;
                }
                
                document.getElementById('sendQuoteModal')?.classList.add('active');
            }
        };

        window.closeSendQuoteModal = function() {
            document.getElementById('sendQuoteModal')?.classList.remove('active');
            document.getElementById('sendQuoteForm')?.reset();
            currentPipelineJobId = null;
        };

        window.openMarkApprovedModal = function(jobId) {
            currentPipelineJobId = jobId;
            const job = window.pipelineJobs.find(j => j.id === jobId);
            
            if (job) {
                document.getElementById('approvedJobInfo').textContent = `Job Ref: ${job.jobReference} - ${job.customerName} - ¬£${parseFloat(job.quoteAmount).toFixed(2)}`;
                document.getElementById('markApprovedModal')?.classList.add('active');
            }
        };

        window.closeMarkApprovedModal = function() {
            document.getElementById('markApprovedModal')?.classList.remove('active');
            document.getElementById('markApprovedForm')?.reset();
            currentPipelineJobId = null;
        };

        window.openCompleteWorkModal = function(jobId) {
            currentPipelineJobId = jobId;
            const job = window.pipelineJobs.find(j => j.id === jobId);
            
            if (job) {
                document.getElementById('completeJobInfo').textContent = `Job Ref: ${job.jobReference} - ${job.customerName}`;
                document.getElementById('completionDate').value = getTodayDate();
                document.getElementById('completeWorkModal')?.classList.add('active');
            }
        };

        window.closeCompleteWorkModal = function() {
            document.getElementById('completeWorkModal')?.classList.remove('active');
            document.getElementById('completeWorkForm')?.reset();
            currentPipelineJobId = null;
        };

        window.openSendInvoiceModal = async function(jobId) {
            currentPipelineJobId = jobId;
            const job = window.pipelineJobs.find(j => j.id === jobId);
            
            if (job) {
                document.getElementById('invoiceJobInfo').textContent = `Job Ref: ${job.jobReference} - ${job.customerName} - ¬£${parseFloat(job.quoteAmount).toFixed(2)}`;
                
                const nextInvoiceNum = await getNextInvoiceNumber();
                document.getElementById('invoiceNumber').value = nextInvoiceNum;
                document.getElementById('invoiceDate').value = getTodayDate();
                document.getElementById('paymentDue').value = getDatePlusDays(14);
                document.getElementById('finalAmount').value = job.quoteAmount || '';
                
                document.getElementById('sendInvoiceModal')?.classList.add('active');
            }
        };

        window.closeSendInvoiceModal = function() {
            document.getElementById('sendInvoiceModal')?.classList.remove('active');
            document.getElementById('sendInvoiceForm')?.reset();
            currentPipelineJobId = null;
        };

        window.openMarkPaidModal = function(jobId) {
            currentPipelineJobId = jobId;
            const job = window.pipelineJobs.find(j => j.id === jobId);
            
            if (job) {
                document.getElementById('paidJobInfo').textContent = `Job Ref: ${job.jobReference} - Invoice: ${job.invoiceNumber} - ¬£${parseFloat(job.quoteAmount).toFixed(2)}`;
                document.getElementById('paymentDate').value = getTodayDate();
                document.getElementById('markPaidModal')?.classList.add('active');
            }
        };

        window.closeMarkPaidModal = function() {
            document.getElementById('markPaidModal')?.classList.remove('active');
            document.getElementById('markPaidForm')?.reset();
            currentPipelineJobId = null;
        };

        window.toggleApprovalFields = function() {
            const requiresApproval = document.getElementById('requiresApproval')?.value;
            const approvalFields = document.getElementById('approvalFields');
            
            if (approvalFields) {
                approvalFields.style.display = requiresApproval === 'yes' ? 'block' : 'none';
            }
        };

        // ========================================
        // PIPELINE HELPER FUNCTIONS
        // ========================================

        // Get next job reference number
        async function getNextJobReference() {
            try {
                const userId = window.currentUser.uid;
                const jobsRef = window.dbRef(window.database, `users/${userId}/pipelineJobs`);
                const snapshot = await window.dbGet(jobsRef);
                
                if (!snapshot.exists()) {
                    return 101; // Start at 101
                }
                
                const jobs = snapshot.val();
                let maxRef = 100;
                
                Object.values(jobs).forEach(job => {
                    const ref = parseInt(job.jobReference);
                    if (!isNaN(ref) && ref > maxRef) {
                        maxRef = ref;
                    }
                });
                
                return maxRef + 1;
            } catch (error) {
                console.error('Error getting next job reference:', error);
                return 101; // Default to 101 if error
            }
        }

        // ========================================
        // PIPELINE ACTION FUNCTIONS
        // ========================================
        
        window.markAsQuoteSent = async function(jobId) {
            try {
                const job = window.pipelineJobs.find(j => j.id === jobId);
                if (!job) {
                    alert('Job not found');
                    return;
                }
                
                // Prompt for quote price
                const defaultPrice = job.estimatedValue || '';
                const quotePriceStr = prompt(`Enter the QUOTED PRICE for ${job.customerName}:\n\n(Estimated value: ¬£${job.estimatedValue || 'Not set'})`, defaultPrice);
                
                if (quotePriceStr === null) return; // User cancelled
                
                const quotePrice = parseFloat(quotePriceStr);
                
                if (isNaN(quotePrice) || quotePrice < 0) {
                    alert('Please enter a valid price');
                    return;
                }
                
                const userId = window.currentUser.uid;
                const jobRef = window.dbRef(window.database, `users/${userId}/pipelineJobs/${jobId}`);
                await window.dbUpdate(jobRef, { 
                    stage: 'quoteSent', 
                    quoteSentDate: new Date().toISOString(),
                    quotedPrice: quotePrice  // Save the quoted price
                });
                alert(`‚úÖ Quote sent for ¬£${quotePrice.toFixed(2)}!`);
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating job');
            }
        };
        
        window.deletePipelineJob = async function(jobId) {
            const job = window.pipelineJobs.find(j => j.id === jobId);
            if (!job) {
                alert('Job not found');
                return;
            }
            
            if (!confirm(`Delete lead for "${job.customerName}"?\n\nJob #${job.jobReference}\n${job.projectType}\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const userId = window.currentUser.uid;
                const jobRef = window.dbRef(window.database, `users/${userId}/pipelineJobs/${jobId}`);
                await window.dbRemove(jobRef);
                
                alert('‚úÖ Lead deleted successfully');
                
                // Refresh pipeline
                if (typeof renderPipeline === 'function') renderPipeline();
                
            } catch (error) {
                console.error('Error deleting job:', error);
                alert('Error deleting lead. Please try again.');
            }
        };
        
        // Edit Pipeline Job Functions
        window.editPipelineJob = function(jobId) {
            const job = window.pipelineJobs.find(j => j.id === jobId);
            if (!job) {
                alert('Job not found');
                return;
            }
            
            // Populate form fields
            document.getElementById('editPipelineJobId').value = jobId;
            document.getElementById('editPipelineJobStage').value = job.stage;
            document.getElementById('editPipelineCustomerName').value = job.customerName || '';
            document.getElementById('editPipelineCustomerPhone').value = job.customerPhone || '';
            document.getElementById('editPipelineCustomerEmail').value = job.customerEmail || '';
            document.getElementById('editPipelineResponsiblePerson').value = job.responsiblePerson || '';
            document.getElementById('editPipelineJobDescription').value = job.jobDescription || '';
            document.getElementById('editPipelineProjectType').value = job.projectType || '';
            document.getElementById('editPipelineEstimatedValue').value = job.estimatedValue || '';
            document.getElementById('editPipelineEstimatedEndDate').value = job.estimatedEndDate || '';
            document.getElementById('editPipelineNotes').value = job.notes || '';
            
            // Show appropriate date field based on stage
            const quoteDeadlineField = document.getElementById('editQuoteDeadlineField');
            const startDateField = document.getElementById('editStartDateField');
            
            if (job.stage === 'newLead' || job.stage === 'quoteSent') {
                // Early stages: Show Quote Deadline
                quoteDeadlineField.style.display = 'block';
                startDateField.style.display = 'none';
                document.getElementById('editPipelineQuoteDeadline').value = job.quoteDeadline || '';
            } else {
                // Later stages: Show Start Date (from linked visit)
                quoteDeadlineField.style.display = 'none';
                startDateField.style.display = 'block';
                
                // Get start date from linked visit
                if (job.visitId && window.visits) {
                    const linkedVisit = window.visits.find(v => v.id === job.visitId);
                    if (linkedVisit) {
                        document.getElementById('editPipelineStartDate').value = linkedVisit.scheduledDate || '';
                    }
                }
            }
            
            // Open modal
            document.getElementById('editPipelineJobModal').classList.add('active');
        };
        
        window.closeEditPipelineJobModal = function() {
            document.getElementById('editPipelineJobModal').classList.remove('active');
            document.getElementById('editPipelineJobForm').reset();
        };
        
        // Handle Edit Pipeline Job Form Submission
        document.getElementById('editPipelineJobForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const jobId = document.getElementById('editPipelineJobId').value;
            const jobStage = document.getElementById('editPipelineJobStage').value;
            
            try {
                const userId = window.currentUser.uid;
                const job = window.pipelineJobs.find(j => j.id === jobId);
                
                // Build updated data for pipeline job
                const updatedData = {
                    customerName: document.getElementById('editPipelineCustomerName').value,
                    customerPhone: document.getElementById('editPipelineCustomerPhone').value,
                    customerEmail: document.getElementById('editPipelineCustomerEmail').value,
                    responsiblePerson: document.getElementById('editPipelineResponsiblePerson').value,
                    jobDescription: document.getElementById('editPipelineJobDescription').value,
                    projectType: document.getElementById('editPipelineProjectType').value,
                    estimatedValue: parseFloat(document.getElementById('editPipelineEstimatedValue').value) || null,
                    estimatedEndDate: document.getElementById('editPipelineEstimatedEndDate').value || null,
                    notes: document.getElementById('editPipelineNotes').value
                };
                
                // Add appropriate date field based on stage
                if (jobStage === 'newLead' || jobStage === 'quoteSent') {
                    // Early stages: Save quote deadline
                    updatedData.quoteDeadline = document.getElementById('editPipelineQuoteDeadline').value || null;
                } else {
                    // Later stages: Update linked visit's start date
                    const newStartDate = document.getElementById('editPipelineStartDate').value;
                    if (newStartDate && job.visitId) {
                        const visitRef = window.dbRef(window.database, `users/${userId}/visits/${job.visitId}`);
                        await window.dbUpdate(visitRef, {
                            scheduledDate: newStartDate
                        });
                    }
                }
                
                // Update pipeline job
                const jobRef = window.dbRef(window.database, `users/${userId}/pipelineJobs/${jobId}`);
                await window.dbUpdate(jobRef, updatedData);
                
                alert('‚úÖ Job updated successfully!');
                closeEditPipelineJobModal();
                
                // Refresh pipeline and calendar
                if (typeof renderPipeline === 'function') renderPipeline();
                if (typeof renderCalendar === 'function') renderCalendar();
                
            } catch (error) {
                console.error('Error updating job:', error);
                alert('Error updating job. Please try again.');
            }
        });
        
        window.markAsApproved = async function(jobId) {
            try {
                const userId = window.currentUser.uid;
                const jobRef = window.dbRef(window.database, `users/${userId}/pipelineJobs/${jobId}`);
                await window.dbUpdate(jobRef, { stage: 'approved', approvedDate: new Date().toISOString() });
                alert('‚úÖ Job marked as approved!');
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating job');
            }
        };
        
        window.scheduleWork = async function(jobId) {
            try {
                // Get the job details
                const job = window.pipelineJobs.find(j => j.id === jobId);
                if (!job) {
                    alert('Job not found');
                    return;
                }
                
                // Prompt for scheduled date in DD/MM/YY format
                const today = new Date();
                const todayFormatted = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getFullYear()).slice(-2)}`;
                const scheduledDateInput = prompt('Enter scheduled date (DD/MM/YY):', todayFormatted);
                if (!scheduledDateInput) return; // User cancelled
                
                // Validate date format DD/MM/YY
                if (!/^\d{2}\/\d{2}\/\d{2}$/.test(scheduledDateInput)) {
                    alert('Invalid date format. Please use DD/MM/YY (e.g., 27/01/26)');
                    return;
                }
                
                // Convert DD/MM/YY to YYYY-MM-DD for storage
                const [day, month, year] = scheduledDateInput.split('/');
                const fullYear = '20' + year; // Assume 2000s
                const scheduledDate = `${fullYear}-${month}-${day}`;
                
                // Validate the date is valid
                const dateObj = new Date(scheduledDate);
                if (isNaN(dateObj.getTime())) {
                    alert('Invalid date. Please check the date and try again.');
                    return;
                }
                
                const userId = window.currentUser.uid;
                
                // Create visit from pipeline job
                const visitData = {
                    pipelineJobId: jobId,  // Link back to pipeline job
                    siteName: job.customerName,
                    siteAddress: job.customerAddress || job.customerEmail || '',
                    scheduledDate: scheduledDate,
                    price: job.estimatedValue || 0,
                    status: 'pending',
                    projectType: job.projectType || '',
                    jobDescription: job.jobDescription || '',
                    customerPhone: job.customerPhone || '',
                    customerEmail: job.customerEmail || '',
                    createdAt: new Date().toISOString()
                };
                
                // Add visit to database
                const visitRef = window.dbPush(window.dbRef(window.database, `users/${userId}/visits`));
                const visitId = visitRef.key;
                await window.dbSet(visitRef, visitData);
                
                // Update pipeline job to in-progress and link to visit
                const jobRef = window.dbRef(window.database, `users/${userId}/pipelineJobs/${jobId}`);
                await window.dbUpdate(jobRef, { 
                    stage: 'inProgress', 
                    startedDate: new Date().toISOString(),
                    visitId: visitId  // Link to created visit
                });
                
                alert(`‚úÖ Work scheduled for ${new Date(scheduledDate).toLocaleDateString('en-GB')}!\nVisit added to Upcoming Visits tab.`);
                
                // Refresh views
                if (typeof renderVisits === 'function') renderVisits();
                if (typeof renderPipeline === 'function') renderPipeline();
                if (typeof updateStats === 'function') updateStats();
                
            } catch (error) {
                console.error('Error scheduling work:', error);
                alert('Error scheduling work. Please try again.');
            }
        };
        
        window.markAsComplete = async function(jobId) {
            try {
                const userId = window.currentUser.uid;
                const jobRef = window.dbRef(window.database, `users/${userId}/pipelineJobs/${jobId}`);
                await window.dbUpdate(jobRef, { stage: 'complete', completedDate: new Date().toISOString() });
                alert('‚úÖ Job complete! Ready to invoice.');
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating job');
            }
        };
        
        window.sendInvoice = async function(jobId) {
            try {
                const userId = window.currentUser.uid;
                const jobRef = window.dbRef(window.database, `users/${userId}/pipelineJobs/${jobId}`);
                await window.dbUpdate(jobRef, { stage: 'invoiced', invoicedDate: new Date().toISOString() });
                alert('‚úÖ Invoiced! Awaiting payment.');
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating job');
            }
        };
        
        window.markAsPaid = async function(jobId) {
            try {
                const userId = window.currentUser.uid;
                const jobRef = window.dbRef(window.database, `users/${userId}/pipelineJobs/${jobId}`);
                await window.dbUpdate(jobRef, { stage: 'paid', paidDate: new Date().toISOString() });
                alert('‚úÖ Payment received! üéâ');
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating job');
            }
        };
        
        // ========================================
        // PIPELINE MOVE BACK FUNCTIONS
        // ========================================
        
        window.moveBackToNewLead = async function(jobId) {
            if (!confirm('Move this job back to New Leads?')) return;
            try {
                const userId = window.currentUser.uid;
                const jobRef = window.dbRef(window.database, `users/${userId}/pipelineJobs/${jobId}`);
                await window.dbUpdate(jobRef, { stage: 'newLead' });
                alert('‚úÖ Job moved back to New Leads');
            } catch (error) {
                console.error('Error:', error);
                alert('Error moving job');
            }
        };
        
        window.moveBackToQuoteSent = async function(jobId) {
            if (!confirm('Move this job back to Quote Sent?')) return;
            try {
                const userId = window.currentUser.uid;
                const jobRef = window.dbRef(window.database, `users/${userId}/pipelineJobs/${jobId}`);
                await window.dbUpdate(jobRef, { stage: 'quoteSent' });
                alert('‚úÖ Job moved back to Quote Sent');
            } catch (error) {
                console.error('Error:', error);
                alert('Error moving job');
            }
        };
        
        window.moveBackToApproved = async function(jobId) {
            if (!confirm('Move this job back to Approved?')) return;
            try {
                const userId = window.currentUser.uid;
                const jobRef = window.dbRef(window.database, `users/${userId}/pipelineJobs/${jobId}`);
                await window.dbUpdate(jobRef, { stage: 'approved' });
                alert('‚úÖ Job moved back to Approved');
            } catch (error) {
                console.error('Error:', error);
                alert('Error moving job');
            }
        };
        
        window.moveBackToInProgress = async function(jobId) {
            if (!confirm('Move this job back to In Progress?')) return;
            try {
                const userId = window.currentUser.uid;
                const jobRef = window.dbRef(window.database, `users/${userId}/pipelineJobs/${jobId}`);
                await window.dbUpdate(jobRef, { stage: 'inProgress' });
                alert('‚úÖ Job moved back to In Progress');
            } catch (error) {
                console.error('Error:', error);
                alert('Error moving job');
            }
        };
        
        window.moveBackToComplete = async function(jobId) {
            if (!confirm('Move this job back to Complete?')) return;
            try {
                const userId = window.currentUser.uid;
                const jobRef = window.dbRef(window.database, `users/${userId}/pipelineJobs/${jobId}`);
                await window.dbUpdate(jobRef, { stage: 'complete' });
                alert('‚úÖ Job moved back to Complete');
            } catch (error) {
                console.error('Error:', error);
                alert('Error moving job');
            }
        };
        
        window.moveBackToInvoiced = async function(jobId) {
            if (!confirm('Move this job back to Invoiced?')) return;
            try {
                const userId = window.currentUser.uid;
                const jobRef = window.dbRef(window.database, `users/${userId}/pipelineJobs/${jobId}`);
                await window.dbUpdate(jobRef, { stage: 'invoiced' });
                alert('‚úÖ Job moved back to Invoiced');
            } catch (error) {
                console.error('Error:', error);
                alert('Error moving job');
            }
        };
        
        // Note: Visit completion now uses openCompleteVisitModal() which shows full form with signature
        
        window.markVisitAsInvoiced = async function(visitId) {
            try {
                const userId = window.currentUser.uid;
                const visitRef = window.dbRef(window.database, `users/${userId}/visits/${visitId}`);
                await window.dbUpdate(visitRef, { 
                    invoiced: true, 
                    invoicedDate: new Date().toISOString() 
                });
                alert('‚úÖ Visit marked as invoiced!');
                if (typeof renderInvoices === 'function') renderInvoices();
                if (typeof updateStats === 'function') updateStats();
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating visit');
            }
        };
        
        window.resumeVisit = async function(visitId) {
            try {
                const userId = window.currentUser.uid;
                const visitRef = window.dbRef(window.database, `users/${userId}/visits/${visitId}`);
                await window.dbUpdate(visitRef, { paused: false, resumedDate: new Date().toISOString() });
                alert('‚úÖ Visit resumed!');
                if (typeof renderVisits === 'function') renderVisits();
                if (typeof updateStats === 'function') updateStats();
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating visit');
            }
        };
        
        // ========================================
        // VISIT EDIT & DELETE FUNCTIONS
        // ========================================
        
        window.openEditVisitModal = function(visitId) {
            const visit = window.visits.find(v => v.id === visitId);
            if (!visit) {
                alert('Visit not found');
                return;
            }
            
            // Populate form
            document.getElementById('editVisitId').value = visitId;
            document.getElementById('editScheduledDate').value = visit.scheduledDate;
            document.getElementById('editPrice').value = visit.price;
            document.getElementById('editNotes').value = visit.notes || '';
            
            // Open modal
            document.getElementById('editVisitModal').classList.add('active');
        };
        
        window.closeEditVisitModal = function() {
            document.getElementById('editVisitModal').classList.remove('active');
            document.getElementById('editVisitForm').reset();
        };
        
        // Edit Visit Form Handler
        document.getElementById('editVisitForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const visitId = document.getElementById('editVisitId').value;
            const scheduledDate = document.getElementById('editScheduledDate').value;
            const price = parseFloat(document.getElementById('editPrice').value);
            const notes = document.getElementById('editNotes').value;
            
            try {
                const userId = window.currentUser.uid;
                const visitRef = window.dbRef(window.database, `users/${userId}/visits/${visitId}`);
                
                await window.dbUpdate(visitRef, {
                    scheduledDate: scheduledDate,
                    price: price,
                    notes: notes,
                    updatedAt: new Date().toISOString()
                });
                
                closeEditVisitModal();
                alert('‚úÖ Visit updated successfully!');
                
                // Refresh views
                if (typeof renderVisits === 'function') renderVisits();
                if (typeof updateStats === 'function') updateStats();
                
            } catch (error) {
                console.error('Error updating visit:', error);
                alert('Error updating visit. Please try again.');
            }
        });
        
        window.deleteVisit = async function(visitId) {
            const visit = window.visits.find(v => v.id === visitId);
            if (!visit) {
                alert('Visit not found');
                return;
            }
            
            if (!confirm(`Delete visit for "${visit.siteName}"?\n\nScheduled: ${new Date(visit.scheduledDate).toLocaleDateString('en-GB')}\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const userId = window.currentUser.uid;
                const visitRef = window.dbRef(window.database, `users/${userId}/visits/${visitId}`);
                await window.dbRemove(visitRef);
                
                alert('‚úÖ Visit deleted successfully');
                
                // Refresh views
                if (typeof renderVisits === 'function') renderVisits();
                if (typeof updateStats === 'function') updateStats();
                
            } catch (error) {
                console.error('Error deleting visit:', error);
                alert('Error deleting visit. Please try again.');
            }
        };

        // ========================================
        // PIPELINE FORM SUBMISSION HANDLERS
        // ========================================

        // Add Pipeline Job Form Handler
        if (document.getElementById('addPipelineJobForm')) {
            document.getElementById('addPipelineJobForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    const userId = window.currentUser.uid;
                    const jobRef = window.dbPush(window.dbRef(window.database, `users/${userId}/pipelineJobs`));
                    const nextRef = await getNextJobReference();
                    
                    // Calculate deadline
                    let deadlineDate = null;
                    const deadlineType = document.getElementById('pipelineDeadlineType').value;
                    
                    if (deadlineType === '1week') {
                        const deadline = new Date();
                        deadline.setDate(deadline.getDate() + 7);
                        deadlineDate = deadline.toISOString().split('T')[0];
                    } else if (deadlineType === '2weeks') {
                        const deadline = new Date();
                        deadline.setDate(deadline.getDate() + 14);
                        deadlineDate = deadline.toISOString().split('T')[0];
                    } else if (deadlineType === 'custom') {
                        deadlineDate = document.getElementById('pipelineCustomDeadline').value;
                    }
                    
                    const jobData = {
                        jobReference: nextRef.toString(),
                        responsiblePerson: document.getElementById('pipelineResponsiblePerson').value,
                        customerName: document.getElementById('pipelineCustomerName').value,
                        customerPhone: document.getElementById('pipelineCustomerPhone').value,
                        customerEmail: document.getElementById('pipelineCustomerEmail').value,
                        jobDescription: document.getElementById('pipelineJobDescription').value,
                        projectType: document.getElementById('pipelineProjectType').value,
                        estimatedValue: parseFloat(document.getElementById('pipelineEstimatedValue').value) || null,
                        estimatedEndDate: document.getElementById('pipelineEstimatedEndDate').value || null,
                        notes: document.getElementById('pipelineNotes').value,
                        quoteDeadline: deadlineDate,
                        stage: 'newLead',
                        createdAt: new Date().toISOString()
                    };
                    
                    await window.dbSet(jobRef, jobData);
                    closeAddPipelineJobModal();
                    
                    // Refresh pipeline display
                    if (typeof renderPipeline === 'function') {
                        renderPipeline();
                    }
                    
                    alert('‚úÖ Lead added successfully! Job Ref: ' + nextRef);
                } catch (error) {
                    console.error('Error adding pipeline job:', error);
                    alert('Error adding lead. Please try again.');
                }
            });
        }

        // Send Quote Form Handler
        if (document.getElementById('sendQuoteForm')) {
            document.getElementById('sendQuoteForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    const userId = window.currentUser.uid;
                    const quoteData = {
                        quoteAmount: parseFloat(document.getElementById('quoteAmount').value),
                        quoteDate: document.getElementById('quoteDate').value,
                        quoteValidUntil: document.getElementById('quoteValidUntil').value,
                        quoteSent: document.getElementById('quoteSent').checked,
                        requiresApproval: document.getElementById('requiresApproval').value,
                        poNumber: document.getElementById('poNumber').value || null,
                        stage: 'quoteSent',
                        updatedAt: new Date().toISOString()
                    };
                    
                    await window.dbUpdate(
                        window.dbRef(window.database, `users/${userId}/pipelineJobs/${currentPipelineJobId}`),
                        quoteData
                    );
                    
                    closeSendQuoteModal();
                    alert('‚úÖ Quote sent successfully!');
                } catch (error) {
                    console.error('Error sending quote:', error);
                    alert('Error sending quote. Please try again.');
                }
            });
        }

        // Mark Approved Form Handler
        if (document.getElementById('markApprovedForm')) {
            document.getElementById('markApprovedForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const userId = window.currentUser.uid;
                const approvalStatus = document.getElementById('approvalStatus').value;
                const poNumber = document.getElementById('approvedPoNumber').value;
                
                const updateData = {
                    approvalStatus: approvalStatus,
                    approvalDate: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                if (poNumber) {
                    updateData.poNumber = poNumber;
                }
                
                if (approvalStatus === 'approved') {
                    updateData.stage = 'approved';
                }
                
                await window.dbUpdate(
                    window.dbRef(window.database, `users/${userId}/pipelineJobs/${currentPipelineJobId}`),
                    updateData
                );
                
                closeMarkApprovedModal();
                alert('‚úÖ Approval status updated!');
            } catch (error) {
                console.error('Error updating approval:', error);
                alert('Error updating approval. Please try again.');
            }
        });

        }

        // Complete Work Form Handler
        if (document.getElementById('completeWorkForm')) {
            document.getElementById('completeWorkForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    const userId = window.currentUser.uid;
                    const completeData = {
                        workCompletionDate: document.getElementById('completionDate').value,
                        jobStatus: document.getElementById('jobStatus').value,
                        snaggingItems: document.getElementById('snaggingItems').value || null,
                        stage: 'complete',
                        updatedAt: new Date().toISOString()
                    };
                    
                    await window.dbUpdate(
                        window.dbRef(window.database, `users/${userId}/pipelineJobs/${currentPipelineJobId}`),
                        completeData
                    );
                    
                    closeCompleteWorkModal();
                    alert('‚úÖ Work marked complete! Ready to send invoice.');
                } catch (error) {
                    console.error('Error completing work:', error);
                    alert('Error completing work. Please try again.');
                }
            });
        }

        // Send Invoice Form Handler
        if (document.getElementById('sendInvoiceForm')) {
            document.getElementById('sendInvoiceForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                const userId = window.currentUser.uid;
                const invoiceData = {
                    invoiceNumber: document.getElementById('invoiceNumber').value,
                    invoiceDate: document.getElementById('invoiceDate').value,
                    paymentDueDate: document.getElementById('paymentDue').value,
                    finalAmount: parseFloat(document.getElementById('finalAmount').value),
                    invoiceSent: document.getElementById('invoiceSent').checked,
                    stage: 'invoiced',
                    updatedAt: new Date().toISOString()
                };
                
                // Update quote amount if changed
                if (invoiceData.finalAmount) {
                    invoiceData.quoteAmount = invoiceData.finalAmount;
                }
                
                await window.dbUpdate(
                    window.dbRef(window.database, `users/${userId}/pipelineJobs/${currentPipelineJobId}`),
                    invoiceData
                );
                
                closeSendInvoiceModal();
                alert('‚úÖ Invoice sent! Now tracking payment.');
            } catch (error) {
                console.error('Error sending invoice:', error);
                alert('Error sending invoice. Please try again.');
            }
        });
        }

        // Mark Paid Form Handler
        document.getElementById('markPaidForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const userId = window.currentUser.uid;
                const paymentData = {
                    paymentReceived: true,
                    paymentDate: document.getElementById('paymentDate').value,
                    paymentMethod: document.getElementById('paymentMethod').value,
                    stage: 'paid',
                    updatedAt: new Date().toISOString()
                };
                
                await window.dbUpdate(
                    window.dbRef(window.database, `users/${userId}/pipelineJobs/${currentPipelineJobId}`),
                    paymentData
                );
                
                closeMarkPaidModal();
                alert('üéâ Payment received! Job complete. Ready to request review?');
            } catch (error) {
                console.error('Error marking paid:', error);
                alert('Error marking as paid. Please try again.');
            }
        });

        // END OF PIPELINE FORM HANDLERS

        // ========================================
        // COMPREHENSIVE EXCEL EXPORT SYSTEM
        // ========================================

        // Helper function to format date for Excel
        function formatDateForExcel(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB');
        }

        // Main export function - exports ALL data to Excel with multiple sheets
        window.exportAllDataToExcel = function() {
            try {
                console.log('Starting comprehensive data export...');
                
                // Create CSV content for each sheet
                let sitesCSV = 'Site Name,Address,Frequency,Contact,Phone,Email,Contract Notes,Status\n';
                window.sites.forEach(site => {
                    const freq = {7: 'Weekly', 14: 'Fortnightly', 28: '4-Weekly', 30: 'Monthly', 91: 'Quarterly'}[site.frequency] || site.frequency + ' days';
                    const status = site.paused ? 'Paused' + (site.pausedUntil ? ' until ' + formatDateForExcel(site.pausedUntil) : '') : 'Active';
                    sitesCSV += `"${site.name}","${site.address}","${freq}","${site.contact || ''}","${site.phone || ''}","${site.email || ''}","${site.contractNotes || ''}","${status}"\n`;
                });

                let visitsCSV = 'Site Name,Address,Scheduled Date,Price,Status,Invoiced,Completed Date\n';
                window.visits.forEach(visit => {
                    const status = visit.status === 'completed' ? 'Completed' : (visit.status === 'paused' ? 'Paused' : (visit.scheduledDate < new Date().toISOString().split('T')[0] ? 'Overdue' : 'Pending'));
                    visitsCSV += `"${visit.siteName}","${visit.siteAddress}","${formatDateForExcel(visit.scheduledDate)}","¬£${visit.price.toFixed(2)}","${status}","${visit.invoiced ? 'Yes' : 'No'}","${visit.completedDate ? formatDateForExcel(visit.completedDate) : ''}"\n`;
                });

                let projectsCSV = 'Project Name,Client,Start Date,Status,Budget,Description,Completion Date\n';
                window.projects.forEach(project => {
                    projectsCSV += `"${project.name}","${project.client}","${formatDateForExcel(project.startDate)}","${project.status || 'In Progress'}","¬£${project.budget || 0}","${project.description || ''}","${project.completionDate ? formatDateForExcel(project.completionDate) : ''}"\n`;
                });

                let pipelineCSV = 'Job Ref,Customer Name,Job Description,Stage,Quote Amount,Quote Date,Invoice Number,Payment Status\n';
                window.pipelineJobs.forEach(job => {
                    const stageNames = {
                        newLead: 'New Lead',
                        quoteSent: 'Quote Sent',
                        approved: 'Approved',
                        inProgress: 'In Progress',
                        complete: 'Complete',
                        invoiced: 'Invoiced',
                        paid: 'Paid'
                    };
                    pipelineCSV += `"${job.jobReference}","${job.customerName}","${job.jobDescription}","${stageNames[job.stage] || job.stage}","¬£${job.quoteAmount || 0}","${job.quoteDate ? formatDateForExcel(job.quoteDate) : ''}","${job.invoiceNumber || ''}","${job.paymentReceived ? 'Paid' : 'Pending'}"\n`;
                });

                // Get invoices (uninvoiced visits)
                let invoicesCSV = 'Site Name,Visit Date,Amount,Status,Invoice Sent Date\n';
                window.visits.filter(v => v.status === 'completed' && !v.invoiced).forEach(visit => {
                    invoicesCSV += `"${visit.siteName}","${formatDateForExcel(visit.completedDate)}","¬£${visit.price.toFixed(2)}","Awaiting Invoice",""\n`;
                });
                window.visits.filter(v => v.invoiced).forEach(visit => {
                    invoicesCSV += `"${visit.siteName}","${formatDateForExcel(visit.completedDate)}","¬£${visit.price.toFixed(2)}","Invoice Sent","${formatDateForExcel(visit.invoicedDate || visit.completedDate)}"\n`;
                });

                // Load saved calibrations from localStorage
                let calibrationsCSV = 'Calculation Name,Seconds,Nozzle Output,Strip Width,Sprayer Capacity,Chemical Rate,Area,Date Saved\n';
                const savedCalcs = JSON.parse(localStorage.getItem('savedCalculations') || '[]');
                savedCalcs.forEach(calc => {
                    calibrationsCSV += `"${calc.name}","${calc.seconds}","${calc.nozzleOutput}","${calc.stripWidth}","${calc.sprayerCapacity}","${calc.chemicalRate}","${calc.area}","${calc.dateSaved ? formatDateForExcel(calc.dateSaved) : ''}"\n`;
                });

                // Create a combined export file with all sheets
                // Note: True multi-sheet Excel requires a library, so we'll create separate CSV files
                // that can be imported into Excel as separate sheets
                
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `Roundwood-Complete-Export-${timestamp}.txt`;
                
                let combinedContent = '='.repeat(80) + '\n';
                combinedContent += 'ROUNDWOOD SOLUTIONS - COMPLETE DATA EXPORT\n';
                combinedContent += 'Export Date: ' + new Date().toLocaleString('en-GB') + '\n';
                combinedContent += '='.repeat(80) + '\n\n';
                
                combinedContent += '\n' + '='.repeat(80) + '\n';
                combinedContent += 'SHEET 1: SITES (' + window.sites.length + ' sites)\n';
                combinedContent += '='.repeat(80) + '\n';
                combinedContent += sitesCSV;
                
                combinedContent += '\n' + '='.repeat(80) + '\n';
                combinedContent += 'SHEET 2: VISITS (' + window.visits.length + ' visits)\n';
                combinedContent += '='.repeat(80) + '\n';
                combinedContent += visitsCSV;
                
                combinedContent += '\n' + '='.repeat(80) + '\n';
                combinedContent += 'SHEET 3: PROJECTS (' + window.projects.length + ' projects)\n';
                combinedContent += '='.repeat(80) + '\n';
                combinedContent += projectsCSV;
                
                combinedContent += '\n' + '='.repeat(80) + '\n';
                combinedContent += 'SHEET 4: PIPELINE (' + window.pipelineJobs.length + ' jobs)\n';
                combinedContent += '='.repeat(80) + '\n';
                combinedContent += pipelineCSV;
                
                combinedContent += '\n' + '='.repeat(80) + '\n';
                combinedContent += 'SHEET 5: INVOICES\n';
                combinedContent += '='.repeat(80) + '\n';
                combinedContent += invoicesCSV;
                
                combinedContent += '\n' + '='.repeat(80) + '\n';
                combinedContent += 'SHEET 6: CALIBRATIONS (' + savedCalcs.length + ' saved)\n';
                combinedContent += '='.repeat(80) + '\n';
                combinedContent += calibrationsCSV;
                
                // Create download
                const blob = new Blob([combinedContent], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                // Save last export date
                localStorage.setItem('lastExportDate', new Date().toISOString());
                
                alert('‚úÖ Complete data export successful!\n\n' +
                      'Exported:\n' +
                      '‚Ä¢ ' + window.sites.length + ' sites\n' +
                      '‚Ä¢ ' + window.visits.length + ' visits\n' +
                      '‚Ä¢ ' + window.projects.length + ' projects\n' +
                      '‚Ä¢ ' + window.pipelineJobs.length + ' pipeline jobs\n' +
                      '‚Ä¢ Invoices\n' +
                      '‚Ä¢ ' + savedCalcs.length + ' calibrations\n\n' +
                      'File: ' + filename);
                
                console.log('Export completed successfully');
                
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting data. Please try again.');
            }
        };

        // Automatic daily backup system
        function checkAndRunDailyBackup() {
            try {
                const autoBackupEnabled = localStorage.getItem('autoBackupEnabled') !== 'false'; // Default: enabled
                
                if (!autoBackupEnabled) {
                    console.log('Auto-backup is disabled');
                    return;
                }
                
                const lastBackup = localStorage.getItem('lastAutoBackupDate');
                const today = new Date().toISOString().split('T')[0];
                
                if (lastBackup !== today) {
                    console.log('Running automatic daily backup...');
                    
                    // Run backup automatically
                    exportAllDataToExcel();
                    
                    // Update last backup date
                    localStorage.setItem('lastAutoBackupDate', today);
                    
                    console.log('Automatic backup completed for', today);
                }
            } catch (error) {
                console.error('Auto-backup error:', error);
            }
        }

        // Toggle auto-backup on/off
        window.toggleAutoBackup = function() {
            const currentStatus = localStorage.getItem('autoBackupEnabled') !== 'false';
            const newStatus = !currentStatus;
            
            localStorage.setItem('autoBackupEnabled', newStatus);
            
            alert(newStatus 
                ? '‚úÖ Automatic daily backups ENABLED\n\nYour data will be exported automatically once per day when you open the app.'
                : '‚è∏Ô∏è Automatic daily backups DISABLED\n\nYou can still export manually anytime using the Export button.'
            );
            
            // Update button text if it exists
            updateAutoBackupButton();
        };

        // Update auto-backup button text
        function updateAutoBackupButton() {
            const enabled = localStorage.getItem('autoBackupEnabled') !== 'false';
            const text = enabled ? '‚úÖ Auto-Backup: ON' : '‚è∏Ô∏è Auto-Backup: OFF';
            
            // Update old button if it exists (for backwards compatibility)
            const btn = document.getElementById('autoBackupToggle');
            if (btn) {
                btn.innerHTML = text;
                btn.className = enabled 
                    ? 'btn btn-success btn-small'
                    : 'btn btn-secondary btn-small';
            }
            
            // Update menu item
            const menuItem = document.getElementById('autoBackupMenuItem');
            if (menuItem) {
                menuItem.innerHTML = text;
            }
        }

        // ========================================
        // GOOGLE DRIVE INTEGRATION
        // ========================================

        // Google API Configuration
        const GOOGLE_CLIENT_ID = 'YOUR_CLIENT_ID_HERE'; // User needs to create this
        const GOOGLE_API_KEY = 'YOUR_API_KEY_HERE'; // User needs to create this
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let googleDriveInitialized = false;
        let googleDriveAuthenticated = false;

        // Initialize Google Drive API
        function initGoogleDrive() {
            // Check if API keys are configured
            if (GOOGLE_CLIENT_ID === 'YOUR_CLIENT_ID_HERE' || GOOGLE_API_KEY === 'YOUR_API_KEY_HERE') {
                console.log('Google Drive not configured yet');
                return;
            }

            gapi.load('client:auth2', async () => {
                try {
                    await gapi.client.init({
                        apiKey: GOOGLE_API_KEY,
                        clientId: GOOGLE_CLIENT_ID,
                        discoveryDocs: DISCOVERY_DOCS,
                        scope: SCOPES
                    });
                    
                    googleDriveInitialized = true;
                    
                    // Check if already signed in
                    const authInstance = gapi.auth2.getAuthInstance();
                    if (authInstance.isSignedIn.get()) {
                        googleDriveAuthenticated = true;
                        updateGoogleDriveStatus();
                        console.log('Google Drive: Already authenticated');
                    }
                    
                } catch (error) {
                    console.error('Google Drive initialization error:', error);
                }
            });
        }

        // Authenticate with Google Drive
        window.authenticateGoogleDrive = async function() {
            if (!googleDriveInitialized) {
                alert('‚ö†Ô∏è Google Drive Setup Required\n\n' +
                      'To enable Google Drive backups:\n\n' +
                      '1. Go to Google Cloud Console\n' +
                      '2. Create a project\n' +
                      '3. Enable Google Drive API\n' +
                      '4. Create credentials (OAuth 2.0)\n' +
                      '5. Add credentials to this file\n\n' +
                      'See GOOGLE-DRIVE-SETUP.md for detailed instructions.');
                return;
            }

            try {
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signIn();
                googleDriveAuthenticated = true;
                updateGoogleDriveStatus();
                alert('‚úÖ Google Drive connected!\n\nYour backups will now automatically upload to Google Drive.');
            } catch (error) {
                console.error('Google Drive authentication error:', error);
                alert('‚ùå Could not connect to Google Drive. Please try again.');
            }
        };

        // Sign out from Google Drive
        window.signOutGoogleDrive = async function() {
            if (!googleDriveInitialized) return;
            
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signOut();
                googleDriveAuthenticated = false;
                updateGoogleDriveStatus();
                alert('Google Drive disconnected.');
            } catch (error) {
                console.error('Google Drive sign out error:', error);
            }
        };

        // Update Google Drive connection status
        function updateGoogleDriveStatus() {
            const text = googleDriveAuthenticated ? '‚úÖ Google Drive Connected' : 'üîó Connect Google Drive';
            
            // Update old button if it exists (for backwards compatibility)
            const statusBtn = document.getElementById('googleDriveStatus');
            if (statusBtn) {
                if (googleDriveAuthenticated) {
                    statusBtn.innerHTML = '‚úÖ Google Drive Connected';
                    statusBtn.className = 'btn btn-success btn-small';
                    statusBtn.onclick = signOutGoogleDrive;
                } else {
                    statusBtn.innerHTML = 'üîó Connect Google Drive';
                    statusBtn.className = 'btn btn-primary btn-small';
                    statusBtn.onclick = authenticateGoogleDrive;
                }
            }
            
            // Update menu item
            const menuItem = document.getElementById('googleDriveMenuItem');
            if (menuItem) {
                menuItem.innerHTML = text;
            }
        }

        // Create or get Roundwood Backups folder in Google Drive
        async function getOrCreateBackupFolder() {
            try {
                // Search for existing folder
                const response = await gapi.client.drive.files.list({
                    q: "name='Roundwood Backups' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                if (response.result.files.length > 0) {
                    return response.result.files[0].id;
                }

                // Create new folder
                const folderMetadata = {
                    name: 'Roundwood Backups',
                    mimeType: 'application/vnd.google-apps.folder'
                };

                const folder = await gapi.client.drive.files.create({
                    resource: folderMetadata,
                    fields: 'id'
                });

                console.log('Created Roundwood Backups folder:', folder.result.id);
                return folder.result.id;

            } catch (error) {
                console.error('Error creating backup folder:', error);
                throw error;
            }
        }

        // Create or get year/month subfolder
        async function getOrCreateDateFolder(parentId) {
            try {
                const now = new Date();
                const year = now.getFullYear().toString();
                const month = now.toLocaleString('en-GB', { month: 'long' });

                // Get or create year folder
                let yearResponse = await gapi.client.drive.files.list({
                    q: `name='${year}' and '${parentId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                let yearFolderId;
                if (yearResponse.result.files.length > 0) {
                    yearFolderId = yearResponse.result.files[0].id;
                } else {
                    const yearFolder = await gapi.client.drive.files.create({
                        resource: {
                            name: year,
                            mimeType: 'application/vnd.google-apps.folder',
                            parents: [parentId]
                        },
                        fields: 'id'
                    });
                    yearFolderId = yearFolder.result.id;
                }

                // Get or create month folder
                let monthResponse = await gapi.client.drive.files.list({
                    q: `name='${month}' and '${yearFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                let monthFolderId;
                if (monthResponse.result.files.length > 0) {
                    monthFolderId = monthResponse.result.files[0].id;
                } else {
                    const monthFolder = await gapi.client.drive.files.create({
                        resource: {
                            name: month,
                            mimeType: 'application/vnd.google-apps.folder',
                            parents: [yearFolderId]
                        },
                        fields: 'id'
                    });
                    monthFolderId = monthFolder.result.id;
                }

                return monthFolderId;

            } catch (error) {
                console.error('Error creating date folder:', error);
                throw error;
            }
        }

        // Upload file to Google Drive
        async function uploadToGoogleDrive(filename, content) {
            if (!googleDriveAuthenticated) {
                console.log('Google Drive not authenticated, skipping upload');
                return false;
            }

            try {
                console.log('Uploading to Google Drive:', filename);

                // Get folder structure
                const rootFolderId = await getOrCreateBackupFolder();
                const monthFolderId = await getOrCreateDateFolder(rootFolderId);

                // Create file metadata
                const fileMetadata = {
                    name: filename,
                    parents: [monthFolderId]
                };

                // Create multipart upload
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";

                const contentType = 'text/plain';
                const metadata = {
                    name: filename,
                    mimeType: contentType,
                    parents: [monthFolderId]
                };

                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                    JSON.stringify(metadata) +
                    delimiter +
                    'Content-Type: ' + contentType + '\r\n\r\n' +
                    content +
                    close_delim;

                const request = gapi.client.request({
                    path: '/upload/drive/v3/files',
                    method: 'POST',
                    params: { uploadType: 'multipart' },
                    headers: {
                        'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                    },
                    body: multipartRequestBody
                });

                const response = await request;
                console.log('Upload successful:', response.result.id);
                
                return true;

            } catch (error) {
                console.error('Google Drive upload error:', error);
                return false;
            }
        }

        // Enhanced export function with Google Drive upload
        const originalExport = window.exportAllDataToExcel;
        window.exportAllDataToExcel = async function() {
            // Run original export (downloads to computer)
            originalExport();

            // Also upload to Google Drive if authenticated
            if (googleDriveAuthenticated) {
                try {
                    // Generate the same content that was downloaded
                    const timestamp = new Date().toISOString().split('T')[0];
                    const filename = `Roundwood-Complete-Export-${timestamp}.txt`;
                    
                    // Recreate export content (same as original function)
                    let combinedContent = '='.repeat(80) + '\n';
                    combinedContent += 'ROUNDWOOD SOLUTIONS - COMPLETE DATA EXPORT\n';
                    combinedContent += 'Export Date: ' + new Date().toLocaleString('en-GB') + '\n';
                    combinedContent += '='.repeat(80) + '\n\n';
                    
                    // Add all sheets (abbreviated for brevity - full version in original function)
                    // Sites
                    let sitesCSV = 'Site Name,Address,Frequency,Contact,Phone,Email,Contract Notes,Status\n';
                    window.sites.forEach(site => {
                        const freq = {7: 'Weekly', 14: 'Fortnightly', 28: '4-Weekly', 30: 'Monthly', 91: 'Quarterly'}[site.frequency] || site.frequency + ' days';
                        const status = site.paused ? 'Paused' : 'Active';
                        sitesCSV += `"${site.name}","${site.address}","${freq}","${site.contact || ''}","${site.phone || ''}","${site.email || ''}","${site.contractNotes || ''}","${status}"\n`;
                    });
                    
                    combinedContent += '\nSHEET 1: SITES (' + window.sites.length + ' sites)\n';
                    combinedContent += '='.repeat(80) + '\n';
                    combinedContent += sitesCSV;
                    
                    // Upload to Google Drive
                    const uploaded = await uploadToGoogleDrive(filename, combinedContent);
                    
                    if (uploaded) {
                        console.log('‚úÖ Backup uploaded to Google Drive');
                    }
                    
                } catch (error) {
                    console.error('Google Drive upload failed:', error);
                }
            }
        };

        // OLD Google Drive initialization - DISABLED (using new version earlier in file)
        // Initialize Google Drive on page load
        // if (typeof gapi !== 'undefined') {
        //     setTimeout(initGoogleDrive, 2000);
        // }

        // Run auto-backup check when app loads
        // if (window.currentUser) {
        //     setTimeout(checkAndRunDailyBackup, 5000); // Wait 5 seconds after login
        // }

        // Also check every hour in case app stays open
        // setInterval(checkAndRunDailyBackup, 3600000); // Check every hour

    </script>
</body>
</html>