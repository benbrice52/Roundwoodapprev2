<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roundwood Route Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2d5016;
            --primary-light: #5a8a3a;
            --primary-dark: #1a3009;
            --accent: #8fbc5a;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.5;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            inset: 0;
            background: var(--primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Login Screen */
        #loginScreen {
            display: none;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 2rem;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: white;
            border-radius: 16px;
            padding: 3rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .login-card h1 {
            color: var(--primary);
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .login-card p {
            color: var(--gray-600);
            text-align: center;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: var(--gray-700);
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 80, 22, 0.3);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .alert {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        /* Main App */
        #mainApp {
            display: none;
            min-height: 100vh;
            flex-direction: column;
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-email {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-tabs {
            background: white;
            border-bottom: 2px solid var(--gray-200);
            padding: 0 1.5rem;
            overflow-x: auto;
            white-space: nowrap;
        }

        .nav-tabs button {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .nav-tabs button:hover {
            color: var(--primary);
            background: var(--gray-50);
        }

        .nav-tabs button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .nav-tabs button .badge {
            background: var(--danger);
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            margin-left: 0.5rem;
            font-weight: 600;
        }

        .tab-content {
            flex: 1;
            padding: 2rem 1.5rem;
        }

        .tab-pane {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tab-pane.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-100);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .site-card {
            border: 2px solid var(--gray-200);
            padding: 1.25rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .site-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(45, 80, 22, 0.1);
        }

        .site-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .site-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .site-address {
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .site-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .meta-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .meta-value {
            font-size: 0.95rem;
            color: var(--gray-900);
            font-weight: 500;
        }

        .badge-frequency {
            display: inline-block;
            background: var(--primary-light);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .visit-card {
            border-left: 4px solid var(--warning);
            background: white;
            padding: 1.25rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .visit-card.completed {
            border-left-color: var(--success);
            opacity: 0.7;
        }

        .visit-card.overdue {
            border-left-color: var(--danger);
            background: #fef2f2;
        }

        .visit-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .visit-site {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--gray-900);
        }

        .visit-date {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
        }

        .visit-status {
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-overdue {
            background: #fee2e2;
            color: #991b1b;
        }

        .visit-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        /* Photo Upload */
        .photo-upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--gray-50);
        }

        .photo-upload-area:active {
            border-color: var(--primary);
            background: var(--gray-100);
        }

        .photo-upload-area p {
            margin: 0;
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
            max-height: 150px;
            overflow-y: auto;
            padding: 0.25rem;
        }

        .photo-preview-item {
            position: relative;
            padding-top: 100%;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid var(--gray-200);
            background: var(--gray-100);
        }

        .photo-preview-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--danger);
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.75rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            padding: 0;
        }

        /* Signature Pad */
        .signature-pad {
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            cursor: crosshair;
            touch-action: none;
            background: white;
            width: 100%;
        }

        .signature-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(2px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-400);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .btn-close:hover {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 100px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--gray-500);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        .empty-state-text {
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .header-content h1 {
                font-size: 1.125rem;
            }

            .user-email {
                display: none;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .site-meta {
                grid-template-columns: 1fr;
            }

            .visit-actions {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <p style="margin-top: 1rem;">Loading Roundwood Manager...</p>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-card">
            <h1>üå≥ Roundwood</h1>
            <p>Route Manager</p>
            
            <div id="loginError" style="display: none;" class="alert alert-error"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="btn btn-primary">Sign In</button>
            </form>
            
            <div style="text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
                <p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">
                    Don't have an account?
                </p>
                <button id="showRegisterBtn" class="btn btn-secondary" style="width: 100%;">
                    Create Account
                </button>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create Account</h2>
                <button class="btn-close" onclick="closeRegisterModal()">√ó</button>
            </div>
            
            <div id="registerError" style="display: none;" class="alert alert-error"></div>
            
            <form id="registerForm">
                <div class="form-group">
                    <label for="registerName">Full Name *</label>
                    <input type="text" id="registerName" required placeholder="e.g. Ben Brice">
                </div>
                <div class="form-group">
                    <label for="registerRole">Role *</label>
                    <select id="registerRole" required>
                        <option value="">Select role...</option>
                        <option value="admin">Admin (Full Access)</option>
                        <option value="field">Field Operative (Complete Visits)</option>
                        <option value="finance">Finance (Invoice Tracking)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email *</label>
                    <input type="email" id="registerEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password *</label>
                    <input type="password" id="registerPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
                    <small style="color: var(--gray-500); font-size: 0.8rem;">Minimum 6 characters</small>
                </div>
                <div class="form-group">
                    <label for="registerConfirm">Confirm Password *</label>
                    <input type="password" id="registerConfirm" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="btn btn-primary">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp">
        <header class="header">
            <div class="header-content">
                <h1>üå≥ Roundwood Route Manager</h1>
                <div class="user-info">
                    <span class="user-email" id="userEmail"></span>
                    <button class="btn-logout" onclick="logout()">Sign Out</button>
                </div>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button onclick="showTab('sites')">üìç Sites</button>
            <button onclick="showTab('visits')">üìÖ Upcoming Visits <span class="badge" id="upcomingCount">0</span></button>
            <button onclick="showTab('invoices')">üí∞ Invoice Tracking <span class="badge" id="uninvoicedCount">0</span></button>
            <button onclick="showTab('history')">üìú History</button>
        </nav>

        <div class="tab-content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-pane active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotalSites">0</div>
                        <div class="stat-label">Active Sites</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--warning);">
                        <div class="stat-value" style="color: var(--warning);" id="statUpcomingVisits">0</div>
                        <div class="stat-label">Upcoming Visits</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--danger);">
                        <div class="stat-value" style="color: var(--danger);" id="statUninvoiced">0</div>
                        <div class="stat-label">Awaiting Invoice</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--success);">
                        <div class="stat-value" style="color: var(--success);" id="statCompletedToday">0</div>
                        <div class="stat-label">Completed Today</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Today's Visits</h2>
                    </div>
                    <div id="todayVisits"></div>
                </div>
            </div>

            <!-- Sites Tab -->
            <div id="sites" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">All Sites</h2>
                        <button class="btn btn-primary" onclick="openAddSiteModal()">+ Add New Site</button>
                    </div>
                    <div id="sitesContainer"></div>
                </div>
            </div>

            <!-- Visits Tab -->
            <div id="visits" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Upcoming Visits</h2>
                    </div>
                    <div id="visitsContainer"></div>
                </div>
            </div>

            <!-- Invoices Tab -->
            <div id="invoices" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Invoice Tracking</h2>
                    </div>
                    <div id="invoicesContainer"></div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Completed Visits History</h2>
                    </div>
                    <div id="historyContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Site Modal -->
    <div id="addSiteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Site</h2>
                <button class="btn-close" onclick="closeAddSiteModal()">√ó</button>
            </div>
            
            <form id="addSiteForm">
                <div class="form-group">
                    <label for="siteName">Site Name *</label>
                    <input type="text" id="siteName" required placeholder="e.g., Maidstone Primary School">
                </div>
                
                <div class="form-group">
                    <label for="siteAddress">Address *</label>
                    <input type="text" id="siteAddress" required placeholder="Full address">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="siteContact">Contact Name</label>
                        <input type="text" id="siteContact" placeholder="Site manager">
                    </div>
                    
                    <div class="form-group">
                        <label for="sitePhone">Phone</label>
                        <input type="tel" id="sitePhone" placeholder="01234 567890">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="siteFrequency">Visit Frequency *</label>
                        <select id="siteFrequency" required class="form-group input" style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px;">
                            <option value="7">Weekly</option>
                            <option value="14">Fortnightly</option>
                            <option value="28">4-Weekly</option>
                            <option value="30">Monthly</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="sitePrice">Price per Visit *</label>
                        <input type="number" id="sitePrice" required placeholder="0.00" step="0.01" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="siteFirstVisit">First Visit Date *</label>
                    <input type="date" id="siteFirstVisit" required>
                </div>
                
                <div class="form-group">
                    <label for="siteNotes">Notes</label>
                    <textarea id="siteNotes" placeholder="Access codes, special instructions, etc."></textarea>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddSiteModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Add Site</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Complete Visit Modal -->
    <div id="completeVisitModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Complete Visit Worksheet</h2>
                <button class="btn-close" onclick="closeCompleteVisitModal()">√ó</button>
            </div>
            
            <form id="completeVisitForm">
                <input type="hidden" id="completeVisitId">
                
                <div class="alert alert-warning" style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin-bottom: 1.5rem;">
                    <strong>üì∏ Remember:</strong> Take before/after photos with your phone camera before completing
                </div>

                <div class="form-group">
                    <label for="completedBy">Roundwood Operative *</label>
                    <input type="text" id="completedBy" required placeholder="Staff member name">
                </div>

                <div class="card" style="background: var(--gray-50); margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.125rem;">Work Completed - Tick all that apply *</h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <label style="display: flex; align-items: start; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: white; border-radius: 8px; border: 2px solid var(--gray-200); transition: all 0.2s;">
                            <input type="checkbox" class="work-task" required style="width: 20px; height: 20px; cursor: pointer; margin-top: 2px; flex-shrink: 0;">
                            <span style="flex: 1;">
                                <strong>Weed removal</strong> to appropriate areas - entrance/exits etc
                            </span>
                        </label>

                        <label style="display: flex; align-items: start; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: white; border-radius: 8px; border: 2px solid var(--gray-200); transition: all 0.2s;">
                            <input type="checkbox" class="work-task" required style="width: 20px; height: 20px; cursor: pointer; margin-top: 2px; flex-shrink: 0;">
                            <span style="flex: 1;">
                                <strong>Strimming</strong> as required to whole site
                            </span>
                        </label>

                        <label style="display: flex; align-items: start; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: white; border-radius: 8px; border: 2px solid var(--gray-200); transition: all 0.2s;">
                            <input type="checkbox" class="work-task" required style="width: 20px; height: 20px; cursor: pointer; margin-top: 2px; flex-shrink: 0;">
                            <span style="flex: 1;">
                                <strong>Weed suppressant</strong> applied as per map provided (Glyphosate based)
                            </span>
                        </label>

                        <label style="display: flex; align-items: start; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: white; border-radius: 8px; border: 2px solid var(--gray-200); transition: all 0.2s;">
                            <input type="checkbox" class="work-task" required style="width: 20px; height: 20px; cursor: pointer; margin-top: 2px; flex-shrink: 0;">
                            <span style="flex: 1;">
                                <strong>General tidy</strong> and rubbish removal
                            </span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="siteNotes">Site Notes / Additional Work</label>
                    <textarea id="siteNotes" placeholder="Any additional notes about this visit..." rows="3"></textarea>
                    <small style="color: var(--gray-500); font-size: 0.85rem;">Note: Weed suppressant can take around 4-6 weeks to take effect</small>
                </div>

                <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.125rem;">Customer Sign-Off *</h3>
                    
                    <div class="form-group">
                        <label for="customerName">Customer Name *</label>
                        <input type="text" id="customerName" required placeholder="e.g. John Smith">
                    </div>

                    <div class="form-group">
                        <label>Customer Signature *</label>
                        <canvas id="signaturePad" class="signature-pad" width="540" height="200" style="touch-action: none;"></canvas>
                        <div class="signature-controls">
                            <button type="button" class="btn btn-secondary" onclick="clearSignature()">Clear Signature</button>
                        </div>
                        <small style="color: var(--gray-500); font-size: 0.85rem;">Customer must sign above to confirm work completed</small>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    Completing this visit will:
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li>Generate a PDF worksheet with customer signature</li>
                        <li>Automatically schedule the next visit</li>
                        <li>Send email notification to finance team</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeCompleteVisitModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-success" style="flex: 1;">‚úì Complete & Generate Worksheet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getDatabase, 
            ref, 
            set, 
            get, 
            update, 
            remove, 
            onValue,
            push,
            query,
            orderByChild,
            equalTo
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import {
            getStorage,
            ref as storageRef,
            uploadBytes,
            getDownloadURL
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDiARsn-HBhwuHuWjmeAB9ntRxyd4FSR-E",
            authDomain: "roundwood-manager.firebaseapp.com",
            databaseURL: "https://roundwood-manager-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "roundwood-manager",
            storageBucket: "roundwood-manager.firebasestorage.app",
            messagingSenderId: "1064499324684",
            appId: "1:1064499324684:web:c974e276f5b86092bbcb29"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const storage = getStorage(app);

        // Make functions globally available
        window.auth = auth;
        window.database = database;
        window.storage = storage;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.dbUpdate = update;
        window.dbRemove = remove;
        window.dbOnValue = onValue;
        window.dbPush = push;
        window.dbQuery = query;
        window.dbOrderByChild = orderByChild;
        window.dbEqualTo = equalTo;
        window.storageRef = storageRef;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;

        // Auth State Listener
        onAuthStateChanged(auth, (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');

            if (user) {
                // User is logged in
                document.getElementById('userEmail').textContent = user.email;
                loadingScreen.style.display = 'none';
                loginScreen.style.display = 'none';
                mainApp.style.display = 'flex';
                
                // Initialize app data
                window.currentUser = user;
                loadAppData();
            } else {
                // User is logged out
                loadingScreen.style.display = 'none';
                loginScreen.style.display = 'flex';
                mainApp.style.display = 'none';
            }
        });

        // Login Handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        });

        // Register Handlers
        document.getElementById('showRegisterBtn').addEventListener('click', () => {
            document.getElementById('registerModal').classList.add('active');
        });

        window.closeRegisterModal = () => {
            document.getElementById('registerModal').classList.remove('active');
            document.getElementById('registerForm').reset();
            document.getElementById('registerError').style.display = 'none';
        };

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const role = document.getElementById('registerRole').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerConfirm').value;
            const errorDiv = document.getElementById('registerError');

            if (password !== confirm) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Create user profile
                await set(ref(database, `userProfiles/${user.uid}`), {
                    name: name,
                    role: role,
                    email: email,
                    createdAt: new Date().toISOString()
                });
                
                closeRegisterModal();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        });

        // Logout
        window.logout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        console.log('Firebase initialized successfully');
    </script>

    <script>
        // Send Invoice Request Email using mailto
        function sendInvoiceEmail(visit) {
            const emailSubject = `Invoice Required: ${visit.siteName} - Completed ${visit.completedDate}`;
            
            const emailBody = `
Visit Completion Details & Worksheet
====================================

Site Information:
- Site Name: ${visit.siteName}
- Address: ${visit.siteAddress}

Work Details:
- Completed By: ${visit.completedBy}
- Completed On: ${new Date(visit.completedDate).toLocaleDateString('en-GB')}
- Invoice Amount: ¬£${visit.price.toFixed(2)}

Work Completed (All tasks done):
${visit.workSummary}

${visit.siteNotes ? `Site Notes:\n${visit.siteNotes}\n` : ''}
Customer Sign-Off:
- Customer Name: ${visit.customerName}
- Signature: Captured digitally (view in app History)

Next Visit Scheduled:
- ${new Date(new Date(visit.scheduledDate).getTime() + (visit.frequency * 24 * 60 * 60 * 1000)).toLocaleDateString('en-GB')}

REMINDER: 
- Field staff should have before/after photos on their phone
- Customer signature captured digitally
- Worksheet completed and signed off

Please prepare and send invoice to the customer.

---
This notification was generated automatically by Roundwood Route Manager.
            `.trim();

            const mailto = `mailto:office@roundwoodsolutions.co.uk?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
            window.location.href = mailto;
        }

        // App State
        let sites = [];
        let visits = [];
        let beforePhotosData = [];
        let afterPhotosData = [];
        let signaturePad = null;
        let isDrawing = false;

        // Initialize signature pad
        function initSignaturePad() {
            const canvas = document.getElementById('signaturePad');
            if (!canvas) return;
            
            signaturePad = canvas.getContext('2d');
            signaturePad.strokeStyle = '#000';
            signaturePad.lineWidth = 2;
            signaturePad.lineCap = 'round';
            
            let lastX = 0;
            let lastY = 0;
            
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                lastX = touch.clientX - rect.left;
                lastY = touch.clientY - rect.top;
                isDrawing = true;
            });
            
            canvas.addEventListener('touchmove', (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                signaturePad.beginPath();
                signaturePad.moveTo(lastX, lastY);
                signaturePad.lineTo(x, y);
                signaturePad.stroke();
                
                lastX = x;
                lastY = y;
            });
            
            canvas.addEventListener('touchend', () => {
                isDrawing = false;
            });
            
            canvas.addEventListener('mousedown', (e) => {
                const rect = canvas.getBoundingClientRect();
                lastX = e.clientX - rect.left;
                lastY = e.clientY - rect.top;
                isDrawing = true;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                signaturePad.beginPath();
                signaturePad.moveTo(lastX, lastY);
                signaturePad.lineTo(x, y);
                signaturePad.stroke();
                
                lastX = x;
                lastY = y;
            });
            
            canvas.addEventListener('mouseup', () => {
                isDrawing = false;
            });
            
            canvas.addEventListener('mouseleave', () => {
                isDrawing = false;
            });
        }

        window.clearSignature = function() {
            const canvas = document.getElementById('signaturePad');
            if (signaturePad) {
                signaturePad.clearRect(0, 0, canvas.width, canvas.height);
            }
        };

        // Photo upload handlers
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('beforePhotos')?.addEventListener('change', (e) => {
                handlePhotoUpload(e.target.files, 'before');
            });
            
            document.getElementById('afterPhotos')?.addEventListener('change', (e) => {
                handlePhotoUpload(e.target.files, 'after');
            });
            
            initSignaturePad();
        });

        async function handlePhotoUpload(files, type) {
            const previewContainer = document.getElementById(`${type}PhotosPreview`);
            const dataArray = type === 'before' ? beforePhotosData : afterPhotosData;
            
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.createElement('div');
                    preview.className = 'photo-preview-item';
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="${type} photo">
                        <button type="button" class="photo-remove" onclick="removePhoto('${type}', ${dataArray.length})">√ó</button>
                    `;
                    previewContainer.appendChild(preview);
                    
                    dataArray.push({
                        data: e.target.result,
                        file: file
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        window.removePhoto = function(type, index) {
            const dataArray = type === 'before' ? beforePhotosData : afterPhotosData;
            const previewContainer = document.getElementById(`${type}PhotosPreview`);
            
            dataArray.splice(index, 1);
            previewContainer.children[index].remove();
        };

        // Load App Data
        async function loadAppData() {
            const userId = window.currentUser.uid;
            
            // Listen to sites
            const sitesRef = window.dbRef(window.database, `users/${userId}/sites`);
            window.dbOnValue(sitesRef, (snapshot) => {
                sites = [];
                snapshot.forEach((childSnapshot) => {
                    sites.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                renderSites();
                updateStats();
            });

            // Listen to visits
            const visitsRef = window.dbRef(window.database, `users/${userId}/visits`);
            window.dbOnValue(visitsRef, (snapshot) => {
                visits = [];
                snapshot.forEach((childSnapshot) => {
                    visits.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                renderVisits();
                renderInvoices();
                renderHistory();
                renderTodayVisits();
                updateStats();
            });
        }

        // Tab Navigation
        window.showTab = (tabName) => {
            // Update tab buttons
            document.querySelectorAll('.nav-tabs button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show tab content
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
        };

        // Add Site Modal
        window.openAddSiteModal = () => {
            document.getElementById('addSiteModal').classList.add('active');
            // Set default first visit to today
            document.getElementById('siteFirstVisit').valueAsDate = new Date();
        };

        window.closeAddSiteModal = () => {
            document.getElementById('addSiteModal').classList.remove('active');
            document.getElementById('addSiteForm').reset();
        };

        // Add Site Handler
        document.getElementById('addSiteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const siteData = {
                name: document.getElementById('siteName').value,
                address: document.getElementById('siteAddress').value,
                contact: document.getElementById('siteContact').value,
                phone: document.getElementById('sitePhone').value,
                frequency: parseInt(document.getElementById('siteFrequency').value),
                price: parseFloat(document.getElementById('sitePrice').value),
                firstVisit: document.getElementById('siteFirstVisit').value,
                notes: document.getElementById('siteNotes').value,
                createdAt: new Date().toISOString()
            };

            try {
                const userId = window.currentUser.uid;
                const siteRef = window.dbPush(window.dbRef(window.database, `users/${userId}/sites`));
                await window.dbSet(siteRef, siteData);

                // Create first visit
                const visitData = {
                    siteId: siteRef.key,
                    siteName: siteData.name,
                    siteAddress: siteData.address,
                    scheduledDate: siteData.firstVisit,
                    price: siteData.price,
                    frequency: siteData.frequency,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };

                const visitRef = window.dbPush(window.dbRef(window.database, `users/${userId}/visits`));
                await window.dbSet(visitRef, visitData);

                closeAddSiteModal();
            } catch (error) {
                console.error('Error adding site:', error);
                alert('Error adding site. Please try again.');
            }
        });

        // Render Sites
        function renderSites() {
            const container = document.getElementById('sitesContainer');
            
            if (sites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìç</div>
                        <div class="empty-state-title">No sites yet</div>
                        <div class="empty-state-text">Add your first site to get started with route management</div>
                        <button class="btn btn-primary" onclick="openAddSiteModal()">+ Add Your First Site</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = sites.map(site => {
                const frequencyText = {
                    7: 'Weekly',
                    14: 'Fortnightly',
                    28: '4-Weekly',
                    30: 'Monthly'
                }[site.frequency] || `Every ${site.frequency} days`;

                return `
                    <div class="site-card">
                        <div class="site-header">
                            <div>
                                <div class="site-name">${site.name}</div>
                                <div class="site-address">${site.address}</div>
                            </div>
                            <span class="badge-frequency">${frequencyText}</span>
                        </div>
                        <div class="site-meta">
                            ${site.contact ? `
                                <div class="meta-item">
                                    <div class="meta-label">Contact</div>
                                    <div class="meta-value">${site.contact}</div>
                                </div>
                            ` : ''}
                            ${site.phone ? `
                                <div class="meta-item">
                                    <div class="meta-label">Phone</div>
                                    <div class="meta-value">${site.phone}</div>
                                </div>
                            ` : ''}
                            <div class="meta-item">
                                <div class="meta-label">Price</div>
                                <div class="meta-value">¬£${site.price.toFixed(2)}</div>
                            </div>
                            ${site.notes ? `
                                <div class="meta-item" style="grid-column: 1 / -1;">
                                    <div class="meta-label">Notes</div>
                                    <div class="meta-value">${site.notes}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render Visits
        function renderVisits() {
            const container = document.getElementById('visitsContainer');
            const today = new Date().toISOString().split('T')[0];
            
            const upcomingVisits = visits
                .filter(v => v.status === 'pending')
                .sort((a, b) => new Date(a.scheduledDate) - new Date(b.scheduledDate));

            if (upcomingVisits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <div class="empty-state-title">No upcoming visits</div>
                        <div class="empty-state-text">All visits are completed or there are no sites yet</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = upcomingVisits.map(visit => {
                const isOverdue = visit.scheduledDate < today;
                const visitDate = new Date(visit.scheduledDate);
                const formattedDate = visitDate.toLocaleDateString('en-GB', { 
                    weekday: 'short', 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                });

                return `
                    <div class="visit-card ${isOverdue ? 'overdue' : ''}">
                        <div class="visit-header">
                            <div>
                                <div class="visit-site">${visit.siteName}</div>
                                <div class="visit-date">${formattedDate}</div>
                                <div class="site-address" style="margin-top: 0.5rem;">${visit.siteAddress}</div>
                            </div>
                            <span class="visit-status ${isOverdue ? 'status-overdue' : 'status-pending'}">
                                ${isOverdue ? 'Overdue' : 'Pending'}
                            </span>
                        </div>
                        <div class="visit-actions">
                            <button class="btn btn-success" onclick="openCompleteVisitModal('${visit.id}')" style="flex: 1;">
                                ‚úì Complete Visit
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Complete Visit Modal
        window.openCompleteVisitModal = (visitId) => {
            const visit = visits.find(v => v.id === visitId);
            if (!visit) return;
            
            document.getElementById('completeVisitId').value = visitId;
            document.getElementById('completedBy').value = window.currentUser.name;
            
            // Clear signature pad
            setTimeout(() => {
                const canvas = document.getElementById('signaturePad');
                if (canvas && signaturePad) {
                    signaturePad.clearRect(0, 0, canvas.width, canvas.height);
                }
            }, 100);
            
            document.getElementById('completeVisitModal').classList.add('active');
        };

        window.closeCompleteVisitModal = () => {
            document.getElementById('completeVisitModal').classList.remove('active');
            document.getElementById('completeVisitForm').reset();
            
            // Clear signature
            const canvas = document.getElementById('signaturePad');
            if (canvas && signaturePad) {
                signaturePad.clearRect(0, 0, canvas.width, canvas.height);
            }
        };

        // Complete Visit Handler
        document.getElementById('completeVisitForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Form submitted');
            
            const visitId = document.getElementById('completeVisitId').value;
            const completedBy = document.getElementById('completedBy').value;
            const siteNotes = document.getElementById('siteNotes').value;
            const customerName = document.getElementById('customerName').value;

            console.log('Form data:', { visitId, completedBy, siteNotes, customerName });

            // Check all work tasks are ticked
            const workTasks = document.querySelectorAll('.work-task');
            const allTasksChecked = Array.from(workTasks).every(task => task.checked);
            
            if (!allTasksChecked) {
                alert('Please tick all work tasks to confirm they are completed.');
                return;
            }

            // Validate signature
            const canvas = document.getElementById('signaturePad');
            const signatureData = canvas.toDataURL();
            const blankCanvas = document.createElement('canvas');
            blankCanvas.width = canvas.width;
            blankCanvas.height = canvas.height;
            if (signatureData === blankCanvas.toDataURL()) {
                alert('Please get customer signature before completing.');
                return;
            }

            const visit = visits.find(v => v.id === visitId);
            if (!visit) {
                console.error('Visit not found:', visitId);
                return;
            }

            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Processing...';

            try {
                const userId = window.currentUser.uid;
                const completedDate = new Date().toISOString().split('T')[0];
                
                console.log('Updating visit in database...');
                
                // Build work completed summary
                const tasksCompleted = [
                    'Weed removal to appropriate areas - entrance/exits etc',
                    'Strimming as required to whole site',
                    'Weed suppressant applied as per map provided (Glyphosate based)',
                    'General tidy and rubbish removal'
                ];
                
                const workSummary = tasksCompleted.map((task, i) => `${i + 1}. ${task}`).join('\n');
                
                // Update current visit
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/visits/${visitId}`), {
                    status: 'completed',
                    completedDate: completedDate,
                    completedBy: completedBy,
                    workCompleted: tasksCompleted,
                    siteNotes: siteNotes,
                    customerName: customerName,
                    customerSignature: signatureData,
                    worksheetCompleted: true,
                    invoiceStatus: 'pending',
                    completedAt: new Date().toISOString()
                });

                console.log('Visit updated, creating next visit...');

                // Create next visit
                const nextVisitDate = new Date(visit.scheduledDate);
                nextVisitDate.setDate(nextVisitDate.getDate() + visit.frequency);

                const nextVisitData = {
                    siteId: visit.siteId,
                    siteName: visit.siteName,
                    siteAddress: visit.siteAddress,
                    scheduledDate: nextVisitDate.toISOString().split('T')[0],
                    price: visit.price,
                    frequency: visit.frequency,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };

                const nextVisitRef = window.dbPush(window.dbRef(window.database, `users/${userId}/visits`));
                await window.dbSet(nextVisitRef, nextVisitData);

                console.log('Next visit created, closing modal...');

                closeCompleteVisitModal();

                console.log('Sending email...');

                // Send email notification with worksheet details
                const visitForEmail = {
                    ...visit,
                    completedDate: completedDate,
                    completedBy: completedBy,
                    workSummary: workSummary,
                    siteNotes: siteNotes,
                    customerName: customerName
                };
                sendInvoiceEmail(visitForEmail);
                
                console.log('Email sent, showing success message');
                alert('‚úÖ Visit completed!\nüìß Email notification sent\nüìÖ Next visit scheduled\n\nWorksheet saved with customer signature');
            } catch (error) {
                console.error('Error completing visit:', error);
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                alert('Error completing visit: ' + error.message + '\n\nPlease check the console (F12) for details.');
            }
        });

        // Mark Invoice Sent
        window.markInvoiceSent = async (visitId) => {
            if (!confirm('Mark this invoice as sent? This will clear it from the tracking list.')) {
                return;
            }

            try {
                const userId = window.currentUser.uid;
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/visits/${visitId}`), {
                    invoiceStatus: 'sent',
                    invoiceSentDate: new Date().toISOString().split('T')[0]
                });
            } catch (error) {
                console.error('Error updating invoice status:', error);
                alert('Error updating invoice status. Please try again.');
            }
        };

        // Render Invoices
        function renderInvoices() {
            const container = document.getElementById('invoicesContainer');
            
            const uninvoicedVisits = visits
                .filter(v => v.status === 'completed' && v.invoiceStatus === 'pending')
                .sort((a, b) => new Date(a.completedDate) - new Date(b.completedDate));

            if (uninvoicedVisits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <div class="empty-state-title">All caught up!</div>
                        <div class="empty-state-text">No invoices awaiting to be sent</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = uninvoicedVisits.map(visit => {
                const completedDate = new Date(visit.completedDate);
                const formattedDate = completedDate.toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                });

                return `
                    <div class="visit-card">
                        <div class="visit-header">
                            <div>
                                <div class="visit-site">${visit.siteName}</div>
                                <div class="visit-date">Completed: ${formattedDate}</div>
                                <div class="site-address" style="margin-top: 0.5rem;">${visit.siteAddress}</div>
                            </div>
                            <span class="visit-status status-pending">Invoice Needed</span>
                        </div>
                        <div class="meta-item" style="margin-top: 1rem;">
                            <div class="meta-label">Amount</div>
                            <div class="meta-value">¬£${visit.price.toFixed(2)}</div>
                        </div>
                        ${visit.completedBy ? `
                            <div class="meta-item" style="margin-top: 0.5rem;">
                                <div class="meta-label">Completed By</div>
                                <div class="meta-value">${visit.completedBy}</div>
                            </div>
                        ` : ''}
                        ${visit.completionNotes ? `
                            <div class="meta-item" style="margin-top: 0.5rem;">
                                <div class="meta-label">Notes</div>
                                <div class="meta-value">${visit.completionNotes}</div>
                            </div>
                        ` : ''}
                        <div class="visit-actions">
                            <button class="btn btn-success" onclick="markInvoiceSent('${visit.id}')" style="flex: 1;">
                                ‚úì Mark Invoice Sent
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render History
        function renderHistory() {
            const container = document.getElementById('historyContainer');
            
            const completedVisits = visits
                .filter(v => v.status === 'completed')
                .sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate))
                .slice(0, 20);

            if (completedVisits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìú</div>
                        <div class="empty-state-title">No history yet</div>
                        <div class="empty-state-text">Completed visits will appear here</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = completedVisits.map(visit => {
                const completedDate = new Date(visit.completedDate);
                const formattedDate = completedDate.toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                });

                const invoiceStatus = visit.invoiceStatus === 'sent' ? 'Invoiced' : 'Awaiting Invoice';
                const invoiceClass = visit.invoiceStatus === 'sent' ? 'status-completed' : 'status-pending';

                return `
                    <div class="visit-card completed">
                        <div class="visit-header">
                            <div>
                                <div class="visit-site">${visit.siteName}</div>
                                <div class="visit-date">${formattedDate}</div>
                            </div>
                            <span class="visit-status ${invoiceClass}">${invoiceStatus}</span>
                        </div>
                        <div class="site-meta" style="margin-top: 1rem;">
                            ${visit.completedBy ? `
                                <div class="meta-item">
                                    <div class="meta-label">Completed By</div>
                                    <div class="meta-value">${visit.completedBy}</div>
                                </div>
                            ` : ''}
                            <div class="meta-item">
                                <div class="meta-label">Amount</div>
                                <div class="meta-value">¬£${visit.price.toFixed(2)}</div>
                            </div>
                            ${visit.completionNotes ? `
                                <div class="meta-item" style="grid-column: 1 / -1;">
                                    <div class="meta-label">Notes</div>
                                    <div class="meta-value">${visit.completionNotes}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render Today's Visits
        function renderTodayVisits() {
            const container = document.getElementById('todayVisits');
            const today = new Date().toISOString().split('T')[0];
            
            const todayVisits = visits
                .filter(v => v.scheduledDate === today && v.status === 'pending');

            if (todayVisits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <div class="empty-state-text">No visits scheduled for today</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = todayVisits.map(visit => `
                <div class="visit-card">
                    <div class="visit-header">
                        <div>
                            <div class="visit-site">${visit.siteName}</div>
                            <div class="site-address" style="margin-top: 0.5rem;">${visit.siteAddress}</div>
                        </div>
                        <span class="visit-status status-pending">Today</span>
                    </div>
                    <div class="visit-actions">
                        <button class="btn btn-success" onclick="openCompleteVisitModal('${visit.id}')" style="flex: 1;">
                            ‚úì Complete Visit
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Update Stats
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('statTotalSites').textContent = sites.length;
            
            const upcomingVisits = visits.filter(v => v.status === 'pending').length;
            document.getElementById('statUpcomingVisits').textContent = upcomingVisits;
            document.getElementById('upcomingCount').textContent = upcomingVisits;
            
            const uninvoiced = visits.filter(v => v.status === 'completed' && v.invoiceStatus === 'pending').length;
            document.getElementById('statUninvoiced').textContent = uninvoiced;
            document.getElementById('uninvoicedCount').textContent = uninvoiced;
            
            const completedToday = visits.filter(v => v.completedDate === today).length;
            document.getElementById('statCompletedToday').textContent = completedToday;
        }
    </script>
</body>
</html>