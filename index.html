<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roundwood Route Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Google Drive API -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2d5016;
            --primary-light: #5a8a3a;
            --primary-dark: #1a3009;
            --accent: #8fbc5a;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.5;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            inset: 0;
            background: var(--primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Login Screen */
        #loginScreen {
            display: none;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 2rem;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: white;
            border-radius: 16px;
            padding: 3rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .login-card h1 {
            color: var(--primary);
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .login-card p {
            color: var(--gray-600);
            text-align: center;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: var(--gray-700);
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 80, 22, 0.3);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .alert {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        /* Main App */
        #mainApp {
            display: none;
            min-height: 100vh;
            flex-direction: column;
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-email {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-export {
            background: rgba(255,255,255,0.25);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.3);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            margin-right: 0.5rem;
        }

        .btn-export:hover {
            background: rgba(255,255,255,0.35);
            border-color: rgba(255,255,255,0.5);
        }

        .nav-tabs {
            background: white;
            border-bottom: 2px solid var(--gray-200);
            padding: 0 1.5rem;
            overflow-x: auto;
            overflow-y: visible;
            white-space: nowrap;
        }

        .nav-tabs button {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .nav-tabs button:hover {
            color: var(--primary);
            background: var(--gray-50);
        }

        .nav-tabs button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .nav-tabs button .badge {
            background: var(--danger);
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            margin-left: 0.5rem;
            font-weight: 600;
        }

        /* Dropdown Menu */
        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dropdown-toggle:hover {
            color: var(--primary);
            background: var(--gray-50);
        }

        .dropdown-toggle.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .dropdown-arrow {
            font-size: 0.7rem;
            transition: transform 0.2s;
        }

        .nav-dropdown.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            display: none;
            position: fixed;
            background: white;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 0.5rem 0;
            z-index: 10000;
            margin-top: 0.5rem;
        }

        .nav-dropdown.open .dropdown-menu {
            display: block;
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 0.75rem 1.5rem;
            text-align: left;
            background: none;
            border: none;
            color: var(--gray-700);
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .dropdown-item:hover {
            background: var(--gray-50);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .tab-content {
            flex: 1;
            padding: 2rem 1.5rem;
        }

        .tab-pane {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tab-pane.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-100);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .site-card {
            border: 2px solid var(--gray-200);
            padding: 1.25rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .site-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(45, 80, 22, 0.1);
        }

        .site-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .site-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .site-address {
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .site-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .meta-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .meta-value {
            font-size: 0.95rem;
            color: var(--gray-900);
            font-weight: 500;
        }

        .badge-frequency {
            display: inline-block;
            background: var(--primary-light);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .visit-card {
            border-left: 4px solid var(--warning);
            background: white;
            padding: 1.25rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .visit-card.completed {
            border-left-color: var(--success);
            opacity: 0.7;
        }

        .visit-card.overdue {
            border-left-color: var(--danger);
            background: #fef2f2;
        }

        .visit-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .visit-site {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--gray-900);
        }

        .visit-date {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
        }

        .visit-status {
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-overdue {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-paused {
            background: #e0e7ff;
            color: #3730a3;
        }

        .visit-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(2px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-400);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .btn-close:hover {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 100px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--gray-500);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        .empty-state-text {
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .header-content h1 {
                font-size: 1.125rem;
            }

            .user-email {
                display: none;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .site-meta {
                grid-template-columns: 1fr;
            }

            .visit-actions {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Calculator Specific Styles */
        .calc-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--gray-50);
            border-radius: 8px;
        }

        .calc-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-light);
        }

        .calc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .calc-grid {
                grid-template-columns: 1fr;
            }
        }

        .calc-input {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 2px solid var(--gray-300);
        }

        .calc-input.preset {
            background: #fff3e0;
            border-color: #ff9800;
        }

        .calc-result {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 6px;
            border: 2px solid #2196f3;
        }

        .calc-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .calc-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .calc-unit {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-left: 0.5rem;
        }

        .saved-calc-item {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid var(--gray-200);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .saved-calc-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .saved-calc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .saved-calc-title {
            font-weight: 600;
            color: var(--gray-900);
        }

        .saved-calc-date {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .saved-calc-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        /* Collapsible Sections */
        .collapsible-section {
            margin-bottom: 1rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
            font-weight: 600;
        }

        .collapsible-header:hover {
            opacity: 0.9;
        }

        .collapsible-header:active {
            transform: scale(0.99);
        }

        .collapsible-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.125rem;
        }

        .collapsible-badge {
            background: rgba(255, 255, 255, 0.3);
            color: inherit;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .collapsible-arrow {
            font-size: 1.25rem;
            transition: transform 0.3s ease;
        }

        .collapsible-section.open .collapsible-arrow {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: white;
        }

        .collapsible-section.open .collapsible-content {
            max-height: 2000px;
        }

        .collapsible-inner {
            padding: 1rem 1.25rem;
        }

        .section-description {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 1rem;
        }

        /* Pipeline-specific styles */
        .pipeline-card {
            background: white;
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border-left: 4px solid;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .pipeline-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .pipeline-card-ref {
            font-size: 0.85rem;
            color: var(--gray-500);
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .pipeline-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .pipeline-card-subtitle {
            font-size: 0.9rem;
            color: var(--gray-500);
        }

        .pipeline-card-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            text-align: right;
        }

        .pipeline-card-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .meta-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            font-weight: 600;
        }

        .meta-value {
            font-size: 0.95rem;
            color: var(--gray-700);
            font-weight: 500;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-badge.sent {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.not-sent {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-badge.approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-badge.invoiced {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.paid {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.unpaid {
            background: #fef3c7;
            color: #92400e;
        }

        .date-prefill {
            display: inline-block;
            background: #d1fae5;
            color: #065f46;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
            font-weight: 600;
        }

        .info-box {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--info);
        }

        .info-box strong {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--gray-800);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <p style="margin-top: 1rem;">Loading Roundwood Manager...</p>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-card">
            <h1>üå≥ Roundwood</h1>
            <p>Route Manager</p>
            
            <div id="loginError" style="display: none;" class="alert alert-error"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="btn btn-primary">Sign In</button>
            </form>
            
            <div style="text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
                <p style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">
                    Don't have an account?
                </p>
                <button id="showRegisterBtn" class="btn btn-secondary" style="width: 100%;">
                    Create Account
                </button>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create Account</h2>
                <button class="btn-close" onclick="closeRegisterModal()">√ó</button>
            </div>
            
            <div id="registerError" style="display: none;" class="alert alert-error"></div>
            
            <form id="registerForm">
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
                    <small style="color: var(--gray-500); font-size: 0.8rem;">Minimum 6 characters</small>
                </div>
                <div class="form-group">
                    <label for="registerConfirm">Confirm Password</label>
                    <input type="password" id="registerConfirm" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="btn btn-primary">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp">
        <header class="header">
            <div class="header-content">
                <h1>üå≥ Roundwood Route Manager</h1>
                <div class="user-info">
                    <span class="user-email" id="userEmail"></span>
                    <button class="btn-logout" onclick="logout()">Sign Out</button>
                </div>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button onclick="showTab('pipeline')">üéØ Pipeline <span class="badge" id="pipelineCount">0</span></button>
            <button onclick="showTab('visits')">üìÖ Upcoming Visits <span class="badge" id="upcomingCount">0</span></button>
            <button onclick="showTab('invoices')">üí∞ Invoice Tracking <span class="badge" id="uninvoicedCount">0</span></button>
            <button onclick="showTab('reviews')">‚≠ê Reviews</button>
            
            <!-- Tools Dropdown -->
            <div class="nav-dropdown" id="toolsDropdown">
                <button class="dropdown-toggle" onclick="toggleDropdown(event)">
                    üîß Tools
                    <span class="dropdown-arrow">‚ñº</span>
                </button>
                <div class="dropdown-menu">
                    <button class="dropdown-item" onclick="exportAllDataToExcel(); closeDropdown();">üì§ Export All Data</button>
                    <button class="dropdown-item" onclick="toggleAutoBackup(); closeDropdown();">
                        <span id="autoBackupMenuItem">‚úÖ Auto-Backup: ON</span>
                    </button>
                    <button class="dropdown-item" onclick="authenticateGoogleDrive(); closeDropdown();">
                        <span id="googleDriveMenuItem">üîó Connect Google Drive</span>
                    </button>
                    <button class="dropdown-item" onclick="showTab('sites'); closeDropdown();">üìç Sites</button>
                    <button class="dropdown-item" onclick="showTab('history'); closeDropdown();">üìú History</button>
                    <button class="dropdown-item" onclick="showTab('calculator'); closeDropdown();">üß™ Calibration</button>
                </div>
            </div>
        </nav>

        <script>
        // Dropdown Menu Functions - Available immediately
        (function() {
            console.log('üîß Dropdown script loaded');
            
            window.toggleDropdown = function(event) {
                console.log('üîß toggleDropdown called');
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                const dropdown = document.getElementById('toolsDropdown');
                if (dropdown) {
                    const isOpen = dropdown.classList.contains('open');
                    console.log('üîß Dropdown current state:', isOpen ? 'open' : 'closed');
                    
                    if (!isOpen) {
                        // Calculate position before opening
                        const button = dropdown.querySelector('.dropdown-toggle');
                        const menu = dropdown.querySelector('.dropdown-menu');
                        if (button && menu) {
                            const rect = button.getBoundingClientRect();
                            menu.style.top = (rect.bottom + 5) + 'px';
                            menu.style.left = rect.left + 'px';
                            console.log('üîß Positioned dropdown at:', rect.left, rect.bottom + 5);
                        }
                    }
                    
                    dropdown.classList.toggle('open');
                    console.log('üîß Dropdown new state:', dropdown.classList.contains('open') ? 'open' : 'closed');
                } else {
                    console.error('üîß toolsDropdown element not found!');
                }
            };

            window.closeDropdown = function() {
                console.log('üîß closeDropdown called');
                const dropdown = document.getElementById('toolsDropdown');
                if (dropdown) {
                    dropdown.classList.remove('open');
                }
            };

            // Close dropdown when clicking outside - set up immediately
            setTimeout(function() {
                document.addEventListener('click', function(event) {
                    const dropdown = document.getElementById('toolsDropdown');
                    if (dropdown && !dropdown.contains(event.target)) {
                        dropdown.classList.remove('open');
                    }
                });
                console.log('üîß Click-outside listener added');
            }, 100);
        })();
        </script>

        <div class="tab-content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-pane active">
                <!-- Awaiting Invoice (Full Width) -->
                <div class="collapsible-section" style="margin-bottom: 1rem;">
                    <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b;">
                        <div class="collapsible-title">
                            <span>üí∞ Awaiting Invoice</span>
                            <span class="collapsible-badge" id="statUninvoiced">0</span>
                        </div>
                        <span class="collapsible-arrow">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-inner">
                            <p class="section-description" style="color: #7f1d1d;">Click Invoice Tracking tab to view and manage uninvoiced work</p>
                        </div>
                    </div>
                </div>

                <!-- Due Today (Collapsible) -->
                <div id="dueTodayCard" style="display: none;">
                    <div class="collapsible-section open">
                        <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e;">
                            <div class="collapsible-title">
                                <span>üìÖ Due Today</span>
                                <span class="collapsible-badge" id="dueTodayBadge">0</span>
                            </div>
                            <span class="collapsible-arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="collapsible-inner">
                                <p class="section-description" style="color: #78350f;">Visits and projects scheduled for today:</p>
                                <div id="dueTodayContent"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Visit Reminders (Collapsible) -->
                <div id="visitRemindersCard" style="display: none;">
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e;">
                            <div class="collapsible-title">
                                <span>‚è∞ Upcoming Reminders</span>
                                <span class="collapsible-badge" id="remindersBadge">0</span>
                            </div>
                            <span class="collapsible-arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="collapsible-inner">
                                <p class="section-description" style="color: #78350f;">Sites with visits in 1-3 days - consider sending courtesy reminders:</p>
                                <div id="visitRemindersContent"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Projects (Collapsible) -->
                <div id="activeProjectsCard" style="display: none;">
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); color: #5b21b6;">
                            <div class="collapsible-title">
                                <span>üöß Active Projects</span>
                                <span class="collapsible-badge" id="activeProjectsBadge">0</span>
                            </div>
                            <span class="collapsible-arrow">‚ñº</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="collapsible-inner">
                                <p class="section-description" style="color: #6b21a8;">Projects in progress or starting soon:</p>
                                <div id="activeProjectsContent"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Next Due Visits (Collapsible) -->
                <div class="collapsible-section open">
                    <div class="collapsible-header" onclick="toggleSection(this)" style="background: var(--primary); color: white;">
                        <div class="collapsible-title">
                            <span>üìÖ Next 7 Days</span>
                            <span class="collapsible-badge" id="nextSevenBadge">0</span>
                        </div>
                        <span class="collapsible-arrow">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-inner">
                            <p class="section-description" style="color: var(--gray-600);">Upcoming visits and projects in the next week:</p>
                            <div id="nextVisits"></div>
                        </div>
                    </div>
                </div>

                <!-- Seasonal Tips (Collapsible) -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46;">
                        <div class="collapsible-title">
                            <span>üå± This Month's Focus</span>
                        </div>
                        <span class="collapsible-arrow">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-inner">
                            <div id="seasonalTips" style="color: #064e3b;"></div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Upsells (Collapsible) -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af;">
                        <div class="collapsible-title">
                            <span>üíº Upsell Opportunities</span>
                        </div>
                        <span class="collapsible-arrow">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-inner">
                            <div id="monthlyUpsells" style="color: #1e3a8a;"></div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Sites Tab -->
            <!-- Sites Tab -->
            <div id="sites" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">All Sites</h2>
                        <button class="btn btn-primary" onclick="openAddSiteModal()">+ Add New Site</button>
                    </div>
                    <div id="sitesContainer"></div>
                </div>
            </div>

            <!-- Projects Tab -->
            <div id="projects" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">All Projects</h2>
                        <button class="btn btn-primary" onclick="openAddProjectModal()">+ Add New Project</button>
                    </div>
                    <div id="projectsContainer"></div>
                </div>
            </div>

            <!-- Visits Tab -->
            <div id="visits" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Upcoming Visits</h2>
                    </div>
                    <div id="visitsContainer"></div>
                </div>
            </div>

            <!-- Invoices Tab -->
            <div id="invoices" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Invoice Tracking</h2>
                    </div>
                    <div id="invoicesContainer"></div>
                </div>
            </div>

            <!-- Pipeline Tab -->
            <div id="pipeline" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üéØ Project Pipeline</h2>
                        <button class="btn btn-primary" onclick="openAddPipelineJobModal()">+ Add New Lead</button>
                    </div>

                    <div style="padding: 1.5rem;">
                        <!-- New Leads Section -->
                        <div class="collapsible-section open">
                            <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-weight: 600; font-size: 1.1rem;">üÜï New Leads</span>
                                    <span style="background: rgba(0,0,0,0.15); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem;" id="newLeadsCount">0</span>
                                </div>
                                <span class="collapsible-arrow" style="transition: transform 0.2s; font-size: 0.8rem;">‚ñº</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-inner" id="newLeadsContainer">
                                    <div class="empty-state">
                                        <div style="font-size: 2rem; margin-bottom: 1rem;">üìã</div>
                                        <div class="empty-state-text">No new leads</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quotes Sent Section -->
                        <div class="collapsible-section open">
                            <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-weight: 600; font-size: 1.1rem;">üí∑ Quotes Sent</span>
                                    <span style="background: rgba(0,0,0,0.15); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem;" id="quotesSentCount">0</span>
                                </div>
                                <span class="collapsible-arrow" style="transition: transform 0.2s; font-size: 0.8rem;">‚ñº</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-inner" id="quotesSentContainer">
                                    <div class="empty-state">
                                        <div style="font-size: 2rem; margin-bottom: 1rem;">üí∑</div>
                                        <div class="empty-state-text">No quotes sent</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Approved - Ready to Schedule Section -->
                        <div class="collapsible-section">
                            <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-weight: 600; font-size: 1.1rem;">‚úÖ Approved - Ready to Schedule</span>
                                    <span style="background: rgba(0,0,0,0.15); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem;" id="approvedCount">0</span>
                                </div>
                                <span class="collapsible-arrow" style="transition: transform 0.2s; font-size: 0.8rem;">‚ñº</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-inner" id="approvedContainer">
                                    <div class="empty-state">
                                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚úÖ</div>
                                        <div class="empty-state-text">No approved quotes</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Work in Progress Section -->
                        <div class="collapsible-section">
                            <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); color: #3730a3;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-weight: 600; font-size: 1.1rem;">üî® Work in Progress</span>
                                    <span style="background: rgba(0,0,0,0.15); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem;" id="inProgressCount">0</span>
                                </div>
                                <span class="collapsible-arrow" style="transition: transform 0.2s; font-size: 0.8rem;">‚ñº</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-inner" id="inProgressContainer">
                                    <div class="empty-state">
                                        <div style="font-size: 2rem; margin-bottom: 1rem;">üî®</div>
                                        <div class="empty-state-text">No work in progress</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Complete - Awaiting Invoice Section -->
                        <div class="collapsible-section">
                            <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-weight: 600; font-size: 1.1rem;">‚úÖ Complete - Awaiting Invoice</span>
                                    <span style="background: rgba(0,0,0,0.15); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem;" id="completeCount">0</span>
                                </div>
                                <span class="collapsible-arrow" style="transition: transform 0.2s; font-size: 0.8rem;">‚ñº</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-inner" id="completeContainer">
                                    <div class="empty-state">
                                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚úÖ</div>
                                        <div class="empty-state-text">No completed work awaiting invoice</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Invoiced - Awaiting Payment Section -->
                        <div class="collapsible-section">
                            <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-weight: 600; font-size: 1.1rem;">üí∞ Invoiced - Awaiting Payment</span>
                                    <span style="background: rgba(0,0,0,0.15); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem;" id="invoicedCount">0</span>
                                </div>
                                <span class="collapsible-arrow" style="transition: transform 0.2s; font-size: 0.8rem;">‚ñº</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-inner" id="invoicedContainer">
                                    <div class="empty-state">
                                        <div style="font-size: 2rem; margin-bottom: 1rem;">üí∞</div>
                                        <div class="empty-state-text">No invoices awaiting payment</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Completed & Paid Section -->
                        <div class="collapsible-section">
                            <div class="collapsible-header" onclick="toggleSection(this)" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="font-weight: 600; font-size: 1.1rem;">üéâ Completed & Paid</span>
                                    <span style="background: rgba(0,0,0,0.15); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem;" id="paidCount">0</span>
                                </div>
                                <span class="collapsible-arrow" style="transition: transform 0.2s; font-size: 0.8rem;">‚ñº</span>
                            </div>
                            <div class="collapsible-content">
                                <div class="collapsible-inner" id="paidContainer">
                                    <div class="empty-state">
                                        <div style="font-size: 2rem; margin-bottom: 1rem;">üéâ</div>
                                        <div class="empty-state-text">No completed & paid jobs yet</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Completed Visits History</h2>
                    </div>
                    <div id="historyContainer"></div>
                </div>
            </div>

            <!-- Reviews Tab -->
            <div id="reviews" class="tab-pane">
                <div class="card">
                    <h2 class="card-title">‚≠ê Request Google Reviews</h2>
                    <p style="color: var(--gray-600); margin-bottom: 1.5rem;">
                        Send review requests to your customers. They'll get an email with a direct link to leave a Google review.
                    </p>

                    <form id="sendReviewForm" style="max-width: 600px;">
                        <div class="form-group">
                            <label for="reviewBusiness">Business *</label>
                            <select id="reviewBusiness" required style="font-size: 1rem; padding: 0.75rem;">
                                <option value="roundwood">üå≥ Roundwood Solutions - Grounds Maintenance</option>
                                <option value="weedcontrol">üåø Weed Control Kent - Weed Control</option>
                            </select>
                            <small style="color: var(--gray-500); font-size: 0.85rem;">Choose which business this review is for</small>
                        </div>

                        <div class="form-group">
                            <label for="reviewCustomerName">Customer Name *</label>
                            <input type="text" id="reviewCustomerName" required placeholder="e.g. John Smith">
                        </div>

                        <div class="form-group">
                            <label for="reviewCustomerEmail">Customer Email *</label>
                            <input type="email" id="reviewCustomerEmail" required placeholder="customer@example.com">
                        </div>

                        <div class="form-group">
                            <label for="reviewSiteName">Site/Property Name *</label>
                            <input type="text" id="reviewSiteName" required placeholder="e.g. Maidstone Office Park or 123 High Street">
                            <small style="color: var(--gray-500); font-size: 0.85rem;">This will appear in the email</small>
                        </div>

                        <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                            <strong>üìß Email Preview:</strong><br>
                            <span id="emailPreviewText">The customer will receive a professional email thanking them for choosing Roundwood Solutions and asking them to leave a Google review.</span>
                        </div>

                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            üìß Send Review Request
                        </button>
                    </form>
                </div>

                <div class="card" style="margin-top: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">üìä Recent Review Requests</h3>
                    <div id="reviewHistoryContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">‚≠ê</div>
                            <div class="empty-state-text">No review requests sent yet</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calculator Tab -->
            <div id="calculator" class="tab-pane">
                <div class="card">
                    <h2 class="card-title">Sprayer Calibration Calculator</h2>
                    
                    <div id="calcAlert" style="display: none;"></div>

                    <!-- Save Calculation Name -->
                    <div class="form-group">
                        <label for="calcName">Calculation Name (optional)</label>
                        <input type="text" id="calcName" placeholder="e.g. Front Car Park - School Site">
                    </div>

                    <!-- Calibration Setup -->
                    <div class="calc-section">
                        <div class="calc-section-title">Calibration Setup</div>
                        <div class="calc-grid">
                            <div class="calc-input preset">
                                <div class="calc-label">Seconds to spray 100m (preset)</div>
                                <input type="number" id="seconds" value="90" step="1" style="width: 100%; padding: 0.5rem; border: 1px solid #ff9800; border-radius: 4px;">
                                <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">seconds</div>
                            </div>
                            <div class="calc-input">
                                <div class="calc-label">Nozzle output</div>
                                <input type="number" id="nozzleOutput" step="0.1" placeholder="0.0" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">LPM</div>
                            </div>
                            <div class="calc-input preset">
                                <div class="calc-label">Strip width (preset)</div>
                                <input type="number" id="stripWidth" value="1" step="0.1" style="width: 100%; padding: 0.5rem; border: 1px solid #ff9800; border-radius: 4px;">
                                <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">meters</div>
                            </div>
                            <div class="calc-input preset">
                                <div class="calc-label">Sprayer capacity (preset)</div>
                                <input type="number" id="sprayerCapacity" value="15" step="1" style="width: 100%; padding: 0.5rem; border: 1px solid #ff9800; border-radius: 4px;">
                                <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">litres</div>
                            </div>
                        </div>
                    </div>

                    <!-- Results Section 1 & 2 -->
                    <div class="calc-section">
                        <div class="calc-section-title">Walking Speed & Sprayer Output</div>
                        <div class="calc-grid">
                            <div class="calc-result">
                                <div class="calc-label">1. Walking Speed</div>
                                <div class="calc-value" id="walkingSpeed">0.00<span class="calc-unit">KPH</span></div>
                            </div>
                            <div class="calc-result">
                                <div class="calc-label">2. Sprayer Output per Hectare</div>
                                <div class="calc-value" id="sprayerOutput">0.00<span class="calc-unit">L/ha</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Result 3 -->
                    <div class="calc-section">
                        <div class="calc-section-title">Spray Tanks per Hectare</div>
                        <div class="calc-result">
                            <div class="calc-label">3. Number of Spray Tanks per Hectare</div>
                            <div class="calc-value" id="tanksPerHa">0.00<span class="calc-unit">tanks</span></div>
                        </div>
                    </div>

                    <!-- Chemical Application -->
                    <div class="calc-section">
                        <div class="calc-section-title">Chemical Application</div>
                        <div class="calc-grid">
                            <div class="calc-input">
                                <div class="calc-label">Chemical rate</div>
                                <input type="number" id="chemicalRate" step="0.1" placeholder="0.0" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">L/ha</div>
                            </div>
                            <div class="calc-result">
                                <div class="calc-label">4. Chemical per Spray Tank</div>
                                <div class="calc-value" id="chemicalPerTank">0.00<span class="calc-unit">mls</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Area Calculations -->
                    <div class="calc-section">
                        <div class="calc-section-title">Area to be Sprayed</div>
                        <div class="calc-grid">
                            <div class="calc-input">
                                <div class="calc-label">Area to be sprayed</div>
                                <input type="number" id="area" step="1" placeholder="0" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">m¬≤</div>
                            </div>
                            <div></div>
                        </div>
                    </div>

                    <!-- Total Chemical & Water -->
                    <div class="calc-section">
                        <div class="calc-section-title">Total Requirements</div>
                        <div class="calc-grid">
                            <div class="calc-result">
                                <div class="calc-label">5. Total Chemical Required</div>
                                <div class="calc-value" id="totalChemical">0.000<span class="calc-unit">litres</span></div>
                            </div>
                            <div class="calc-result">
                                <div class="calc-label">6. Total Water Required</div>
                                <div class="calc-value" id="totalWater">0.00<span class="calc-unit">litres</span></div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="saveCalculation()">üíæ Save Calculation</button>
                        <button class="btn btn-secondary" onclick="resetCalculator()">üîÑ Reset</button>
                    </div>
                </div>

                <div class="card" style="margin-top: 1.5rem;">
                    <h2 class="card-title">Saved Calculations</h2>
                    <div id="savedCalcsList" class="loading">Loading saved calculations...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- PIPELINE MODALS -->
    
    <!-- Add Pipeline Job Modal -->
    <div id="addPipelineJobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">+ Add New Lead</h2>
                <button class="btn-close" onclick="closeAddPipelineJobModal()">√ó</button>
            </div>
            <form id="addPipelineJobForm">
                <div class="modal-body">
                    <div class="info-box">
                        <strong>üí° Auto-Generated</strong>
                        Job Reference will be automatically assigned
                    </div>

                    <div class="form-group">
                        <label for="pipelineCustomerName">Customer Name *</label>
                        <input type="text" id="pipelineCustomerName" required placeholder="e.g., Tunbury Primary School">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pipelineCustomerPhone">Phone</label>
                            <input type="tel" id="pipelineCustomerPhone" placeholder="01234 567890">
                        </div>
                        <div class="form-group">
                            <label for="pipelineCustomerEmail">Email</label>
                            <input type="email" id="pipelineCustomerEmail" placeholder="contact@customer.com">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="pipelineJobDescription">Job Description *</label>
                        <textarea id="pipelineJobDescription" required placeholder="e.g., Install new fencing around playground"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="pipelineProjectType">Project Type *</label>
                            <select id="pipelineProjectType" required>
                                <option value="">-- Select --</option>
                                <option>Landscaping</option>
                                <option>Paving</option>
                                <option>Fencing</option>
                                <option>Weed Control</option>
                                <option>Tree Work</option>
                                <option>Maintenance Contract</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pipelineEstimatedValue">Estimated Value (¬£)</label>
                            <input type="number" id="pipelineEstimatedValue" placeholder="0.00" step="0.01">
                            <small>Optional - helps prioritize</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="pipelineNotes">Notes (Optional)</label>
                        <textarea id="pipelineNotes" placeholder="Any additional notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddPipelineJobModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Lead</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Send Quote Modal -->
    <div id="sendQuoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí∑ Send Quote</h2>
                <button class="btn-close" onclick="closeSendQuoteModal()">√ó</button>
            </div>
            <form id="sendQuoteForm">
                <div class="modal-body">
                    <div class="info-box">
                        <strong id="quoteJobInfo">Job details</strong>
                    </div>

                    <div class="form-group">
                        <label for="quoteAmount">Quote Amount (Ex VAT) *</label>
                        <input type="number" id="quoteAmount" required placeholder="0.00" step="0.01">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="quoteDate">Date <span class="date-prefill">‚ú® Today</span></label>
                            <input type="date" id="quoteDate" required>
                        </div>
                        <div class="form-group">
                            <label for="quoteValidUntil">Valid Until <span class="date-prefill">‚ú® +30 days</span></label>
                            <input type="date" id="quoteValidUntil" required>
                        </div>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="quoteSent" checked>
                        <label for="quoteSent">Mark as sent immediately</label>
                    </div>

                    <div class="form-group">
                        <label for="requiresApproval">Requires Approval?</label>
                        <select id="requiresApproval" onchange="toggleApprovalFields()">
                            <option value="no">No - Direct to customer</option>
                            <option value="yes">Yes - Needs approval</option>
                            <option value="na">N/A</option>
                        </select>
                    </div>

                    <div id="approvalFields" style="display: none;">
                        <div class="form-group">
                            <label for="poNumber">PO Number</label>
                            <input type="text" id="poNumber" placeholder="e.g., TPS002498">
                            <small>Purchase Order number (if applicable)</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeSendQuoteModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Quote</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mark Approved Modal -->
    <div id="markApprovedModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úÖ Mark Quote Approved</h2>
                <button class="btn-close" onclick="closeMarkApprovedModal()">√ó</button>
            </div>
            <form id="markApprovedForm">
                <div class="modal-body">
                    <div class="info-box">
                        <strong id="approvedJobInfo">Job details</strong>
                    </div>

                    <div class="form-group">
                        <label for="approvalStatus">Approval Status *</label>
                        <select id="approvalStatus" required>
                            <option value="">-- Select --</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected/Not Approved</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="approvedPoNumber">PO Number</label>
                        <input type="text" id="approvedPoNumber" placeholder="e.g., TPS002498">
                        <small>Purchase Order number (if provided)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeMarkApprovedModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Complete Work Modal -->
    <div id="completeWorkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úÖ Mark Work Complete</h2>
                <button class="btn-close" onclick="closeCompleteWorkModal()">√ó</button>
            </div>
            <form id="completeWorkForm">
                <div class="modal-body">
                    <div class="info-box">
                        <strong id="completeJobInfo">Job details</strong>
                    </div>

                    <div class="form-group">
                        <label for="completionDate">Completion Date <span class="date-prefill">‚ú® Today</span></label>
                        <input type="date" id="completionDate" required>
                        <small>Pre-filled with today - change if needed</small>
                    </div>

                    <div class="form-group">
                        <label for="jobStatus">Job Status *</label>
                        <select id="jobStatus" required>
                            <option value="complete">Complete</option>
                            <option value="complete-snagging">Complete (minor snagging)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="snaggingItems">Any Snagging Items?</label>
                        <textarea id="snaggingItems" placeholder="List any minor items to fix (optional)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCompleteWorkModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">‚úÖ Mark Complete</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Send Invoice Modal -->
    <div id="sendInvoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìÑ Send Invoice</h2>
                <button class="btn-close" onclick="closeSendInvoiceModal()">√ó</button>
            </div>
            <form id="sendInvoiceForm">
                <div class="modal-body">
                    <div class="info-box">
                        <strong id="invoiceJobInfo">Job details</strong>
                    </div>

                    <div class="form-group">
                        <label for="invoiceNumber">Invoice Number <span class="date-prefill">‚ú® Auto-generated</span></label>
                        <input type="text" id="invoiceNumber" required placeholder="26-XXX">
                        <small>Next available invoice number</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoiceDate">Invoice Date <span class="date-prefill">‚ú® Today</span></label>
                            <input type="date" id="invoiceDate" required>
                        </div>
                        <div class="form-group">
                            <label for="paymentDue">Payment Due <span class="date-prefill">‚ú® +14 days</span></label>
                            <input type="date" id="paymentDue" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="finalAmount">Final Amount (Ex VAT)</label>
                        <input type="number" id="finalAmount" step="0.01" required>
                        <small>Change if different from quote</small>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="invoiceSent" checked>
                        <label for="invoiceSent">Mark as sent immediately</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeSendInvoiceModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Invoice</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mark Paid Modal -->
    <div id="markPaidModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úÖ Mark as Paid</h2>
                <button class="btn-close" onclick="closeMarkPaidModal()">√ó</button>
            </div>
            <form id="markPaidForm">
                <div class="modal-body">
                    <div class="info-box">
                        <strong id="paidJobInfo">Job details</strong>
                    </div>

                    <div class="form-group">
                        <label for="paymentDate">Payment Received Date <span class="date-prefill">‚ú® Today</span></label>
                        <input type="date" id="paymentDate" required>
                    </div>

                    <div class="form-group">
                        <label for="paymentMethod">Payment Method</label>
                        <select id="paymentMethod">
                            <option>Bank Transfer</option>
                            <option>Cash</option>
                            <option>Card</option>
                            <option>Cheque</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeMarkPaidModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">‚úÖ Mark Paid</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Site Modal -->
    <div id="addSiteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Site</h2>
                <button class="btn-close" onclick="closeAddSiteModal()">√ó</button>
            </div>
            
            <form id="addSiteForm">
                <div class="form-group">
                    <label for="siteName">Site Name *</label>
                    <input type="text" id="siteName" required placeholder="e.g., Maidstone Primary School">
                </div>
                
                <div class="form-group">
                    <label for="siteAddress">Address *</label>
                    <input type="text" id="siteAddress" required placeholder="Full address">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="siteContact">Contact Name</label>
                        <input type="text" id="siteContact" placeholder="Site manager">
                    </div>
                    
                    <div class="form-group">
                        <label for="sitePhone">Phone</label>
                        <input type="tel" id="sitePhone" placeholder="01234 567890">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="siteFrequency">Visit Frequency *</label>
                        <select id="siteFrequency" required class="form-group input" style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px;">
                            <option value="7">Weekly</option>
                            <option value="14">Fortnightly</option>
                            <option value="28">4-Weekly</option>
                            <option value="30">Monthly</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="sitePrice">Price per Visit *</label>
                        <input type="number" id="sitePrice" required placeholder="0.00" step="0.01" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="siteFirstVisit">First Visit Date *</label>
                    <input type="date" id="siteFirstVisit" required>
                </div>
                
                <div class="form-group">
                    <label for="siteNotes">Notes</label>
                    <textarea id="siteNotes" placeholder="Access codes, special instructions, etc."></textarea>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddSiteModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Add Site</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Complete Visit Modal -->
    <div id="completeVisitModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Complete Visit Worksheet</h2>
                <button class="btn-close" onclick="closeCompleteVisitModal()">√ó</button>
            </div>
            
            <form id="completeVisitForm">
                <input type="hidden" id="completeVisitId">
                
                <div class="alert alert-warning" style="margin-bottom: 1.5rem;">
                    <strong>üì∏ Remember:</strong> Take before/after photos with your phone camera before completing
                </div>
                
                <div class="form-group">
                    <label for="completedBy">Roundwood Operative *</label>
                    <input type="text" id="completedBy" required placeholder="Staff member name">
                </div>

                <div style="background: var(--primary); color: white; padding: 1rem; border-radius: 8px; margin: 1.5rem 0;">
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.125rem;">Work Completed - Tick what applies</h3>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; padding: 1rem; background: white; border: 2px solid var(--gray-300); border-radius: 8px; cursor: pointer; margin-bottom: 0.75rem;">
                        <input type="checkbox" id="weedRemoval" style="width: 20px; height: 20px; margin-right: 1rem;">
                        <div>
                            <strong>Weed removal</strong> to appropriate areas - entrance/exits etc
                        </div>
                    </label>
                    
                    <label style="display: flex; align-items: center; padding: 1rem; background: white; border: 2px solid var(--gray-300); border-radius: 8px; cursor: pointer; margin-bottom: 0.75rem;">
                        <input type="checkbox" id="strimming" style="width: 20px; height: 20px; margin-right: 1rem;">
                        <div>
                            <strong>Strimming</strong> as required to whole site
                        </div>
                    </label>
                    
                    <label style="display: flex; align-items: center; padding: 1rem; background: white; border: 2px solid var(--gray-300); border-radius: 8px; cursor: pointer; margin-bottom: 0.75rem;">
                        <input type="checkbox" id="weedSuppressant" style="width: 20px; height: 20px; margin-right: 1rem;">
                        <div>
                            <strong>Weed suppressant</strong> applied as per map provided (Glyphosate based)
                        </div>
                    </label>
                    
                    <label style="display: flex; align-items: center; padding: 1rem; background: white; border: 2px solid var(--gray-300); border-radius: 8px; cursor: pointer; margin-bottom: 0.75rem;">
                        <input type="checkbox" id="generalTidy" style="width: 20px; height: 20px; margin-right: 1rem;">
                        <div>
                            <strong>General tidy</strong> and rubbish removal
                        </div>
                    </label>

                    <small style="color: var(--gray-500); display: block; margin-top: 0.5rem;">
                        Tick only the tasks that were completed for this visit
                    </small>
                </div>

                <div class="form-group">
                    <label for="siteNotes">Site Notes / Additional Work</label>
                    <textarea id="siteNotes" placeholder="Any additional notes about this visit..." rows="3"></textarea>
                    <small style="color: var(--gray-500); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                        Note: Weed suppressant can take around 4-6 weeks to take effect
                    </small>
                </div>

                <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
                    <h3 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.125rem;">Customer Sign-Off *</h3>
                    
                    <div class="form-group">
                        <label for="customerName">Customer Name *</label>
                        <input type="text" id="customerName" required placeholder="e.g. John Smith">
                    </div>

                    <div class="form-group">
                        <label>Customer Signature *</label>
                        <canvas id="signaturePad" class="signature-pad" width="540" height="200" style="touch-action: none;"></canvas>
                        <div class="signature-controls">
                            <button type="button" class="btn btn-secondary" onclick="clearSignature()">Clear Signature</button>
                        </div>
                        <small style="color: var(--gray-500); font-size: 0.85rem;">Customer must sign above to confirm work completed</small>
                    </div>
                </div>

                <div class="alert alert-info">
                    Completing this visit will:
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li>Save worksheet with customer signature</li>
                        <li>Automatically schedule the next visit</li>
                        <li>Send email notification to finance team</li>
                    </ul>
                    <p style="margin-top: 0.75rem; margin-bottom: 0;">
                        üí° <strong>Tip:</strong> Use the ‚≠ê <strong>Reviews</strong> tab to send review requests later
                    </p>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeCompleteVisitModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-success" style="flex: 1;">‚úì Complete & Generate Worksheet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div id="addProjectModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Add New Project</h2>
                <button class="btn-close" onclick="closeAddProjectModal()">√ó</button>
            </div>
            
            <form id="addProjectForm">
                <div class="form-group">
                    <label for="projectName">Project Name *</label>
                    <input type="text" id="projectName" required placeholder="e.g. Car Park Resurfacing">
                </div>

                <div class="form-group">
                    <label for="projectType">Project Type *</label>
                    <select id="projectType" required>
                        <option value="">-- Select Type --</option>
                        <option value="Landscaping">Landscaping</option>
                        <option value="Paving">Paving</option>
                        <option value="Fencing">Fencing</option>
                        <option value="Tree Work">Tree Work</option>
                        <option value="Groundworks">Groundworks</option>
                        <option value="Artificial Grass">Artificial Grass</option>
                        <option value="Decking">Decking</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="projectClientName">Client Name *</label>
                    <input type="text" id="projectClientName" required placeholder="e.g. John Smith or Station Road Site">
                </div>
                
                <div class="form-group">
                    <label for="projectAddress">Site Address *</label>
                    <input type="text" id="projectAddress" required placeholder="Full address">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="projectContact">Contact Name</label>
                        <input type="text" id="projectContact" placeholder="Site contact">
                    </div>
                    
                    <div class="form-group">
                        <label for="projectPhone">Phone</label>
                        <input type="tel" id="projectPhone" placeholder="01234 567890">
                    </div>
                </div>

                <div class="form-group">
                    <label for="projectEmail">Email</label>
                    <input type="email" id="projectEmail" placeholder="client@example.com">
                </div>

                <div class="form-group">
                    <label for="projectPrice">Project Price *</label>
                    <input type="number" id="projectPrice" required placeholder="0.00" step="0.01" min="0">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="projectStartDate">Start Date *</label>
                        <input type="date" id="projectStartDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="projectExpectedEnd">Expected Completion *</label>
                        <input type="date" id="projectExpectedEnd" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="projectDescription">Project Description / Scope *</label>
                    <textarea id="projectDescription" required placeholder="Describe the work to be completed..." rows="4"></textarea>
                </div>

                <div class="form-group">
                    <label for="projectNotes">Additional Notes</label>
                    <textarea id="projectNotes" placeholder="Any special requirements, access notes, etc..." rows="2"></textarea>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddProjectModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Add Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Complete Project Modal -->
    <div id="completeProjectModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Complete Project</h2>
                <button class="btn-close" onclick="closeCompleteProjectModal()">√ó</button>
            </div>
            
            <form id="completeProjectForm">
                <input type="hidden" id="completeProjectId">
                
                <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                    <strong>üì∏ Remember:</strong> Take before/after photos with your phone before completing
                </div>

                <div class="form-group">
                    <label for="projectCompletedBy">Completed By *</label>
                    <input type="text" id="projectCompletedBy" required placeholder="Staff member name">
                </div>

                <div class="form-group">
                    <label for="projectActualEndDate">Actual Completion Date *</label>
                    <input type="date" id="projectActualEndDate" required>
                </div>
                
                <div class="form-group">
                    <label for="projectCompletionNotes">Completion Notes</label>
                    <textarea id="projectCompletionNotes" placeholder="Any notes about the completed project..." rows="3"></textarea>
                </div>

                <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; color: var(--primary); font-size: 1.125rem;">Customer Sign-Off *</h3>
                    
                    <div class="form-group">
                        <label for="projectCustomerName">Customer Name *</label>
                        <input type="text" id="projectCustomerName" required placeholder="e.g. John Smith">
                    </div>

                    <div class="form-group">
                        <label>Customer Signature *</label>
                        <canvas id="projectSignaturePad" class="signature-pad" width="540" height="200" style="touch-action: none;"></canvas>
                        <div class="signature-controls">
                            <button type="button" class="btn btn-secondary" onclick="clearProjectSignature()">Clear Signature</button>
                        </div>
                        <small style="color: var(--gray-500); font-size: 0.85rem;">Customer must sign above to confirm work completed</small>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    Completing this project will:
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li>Save completion details with customer signature</li>
                        <li>Add to invoice tracking for billing</li>
                        <li>Send email notification to finance team</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeCompleteProjectModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-success" style="flex: 1;">‚úì Complete Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Project Update Modal -->
    <div id="addUpdateModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Add Project Update</h2>
                <button class="btn-close" onclick="closeAddUpdateModal()">√ó</button>
            </div>
            
            <form id="addUpdateForm">
                <input type="hidden" id="updateProjectId">
                
                <div class="form-group">
                    <label for="updateText">Update / Note *</label>
                    <textarea id="updateText" required placeholder="e.g. Awaiting materials - ETA 2 weeks&#10;Revisit in 6 weeks for painting&#10;Client requested color change" rows="4" style="resize: vertical;"></textarea>
                    <small style="color: var(--gray-500); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                        Track progress, delays, client requests, or any important notes
                    </small>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddUpdateModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Add Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getDatabase, 
            ref, 
            set, 
            get, 
            update, 
            remove, 
            onValue,
            push,
            query,
            orderByChild,
            equalTo
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDiARsn-HBhwuHuWjmeAB9ntRxyd4FSR-E",
            authDomain: "roundwood-manager.firebaseapp.com",
            databaseURL: "https://roundwood-manager-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "roundwood-manager",
            storageBucket: "roundwood-manager.firebasestorage.app",
            messagingSenderId: "1064499324684",
            appId: "1:1064499324684:web:c974e276f5b86092bbcb29"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Make functions globally available
        window.auth = auth;
        window.database = database;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.dbUpdate = update;
        window.dbRemove = remove;
        window.dbOnValue = onValue;
        window.dbPush = push;
        window.dbQuery = query;
        window.dbOrderByChild = orderByChild;
        window.dbEqualTo = equalTo;

        // Google Drive API Configuration
        const GOOGLE_API_KEY = 'YOUR_GOOGLE_API_KEY_HERE'; // SECURITY: Add your key locally only - DO NOT commit to GitHub!
        const GOOGLE_CLIENT_ID = '1064499324684-uhn2u0okn82psh87j7v0jvf5mjvbhq5s.apps.googleusercontent.com';
        const GOOGLE_DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        let gapiLoaded = false;
        let googleAuth = null;

        // Initialize Google API
        function initGoogleAPI() {
            // Check if gapi is loaded
            if (typeof gapi === 'undefined') {
                console.warn('Google API not loaded yet. Retrying in 1 second...');
                setTimeout(initGoogleAPI, 1000);
                return;
            }

            gapi.load('client:auth2', async () => {
                try {
                    await gapi.client.init({
                        apiKey: GOOGLE_API_KEY,
                        clientId: GOOGLE_CLIENT_ID,
                        discoveryDocs: GOOGLE_DISCOVERY_DOCS,
                        scope: GOOGLE_SCOPES
                    });
                    googleAuth = gapi.auth2.getAuthInstance();
                    gapiLoaded = true;
                    console.log('‚úÖ Google Drive API initialized successfully');
                } catch (error) {
                    console.error('‚ùå Error initializing Google API:', error);
                    console.log('Note: This is normal if you haven\'t configured OAuth consent screen yet');
                }
            });
        }

        // Export data to Google Drive
        async function exportToGoogleDrive() {
            if (!gapiLoaded) {
                alert('‚ö†Ô∏è Google Drive Export Not Configured\n\nThis feature requires OAuth setup:\n1. Complete OAuth consent screen in Google Cloud Console\n2. Verify redirect URIs are set\n3. Uncomment initGoogleAPI() in the code\n\nFor now, your data is safely stored in Firebase.');
                console.log('üí° To enable Google Drive export, complete OAuth setup and uncomment initGoogleAPI()');
                return;
            }

            try {
                // Sign in if not already signed in
                if (!googleAuth.isSignedIn.get()) {
                    await googleAuth.signIn();
                }

                // Get all data
                const userId = window.auth.currentUser.uid;
                const snapshot = await window.dbGet(window.dbRef(window.database, `users/${userId}`));
                const allData = snapshot.val();

                // Create formatted export data
                const exportData = {
                    exportDate: new Date().toISOString(),
                    pipeline: allData.pipelineJobs || {},
                    sites: allData.sites || {},
                    projects: allData.projects || {},
                    visits: allData.visits || {},
                    reviews: allData.reviews || {}
                };

                // Convert to JSON
                const jsonContent = JSON.stringify(exportData, null, 2);
                const fileName = `Roundwood-Backup-${new Date().toISOString().split('T')[0]}.json`;

                // Create file metadata
                const fileMetadata = {
                    name: fileName,
                    mimeType: 'application/json'
                };

                // Create file content
                const fileContent = new Blob([jsonContent], { type: 'application/json' });

                // Upload to Google Drive
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
                form.append('file', fileContent);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + gapi.auth.getToken().access_token
                    },
                    body: form
                });

                if (response.ok) {
                    alert(`‚úÖ Data exported successfully to Google Drive!\nFile: ${fileName}`);
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå Failed to export to Google Drive. Please try again.');
            }
        }

        // Make Google Drive functions available globally
        window.initGoogleAPI = initGoogleAPI;
        window.exportToGoogleDrive = exportToGoogleDrive;

        // Define essential UI functions immediately (before auth listener)
        window.toggleSection = function(header) {
            const section = header.closest('.collapsible-section');
            const arrow = header.querySelector('.collapsible-arrow');
            
            section.classList.toggle('open');
            
            if (section.classList.contains('open')) {
                if (arrow) arrow.textContent = '‚ñ≤';
            } else {
                if (arrow) arrow.textContent = '‚ñº';
            }
        };

        window.showTab = (tabName) => {
            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-tabs > button').forEach(item => {
                item.classList.remove('active');
            });
            
            // Remove active class from dropdown toggle
            document.querySelectorAll('.dropdown-toggle').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Check if this tab is in the Tools dropdown
            const toolsTabs = ['sites', 'history', 'calculator'];
            if (toolsTabs.includes(tabName)) {
                // Make Tools dropdown active
                const dropdownToggle = document.querySelector('.dropdown-toggle');
                if (dropdownToggle) {
                    dropdownToggle.classList.add('active');
                }
            } else {
                // Add active class to clicked nav item
                const selectedNav = document.querySelector(`.nav-tabs > button[onclick="showTab('${tabName}')"]`);
                if (selectedNav) {
                    selectedNav.classList.add('active');
                }
            }
            
            // Load tab-specific data
            if (tabName === 'sites') {
                if (typeof renderSites === 'function') renderSites();
            } else if (tabName === 'dashboard') {
                if (typeof renderUpcomingVisits === 'function') renderUpcomingVisits();
                if (typeof renderInvoiceTracking === 'function') renderInvoiceTracking();
            } else if (tabName === 'projects') {
                if (typeof renderProjects === 'function') renderProjects();
            } else if (tabName === 'upcomingVisits') {
                if (typeof renderAllUpcomingVisits === 'function') renderAllUpcomingVisits();
            } else if (tabName === 'invoiceTracking') {
                if (typeof renderFullInvoiceTracking === 'function') renderFullInvoiceTracking();
            } else if (tabName === 'pipeline') {
                if (typeof renderPipeline === 'function') renderPipeline();
            }
        };

        window.loadAppData = async function() {
            if (!window.currentUser) return;
            
            const userId = window.currentUser.uid;
            console.log('Loading data for user:', userId);
            
            // Listen to sites
            const sitesRef = window.dbRef(window.database, `users/${userId}/sites`);
            window.dbOnValue(sitesRef, (snapshot) => {
                window.sites = [];
                snapshot.forEach((childSnapshot) => {
                    window.sites.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                console.log('Loaded sites:', window.window.sites.length);
                if (typeof renderSites === 'function') renderSites();
                if (typeof updateStats === 'function') updateStats();
            });

            // Listen to visits
            const visitsRef = window.dbRef(window.database, `users/${userId}/visits`);
            window.dbOnValue(visitsRef, (snapshot) => {
                window.visits = [];
                snapshot.forEach((childSnapshot) => {
                    window.visits.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                console.log('Loaded visits:', window.window.visits.length);
                if (typeof renderVisits === 'function') renderVisits();
                if (typeof renderInvoices === 'function') renderInvoices();
                if (typeof renderHistory === 'function') renderHistory();
                if (typeof updateStats === 'function') updateStats();
            });

            // Listen to projects
            const projectsRef = window.dbRef(window.database, `users/${userId}/projects`);
            window.dbOnValue(projectsRef, (snapshot) => {
                window.projects = [];
                snapshot.forEach((childSnapshot) => {
                    window.projects.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                console.log('Loaded projects:', window.window.projects.length);
                if (typeof renderProjects === 'function') renderProjects();
                if (typeof updateStats === 'function') updateStats();
            });
            
            // Listen to pipeline jobs
            const pipelineRef = window.dbRef(window.database, `users/${userId}/pipelineJobs`);
            window.dbOnValue(pipelineRef, (snapshot) => {
                window.pipelineJobs = [];
                snapshot.forEach((childSnapshot) => {
                    window.pipelineJobs.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                console.log('Loaded pipeline jobs:', window.window.pipelineJobs.length);
                if (typeof renderPipeline === 'function') renderPipeline();
            });
            
            // Load review history and saved calculations
            if (typeof loadReviewHistory === 'function') loadReviewHistory();
            if (typeof loadSavedCalculations === 'function') loadSavedCalculations();
        };

        // Auth State Listener
        onAuthStateChanged(auth, (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');

            if (user) {
                // User is logged in
                document.getElementById('userEmail').textContent = user.email;
                loadingScreen.style.display = 'none';
                loginScreen.style.display = 'none';
                mainApp.style.display = 'flex';
                
                // Initialize app data
                window.currentUser = user;
                
                // Initialize Google Drive API (disabled until OAuth fully configured)
                // Uncomment this line after completing OAuth consent screen setup
                // initGoogleAPI();
                
                // Load data immediately (functions are now defined)
                loadAppData();
                
                // Wait briefly for render functions to be defined
                setTimeout(() => {
                    if (typeof renderSeasonalTips === 'function') renderSeasonalTips();
                    if (typeof renderMonthlyUpsells === 'function') renderMonthlyUpsells();
                    // Update Tools dropdown menu items
                    if (typeof updateAutoBackupButton === 'function') updateAutoBackupButton();
                    if (typeof updateGoogleDriveStatus === 'function') updateGoogleDriveStatus();
                }, 50);
            } else {
                // User is logged out
                loadingScreen.style.display = 'none';
                loginScreen.style.display = 'flex';
                mainApp.style.display = 'none';
            }
        });

        // Login Handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        });

        // Register Handlers
        document.getElementById('showRegisterBtn').addEventListener('click', () => {
            document.getElementById('registerModal').classList.add('active');
        });

        window.closeRegisterModal = () => {
            document.getElementById('registerModal').classList.remove('active');
            document.getElementById('registerForm').reset();
            document.getElementById('registerError').style.display = 'none';
        };

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerConfirm').value;
            const errorDiv = document.getElementById('registerError');

            if (password !== confirm) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                closeRegisterModal();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        });

        // Logout
        window.logout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        console.log('Firebase initialized successfully');
    </script>

    <script>
        // Send Invoice Request Email using mailto
        function sendInvoiceEmail(visit) {
            const emailSubject = `Invoice Required: ${visit.siteName} - Completed ${visit.completedDate}`;
            
            // Format work completed checklist
            const workList = [];
            if (visit.workCompleted) {
                if (visit.workCompleted.weedRemoval) workList.push('‚úì Weed removal to appropriate areas');
                if (visit.workCompleted.strimming) workList.push('‚úì Strimming as required to whole site');
                if (visit.workCompleted.weedSuppressant) workList.push('‚úì Weed suppressant applied (Glyphosate based)');
                if (visit.workCompleted.generalTidy) workList.push('‚úì General tidy and rubbish removal');
            }
            
            const emailBody = `
Visit Completion Worksheet
====================================

Site Information:
- Site Name: ${visit.siteName}
- Address: ${visit.siteAddress}

Work Details:
- Completed By: ${visit.completedBy}
- Completed On: ${new Date(visit.completedDate).toLocaleDateString('en-GB')}
- Invoice Amount: ¬£${visit.price.toFixed(2)}

Work Completed:
${workList.length > 0 ? workList.join('\n') : 'No tasks recorded'}

${visit.siteNotes ? `Site Notes / Additional Work:\n${visit.siteNotes}\n` : ''}
Customer Sign-Off:
- Customer Name: ${visit.customerName}
- Signature: Captured digitally (view in app History tab)

REMINDER: 
- Field staff should have before/after photos on their phone
- Customer signature captured digitally
- Work completion confirmed

Please prepare and send invoice to the customer.

---
This notification was generated automatically by Roundwood Route Manager.
            `.trim();

            // Create mailto link
            const mailto = `mailto:office@roundwoodsolutions.co.uk?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
            
            // Open email client
            window.location.href = mailto;
        }

        // Toggle Collapsible Sections
        // App State (initialize on window for global access)
        window.sites = [];
        window.visits = [];
        window.projects = [];
        window.pipelineJobs = [];
        let sites = window.sites;
        let visits = window.visits;
        let projects = window.projects;
        let pipelineJobs = window.pipelineJobs;
        let projectSignaturePad = null;

        // Seasonal Tips and Upsells Data
        const monthlyContent = {
            1: { // January
                tips: [
                    "üå≥ <strong>Prune fruit trees</strong> - Perfect time while trees are dormant. Remove dead, diseased, or crossing branches.",
                    "‚ùÑÔ∏è <strong>Winter damage checks</strong> - Inspect sites for frost damage, broken branches, and waterlogging issues.",
                    "üçÇ <strong>Clear debris</strong> - Remove remaining autumn leaves and debris to prevent disease and drainage problems."
                ],
                upsells: [
                    "üå≤ <strong>Tree pruning service</strong> - Offer winter pruning for fruit trees and ornamentals while dormant.",
                    "üíß <strong>Drainage solutions</strong> - Identify waterlogged areas and offer drainage improvement services."
                ]
            },
            2: { // February
                tips: [
                    "üå± <strong>Early weed control</strong> - Start treating perennial weeds before they establish. More effective now.",
                    "üå≥ <strong>Complete winter pruning</strong> - Last chance for major pruning before sap rises in March.",
                    "üîç <strong>Site audits</strong> - Perfect time to walk sites and plan spring work programmes with clients."
                ],
                upsells: [
                    "‚ùÑÔ∏è <strong>Winter tree pruning</strong> - February is the last month for dormant season pruning. Quote for fruit trees, roses, and deciduous shrubs before sap rises.",
                    "üåø <strong>Early weed treatment</strong> - Treat perennial weeds NOW while they're small and weak. February treatments are more effective than waiting until spring."
                ]
            },
            3: { // March
                tips: [
                    "üå± <strong>Spring growth begins</strong> - Increase visit frequency as grass starts growing actively.",
                    "‚úÇÔ∏è <strong>First cuts of season</strong> - Set mowers high for first cuts, don't scalp the grass.",
                    "üåø <strong>Feed applications</strong> - Apply spring fertilizer to boost growth and green-up lawns."
                ],
                upsells: [
                    "üíö <strong>Spring fertilizer treatments</strong> - Offer professional feed applications for healthier lawns.",
                    "üå∑ <strong>Summer bedding installation</strong> - Quote for installing colorful summer displays - book now for May planting."
                ]
            },
            4: { // April
                tips: [
                    "üå± <strong>Weekly cuts resume</strong> - Grass growing strongly now, ensure teams are keeping to schedules.",
                    "üå∏ <strong>Weed control peak time</strong> - Most effective month for treating broad-leaved weeds in grass.",
                    "üí¶ <strong>Check irrigation</strong> - Test and commission irrigation systems before hot weather arrives."
                ],
                upsells: [
                    "üåø <strong>Selective weed treatments</strong> - Offer targeted weed control programs for lawns and beds.",
                    "üíß <strong>Irrigation maintenance</strong> - Propose irrigation system checks and repairs before summer."
                ]
            },
            5: { // May
                tips: [
                    "‚úÇÔ∏è <strong>Peak cutting season</strong> - Busiest time of year, ensure equipment is maintained and teams are productive.",
                    "üå∫ <strong>Bedding plants</strong> - Install summer displays and hanging baskets for commercial sites.",
                    "üêõ <strong>Pest monitoring</strong> - Watch for aphids, caterpillars, and other spring pests."
                ],
                upsells: [
                    "üåª <strong>Summer displays</strong> - Offer vibrant bedding plant installations and maintenance packages.",
                    "ü¶ü <strong>Pest control services</strong> - Propose integrated pest management programs."
                ]
            },
            6: { // June
                tips: [
                    "‚òÄÔ∏è <strong>Drought watch</strong> - Monitor grass and plants closely, advise clients on irrigation needs.",
                    "üåø <strong>Hedge cutting begins</strong> - Start formal hedge trimming after bird nesting season (check first!).",
                    "üíê <strong>Deadheading</strong> - Regular deadheading keeps displays looking fresh all summer."
                ],
                upsells: [
                    "‚úÇÔ∏è <strong>Hedge trimming services</strong> - Offer professional hedge cutting and shaping packages.",
                    "üí¶ <strong>Drought management</strong> - Propose temporary irrigation or drought-tolerant planting solutions."
                ]
            },
            7: { // July
                tips: [
                    "üåû <strong>Heat stress management</strong> - Raise cutting heights, mow early morning or evening to reduce stress.",
                    "üíß <strong>Irrigation critical</strong> - Ensure irrigation systems are working efficiently during peak demand.",
                    "üåæ <strong>Holiday cover</strong> - Plan staff rotas carefully to maintain service during holiday season."
                ],
                upsells: [
                    "üåø <strong>Book autumn renovation now</strong> - Pre-sell scarifying, aerating, and overseeding packages for September. Early booking discounts available.",
                    "üí¶ <strong>Water management services</strong> - Offer irrigation monitoring and water-saving solutions."
                ]
            },
            8: { // August
                tips: [
                    "üçÇ <strong>Plan autumn work</strong> - Start discussing and quoting autumn renovation projects with clients.",
                    "üå± <strong>Overseed preparation</strong> - Identify thin or damaged turf that will need autumn overseeding.",
                    "‚òÄÔ∏è <strong>Continue heat precautions</strong> - Keep cutting heights up, don't stress grass in dry spells."
                ],
                upsells: [
                    "üåæ <strong>Autumn renovation bookings</strong> - Scarifying removes thatch, aeration relieves compaction, overseeding thickens turf. Package all three for September.",
                    "üå≥ <strong>Tree health surveys</strong> - Professional tree inspections identify disease, decay, and hazards before winter storms."
                ]
            },
            9: { // September
                tips: [
                    "üçÇ <strong>Autumn renovation peak</strong> - Perfect conditions for scarifying, aerating, and overseeding.",
                    "üå± <strong>Autumn feeding</strong> - Apply autumn fertilizer with slow-release nitrogen for winter hardiness.",
                    "üíß <strong>Reduce irrigation</strong> - Scale back watering as temperatures drop and rain increases."
                ],
                upsells: [
                    "üçÇ <strong>Gutter clearing contracts</strong> - Prevent blockages and water damage. Quote for October/November monthly gutter clears.",
                    "üåø <strong>Lawn renovation final push</strong> - Last chance this year! Scarify dead thatch, aerate compacted soil, overseed thin patches."
                ]
            },
            10: { // October
                tips: [
                    "üçÇ <strong>Leaf clearance begins</strong> - Start regular leaf blowing and removal programs.",
                    "‚úÇÔ∏è <strong>Final cuts</strong> - Reduce cutting frequency as growth slows, set mowers higher.",
                    "üå≥ <strong>Tree inspection</strong> - Check trees for damage or disease before winter storms."
                ],
                upsells: [
                    "üçÅ <strong>Leaf clearance contracts</strong> - Offer weekly leaf clearing services for remainder of autumn.",
                    "üå≤ <strong>Winter plant protection</strong> - Propose wrapping and protection services for tender plants."
                ]
            },
            11: { // November
                tips: [
                    "üçÇ <strong>Leaf clearance priority</strong> - Peak leaf fall month, stay on top of clearing schedules.",
                    "‚ùÑÔ∏è <strong>Winter prep</strong> - Clear gutters, check drains, prepare sites for winter weather.",
                    "üå≥ <strong>Tree works</strong> - Begin tree surgery and major pruning work in earnest."
                ],
                upsells: [
                    "üéÑ <strong>Christmas displays</strong> - Offer festive planting and decoration services for commercial sites.",
                    "‚ùÑÔ∏è <strong>Winter gritting</strong> - Propose path and car park gritting contracts."
                ]
            },
            12: { // December
                tips: [
                    "üéÑ <strong>Festive displays</strong> - Install and maintain Christmas planters and decorations.",
                    "‚ùÑÔ∏è <strong>Weather watch</strong> - Monitor forecasts, be ready for snow/ice response if contracted.",
                    "üìã <strong>Year planning</strong> - Review year with clients, plan contracts and pricing for next season."
                ],
                upsells: [
                    "üìÖ <strong>Renew 2026 contracts now</strong> - Secure next year's business. Offer multi-year discounts or frequency increases for contract renewals.",
                    "üå≤ <strong>Bare-root tree planting</strong> - Winter is ideal for planting dormant bare-root trees. Quote for January/February planting projects."
                ]
            }
        };

        // Render Seasonal Tips
        function renderSeasonalTips() {
            const month = new Date().getMonth() + 1; // 1-12
            const content = monthlyContent[month];
            const container = document.getElementById('seasonalTips');
            
            if (!container) {
                console.error('seasonalTips container not found');
                return;
            }
            
            if (!content) {
                console.error('No content for month:', month);
                return;
            }
            
            console.log('Rendering tips for month:', month, content.tips);
            
            container.innerHTML = content.tips.map(tip => 
                `<div style="padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.75rem; border-left: 3px solid var(--success);">
                    ${tip}
                </div>`
            ).join('');
        }

        // Render Monthly Upsells
        function renderMonthlyUpsells() {
            const currentMonth = new Date().getMonth() + 1; // 1-12
            const nextMonth = currentMonth === 12 ? 1 : currentMonth + 1;
            const content = monthlyContent[nextMonth];
            const container = document.getElementById('monthlyUpsells');
            
            if (!container) {
                console.error('monthlyUpsells container not found');
                return;
            }
            
            if (!content) {
                console.error('No content for next month:', nextMonth);
                return;
            }
            
            console.log('Rendering upsells for next month:', nextMonth, content.upsells);
            
            const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            container.innerHTML = `
                <p style="margin-bottom: 1rem; font-weight: 500;">For ${monthNames[nextMonth]}:</p>
                ${content.upsells.map(upsell => 
                    `<div style="padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.75rem; border-left: 3px solid #3b82f6;">
                        ${upsell}
                    </div>`
                ).join('')}
            `;
        }

        // Load App Data
        async function loadAppData() {
            const userId = window.currentUser.uid;
            console.log('Loading data for user:', userId);
            
            // Listen to sites
            const sitesRef = window.dbRef(window.database, `users/${userId}/sites`);
            window.dbOnValue(sitesRef, (snapshot) => {
                sites = [];
                snapshot.forEach((childSnapshot) => {
                    sites.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                console.log('Loaded sites:', window.sites.length);
                renderSites();
                updateStats();
            });

            // Listen to visits
            const visitsRef = window.dbRef(window.database, `users/${userId}/visits`);
            window.dbOnValue(visitsRef, (snapshot) => {
                visits = [];
                snapshot.forEach((childSnapshot) => {
                    visits.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                console.log('Loaded visits:', window.visits.length);
                renderVisits();
                renderInvoices();
                renderHistory();
                updateStats();
            });

            // Listen to projects
            const projectsRef = window.dbRef(window.database, `users/${userId}/projects`);
            window.dbOnValue(projectsRef, (snapshot) => {
                projects = [];
                snapshot.forEach((childSnapshot) => {
                    projects.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                console.log('Loaded projects:', window.projects.length);
                renderProjects();
                updateStats();
            });
            
            // Load review history and saved calculations
            loadReviewHistory();
            loadSavedCalculations();
        }

        // Tab Navigation
        window.showTab = (tabName) => {
            // Update tab buttons
            document.querySelectorAll('.nav-tabs button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show tab content
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
        };

        // Add Site Modal
        window.openAddSiteModal = () => {
            document.getElementById('addSiteModal').classList.add('active');
            // Set default first visit to today
            document.getElementById('siteFirstVisit').valueAsDate = new Date();
        };

        window.closeAddSiteModal = () => {
            document.getElementById('addSiteModal').classList.remove('active');
            document.getElementById('addSiteForm').reset();
        };

        // Add Site Handler
        document.getElementById('addSiteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const siteData = {
                name: document.getElementById('siteName').value,
                address: document.getElementById('siteAddress').value,
                contact: document.getElementById('siteContact').value,
                phone: document.getElementById('sitePhone').value,
                frequency: parseInt(document.getElementById('siteFrequency').value),
                price: parseFloat(document.getElementById('sitePrice').value),
                firstVisit: document.getElementById('siteFirstVisit').value,
                notes: document.getElementById('siteNotes').value,
                createdAt: new Date().toISOString()
            };

            try {
                const userId = window.currentUser.uid;
                const siteRef = window.dbPush(window.dbRef(window.database, `users/${userId}/sites`));
                await window.dbSet(siteRef, siteData);

                // Create first visit
                const visitData = {
                    siteId: siteRef.key,
                    siteName: siteData.name,
                    siteAddress: siteData.address,
                    scheduledDate: siteData.firstVisit,
                    price: siteData.price,
                    frequency: siteData.frequency,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };

                const visitRef = window.dbPush(window.dbRef(window.database, `users/${userId}/visits`));
                await window.dbSet(visitRef, visitData);

                closeAddSiteModal();
            } catch (error) {
                console.error('Error adding site:', error);
                alert('Error adding site. Please try again.');
            }
        });

        // Render Sites
        function renderSites() {
            const container = document.getElementById('sitesContainer');
            
            if (!container) {
                console.error('sitesContainer element not found');
                return;
            }
            
            console.log('renderSites called with', window.window.sites.length, 'sites');
            
            if (window.window.sites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìç</div>
                        <div class="empty-state-title">No sites yet</div>
                        <div class="empty-state-text">Add your first site to get started with route management</div>
                        <button class="btn btn-primary" onclick="openAddSiteModal()">+ Add Your First Site</button>
                    </div>
                `;
                return;
            }

            try {
                const html = window.window.sites.map(site => {
                    const frequencyText = {
                    7: 'Weekly',
                    14: 'Fortnightly',
                    28: '4-Weekly',
                    30: 'Monthly',
                    91: 'Quarterly'
                }[site.frequency] || `Every ${site.frequency} days`;

                return `
                    <div class="site-card">
                        <div class="site-header">
                            <div>
                                <div class="site-name">${site.name}</div>
                                <div class="site-address">${site.address}</div>
                                ${site.paused ? `
                                    <div style="display: inline-block; background: #fee2e2; color: #991b1b; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; margin-top: 0.25rem;">
                                        ‚è∏Ô∏è Paused${site.pausedUntil ? ` until ${new Date(site.pausedUntil).toLocaleDateString('en-GB')}` : ' indefinitely'}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="badge-frequency">${frequencyText}</span>
                                ${site.paused ? `
                                    <button class="btn btn-success" onclick="resumeContract('${site.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                                        ‚ñ∂Ô∏è Resume
                                    </button>
                                ` : `
                                    <button class="btn btn-warning" onclick="pauseContract('${site.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.85rem; background: #f59e0b; color: white;">
                                        ‚è∏Ô∏è Pause
                                    </button>
                                `}
                                <button class="btn btn-secondary" onclick="editSite('${site.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                                    ‚úèÔ∏è Edit Site
                                </button>
                                <button class="btn btn-danger" onclick="deleteSite('${site.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                        <div class="site-meta">
                            ${site.contractNotes ? `
                                <div class="meta-item" style="grid-column: 1 / -1; background: #fef3c7; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #f59e0b;">
                                    <div class="meta-label" style="color: #92400e; font-weight: 600;">üìã Contract Notes</div>
                                    <div class="meta-value" style="color: #78350f; white-space: pre-wrap;">${site.contractNotes}</div>
                                </div>
                            ` : ''}
                            ${site.contact ? `
                                <div class="meta-item">
                                    <div class="meta-label">Contact</div>
                                    <div class="meta-value">${site.contact}</div>
                                </div>
                            ` : ''}
                            ${site.phone ? `
                                <div class="meta-item">
                                    <div class="meta-label">Phone</div>
                                    <div class="meta-value">${site.phone}</div>
                                </div>
                            ` : ''}
                            <div class="meta-item">
                                <div class="meta-label">Price</div>
                                <div class="meta-value">¬£${site.price.toFixed(2)}</div>
                            </div>
                            ${site.notes ? `
                                <div class="meta-item" style="grid-column: 1 / -1;">
                                    <div class="meta-label">Access Notes</div>
                                    <div class="meta-value">${site.notes}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('Generated HTML length:', html.length);
            container.innerHTML = html;
            console.log('Container innerHTML set successfully');
            
            } catch (error) {
                console.error('Error rendering sites:', error);                container.innerHTML = `
                    <div class="alert alert-danger">
                        Error displaying sites. Please refresh the page. Error: ${error.message}
                    </div>
                `;
            }
        }

        // ============================================
        // SITE MANAGEMENT FUNCTIONS
        // ============================================

        // Pause Contract
        window.pauseContract = async (siteId) => {
            const site = window.sites.find(s => s.id === siteId);
            if (!site) return;

            const pauseIndefinitely = confirm(`Pause "${site.name}"?\n\nClick OK to pause indefinitely, or Cancel to choose an end date.`);
            
            let pausedUntil = null;
            if (!pauseIndefinitely) {
                const dateStr = prompt('Pause until (YYYY-MM-DD):');
                if (!dateStr) return;
                pausedUntil = dateStr;
            }

            try {
                const userId = window.currentUser.uid;
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/sites/${siteId}`), {
                    paused: true,
                    pausedUntil: pausedUntil,
                    pausedDate: new Date().toISOString().split('T')[0]
                });

                // Hide all pending visits for this site
                const siteVisits = window.visits.filter(v => v.siteId === siteId && v.status === 'pending');
                for (const visit of siteVisits) {
                    await window.dbUpdate(window.dbRef(window.database, `users/${userId}/visits/${visit.id}`), {
                        hidden: true
                    });
                }

                alert(`‚úÖ Contract paused${pausedUntil ? ` until ${new Date(pausedUntil).toLocaleDateString('en-GB')}` : ' indefinitely'}`);
            } catch (error) {
                console.error('Error pausing contract:', error);
                alert('Error pausing contract. Please try again.');
            }
        };

        // Resume Contract
        window.resumeContract = async (siteId) => {
            const site = window.sites.find(s => s.id === siteId);
            if (!site) return;

            if (!confirm(`Resume "${site.name}"?\n\nThis will create a new visit starting from today.`)) {
                return;
            }

            try {
                const userId = window.currentUser.uid;
                
                // Resume the site
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/sites/${siteId}`), {
                    paused: false,
                    pausedUntil: null,
                    resumedDate: new Date().toISOString().split('T')[0]
                });

                // Unhide visits and create new visit from today
                const siteVisits = window.visits.filter(v => v.siteId === siteId && v.hidden);
                for (const visit of siteVisits) {
                    await window.dbRemove(window.dbRef(window.database, `users/${userId}/visits/${visit.id}`));
                }

                // Create new visit starting today
                const nextVisitData = {
                    siteId: site.id,
                    siteName: site.name,
                    siteAddress: site.address,
                    scheduledDate: new Date().toISOString().split('T')[0],
                    price: site.price,
                    frequency: site.frequency,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };

                const nextVisitRef = window.dbPush(window.dbRef(window.database, `users/${userId}/visits`));
                await window.dbSet(nextVisitRef, nextVisitData);

                alert('‚úÖ Contract resumed! New visit scheduled for today.');
            } catch (error) {
                console.error('Error resuming contract:', error);
                alert('Error resuming contract. Please try again.');
            }
        };

        // Edit Site
        window.editSite = async (siteId) => {
            console.log('editSite called with siteId:', siteId);
            const site = window.sites.find(s => s.id === siteId);
            console.log('Found site:', site);
            if (!site) {
                console.error('Site not found');
                return;
            }

            // Open modal first
            const modal = document.getElementById('addSiteModal');
            if (!modal) {
                console.error('Modal not found');
                return;
            }
            modal.classList.add('active');

            // Wait for modal to be visible before populating
            setTimeout(() => {
                // Populate form with existing data
                const fields = {
                    siteName: site.name,
                    siteAddress: site.address,
                    siteContact: site.contact || '',
                    sitePhone: site.phone || '',
                    sitePrice: site.price,
                    siteFrequency: site.frequency,
                    siteNotes: site.notes || '',
                    contractNotes: site.contractNotes || ''
                };

                for (const [fieldId, value] of Object.entries(fields)) {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.value = value;
                    } else {
                        console.warn(`Field ${fieldId} not found`);
                    }
                }

                // Change form title and button
                const titleElement = document.querySelector('#addSiteModal .modal-title');
                if (titleElement) titleElement.textContent = 'Edit Site';
                
                const submitBtn = document.querySelector('#addSiteForm button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Update Site';
                    submitBtn.onclick = async (e) => {
                e.preventDefault();
                
                const updatedData = {
                    name: document.getElementById('siteName').value,
                    address: document.getElementById('siteAddress').value,
                    contact: document.getElementById('siteContact').value,
                    phone: document.getElementById('sitePhone').value,
                    price: parseFloat(document.getElementById('sitePrice').value),
                    frequency: parseInt(document.getElementById('siteFrequency').value),
                    notes: document.getElementById('siteNotes').value,
                    contractNotes: document.getElementById('contractNotes').value
                };

                try {
                    const userId = window.currentUser.uid;
                    await window.dbUpdate(window.dbRef(window.database, `users/${userId}/sites/${siteId}`), updatedData);

                    // Update all pending visits for this site
                    const siteVisits = window.visits.filter(v => v.siteId === siteId && v.status === 'pending');
                    for (const visit of siteVisits) {
                        await window.dbUpdate(window.dbRef(window.database, `users/${userId}/visits/${visit.id}`), {
                            siteName: updatedData.name,
                            siteAddress: updatedData.address,
                            price: updatedData.price,
                            frequency: updatedData.frequency
                        });
                    }

                    closeAddSiteModal();
                    alert('‚úÖ Site updated successfully!');
                } catch (error) {
                    console.error('Error updating site:', error);
                    alert('Error updating site. Please try again.');
                }
            };

            console.log('Opening edit modal...');
            console.log('Modal should now be visible');
                } else {
                    console.error('Submit button not found');
                }
            }, 100); // Wait 100ms for modal to render
        };

        // Delete Site
        window.deleteSite = async (siteId) => {
            const site = window.sites.find(s => s.id === siteId);
            if (!site) return;

            if (!confirm(`Are you sure you want to delete "${site.name}"?\n\nThis will also delete all associated visits.\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const userId = window.currentUser.uid;
                
                // Delete all visits for this site
                const siteVisits = window.visits.filter(v => v.siteId === siteId);
                for (const visit of siteVisits) {
                    await window.dbRemove(window.dbRef(window.database, `users/${userId}/visits/${visit.id}`));
                }

                // Delete the site
                await window.dbRemove(window.dbRef(window.database, `users/${userId}/sites/${siteId}`));

                alert(`‚úÖ Site "${site.name}" and all associated visits deleted successfully.`);
            } catch (error) {
                console.error('Error deleting site:', error);
                alert('Error deleting site: ' + error.message);
            }
        };

        // ============================================
        // PROJECT FUNCTIONS
        // ============================================

        // Render Projects
        function renderProjects() {
            const container = document.getElementById('projectsContainer');
            
            if (window.projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìê</div>
                        <div class="empty-state-title">No projects yet</div>
                        <div class="empty-state-text">Add your first landscaping project or one-off job</div>
                        <button class="btn btn-primary" onclick="openAddProjectModal()">+ Add Your First Project</button>
                    </div>
                `;
                return;
            }

            // Separate by status
            const notStarted = window.projects.filter(p => p.status === 'not-started');
            const inProgress = window.projects.filter(p => p.status === 'in-progress');
            const completed = window.projects.filter(p => p.status === 'completed');

            let html = '';

            // In Progress Section
            if (inProgress.length > 0) {
                html += `
                    <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 1.5rem;">
                        <h3 style="color: #1e40af; margin-bottom: 0.5rem; font-size: 1.125rem;">üöß In Progress (${inProgress.length})</h3>
                    </div>
                `;
                html += inProgress.map(renderProjectCard).join('');
            }

            // Not Started Section
            if (notStarted.length > 0) {
                html += `
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 1.5rem; margin-top: 1.5rem;">
                        <h3 style="color: #92400e; margin-bottom: 0.5rem; font-size: 1.125rem;">üìã Not Started (${notStarted.length})</h3>
                    </div>
                `;
                html += notStarted.map(renderProjectCard).join('');
            }

            // Completed Section (show last 5)
            if (completed.length > 0) {
                html += `
                    <div style="background: #d1fae5; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--success); margin-bottom: 1.5rem; margin-top: 1.5rem;">
                        <h3 style="color: #065f46; margin-bottom: 0.5rem; font-size: 1.125rem;">‚úÖ Recently Completed</h3>
                    </div>
                `;
                html += completed.slice(-5).reverse().map(renderProjectCard).join('');
            }

            container.innerHTML = html;
        }

        function renderProjectCard(project) {
            const statusColors = {
                'not-started': { bg: '#fef3c7', text: '#92400e', label: 'Not Started' },
                'in-progress': { bg: '#dbeafe', text: '#1e40af', label: 'In Progress' },
                'completed': { bg: '#d1fae5', text: '#065f46', label: 'Completed' }
            };

            const status = statusColors[project.status];
            const startDate = new Date(project.startDate).toLocaleDateString('en-GB');
            const endDate = new Date(project.expectedEnd).toLocaleDateString('en-GB');

            return `
                <div class="site-card" style="border-left: 4px solid ${status.bg};">
                    <div class="site-header">
                        <div>
                            <div class="site-name">üìê ${project.projectName}</div>
                            <div class="site-address">${project.projectType} ‚Ä¢ ${project.clientName}</div>
                            <div class="site-address" style="margin-top: 0.25rem;">${project.address}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span class="visit-status" style="background: ${status.bg}; color: ${status.text}; padding: 0.375rem 0.875rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                ${status.label}
                            </span>
                            ${project.status !== 'completed' ? `
                                <button class="btn btn-secondary" onclick="editProject('${project.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button class="btn btn-danger" onclick="deleteProject('${project.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                                    üóëÔ∏è Delete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="site-meta">
                        <div class="meta-item">
                            <div class="meta-label">Price</div>
                            <div class="meta-value">¬£${project.price.toFixed(2)}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Start Date</div>
                            <div class="meta-value">${startDate}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">${project.status === 'completed' ? 'Completed' : 'Expected End'}</div>
                            <div class="meta-value">${project.actualCompletionDate ? new Date(project.actualCompletionDate).toLocaleDateString('en-GB') : endDate}</div>
                        </div>
                        ${project.contact ? `
                            <div class="meta-item">
                                <div class="meta-label">Contact</div>
                                <div class="meta-value">${project.contact}</div>
                            </div>
                        ` : ''}
                        ${project.phone ? `
                            <div class="meta-item">
                                <div class="meta-label">Phone</div>
                                <div class="meta-value">${project.phone}</div>
                            </div>
                        ` : ''}
                        ${project.description ? `
                            <div class="meta-item" style="grid-column: 1 / -1; background: var(--gray-50); padding: 0.75rem; border-radius: 6px;">
                                <div class="meta-label">Project Description</div>
                                <div class="meta-value" style="white-space: pre-wrap;">${project.description}</div>
                            </div>
                        ` : ''}
                        ${project.notes ? `
                            <div class="meta-item" style="grid-column: 1 / -1;">
                                <div class="meta-label">Notes</div>
                                <div class="meta-value">${project.notes}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${project.status !== 'completed' ? `
                        <!-- Project Updates Section -->
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <h4 style="margin: 0; font-size: 0.95rem; color: var(--gray-700);">üìù Project Updates</h4>
                                <button class="btn btn-secondary" onclick="openAddUpdateModal('${project.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">
                                    + Add Update
                                </button>
                            </div>
                            <div id="projectUpdates-${project.id}">
                                ${project.updates && project.updates.length > 0 ? `
                                    <div style="max-height: 200px; overflow-y: auto;">
                                        ${project.updates.map(update => `
                                            <div style="background: var(--gray-50); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid var(--primary);">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.25rem;">
                                                    <div style="font-size: 0.8rem; color: var(--gray-500);">
                                                        ${new Date(update.timestamp).toLocaleDateString('en-GB', { 
                                                            day: 'numeric', 
                                                            month: 'short', 
                                                            year: 'numeric',
                                                            hour: '2-digit',
                                                            minute: '2-digit'
                                                        })}
                                                    </div>
                                                    <button onclick="deleteProjectUpdate('${project.id}', '${update.id}')" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 0; font-size: 0.85rem;" title="Delete update">üóëÔ∏è</button>
                                                </div>
                                                <div style="color: var(--gray-700); font-size: 0.9rem; white-space: pre-wrap;">${update.text}</div>
                                            </div>
                                        `).reverse().join('')}
                                    </div>
                                ` : `
                                    <div style="text-align: center; padding: 1rem; color: var(--gray-400); font-size: 0.9rem;">
                                        No updates yet - click "Add Update" to track progress
                                    </div>
                                `}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${project.status !== 'completed' ? `
                        <div style="display: flex; gap: 0.75rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                            ${project.status === 'not-started' ? `
                                <button class="btn btn-primary" onclick="startProject('${project.id}')" style="flex: 1;">
                                    ‚ñ∂Ô∏è Start Project
                                </button>
                            ` : `
                                <button class="btn btn-success" onclick="openCompleteProjectModal('${project.id}')" style="flex: 1;">
                                    ‚úì Complete Project
                                </button>
                            `}
                        </div>
                    ` : `
                        ${project.invoiceStatus === 'pending' ? `
                            <div style="display: flex; gap: 0.75rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                                <button class="btn btn-success" onclick="markProjectInvoiced('${project.id}')" style="flex: 1;">
                                    ‚úì Mark Invoiced
                                </button>
                            </div>
                        ` : ''}
                    `}
                </div>
            `;
        }

        // Open Add Project Modal
        window.openAddProjectModal = () => {
            document.getElementById('addProjectModal').classList.add('active');
            document.getElementById('projectStartDate').valueAsDate = new Date();
        };

        window.closeAddProjectModal = () => {
            document.getElementById('addProjectModal').classList.remove('active');
            document.getElementById('addProjectForm').reset();
        };

        // Add Project Handler
        document.getElementById('addProjectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const projectData = {
                projectName: document.getElementById('projectName').value,
                projectType: document.getElementById('projectType').value,
                clientName: document.getElementById('projectClientName').value,
                address: document.getElementById('projectAddress').value,
                contact: document.getElementById('projectContact').value,
                phone: document.getElementById('projectPhone').value,
                email: document.getElementById('projectEmail').value,
                price: parseFloat(document.getElementById('projectPrice').value),
                startDate: document.getElementById('projectStartDate').value,
                expectedEnd: document.getElementById('projectExpectedEnd').value,
                description: document.getElementById('projectDescription').value,
                notes: document.getElementById('projectNotes').value,
                status: 'not-started',
                invoiceStatus: 'pending',
                createdAt: new Date().toISOString()
            };

            try {
                const userId = window.currentUser.uid;
                const projectRef = window.dbPush(window.dbRef(window.database, `users/${userId}/projects`));
                await window.dbSet(projectRef, projectData);

                closeAddProjectModal();
                alert('‚úÖ Project added successfully!');
            } catch (error) {
                console.error('Error adding project:', error);
                alert('Error adding project. Please try again.');
            }
        });

        // Start Project
        window.startProject = async (projectId) => {
            if (!confirm('Mark this project as started?')) return;
            
            try {
                const userId = window.currentUser.uid;
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/projects/${projectId}`), {
                    status: 'in-progress',
                    actualStartDate: new Date().toISOString().split('T')[0]
                });
                alert('‚úÖ Project started!');
            } catch (error) {
                console.error('Error starting project:', error);
                alert('Error starting project. Please try again.');
            }
        };

        // Initialize project signature pad
        function initProjectSignaturePad() {
            const canvas = document.getElementById('projectSignaturePad');
            if (!canvas) return;
            
            projectSignaturePad = canvas.getContext('2d');
            projectSignaturePad.strokeStyle = '#000';
            projectSignaturePad.lineWidth = 2;
            projectSignaturePad.lineCap = 'round';
            
            let lastX = 0;
            let lastY = 0;
            let isDrawing = false;
            
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                lastX = touch.clientX - rect.left;
                lastY = touch.clientY - rect.top;
                isDrawing = true;
            });
            
            canvas.addEventListener('touchmove', (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                projectSignaturePad.beginPath();
                projectSignaturePad.moveTo(lastX, lastY);
                projectSignaturePad.lineTo(x, y);
                projectSignaturePad.stroke();
                
                lastX = x;
                lastY = y;
            });
            
            canvas.addEventListener('touchend', () => {
                isDrawing = false;
            });
            
            canvas.addEventListener('mousedown', (e) => {
                const rect = canvas.getBoundingClientRect();
                lastX = e.clientX - rect.left;
                lastY = e.clientY - rect.top;
                isDrawing = true;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                projectSignaturePad.beginPath();
                projectSignaturePad.moveTo(lastX, lastY);
                projectSignaturePad.lineTo(x, y);
                projectSignaturePad.stroke();
                
                lastX = x;
                lastY = y;
            });
            
            canvas.addEventListener('mouseup', () => {
                isDrawing = false;
            });
            
            canvas.addEventListener('mouseleave', () => {
                isDrawing = false;
            });
        }

        window.clearProjectSignature = function() {
            const canvas = document.getElementById('projectSignaturePad');
            if (projectSignaturePad) {
                projectSignaturePad.clearRect(0, 0, canvas.width, canvas.height);
            }
        };

        // Open Complete Project Modal
        window.openCompleteProjectModal = (projectId) => {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            document.getElementById('completeProjectId').value = projectId;
            document.getElementById('projectCompletedBy').value = window.currentUser.email;
            document.getElementById('projectActualEndDate').valueAsDate = new Date();
            
            if (!projectSignaturePad) {
                initProjectSignaturePad();
            }
            
            setTimeout(() => {
                const canvas = document.getElementById('projectSignaturePad');
                if (canvas && projectSignaturePad) {
                    projectSignaturePad.clearRect(0, 0, canvas.width, canvas.height);
                }
            }, 100);
            
            document.getElementById('completeProjectModal').classList.add('active');
        };

        window.closeCompleteProjectModal = () => {
            document.getElementById('completeProjectModal').classList.remove('active');
            document.getElementById('completeProjectForm').reset();
            
            const canvas = document.getElementById('projectSignaturePad');
            if (canvas && projectSignaturePad) {
                projectSignaturePad.clearRect(0, 0, canvas.width, canvas.height);
            }
        };

        // Complete Project Handler
        document.getElementById('completeProjectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const projectId = document.getElementById('completeProjectId').value;
            const completedBy = document.getElementById('projectCompletedBy').value;
            const actualEndDate = document.getElementById('projectActualEndDate').value;
            const completionNotes = document.getElementById('projectCompletionNotes').value;
            const customerName = document.getElementById('projectCustomerName').value;

            // Validate signature
            const canvas = document.getElementById('projectSignaturePad');
            const signatureData = canvas.toDataURL();
            const blankCanvas = document.createElement('canvas');
            blankCanvas.width = canvas.width;
            blankCanvas.height = canvas.height;
            if (signatureData === blankCanvas.toDataURL()) {
                alert('Please get customer signature before completing.');
                return;
            }

            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            try {
                const userId = window.currentUser.uid;
                
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/projects/${projectId}`), {
                    status: 'completed',
                    completedBy: completedBy,
                    actualCompletionDate: actualEndDate,
                    completionNotes: completionNotes,
                    customerName: customerName,
                    customerSignature: signatureData,
                    completedAt: new Date().toISOString()
                });

                closeCompleteProjectModal();
                
                // Send email notification
                sendProjectInvoiceEmail(project, completedBy, actualEndDate, completionNotes, customerName);
                
                alert('‚úÖ Project completed!\nüìß Email notification sent\n\nProject moved to invoice tracking');
            } catch (error) {
                console.error('Error completing project:', error);
                alert('Error completing project. Please try again.');
            }
        });

        // Send Project Invoice Email
        function sendProjectInvoiceEmail(project, completedBy, completedDate, notes, customerName) {
            const emailSubject = `Invoice Required: ${project.projectName} - Completed ${completedDate}`;
            
            const emailBody = `
Project Completion Details
====================================

Project Information:
- Project Name: ${project.projectName}
- Project Type: ${project.projectType}
- Client: ${project.clientName}
- Address: ${project.address}

Work Details:
- Completed By: ${completedBy}
- Completed On: ${new Date(completedDate).toLocaleDateString('en-GB')}
- Invoice Amount: ¬£${project.price.toFixed(2)}

Project Description:
${project.description}

${notes ? `Completion Notes:\n${notes}\n` : ''}
Customer Sign-Off:
- Customer Name: ${customerName}
- Signature: Captured digitally (view in app Projects tab)

REMINDER: 
- Field staff should have before/after photos on their phone
- Customer signature captured digitally
- Project completion confirmed

Please prepare and send invoice to the customer.

---
This notification was generated automatically by Roundwood Route Manager.
            `.trim();

            const mailto = `mailto:office@roundwoodsolutions.co.uk?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
            window.location.href = mailto;
        }

        // Delete Project
        window.deleteProject = async (projectId) => {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            if (!confirm(`Are you sure you want to delete "${project.projectName}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const userId = window.currentUser.uid;
                await window.dbRemove(window.dbRef(window.database, `users/${userId}/projects/${projectId}`));
                alert(`‚úÖ Project "${project.projectName}" deleted successfully.`);
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Error deleting project: ' + error.message);
            }
        };

        // Edit Project
        window.editProject = async (projectId) => {
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                console.error('Project not found');
                return;
            }

            // Open modal first
            const modal = document.getElementById('addProjectModal');
            if (!modal) {
                console.error('Project modal not found');
                return;
            }
            modal.classList.add('active');

            // Wait for modal to render then populate
            setTimeout(() => {
                const fields = {
                    projectName: project.projectName,
                    projectType: project.projectType,
                    clientName: project.clientName,
                    projectAddress: project.address,
                    projectContact: project.contact || '',
                    projectPhone: project.phone || '',
                    projectPrice: project.price,
                    projectStartDate: project.startDate,
                    projectExpectedEnd: project.expectedEnd,
                    projectDescription: project.description || '',
                    projectNotes: project.notes || ''
                };

                for (const [fieldId, value] of Object.entries(fields)) {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.value = value;
                    } else {
                        console.warn(`Field ${fieldId} not found`);
                    }
                }

                // Change form title and button
                const titleElement = document.querySelector('#addProjectModal .modal-title');
                if (titleElement) titleElement.textContent = 'Edit Project';
                
                const submitBtn = document.querySelector('#addProjectForm button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Update Project';
                    submitBtn.onclick = async (e) => {
                        e.preventDefault();
                        
                        const updatedData = {
                            projectName: document.getElementById('projectName').value,
                            projectType: document.getElementById('projectType').value,
                            clientName: document.getElementById('clientName').value,
                            address: document.getElementById('projectAddress').value,
                            contact: document.getElementById('projectContact').value,
                            phone: document.getElementById('projectPhone').value,
                            price: parseFloat(document.getElementById('projectPrice').value),
                            startDate: document.getElementById('projectStartDate').value,
                            expectedEnd: document.getElementById('projectExpectedEnd').value,
                            description: document.getElementById('projectDescription').value,
                            notes: document.getElementById('projectNotes').value
                        };

                        try {
                            const userId = window.currentUser.uid;
                            await window.dbUpdate(window.dbRef(window.database, `users/${userId}/projects/${projectId}`), updatedData);
                            closeAddProjectModal();
                            alert('‚úÖ Project updated successfully!');
                        } catch (error) {
                            console.error('Error updating project:', error);
                            alert('Error updating project. Please try again.');
                        }
                    };
                }
            }, 100);
        };

        // Mark Project Invoiced
        window.markProjectInvoiced = async (projectId) => {
            if (!confirm('Mark this project as invoiced?')) return;
            
            try {
                const userId = window.currentUser.uid;
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/projects/${projectId}`), {
                    invoiceStatus: 'sent',
                    invoiceSentDate: new Date().toISOString().split('T')[0]
                });
            } catch (error) {
                console.error('Error updating invoice status:', error);
                alert('Error updating invoice status. Please try again.');
            }
        };

        // ============================================
        // PROJECT UPDATE FUNCTIONS
        // ============================================

        // Open Add Update Modal
        window.openAddUpdateModal = (projectId) => {
            document.getElementById('updateProjectId').value = projectId;
            document.getElementById('addUpdateModal').classList.add('active');
        };

        // Close Add Update Modal
        window.closeAddUpdateModal = () => {
            document.getElementById('addUpdateModal').classList.remove('active');
            document.getElementById('addUpdateForm').reset();
        };

        // Add Project Update
        document.getElementById('addUpdateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const projectId = document.getElementById('updateProjectId').value;
            const updateText = document.getElementById('updateText').value;
            
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            try {
                const userId = window.currentUser.uid;
                
                // Get existing updates or create new array
                const existingUpdates = project.updates || [];
                
                // Create new update
                const newUpdate = {
                    id: Date.now().toString(),
                    text: updateText,
                    timestamp: new Date().toISOString()
                };
                
                // Add to beginning of array (newest first)
                const updatedUpdates = [...existingUpdates, newUpdate];
                
                // Save to Firebase
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/projects/${projectId}`), {
                    updates: updatedUpdates
                });

                closeAddUpdateModal();
                alert('‚úÖ Update added successfully!');
            } catch (error) {
                console.error('Error adding update:', error);
                alert('Error adding update. Please try again.');
            }
        });

        // Delete Project Update
        window.deleteProjectUpdate = async (projectId, updateId) => {
            if (!confirm('Delete this update?')) return;
            
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            try {
                const userId = window.currentUser.uid;
                
                // Remove the update from the array
                const updatedUpdates = (project.updates || []).filter(u => u.id !== updateId);
                
                // Save to Firebase
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/projects/${projectId}`), {
                    updates: updatedUpdates
                });

                alert('‚úÖ Update deleted successfully!');
            } catch (error) {
                console.error('Error deleting update:', error);
                alert('Error deleting update. Please try again.');
            }
        };

        // Render Visits
        function renderVisits() {
            const container = document.getElementById('visitsContainer');
            const today = new Date().toISOString().split('T')[0];
            
            const upcomingVisits = visits
                .filter(v => v.status === 'pending')
                .sort((a, b) => new Date(a.scheduledDate) - new Date(b.scheduledDate));

            if (upcomingVisits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <div class="empty-state-title">No upcoming visits</div>
                        <div class="empty-state-text">All visits are completed or there are no sites yet</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = upcomingVisits.map(visit => {
                const isOverdue = visit.scheduledDate < today && visit.status !== 'paused';
                const visitDate = new Date(visit.scheduledDate);
                const formattedDate = visitDate.toLocaleDateString('en-GB', { 
                    weekday: 'short', 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                });

                return `
                    <div class="visit-card ${isOverdue ? 'overdue' : ''}">
                        <div class="visit-header">
                            <div>
                                <div class="visit-site">${visit.siteName}</div>
                                <div class="visit-date">${formattedDate}</div>
                                <div class="site-address" style="margin-top: 0.5rem;">${visit.siteAddress}</div>
                            </div>
                            <span class="visit-status ${visit.status === 'paused' ? 'status-paused' : (isOverdue ? 'status-overdue' : 'status-pending')}">
                                ${visit.status === 'paused' ? 'Paused' : (isOverdue ? 'Overdue' : 'Pending')}
                            </span>
                        </div>
                        <div class="meta-item" style="margin-top: 1rem;">
                            <div class="meta-label">Visit Price</div>
                            <div class="meta-value">¬£${visit.price.toFixed(2)}</div>
                        </div>
                        <div class="visit-actions">
                            <button class="btn btn-success" onclick="openCompleteVisitModal('${visit.id}')" style="flex: 1;">
                                ‚úì Complete Visit
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Complete Visit Modal
        window.openCompleteVisitModal = (visitId) => {
            document.getElementById('completeVisitId').value = visitId;
            document.getElementById('completeVisitModal').classList.add('active');
            
            // Initialize signature pad after modal is visible
            setTimeout(() => {
                initSignaturePad();
            }, 100);
        };

        window.closeCompleteVisitModal = () => {
            document.getElementById('completeVisitModal').classList.remove('active');
            document.getElementById('completeVisitForm').reset();
            clearSignature();
        };

        // Initialize signature pad
        let signaturePad = null;
        
        function initSignaturePad() {
            const canvas = document.getElementById('signaturePad');
            if (!canvas) return;
            
            signaturePad = canvas.getContext('2d');
            signaturePad.strokeStyle = '#000';
            signaturePad.lineWidth = 2;
            signaturePad.lineCap = 'round';
            
            let lastX = 0;
            let lastY = 0;
            let isDrawing = false;
            
            // Remove old event listeners by cloning the canvas
            const newCanvas = canvas.cloneNode(true);
            canvas.parentNode.replaceChild(newCanvas, canvas);
            const ctx = newCanvas.getContext('2d');
            signaturePad = ctx;
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            // Touch events
            newCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = newCanvas.getBoundingClientRect();
                lastX = touch.clientX - rect.left;
                lastY = touch.clientY - rect.top;
                isDrawing = true;
            });
            
            newCanvas.addEventListener('touchmove', (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const touch = e.touches[0];
                const rect = newCanvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                lastX = x;
                lastY = y;
            });
            
            newCanvas.addEventListener('touchend', () => {
                isDrawing = false;
            });
            
            // Mouse events
            newCanvas.addEventListener('mousedown', (e) => {
                const rect = newCanvas.getBoundingClientRect();
                lastX = e.clientX - rect.left;
                lastY = e.clientY - rect.top;
                isDrawing = true;
            });
            
            newCanvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const rect = newCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                lastX = x;
                lastY = y;
            });
            
            newCanvas.addEventListener('mouseup', () => {
                isDrawing = false;
            });
            
            newCanvas.addEventListener('mouseleave', () => {
                isDrawing = false;
            });
        }

        window.clearSignature = function() {
            const canvas = document.getElementById('signaturePad');
            if (canvas && signaturePad) {
                signaturePad.clearRect(0, 0, canvas.width, canvas.height);
            }
        };

        // Complete Visit Handler
        document.getElementById('completeVisitForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const visitId = document.getElementById('completeVisitId').value;
            const completedBy = document.getElementById('completedBy').value;
            const customerName = document.getElementById('customerName').value;
            
            // Get checklist values
            const workCompleted = {
                weedRemoval: document.getElementById('weedRemoval').checked,
                strimming: document.getElementById('strimming').checked,
                weedSuppressant: document.getElementById('weedSuppressant').checked,
                generalTidy: document.getElementById('generalTidy').checked
            };
            
            const siteNotes = document.getElementById('siteNotes').value;

            // Validate signature
            const canvas = document.getElementById('signaturePad');
            const signatureData = canvas.toDataURL();
            const blankCanvas = document.createElement('canvas');
            blankCanvas.width = canvas.width;
            blankCanvas.height = canvas.height;
            if (signatureData === blankCanvas.toDataURL()) {
                alert('Please get customer signature before completing.');
                return;
            }

            const visit = window.visits.find(v => v.id === visitId);
            if (!visit) return;

            try {
                const userId = window.currentUser.uid;
                
                // Update current visit
                const completedDate = new Date().toISOString().split('T')[0];
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/visits/${visitId}`), {
                    status: 'completed',
                    completedDate: completedDate,
                    completedBy: completedBy,
                    customerName: customerName,
                    customerSignature: signatureData,
                    workCompleted: workCompleted,
                    siteNotes: siteNotes,
                    invoiceStatus: 'pending'
                });

                // Create next visit (unless site is paused)
                const site = window.sites.find(s => s.id === visit.siteId);
                if (!site || !site.paused) {
                    const nextVisitDate = new Date(visit.scheduledDate);
                    nextVisitDate.setDate(nextVisitDate.getDate() + visit.frequency);

                    const nextVisitData = {
                        siteId: visit.siteId,
                        siteName: visit.siteName,
                        siteAddress: visit.siteAddress,
                        scheduledDate: nextVisitDate.toISOString().split('T')[0],
                        price: visit.price,
                        frequency: visit.frequency,
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    };

                    const nextVisitRef = window.dbPush(window.dbRef(window.database, `users/${userId}/visits`));
                    await window.dbSet(nextVisitRef, nextVisitData);
                }

                closeCompleteVisitModal();

                // Prepare email data and open email client
                const visitForEmail = {
                    ...visit,
                    completedDate: completedDate,
                    completedBy: completedBy,
                    customerName: customerName,
                    workCompleted: workCompleted,
                    siteNotes: siteNotes
                };
                
                // Open email client with pre-filled details
                sendInvoiceEmail(visitForEmail);
                
                alert('‚úÖ Visit completed!\nüìß Email opening to office@roundwoodsolutions.co.uk\nüìÖ Next visit scheduled');
            } catch (error) {
                console.error('Error completing visit:', error);
                alert('Error completing visit. Please try again.');
            }
        });

        // Mark Invoice Sent
        window.markInvoiceSent = async (visitId) => {
            if (!confirm('Mark this invoice as sent? This will clear it from the tracking list.')) {
                return;
            }

            try {
                const userId = window.currentUser.uid;
                await window.dbUpdate(window.dbRef(window.database, `users/${userId}/visits/${visitId}`), {
                    invoiceStatus: 'sent',
                    invoiceSentDate: new Date().toISOString().split('T')[0]
                });
            } catch (error) {
                console.error('Error updating invoice status:', error);
                alert('Error updating invoice status. Please try again.');
            }
        };

        // Render Invoices
        function renderInvoices() {
            const container = document.getElementById('invoicesContainer');
            
            const uninvoicedVisits = visits
                .filter(v => v.status === 'completed' && v.invoiceStatus === 'pending')
                .sort((a, b) => new Date(a.completedDate) - new Date(b.completedDate));

            if (uninvoicedVisits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <div class="empty-state-title">All caught up!</div>
                        <div class="empty-state-text">No invoices awaiting to be sent</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = uninvoicedVisits.map(visit => {
                const completedDate = new Date(visit.completedDate);
                const formattedDate = completedDate.toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                });

                return `
                    <div class="visit-card">
                        <div class="visit-header">
                            <div>
                                <div class="visit-site">${visit.siteName}</div>
                                <div class="visit-date">Completed: ${formattedDate}</div>
                                <div class="site-address" style="margin-top: 0.5rem;">${visit.siteAddress}</div>
                            </div>
                            <span class="visit-status status-pending">Invoice Needed</span>
                        </div>
                        <div class="meta-item" style="margin-top: 1rem;">
                            <div class="meta-label">Amount</div>
                            <div class="meta-value">¬£${visit.price.toFixed(2)}</div>
                        </div>
                        ${visit.completedBy ? `
                            <div class="meta-item" style="margin-top: 0.5rem;">
                                <div class="meta-label">Completed By</div>
                                <div class="meta-value">${visit.completedBy}</div>
                            </div>
                        ` : ''}
                        ${visit.completionNotes ? `
                            <div class="meta-item" style="margin-top: 0.5rem;">
                                <div class="meta-label">Notes</div>
                                <div class="meta-value">${visit.completionNotes}</div>
                            </div>
                        ` : ''}
                        <div class="visit-actions">
                            <button class="btn btn-success" onclick="markInvoiceSent('${visit.id}')" style="flex: 1;">
                                ‚úì Mark Invoice Sent
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render History
        function renderHistory() {
            const container = document.getElementById('historyContainer');
            
            const completedVisits = visits
                .filter(v => v.status === 'completed')
                .sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate))
                .slice(0, 20);

            if (completedVisits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìú</div>
                        <div class="empty-state-title">No history yet</div>
                        <div class="empty-state-text">Completed visits will appear here</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = completedVisits.map(visit => {
                const completedDate = new Date(visit.completedDate);
                const formattedDate = completedDate.toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                });

                const invoiceStatus = visit.invoiceStatus === 'sent' ? 'Invoiced' : 'Awaiting Invoice';
                const invoiceClass = visit.invoiceStatus === 'sent' ? 'status-completed' : 'status-pending';

                return `
                    <div class="visit-card completed">
                        <div class="visit-header">
                            <div>
                                <div class="visit-site">${visit.siteName}</div>
                                <div class="visit-date">${formattedDate}</div>
                            </div>
                            <span class="visit-status ${invoiceClass}">${invoiceStatus}</span>
                        </div>
                        <div class="site-meta" style="margin-top: 1rem;">
                            ${visit.completedBy ? `
                                <div class="meta-item">
                                    <div class="meta-label">Completed By</div>
                                    <div class="meta-value">${visit.completedBy}</div>
                                </div>
                            ` : ''}
                            <div class="meta-item">
                                <div class="meta-label">Amount</div>
                                <div class="meta-value">¬£${visit.price.toFixed(2)}</div>
                            </div>
                            ${visit.completionNotes ? `
                                <div class="meta-item" style="grid-column: 1 / -1;">
                                    <div class="meta-label">Notes</div>
                                    <div class="meta-value">${visit.completionNotes}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }


        // Render Visit Reminders (3 days ahead)
        // Render Due Today on Dashboard
        function renderDueToday() {
            const todayStr = new Date().toISOString().split('T')[0];
            
            // Get today's visits
            const todayVisits = visits
                .filter(v => v.status === 'pending' && !v.hidden && v.scheduledDate === todayStr)
                .map(v => ({ ...v, type: 'visit' }));
            
            // Get today's projects
            const todayProjects = projects
                .filter(p => p.status !== 'completed' && p.startDate === todayStr)
                .map(p => ({ ...p, type: 'project' }));
            
            const todayItems = [...todayVisits, ...todayProjects];
            
            const card = document.getElementById('dueTodayCard');
            const container = document.getElementById('dueTodayContent');
            const badge = document.getElementById('dueTodayBadge');
            
            if (!card || !container) return;
            
            if (todayItems.length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            if (badge) badge.textContent = todayItems.length;
            container.innerHTML = todayItems.map(item => {
                if (item.type === 'project') {
                    return `
                        <div style="padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.75rem; border-left: 3px solid #8b5cf6;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #1f2937;">üìê ${item.projectName}</div>
                                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                        ${item.projectType} ‚Ä¢ ${item.clientName}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #8b5cf6; margin-top: 0.375rem; font-weight: 500;">
                                        ${item.status === 'not-started' ? 'Starting today' : 'In Progress'}
                                    </div>
                                </div>
                                <div>
                                    ${item.status === 'not-started' ? 
                                        `<button class="btn btn-primary" onclick="startProject('${item.id}')" style="font-size: 0.85rem; padding: 0.375rem 0.75rem;">‚ñ∂Ô∏è Start</button>` :
                                        `<button class="btn btn-success" onclick="openCompleteProjectModal('${item.id}')" style="font-size: 0.85rem; padding: 0.375rem 0.75rem;">‚úì Complete</button>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div style="padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.75rem; border-left: 3px solid var(--success);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #1f2937;">${item.siteName}</div>
                                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                        ${item.siteAddress}
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--success); margin-top: 0.375rem; font-weight: 500;">
                                        ¬£${item.price.toFixed(2)}
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-success" onclick="openCompleteVisitModal('${item.id}')" style="font-size: 0.85rem; padding: 0.375rem 0.75rem;">
                                        ‚úì Complete Visit
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Render Active Projects on Dashboard
        function renderActiveProjects() {
            const activeProjects = window.projects.filter(p => p.status !== 'completed');
            
            const card = document.getElementById('activeProjectsCard');
            const container = document.getElementById('activeProjectsContent');
            const badge = document.getElementById('activeProjectsBadge');
            
            if (!card || !container) return;
            
            if (activeProjects.length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            if (badge) badge.textContent = activeProjects.length;
            container.innerHTML = activeProjects.map(project => {
                const startDate = new Date(project.startDate);
                const endDate = new Date(project.expectedEnd);
                const today = new Date();
                const daysUntilStart = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
                const daysUntilEnd = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                
                const statusInfo = {
                    'not-started': {
                        bg: '#fef3c7',
                        text: '#92400e',
                        label: daysUntilStart > 0 ? `Starts in ${daysUntilStart} day${daysUntilStart > 1 ? 's' : ''}` : 'Starts today',
                        action: daysUntilStart <= 0 ? `<button class="btn btn-primary" onclick="startProject('${project.id}')" style="font-size: 0.85rem; padding: 0.375rem 0.75rem;">‚ñ∂Ô∏è Start Project</button>` : ''
                    },
                    'in-progress': {
                        bg: '#dbeafe',
                        text: '#1e40af',
                        label: daysUntilEnd > 0 ? `Due in ${daysUntilEnd} day${daysUntilEnd > 1 ? 's' : ''}` : 'Due today',
                        action: `<button class="btn btn-success" onclick="openCompleteProjectModal('${project.id}')" style="font-size: 0.85rem; padding: 0.375rem 0.75rem;">‚úì Complete</button>`
                    }
                };
                
                const status = statusInfo[project.status];
                
                return `
                    <div style="padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.75rem; border-left: 3px solid ${status.bg};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1f2937;">üìê ${project.projectName}</div>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                    ${project.projectType} ‚Ä¢ ${project.clientName}
                                </div>
                                <div style="font-size: 0.85rem; color: ${status.text}; margin-top: 0.375rem; font-weight: 500;">
                                    ${status.label}
                                </div>
                            </div>
                            <div>
                                ${status.action}
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #9ca3af; margin-top: 0.5rem;">
                            ${startDate.toLocaleDateString('en-GB')} ‚Üí ${endDate.toLocaleDateString('en-GB')} ‚Ä¢ ¬£${project.price.toFixed(2)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render Visit Reminders
        function renderVisitReminders() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            const threeDaysFromNow = new Date(today);
            threeDaysFromNow.setDate(today.getDate() + 3);
            const threeDaysStr = threeDaysFromNow.toISOString().split('T')[0];
            
            // Get visits between tomorrow and 3 days from now
            const upcomingVisits = visits
                .filter(v => {
                    if (v.status !== 'pending' || v.hidden) return false;
                    return v.scheduledDate > todayStr && v.scheduledDate <= threeDaysStr;
                })
                .sort((a, b) => a.siteName.localeCompare(b.siteName));
            
            const card = document.getElementById('visitRemindersCard');
            const container = document.getElementById('visitRemindersContent');
            const badge = document.getElementById('remindersBadge');
            
            if (upcomingVisits.length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            if (badge) badge.textContent = upcomingVisits.length;
            container.innerHTML = upcomingVisits.map(visit => {
                const daysUntil = Math.ceil((new Date(visit.scheduledDate) - today) / (1000 * 60 * 60 * 24));
                return `
                <div style="padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #f59e0b;">
                    <div>
                        <div style="font-weight: 600; color: #92400e;">${visit.siteName}</div>
                        <div style="font-size: 0.875rem; color: #78350f; margin-top: 0.25rem;">
                            ${visit.siteAddress}
                        </div>
                        <div style="font-size: 0.85rem; color: #a16207; margin-top: 0.25rem;">
                            üìÖ ${new Date(visit.scheduledDate).toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' })} (in ${daysUntil} day${daysUntil > 1 ? 's' : ''})
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="sendCourtesyReminder('${visit.siteName}', '${visit.siteAddress}', '${visit.scheduledDate}')" style="font-size: 0.875rem; white-space: nowrap;">
                        üìß Send Reminder
                    </button>
                </div>
            `;
            }).join('');
        }

        // Send Courtesy Reminder Email
        window.sendCourtesyReminder = function(siteName, siteAddress, visitDate) {
            const formattedDate = new Date(visitDate).toLocaleDateString('en-GB', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long',
                year: 'numeric'
            });
            
            const emailSubject = `Roundwood Solutions - Upcoming Visit on ${formattedDate}`;
            
            const emailBody = `
Good morning,

This is a courtesy reminder that we have a scheduled grounds maintenance visit to ${siteName} on:

üìÖ ${formattedDate}

Our team will be on-site to complete the scheduled maintenance work as per our agreement.

If you have any specific requirements or concerns for this visit, please let us know.

Many thanks,

Ben Brice
Director
Roundwood Solutions Limited

üìû 07545 642021
üìß office@roundwoodsolutions.co.uk
üåê www.roundwoodsolutions.co.uk
            `.trim();

            const mailto = `mailto:?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
            window.location.href = mailto;
            
            alert('‚úÖ Courtesy reminder email opened!\n\nAdd the client contact email and send.');
        };

        // Render Next Due Visits (Next 7 days + Overdue)
        function renderNextVisits() {
            const container = document.getElementById('nextVisits');
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const sevenDaysFromNow = new Date(today);
            sevenDaysFromNow.setDate(today.getDate() + 7);
            
            // Get overdue visits (only visits BEFORE today, not today)
            const overdueVisits = visits
                .filter(v => {
                    if (v.status !== 'pending' || v.hidden) return false;
                    return v.scheduledDate < todayStr; // String comparison: earlier dates are "less than"
                })
                .map(v => ({ ...v, type: 'visit', date: v.scheduledDate }))
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Get next 7 days visits
            const upcomingVisits = visits
                .filter(v => {
                    if (v.status !== 'pending' || v.hidden) return false;
                    const visitDate = new Date(v.scheduledDate);
                    return visitDate >= today && visitDate <= sevenDaysFromNow;
                })
                .map(v => ({ ...v, type: 'visit', date: v.scheduledDate }));

            // Get projects starting in next 7 days (not started or in progress)
            const upcomingProjects = projects
                .filter(p => {
                    if (p.status === 'completed') return false;
                    const projectStartDate = new Date(p.startDate);
                    projectStartDate.setHours(0, 0, 0, 0);
                    const todayStart = new Date(today);
                    todayStart.setHours(0, 0, 0, 0);
                    return projectStartDate >= todayStart && projectStartDate <= sevenDaysFromNow;
                })
                .map(p => ({ ...p, type: 'project', date: p.startDate }));

            // Combine and sort by date
            const allItems = [...overdueVisits, ...upcomingVisits, ...upcomingProjects]
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if (allItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <div class="empty-state-text">No overdue or upcoming visits/projects in the next 7 days</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Render overdue section if there are overdue visits
            if (overdueVisits.length > 0) {
                html += `
                    <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--danger); margin-bottom: 1.5rem;">
                        <h3 style="color: #991b1b; margin-bottom: 0.5rem; font-size: 1.125rem;">‚ö†Ô∏è Overdue Visits (${overdueVisits.length})</h3>
                        <p style="color: #7f1d1d; font-size: 0.9rem;">These visits are past their scheduled date and need immediate attention.</p>
                    </div>
                `;
                
                html += overdueVisits.map(visit => {
                    const visitDate = new Date(visit.date);
                    const formattedDate = visitDate.toLocaleDateString('en-GB', { 
                        weekday: 'short', 
                        day: 'numeric', 
                        month: 'short', 
                        year: 'numeric' 
                    });
                    
                    const daysOverdue = Math.floor((today - visitDate) / (1000 * 60 * 60 * 24));

                    return `
                        <div class="visit-card overdue">
                            <div class="visit-header">
                                <div>
                                    <div class="visit-site">${visit.siteName}</div>
                                    <div class="visit-date">${formattedDate} - ${daysOverdue} day${daysOverdue > 1 ? 's' : ''} overdue</div>
                                    <div class="site-address" style="margin-top: 0.5rem;">${visit.siteAddress}</div>
                                </div>
                                <span class="visit-status status-overdue">
                                    Overdue
                                </span>
                            </div>
                            <div class="visit-actions">
                                <button class="btn btn-success" onclick="openCompleteVisitModal('${visit.id}')" style="flex: 1;">
                                    ‚úì Complete Visit
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Render upcoming section (visits and projects combined)
            const upcomingItems = allItems.filter(item => {
                const itemDate = new Date(item.date);
                itemDate.setHours(0, 0, 0, 0);
                const todayStart = new Date(today);
                todayStart.setHours(0, 0, 0, 0);
                return itemDate >= todayStart;
            });
            if (upcomingItems.length > 0) {
                if (overdueVisits.length > 0) {
                    html += `
                        <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin: 1.5rem 0;">
                            <h3 style="color: #1e40af; margin-bottom: 0.5rem; font-size: 1.125rem;">üìÖ Upcoming (Next 7 Days)</h3>
                        </div>
                    `;
                }
                
                html += upcomingItems.map(item => {
                    const itemDate = new Date(item.date);
                    const isToday = item.date === todayStr;
                    const formattedDate = itemDate.toLocaleDateString('en-GB', { 
                        weekday: 'short', 
                        day: 'numeric', 
                        month: 'short', 
                        year: 'numeric' 
                    });

                    if (item.type === 'project') {
                        // Render project card
                        const statusLabel = item.status === 'not-started' ? 'Starting' : 'In Progress';
                        return `
                            <div class="visit-card" style="border-left-color: #8b5cf6;">
                                <div class="visit-header">
                                    <div>
                                        <div class="visit-site">üìê ${item.projectName}</div>
                                        <div class="visit-date">${formattedDate} ‚Ä¢ ${item.projectType}</div>
                                        <div class="site-address" style="margin-top: 0.5rem;">${item.clientName} - ${item.address}</div>
                                    </div>
                                    <span class="visit-status" style="background: #ede9fe; color: #6b21a8;">
                                        ${statusLabel}
                                    </span>
                                </div>
                                ${item.status === 'not-started' && isToday ? `
                                    <div class="visit-actions">
                                        <button class="btn btn-primary" onclick="startProject('${item.id}')" style="flex: 1;">
                                            ‚ñ∂Ô∏è Start Project
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    } else {
                        // Render visit card
                        return `
                            <div class="visit-card">
                                <div class="visit-header">
                                    <div>
                                        <div class="visit-site">${item.siteName}</div>
                                        <div class="visit-date">${formattedDate}</div>
                                        <div class="site-address" style="margin-top: 0.5rem;">${item.siteAddress}</div>
                                    </div>
                                    <span class="visit-status ${isToday ? 'status-pending' : 'status-pending'}" style="${isToday ? 'background: #fef3c7; color: #92400e;' : ''}">
                                        ${isToday ? 'Today' : formattedDate.split(',')[0]}
                                    </span>
                                </div>
                                ${isToday ? `
                                    <div class="visit-actions">
                                        <button class="btn btn-success" onclick="openCompleteVisitModal('${item.id}')" style="flex: 1;">
                                            ‚úì Complete Visit
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                }).join('');
            }
            
            container.innerHTML = html;
            
            // Update badge count
            const badge = document.getElementById('nextSevenBadge');
            if (badge) badge.textContent = allItems.length;
        }

        // Update Stats
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            
            // Update top nav counts
            const upcomingVisits = window.visits.filter(v => v.status === 'pending').length;
            document.getElementById('upcomingCount').textContent = upcomingVisits;
            
            const uninvoiced = window.visits.filter(v => v.status === 'completed' && v.invoiceStatus === 'pending').length;
            const uninvoicedProjects = window.projects.filter(p => p.status === 'completed' && p.invoiceStatus === 'pending').length;
            document.getElementById('statUninvoiced').textContent = uninvoiced + uninvoicedProjects;
            document.getElementById('uninvoicedCount').textContent = uninvoiced + uninvoicedProjects;
            
            // Update project count
            const activeProjects = window.projects.filter(p => p.status !== 'completed').length;
            document.getElementById('projectsCount').textContent = activeProjects;
            
            // Update dashboard content
            renderSeasonalTips();
            renderMonthlyUpsells();
            renderActiveProjects();
            renderDueToday();
            renderVisitReminders();
            renderNextVisits();
        }

        // ============================================
        // REVIEW REQUEST FUNCTIONS
        // ============================================
        
        function sendReviewRequest(customerEmail, customerName, siteName, business) {
            let emailSubject, emailBody;
            
            if (business === 'weedcontrol') {
                // Weed Control Kent template
                emailSubject = 'How was our weed control service at ' + siteName + '?';
                
                emailBody = `
Hi ${customerName},

Thank you for choosing Weed Control Kent for your professional weed control at ${siteName}.

We'd really appreciate it if you could take 2 minutes to leave us a review on Google. Your feedback helps us improve and helps other property managers find reliable weed control services.

Leave a review here:
https://g.page/r/CUIoA0XVVFhTEAI/review

Thank you for your time and trust in our services.

Best regards,

Ben Brice
Director
Weed Control Kent

üìû 07545 642021
üìß office@roundwoodsolutions.co.uk
üåê www.weedcontrolkent.co.uk

üåø Professional Weed Control Services Across Kent
                `.trim();
            } else {
                // Roundwood Solutions template
                emailSubject = 'How was our service at ' + siteName + '?';
                
                emailBody = `
Hi ${customerName},

Thank you for choosing Roundwood Solutions for your grounds maintenance at ${siteName}.

We'd really appreciate it if you could take 2 minutes to leave us a review on Google. Your feedback helps us improve and helps other businesses find quality grounds maintenance services.

Leave a review here:
https://g.page/r/CUIoA0XVVFhTEAI/review

Thank you for your time and trust in our services.

Best regards,

Ben Brice
Director
Roundwood Solutions Limited

üìû 07545 642021
üìß office@roundwoodsolutions.co.uk
üåê www.roundwoodsolutions.co.uk

üå≥ Commercial Landscaping and Grounds Maintenance
                `.trim();
            }

            const mailto = `mailto:${customerEmail}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
            
            return mailto;
        }

        // Update email preview when business changes
        document.getElementById('reviewBusiness').addEventListener('change', (e) => {
            const previewText = document.getElementById('emailPreviewText');
            if (e.target.value === 'weedcontrol') {
                previewText.textContent = 'The customer will receive a professional email thanking them for choosing Weed Control Kent and asking them to leave a Google review.';
            } else {
                previewText.textContent = 'The customer will receive a professional email thanking them for choosing Roundwood Solutions and asking them to leave a Google review.';
            }
        });

        // Send Review Request Form
        document.getElementById('sendReviewForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const customerName = document.getElementById('reviewCustomerName').value;
            const customerEmail = document.getElementById('reviewCustomerEmail').value;
            const siteName = document.getElementById('reviewSiteName').value;
            const business = document.getElementById('reviewBusiness').value;
            
            const reviewLink = sendReviewRequest(customerEmail, customerName, siteName, business);
            window.location.href = reviewLink;
            
            const userId = window.currentUser.uid;
            const reviewData = {
                customerName: customerName,
                customerEmail: customerEmail,
                siteName: siteName,
                business: business,
                sentDate: new Date().toISOString(),
                sentBy: window.currentUser.email
            };
            
            const reviewRef = window.dbPush(window.dbRef(window.database, `users/${userId}/reviewRequests`));
            window.dbSet(reviewRef, reviewData).then(() => {
                document.getElementById('sendReviewForm').reset();
                alert('‚úÖ Review request email opened!\n\nSend the email from your email client to complete.');
                loadReviewHistory();
            }).catch(error => {
                console.error('Error saving review request:', error);
            });
        });

        // Load Review History
        function loadReviewHistory() {
            if (!window.currentUser) return;
            
            const userId = window.currentUser.uid;
            const reviewsRef = window.dbRef(window.database, `users/${userId}/reviewRequests`);
            
            window.dbOnValue(reviewsRef, (snapshot) => {
                const container = document.getElementById('reviewHistoryContainer');
                const reviews = [];
                
                snapshot.forEach((childSnapshot) => {
                    reviews.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                if (reviews.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚≠ê</div>
                            <div class="empty-state-text">No review requests sent yet</div>
                        </div>
                    `;
                    return;
                }
                
                reviews.sort((a, b) => new Date(b.sentDate) - new Date(a.sentDate));
                const recentReviews = reviews.slice(0, 10);
                
                container.innerHTML = recentReviews.map(review => {
                    const businessIcon = review.business === 'weedcontrol' ? 'üåø' : 'üå≥';
                    const businessName = review.business === 'weedcontrol' ? 'Weed Control Kent' : 'Roundwood Solutions';
                    
                    return `
                    <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 600;">${review.customerName}</div>
                                <div style="font-size: 0.9rem; color: var(--gray-600);">${review.customerEmail}</div>
                                <div style="font-size: 0.85rem; color: var(--gray-500); margin-top: 0.25rem;">
                                    Site: ${review.siteName}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--primary); margin-top: 0.25rem; font-weight: 500;">
                                    ${businessIcon} ${businessName}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.85rem; color: var(--gray-500);">
                                    ${new Date(review.sentDate).toLocaleDateString('en-GB')}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--gray-400);">
                                    by ${review.sentBy}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
            });
        }

        // ============================================
        // CALCULATOR FUNCTIONS
        // ============================================
        
        function calculate() {
            const seconds = parseFloat(document.getElementById('seconds').value) || 90;
            const nozzleOutput = parseFloat(document.getElementById('nozzleOutput').value) || 0;
            const stripWidth = parseFloat(document.getElementById('stripWidth').value) || 1;
            const sprayerCapacity = parseFloat(document.getElementById('sprayerCapacity').value) || 15;
            const chemicalRate = parseFloat(document.getElementById('chemicalRate').value) || 0;
            const area = parseFloat(document.getElementById('area').value) || 0;

            const walkingSpeed = 360 / seconds;
            document.getElementById('walkingSpeed').innerHTML = walkingSpeed.toFixed(2) + '<span class="calc-unit">KPH</span>';

            const sprayerOutput = (600 * nozzleOutput) / stripWidth / walkingSpeed;
            document.getElementById('sprayerOutput').innerHTML = sprayerOutput.toFixed(2) + '<span class="calc-unit">L/ha</span>';

            const tanksPerHa = sprayerOutput / sprayerCapacity;
            document.getElementById('tanksPerHa').innerHTML = tanksPerHa.toFixed(2) + '<span class="calc-unit">tanks</span>';

            const chemicalPerTank = tanksPerHa > 0 ? (chemicalRate * 1000) / tanksPerHa : 0;
            document.getElementById('chemicalPerTank').innerHTML = chemicalPerTank.toFixed(2) + '<span class="calc-unit">mls</span>';

            const totalChemical = (chemicalRate / 10000) * area;
            document.getElementById('totalChemical').innerHTML = totalChemical.toFixed(3) + '<span class="calc-unit">litres</span>';

            const totalWater = (sprayerOutput / 10000) * area - totalChemical;
            document.getElementById('totalWater').innerHTML = totalWater.toFixed(2) + '<span class="calc-unit">litres</span>';
        }

        setTimeout(() => {
            const inputs = ['seconds', 'nozzleOutput', 'stripWidth', 'sprayerCapacity', 'chemicalRate', 'area'];
            inputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', calculate);
                }
            });
        }, 1000);

        window.saveCalculation = async function() {
            if (!window.currentUser) {
                alert('Please sign in to save calculations');
                return;
            }

            const calcName = document.getElementById('calcName').value || 'Unnamed Calculation';
            const nozzleOutput = parseFloat(document.getElementById('nozzleOutput').value) || 0;

            if (nozzleOutput === 0) {
                alert('Please enter nozzle output');
                return;
            }

            const calculation = {
                name: calcName,
                timestamp: Date.now(),
                date: new Date().toLocaleDateString(),
                inputs: {
                    seconds: parseFloat(document.getElementById('seconds').value),
                    nozzleOutput: nozzleOutput,
                    stripWidth: parseFloat(document.getElementById('stripWidth').value),
                    sprayerCapacity: parseFloat(document.getElementById('sprayerCapacity').value),
                    chemicalRate: parseFloat(document.getElementById('chemicalRate').value),
                    area: parseFloat(document.getElementById('area').value)
                },
                results: {
                    walkingSpeed: parseFloat(document.getElementById('walkingSpeed').textContent),
                    sprayerOutput: parseFloat(document.getElementById('sprayerOutput').textContent),
                    tanksPerHa: parseFloat(document.getElementById('tanksPerHa').textContent),
                    chemicalPerTank: parseFloat(document.getElementById('chemicalPerTank').textContent),
                    totalChemical: parseFloat(document.getElementById('totalChemical').textContent),
                    totalWater: parseFloat(document.getElementById('totalWater').textContent)
                }
            };

            try {
                await window.dbSet(window.dbPush(window.dbRef(window.database, `users/${window.currentUser.uid}/calibrations`)), calculation);
                alert('Calculation saved successfully!');
                document.getElementById('calcName').value = '';
                loadSavedCalculations();
            } catch (error) {
                alert('Error saving calculation: ' + error.message);
            }
        };

        function loadSavedCalculations() {
            if (!window.currentUser) return;

            const listDiv = document.getElementById('savedCalcsList');
            listDiv.innerHTML = '<div class="loading">Loading...</div>';

            window.dbOnValue(window.dbRef(window.database, `users/${window.currentUser.uid}/calibrations`), (snapshot) => {
                const calcs = [];
                snapshot.forEach((child) => {
                    calcs.push({ id: child.key, ...child.val() });
                });

                calcs.reverse();

                if (calcs.length === 0) {
                    listDiv.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">No saved calculations yet</p>';
                    return;
                }

                listDiv.innerHTML = calcs.map(calc => `
                    <div class="saved-calc-item" onclick="loadCalculation('\${calc.id}')">
                        <div class="saved-calc-header">
                            <div class="saved-calc-title">\${calc.name}</div>
                            <div class="saved-calc-date">\${calc.date}</div>
                        </div>
                        <div class="saved-calc-details">
                            <div>Nozzle: \${calc.inputs.nozzleOutput} LPM</div>
                            <div>Chemical: \${calc.inputs.chemicalRate} L/ha</div>
                            <div>Area: \${calc.inputs.area} m¬≤</div>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--primary); font-weight: 600;">
                            Total Chemical: \${calc.results.totalChemical.toFixed(3)}L | Water: \${calc.results.totalWater.toFixed(2)}L
                        </div>
                        <button class="btn btn-danger" style="margin-top: 0.5rem; padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="event.stopPropagation(); deleteCalculation('\${calc.id}')">Delete</button>
                    </div>
                `).join('');
            });
        }

        window.loadCalculation = function(calcId) {
            window.dbGet(window.dbRef(window.database, `users/${window.currentUser.uid}/calibrations/${calcId}`)).then((snapshot) => {
                const calc = snapshot.val();
                if (!calc) return;

                document.getElementById('calcName').value = calc.name;
                document.getElementById('seconds').value = calc.inputs.seconds;
                document.getElementById('nozzleOutput').value = calc.inputs.nozzleOutput;
                document.getElementById('stripWidth').value = calc.inputs.stripWidth;
                document.getElementById('sprayerCapacity').value = calc.inputs.sprayerCapacity;
                document.getElementById('chemicalRate').value = calc.inputs.chemicalRate;
                document.getElementById('area').value = calc.inputs.area;

                calculate();
                window.scrollTo(0, 0);
                alert('Calculation loaded successfully!');
            });
        };

        window.deleteCalculation = async function(calcId) {
            if (!confirm('Are you sure you want to delete this calculation?')) return;

            try {
                await window.dbRemove(window.dbRef(window.database, `users/${window.currentUser.uid}/calibrations/${calcId}`));
                alert('Calculation deleted');
                loadSavedCalculations();
            } catch (error) {
                alert('Error deleting calculation: ' + error.message);
            }
        };

        window.resetCalculator = function() {
            document.getElementById('calcName').value = '';
            document.getElementById('seconds').value = 90;
            document.getElementById('nozzleOutput').value = '';
            document.getElementById('stripWidth').value = 1;
            document.getElementById('sprayerCapacity').value = 15;
            document.getElementById('chemicalRate').value = '';
            document.getElementById('area').value = '';
            calculate();
        };

        // ========================================
        // PIPELINE MODAL FUNCTIONS
        // ========================================

        window.openAddPipelineJobModal = function() {
            document.getElementById('addPipelineJobModal')?.classList.add('active');
        };

        window.closeAddPipelineJobModal = function() {
            document.getElementById('addPipelineJobModal')?.classList.remove('active');
            document.getElementById('addPipelineJobForm')?.reset();
        };

        window.openSendQuoteModal = function(jobId) {
            currentPipelineJobId = jobId;
            const job = window.pipelineJobs.find(j => j.id === jobId);
            
            if (job) {
                document.getElementById('quoteJobInfo').textContent = `Job Ref: ${job.jobReference} - ${job.customerName} - ${job.jobDescription}`;
                document.getElementById('quoteDate').value = getTodayDate();
                document.getElementById('quoteValidUntil').value = getDatePlusDays(30);
                
                if (job.quoteAmount) {
                    document.getElementById('quoteAmount').value = job.quoteAmount;
                }
                
                document.getElementById('sendQuoteModal')?.classList.add('active');
            }
        };

        window.closeSendQuoteModal = function() {
            document.getElementById('sendQuoteModal')?.classList.remove('active');
            document.getElementById('sendQuoteForm')?.reset();
            currentPipelineJobId = null;
        };

        window.openMarkApprovedModal = function(jobId) {
            currentPipelineJobId = jobId;
            const job = window.pipelineJobs.find(j => j.id === jobId);
            
            if (job) {
                document.getElementById('approvedJobInfo').textContent = `Job Ref: ${job.jobReference} - ${job.customerName} - ¬£${parseFloat(job.quoteAmount).toFixed(2)}`;
                document.getElementById('markApprovedModal')?.classList.add('active');
            }
        };

        window.closeMarkApprovedModal = function() {
            document.getElementById('markApprovedModal')?.classList.remove('active');
            document.getElementById('markApprovedForm')?.reset();
            currentPipelineJobId = null;
        };

        window.openCompleteWorkModal = function(jobId) {
            currentPipelineJobId = jobId;
            const job = window.pipelineJobs.find(j => j.id === jobId);
            
            if (job) {
                document.getElementById('completeJobInfo').textContent = `Job Ref: ${job.jobReference} - ${job.customerName}`;
                document.getElementById('completionDate').value = getTodayDate();
                document.getElementById('completeWorkModal')?.classList.add('active');
            }
        };

        window.closeCompleteWorkModal = function() {
            document.getElementById('completeWorkModal')?.classList.remove('active');
            document.getElementById('completeWorkForm')?.reset();
            currentPipelineJobId = null;
        };

        window.openSendInvoiceModal = async function(jobId) {
            currentPipelineJobId = jobId;
            const job = window.pipelineJobs.find(j => j.id === jobId);
            
            if (job) {
                document.getElementById('invoiceJobInfo').textContent = `Job Ref: ${job.jobReference} - ${job.customerName} - ¬£${parseFloat(job.quoteAmount).toFixed(2)}`;
                
                const nextInvoiceNum = await getNextInvoiceNumber();
                document.getElementById('invoiceNumber').value = nextInvoiceNum;
                document.getElementById('invoiceDate').value = getTodayDate();
                document.getElementById('paymentDue').value = getDatePlusDays(14);
                document.getElementById('finalAmount').value = job.quoteAmount || '';
                
                document.getElementById('sendInvoiceModal')?.classList.add('active');
            }
        };

        window.closeSendInvoiceModal = function() {
            document.getElementById('sendInvoiceModal')?.classList.remove('active');
            document.getElementById('sendInvoiceForm')?.reset();
            currentPipelineJobId = null;
        };

        window.openMarkPaidModal = function(jobId) {
            currentPipelineJobId = jobId;
            const job = window.pipelineJobs.find(j => j.id === jobId);
            
            if (job) {
                document.getElementById('paidJobInfo').textContent = `Job Ref: ${job.jobReference} - Invoice: ${job.invoiceNumber} - ¬£${parseFloat(job.quoteAmount).toFixed(2)}`;
                document.getElementById('paymentDate').value = getTodayDate();
                document.getElementById('markPaidModal')?.classList.add('active');
            }
        };

        window.closeMarkPaidModal = function() {
            document.getElementById('markPaidModal')?.classList.remove('active');
            document.getElementById('markPaidForm')?.reset();
            currentPipelineJobId = null;
        };

        window.toggleApprovalFields = function() {
            const requiresApproval = document.getElementById('requiresApproval')?.value;
            const approvalFields = document.getElementById('approvalFields');
            
            if (approvalFields) {
                approvalFields.style.display = requiresApproval === 'yes' ? 'block' : 'none';
            }
        };

        // ========================================
        // PIPELINE HELPER FUNCTIONS
        // ========================================

        // Get next job reference number
        async function getNextJobReference() {
            try {
                const userId = window.currentUser.uid;
                const jobsRef = window.dbRef(window.database, `users/${userId}/pipelineJobs`);
                const snapshot = await window.dbGet(jobsRef);
                
                if (!snapshot.exists()) {
                    return 101; // Start at 101
                }
                
                const jobs = snapshot.val();
                let maxRef = 100;
                
                Object.values(jobs).forEach(job => {
                    const ref = parseInt(job.jobReference);
                    if (!isNaN(ref) && ref > maxRef) {
                        maxRef = ref;
                    }
                });
                
                return maxRef + 1;
            } catch (error) {
                console.error('Error getting next job reference:', error);
                return 101; // Default to 101 if error
            }
        }

        // ========================================
        // PIPELINE FORM SUBMISSION HANDLERS
        // ========================================

        // Add Pipeline Job Form Handler
        if (document.getElementById('addPipelineJobForm')) {
            document.getElementById('addPipelineJobForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    const userId = window.currentUser.uid;
                    const jobRef = window.dbPush(window.dbRef(window.database, `users/${userId}/pipelineJobs`));
                    const nextRef = await getNextJobReference();
                    
                    const jobData = {
                        jobReference: nextRef.toString(),
                        customerName: document.getElementById('pipelineCustomerName').value,
                        customerPhone: document.getElementById('pipelineCustomerPhone').value,
                        customerEmail: document.getElementById('pipelineCustomerEmail').value,
                        jobDescription: document.getElementById('pipelineJobDescription').value,
                        projectType: document.getElementById('pipelineProjectType').value,
                        estimatedValue: parseFloat(document.getElementById('pipelineEstimatedValue').value) || null,
                        notes: document.getElementById('pipelineNotes').value,
                        stage: 'newLead',
                        createdAt: new Date().toISOString()
                    };
                    
                    await window.dbSet(jobRef, jobData);
                    closeAddPipelineJobModal();
                    alert('‚úÖ Lead added successfully! Job Ref: ' + nextRef);
                } catch (error) {
                    console.error('Error adding pipeline job:', error);
                    alert('Error adding lead. Please try again.');
                }
            });
        }

        // Send Quote Form Handler
        if (document.getElementById('sendQuoteForm')) {
            document.getElementById('sendQuoteForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    const userId = window.currentUser.uid;
                    const quoteData = {
                        quoteAmount: parseFloat(document.getElementById('quoteAmount').value),
                        quoteDate: document.getElementById('quoteDate').value,
                        quoteValidUntil: document.getElementById('quoteValidUntil').value,
                        quoteSent: document.getElementById('quoteSent').checked,
                        requiresApproval: document.getElementById('requiresApproval').value,
                        poNumber: document.getElementById('poNumber').value || null,
                        stage: 'quoteSent',
                        updatedAt: new Date().toISOString()
                    };
                    
                    await window.dbUpdate(
                        window.dbRef(window.database, `users/${userId}/pipelineJobs/${currentPipelineJobId}`),
                        quoteData
                    );
                    
                    closeSendQuoteModal();
                    alert('‚úÖ Quote sent successfully!');
                } catch (error) {
                    console.error('Error sending quote:', error);
                    alert('Error sending quote. Please try again.');
                }
            });
        }

        // Mark Approved Form Handler
        if (document.getElementById('markApprovedForm')) {
            document.getElementById('markApprovedForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const userId = window.currentUser.uid;
                const approvalStatus = document.getElementById('approvalStatus').value;
                const poNumber = document.getElementById('approvedPoNumber').value;
                
                const updateData = {
                    approvalStatus: approvalStatus,
                    approvalDate: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                if (poNumber) {
                    updateData.poNumber = poNumber;
                }
                
                if (approvalStatus === 'approved') {
                    updateData.stage = 'approved';
                }
                
                await window.dbUpdate(
                    window.dbRef(window.database, `users/${userId}/pipelineJobs/${currentPipelineJobId}`),
                    updateData
                );
                
                closeMarkApprovedModal();
                alert('‚úÖ Approval status updated!');
            } catch (error) {
                console.error('Error updating approval:', error);
                alert('Error updating approval. Please try again.');
            }
        });

        }

        // Complete Work Form Handler
        if (document.getElementById('completeWorkForm')) {
            document.getElementById('completeWorkForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    const userId = window.currentUser.uid;
                    const completeData = {
                        workCompletionDate: document.getElementById('completionDate').value,
                        jobStatus: document.getElementById('jobStatus').value,
                        snaggingItems: document.getElementById('snaggingItems').value || null,
                        stage: 'complete',
                        updatedAt: new Date().toISOString()
                    };
                    
                    await window.dbUpdate(
                        window.dbRef(window.database, `users/${userId}/pipelineJobs/${currentPipelineJobId}`),
                        completeData
                    );
                    
                    closeCompleteWorkModal();
                    alert('‚úÖ Work marked complete! Ready to send invoice.');
                } catch (error) {
                    console.error('Error completing work:', error);
                    alert('Error completing work. Please try again.');
                }
            });
        }

        // Send Invoice Form Handler
        if (document.getElementById('sendInvoiceForm')) {
            document.getElementById('sendInvoiceForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                const userId = window.currentUser.uid;
                const invoiceData = {
                    invoiceNumber: document.getElementById('invoiceNumber').value,
                    invoiceDate: document.getElementById('invoiceDate').value,
                    paymentDueDate: document.getElementById('paymentDue').value,
                    finalAmount: parseFloat(document.getElementById('finalAmount').value),
                    invoiceSent: document.getElementById('invoiceSent').checked,
                    stage: 'invoiced',
                    updatedAt: new Date().toISOString()
                };
                
                // Update quote amount if changed
                if (invoiceData.finalAmount) {
                    invoiceData.quoteAmount = invoiceData.finalAmount;
                }
                
                await window.dbUpdate(
                    window.dbRef(window.database, `users/${userId}/pipelineJobs/${currentPipelineJobId}`),
                    invoiceData
                );
                
                closeSendInvoiceModal();
                alert('‚úÖ Invoice sent! Now tracking payment.');
            } catch (error) {
                console.error('Error sending invoice:', error);
                alert('Error sending invoice. Please try again.');
            }
        });
        }

        // Mark Paid Form Handler
        document.getElementById('markPaidForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const userId = window.currentUser.uid;
                const paymentData = {
                    paymentReceived: true,
                    paymentDate: document.getElementById('paymentDate').value,
                    paymentMethod: document.getElementById('paymentMethod').value,
                    stage: 'paid',
                    updatedAt: new Date().toISOString()
                };
                
                await window.dbUpdate(
                    window.dbRef(window.database, `users/${userId}/pipelineJobs/${currentPipelineJobId}`),
                    paymentData
                );
                
                closeMarkPaidModal();
                alert('üéâ Payment received! Job complete. Ready to request review?');
            } catch (error) {
                console.error('Error marking paid:', error);
                alert('Error marking as paid. Please try again.');
            }
        });

        // END OF PIPELINE FORM HANDLERS

        // ========================================
        // COMPREHENSIVE EXCEL EXPORT SYSTEM
        // ========================================

        // Helper function to format date for Excel
        function formatDateForExcel(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB');
        }

        // Main export function - exports ALL data to Excel with multiple sheets
        window.exportAllDataToExcel = function() {
            try {
                console.log('Starting comprehensive data export...');
                
                // Create CSV content for each sheet
                let sitesCSV = 'Site Name,Address,Frequency,Contact,Phone,Email,Contract Notes,Status\n';
                window.sites.forEach(site => {
                    const freq = {7: 'Weekly', 14: 'Fortnightly', 28: '4-Weekly', 30: 'Monthly', 91: 'Quarterly'}[site.frequency] || site.frequency + ' days';
                    const status = site.paused ? 'Paused' + (site.pausedUntil ? ' until ' + formatDateForExcel(site.pausedUntil) : '') : 'Active';
                    sitesCSV += `"${site.name}","${site.address}","${freq}","${site.contact || ''}","${site.phone || ''}","${site.email || ''}","${site.contractNotes || ''}","${status}"\n`;
                });

                let visitsCSV = 'Site Name,Address,Scheduled Date,Price,Status,Invoice Sent,Completed Date\n';
                window.visits.forEach(visit => {
                    const status = visit.completed ? 'Completed' : (visit.status === 'paused' ? 'Paused' : (visit.scheduledDate < new Date().toISOString().split('T')[0] ? 'Overdue' : 'Pending'));
                    visitsCSV += `"${visit.siteName}","${visit.siteAddress}","${formatDateForExcel(visit.scheduledDate)}","¬£${visit.price.toFixed(2)}","${status}","${visit.invoiceSent ? 'Yes' : 'No'}","${visit.completedDate ? formatDateForExcel(visit.completedDate) : ''}"\n`;
                });

                let projectsCSV = 'Project Name,Client,Start Date,Status,Budget,Description,Completion Date\n';
                window.projects.forEach(project => {
                    projectsCSV += `"${project.name}","${project.client}","${formatDateForExcel(project.startDate)}","${project.status || 'In Progress'}","¬£${project.budget || 0}","${project.description || ''}","${project.completionDate ? formatDateForExcel(project.completionDate) : ''}"\n`;
                });

                let pipelineCSV = 'Job Ref,Customer Name,Job Description,Stage,Quote Amount,Quote Date,Invoice Number,Payment Status\n';
                window.pipelineJobs.forEach(job => {
                    const stageNames = {
                        newLead: 'New Lead',
                        quoteSent: 'Quote Sent',
                        approved: 'Approved',
                        inProgress: 'In Progress',
                        complete: 'Complete',
                        invoiced: 'Invoiced',
                        paid: 'Paid'
                    };
                    pipelineCSV += `"${job.jobReference}","${job.customerName}","${job.jobDescription}","${stageNames[job.stage] || job.stage}","¬£${job.quoteAmount || 0}","${job.quoteDate ? formatDateForExcel(job.quoteDate) : ''}","${job.invoiceNumber || ''}","${job.paymentReceived ? 'Paid' : 'Pending'}"\n`;
                });

                // Get invoices (uninvoiced visits)
                let invoicesCSV = 'Site Name,Visit Date,Amount,Status,Invoice Sent Date\n';
                window.visits.filter(v => v.completed && !v.invoiceSent).forEach(visit => {
                    invoicesCSV += `"${visit.siteName}","${formatDateForExcel(visit.completedDate)}","¬£${visit.price.toFixed(2)}","Awaiting Invoice",""\n`;
                });
                window.visits.filter(v => v.invoiceSent).forEach(visit => {
                    invoicesCSV += `"${visit.siteName}","${formatDateForExcel(visit.completedDate)}","¬£${visit.price.toFixed(2)}","Invoice Sent","${formatDateForExcel(visit.invoiceSentDate)}"\n`;
                });

                // Load saved calibrations from localStorage
                let calibrationsCSV = 'Calculation Name,Seconds,Nozzle Output,Strip Width,Sprayer Capacity,Chemical Rate,Area,Date Saved\n';
                const savedCalcs = JSON.parse(localStorage.getItem('savedCalculations') || '[]');
                savedCalcs.forEach(calc => {
                    calibrationsCSV += `"${calc.name}","${calc.seconds}","${calc.nozzleOutput}","${calc.stripWidth}","${calc.sprayerCapacity}","${calc.chemicalRate}","${calc.area}","${calc.dateSaved ? formatDateForExcel(calc.dateSaved) : ''}"\n`;
                });

                // Create a combined export file with all sheets
                // Note: True multi-sheet Excel requires a library, so we'll create separate CSV files
                // that can be imported into Excel as separate sheets
                
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `Roundwood-Complete-Export-${timestamp}.txt`;
                
                let combinedContent = '='.repeat(80) + '\n';
                combinedContent += 'ROUNDWOOD SOLUTIONS - COMPLETE DATA EXPORT\n';
                combinedContent += 'Export Date: ' + new Date().toLocaleString('en-GB') + '\n';
                combinedContent += '='.repeat(80) + '\n\n';
                
                combinedContent += '\n' + '='.repeat(80) + '\n';
                combinedContent += 'SHEET 1: SITES (' + window.sites.length + ' sites)\n';
                combinedContent += '='.repeat(80) + '\n';
                combinedContent += sitesCSV;
                
                combinedContent += '\n' + '='.repeat(80) + '\n';
                combinedContent += 'SHEET 2: VISITS (' + window.visits.length + ' visits)\n';
                combinedContent += '='.repeat(80) + '\n';
                combinedContent += visitsCSV;
                
                combinedContent += '\n' + '='.repeat(80) + '\n';
                combinedContent += 'SHEET 3: PROJECTS (' + window.projects.length + ' projects)\n';
                combinedContent += '='.repeat(80) + '\n';
                combinedContent += projectsCSV;
                
                combinedContent += '\n' + '='.repeat(80) + '\n';
                combinedContent += 'SHEET 4: PIPELINE (' + window.pipelineJobs.length + ' jobs)\n';
                combinedContent += '='.repeat(80) + '\n';
                combinedContent += pipelineCSV;
                
                combinedContent += '\n' + '='.repeat(80) + '\n';
                combinedContent += 'SHEET 5: INVOICES\n';
                combinedContent += '='.repeat(80) + '\n';
                combinedContent += invoicesCSV;
                
                combinedContent += '\n' + '='.repeat(80) + '\n';
                combinedContent += 'SHEET 6: CALIBRATIONS (' + savedCalcs.length + ' saved)\n';
                combinedContent += '='.repeat(80) + '\n';
                combinedContent += calibrationsCSV;
                
                // Create download
                const blob = new Blob([combinedContent], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                // Save last export date
                localStorage.setItem('lastExportDate', new Date().toISOString());
                
                alert('‚úÖ Complete data export successful!\n\n' +
                      'Exported:\n' +
                      '‚Ä¢ ' + window.sites.length + ' sites\n' +
                      '‚Ä¢ ' + window.visits.length + ' visits\n' +
                      '‚Ä¢ ' + window.projects.length + ' projects\n' +
                      '‚Ä¢ ' + window.pipelineJobs.length + ' pipeline jobs\n' +
                      '‚Ä¢ Invoices\n' +
                      '‚Ä¢ ' + savedCalcs.length + ' calibrations\n\n' +
                      'File: ' + filename);
                
                console.log('Export completed successfully');
                
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting data. Please try again.');
            }
        };

        // Automatic daily backup system
        function checkAndRunDailyBackup() {
            try {
                const autoBackupEnabled = localStorage.getItem('autoBackupEnabled') !== 'false'; // Default: enabled
                
                if (!autoBackupEnabled) {
                    console.log('Auto-backup is disabled');
                    return;
                }
                
                const lastBackup = localStorage.getItem('lastAutoBackupDate');
                const today = new Date().toISOString().split('T')[0];
                
                if (lastBackup !== today) {
                    console.log('Running automatic daily backup...');
                    
                    // Run backup automatically
                    exportAllDataToExcel();
                    
                    // Update last backup date
                    localStorage.setItem('lastAutoBackupDate', today);
                    
                    console.log('Automatic backup completed for', today);
                }
            } catch (error) {
                console.error('Auto-backup error:', error);
            }
        }

        // Toggle auto-backup on/off
        window.toggleAutoBackup = function() {
            const currentStatus = localStorage.getItem('autoBackupEnabled') !== 'false';
            const newStatus = !currentStatus;
            
            localStorage.setItem('autoBackupEnabled', newStatus);
            
            alert(newStatus 
                ? '‚úÖ Automatic daily backups ENABLED\n\nYour data will be exported automatically once per day when you open the app.'
                : '‚è∏Ô∏è Automatic daily backups DISABLED\n\nYou can still export manually anytime using the Export button.'
            );
            
            // Update button text if it exists
            updateAutoBackupButton();
        };

        // Update auto-backup button text
        function updateAutoBackupButton() {
            const enabled = localStorage.getItem('autoBackupEnabled') !== 'false';
            const text = enabled ? '‚úÖ Auto-Backup: ON' : '‚è∏Ô∏è Auto-Backup: OFF';
            
            // Update old button if it exists (for backwards compatibility)
            const btn = document.getElementById('autoBackupToggle');
            if (btn) {
                btn.innerHTML = text;
                btn.className = enabled 
                    ? 'btn btn-success btn-small'
                    : 'btn btn-secondary btn-small';
            }
            
            // Update menu item
            const menuItem = document.getElementById('autoBackupMenuItem');
            if (menuItem) {
                menuItem.innerHTML = text;
            }
        }

        // ========================================
        // GOOGLE DRIVE INTEGRATION
        // ========================================

        // Google API Configuration
        const GOOGLE_CLIENT_ID = 'YOUR_CLIENT_ID_HERE'; // User needs to create this
        const GOOGLE_API_KEY = 'YOUR_API_KEY_HERE'; // User needs to create this
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let googleDriveInitialized = false;
        let googleDriveAuthenticated = false;

        // Initialize Google Drive API
        function initGoogleDrive() {
            // Check if API keys are configured
            if (GOOGLE_CLIENT_ID === 'YOUR_CLIENT_ID_HERE' || GOOGLE_API_KEY === 'YOUR_API_KEY_HERE') {
                console.log('Google Drive not configured yet');
                return;
            }

            gapi.load('client:auth2', async () => {
                try {
                    await gapi.client.init({
                        apiKey: GOOGLE_API_KEY,
                        clientId: GOOGLE_CLIENT_ID,
                        discoveryDocs: DISCOVERY_DOCS,
                        scope: SCOPES
                    });
                    
                    googleDriveInitialized = true;
                    
                    // Check if already signed in
                    const authInstance = gapi.auth2.getAuthInstance();
                    if (authInstance.isSignedIn.get()) {
                        googleDriveAuthenticated = true;
                        updateGoogleDriveStatus();
                        console.log('Google Drive: Already authenticated');
                    }
                    
                } catch (error) {
                    console.error('Google Drive initialization error:', error);
                }
            });
        }

        // Authenticate with Google Drive
        window.authenticateGoogleDrive = async function() {
            if (!googleDriveInitialized) {
                alert('‚ö†Ô∏è Google Drive Setup Required\n\n' +
                      'To enable Google Drive backups:\n\n' +
                      '1. Go to Google Cloud Console\n' +
                      '2. Create a project\n' +
                      '3. Enable Google Drive API\n' +
                      '4. Create credentials (OAuth 2.0)\n' +
                      '5. Add credentials to this file\n\n' +
                      'See GOOGLE-DRIVE-SETUP.md for detailed instructions.');
                return;
            }

            try {
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signIn();
                googleDriveAuthenticated = true;
                updateGoogleDriveStatus();
                alert('‚úÖ Google Drive connected!\n\nYour backups will now automatically upload to Google Drive.');
            } catch (error) {
                console.error('Google Drive authentication error:', error);
                alert('‚ùå Could not connect to Google Drive. Please try again.');
            }
        };

        // Sign out from Google Drive
        window.signOutGoogleDrive = async function() {
            if (!googleDriveInitialized) return;
            
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signOut();
                googleDriveAuthenticated = false;
                updateGoogleDriveStatus();
                alert('Google Drive disconnected.');
            } catch (error) {
                console.error('Google Drive sign out error:', error);
            }
        };

        // Update Google Drive connection status
        function updateGoogleDriveStatus() {
            const text = googleDriveAuthenticated ? '‚úÖ Google Drive Connected' : 'üîó Connect Google Drive';
            
            // Update old button if it exists (for backwards compatibility)
            const statusBtn = document.getElementById('googleDriveStatus');
            if (statusBtn) {
                if (googleDriveAuthenticated) {
                    statusBtn.innerHTML = '‚úÖ Google Drive Connected';
                    statusBtn.className = 'btn btn-success btn-small';
                    statusBtn.onclick = signOutGoogleDrive;
                } else {
                    statusBtn.innerHTML = 'üîó Connect Google Drive';
                    statusBtn.className = 'btn btn-primary btn-small';
                    statusBtn.onclick = authenticateGoogleDrive;
                }
            }
            
            // Update menu item
            const menuItem = document.getElementById('googleDriveMenuItem');
            if (menuItem) {
                menuItem.innerHTML = text;
            }
        }

        // Create or get Roundwood Backups folder in Google Drive
        async function getOrCreateBackupFolder() {
            try {
                // Search for existing folder
                const response = await gapi.client.drive.files.list({
                    q: "name='Roundwood Backups' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                if (response.result.files.length > 0) {
                    return response.result.files[0].id;
                }

                // Create new folder
                const folderMetadata = {
                    name: 'Roundwood Backups',
                    mimeType: 'application/vnd.google-apps.folder'
                };

                const folder = await gapi.client.drive.files.create({
                    resource: folderMetadata,
                    fields: 'id'
                });

                console.log('Created Roundwood Backups folder:', folder.result.id);
                return folder.result.id;

            } catch (error) {
                console.error('Error creating backup folder:', error);
                throw error;
            }
        }

        // Create or get year/month subfolder
        async function getOrCreateDateFolder(parentId) {
            try {
                const now = new Date();
                const year = now.getFullYear().toString();
                const month = now.toLocaleString('en-GB', { month: 'long' });

                // Get or create year folder
                let yearResponse = await gapi.client.drive.files.list({
                    q: `name='${year}' and '${parentId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                let yearFolderId;
                if (yearResponse.result.files.length > 0) {
                    yearFolderId = yearResponse.result.files[0].id;
                } else {
                    const yearFolder = await gapi.client.drive.files.create({
                        resource: {
                            name: year,
                            mimeType: 'application/vnd.google-apps.folder',
                            parents: [parentId]
                        },
                        fields: 'id'
                    });
                    yearFolderId = yearFolder.result.id;
                }

                // Get or create month folder
                let monthResponse = await gapi.client.drive.files.list({
                    q: `name='${month}' and '${yearFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                let monthFolderId;
                if (monthResponse.result.files.length > 0) {
                    monthFolderId = monthResponse.result.files[0].id;
                } else {
                    const monthFolder = await gapi.client.drive.files.create({
                        resource: {
                            name: month,
                            mimeType: 'application/vnd.google-apps.folder',
                            parents: [yearFolderId]
                        },
                        fields: 'id'
                    });
                    monthFolderId = monthFolder.result.id;
                }

                return monthFolderId;

            } catch (error) {
                console.error('Error creating date folder:', error);
                throw error;
            }
        }

        // Upload file to Google Drive
        async function uploadToGoogleDrive(filename, content) {
            if (!googleDriveAuthenticated) {
                console.log('Google Drive not authenticated, skipping upload');
                return false;
            }

            try {
                console.log('Uploading to Google Drive:', filename);

                // Get folder structure
                const rootFolderId = await getOrCreateBackupFolder();
                const monthFolderId = await getOrCreateDateFolder(rootFolderId);

                // Create file metadata
                const fileMetadata = {
                    name: filename,
                    parents: [monthFolderId]
                };

                // Create multipart upload
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";

                const contentType = 'text/plain';
                const metadata = {
                    name: filename,
                    mimeType: contentType,
                    parents: [monthFolderId]
                };

                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                    JSON.stringify(metadata) +
                    delimiter +
                    'Content-Type: ' + contentType + '\r\n\r\n' +
                    content +
                    close_delim;

                const request = gapi.client.request({
                    path: '/upload/drive/v3/files',
                    method: 'POST',
                    params: { uploadType: 'multipart' },
                    headers: {
                        'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                    },
                    body: multipartRequestBody
                });

                const response = await request;
                console.log('Upload successful:', response.result.id);
                
                return true;

            } catch (error) {
                console.error('Google Drive upload error:', error);
                return false;
            }
        }

        // Enhanced export function with Google Drive upload
        const originalExport = window.exportAllDataToExcel;
        window.exportAllDataToExcel = async function() {
            // Run original export (downloads to computer)
            originalExport();

            // Also upload to Google Drive if authenticated
            if (googleDriveAuthenticated) {
                try {
                    // Generate the same content that was downloaded
                    const timestamp = new Date().toISOString().split('T')[0];
                    const filename = `Roundwood-Complete-Export-${timestamp}.txt`;
                    
                    // Recreate export content (same as original function)
                    let combinedContent = '='.repeat(80) + '\n';
                    combinedContent += 'ROUNDWOOD SOLUTIONS - COMPLETE DATA EXPORT\n';
                    combinedContent += 'Export Date: ' + new Date().toLocaleString('en-GB') + '\n';
                    combinedContent += '='.repeat(80) + '\n\n';
                    
                    // Add all sheets (abbreviated for brevity - full version in original function)
                    // Sites
                    let sitesCSV = 'Site Name,Address,Frequency,Contact,Phone,Email,Contract Notes,Status\n';
                    window.sites.forEach(site => {
                        const freq = {7: 'Weekly', 14: 'Fortnightly', 28: '4-Weekly', 30: 'Monthly', 91: 'Quarterly'}[site.frequency] || site.frequency + ' days';
                        const status = site.paused ? 'Paused' : 'Active';
                        sitesCSV += `"${site.name}","${site.address}","${freq}","${site.contact || ''}","${site.phone || ''}","${site.email || ''}","${site.contractNotes || ''}","${status}"\n`;
                    });
                    
                    combinedContent += '\nSHEET 1: SITES (' + window.sites.length + ' sites)\n';
                    combinedContent += '='.repeat(80) + '\n';
                    combinedContent += sitesCSV;
                    
                    // Upload to Google Drive
                    const uploaded = await uploadToGoogleDrive(filename, combinedContent);
                    
                    if (uploaded) {
                        console.log('‚úÖ Backup uploaded to Google Drive');
                    }
                    
                } catch (error) {
                    console.error('Google Drive upload failed:', error);
                }
            }
        };

        // OLD Google Drive initialization - DISABLED (using new version earlier in file)
        // Initialize Google Drive on page load
        // if (typeof gapi !== 'undefined') {
        //     setTimeout(initGoogleDrive, 2000);
        // }

        // Run auto-backup check when app loads
        // if (window.currentUser) {
        //     setTimeout(checkAndRunDailyBackup, 5000); // Wait 5 seconds after login
        // }

        // Also check every hour in case app stays open
        // setInterval(checkAndRunDailyBackup, 3600000); // Check every hour

    </script>
</body>
</html>